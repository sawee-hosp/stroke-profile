<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* =========================================
           1. CORE VARIABLES & THEME
           ========================================= */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            /* Health Theme (Red) */
            --theme-red: #ff3654; 
            --theme-red-light: #ffebee;
            --theme-red-dark: #b71c1c;

            /* VHV Theme (Gold) */
            --gold-dark: #8B4513;   /* SaddleBrown for Text */
            --gold-main: #D4AF37;   /* Metallic Gold */
            --gold-bright: #FFD700; /* Gold */
            --gold-bg: #FFF8E1;     /* Cornsilk/Cream */
            --gold-card: #FFFCF2;   /* Very Light Gold */
            
            --base-size: 16px; 
        }

        html { font-size: var(--base-size); }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 1rem; 
            /* Default Red Gradient for Users */
            background: linear-gradient(180deg, var(--theme-red) 0%, #ffffff 450px);
            background-attachment: fixed;
            margin: 0; 
            padding-bottom: 6rem; 
            transition: background 0.5s ease;
            -webkit-tap-highlight-color: transparent;
            color: #333;
        }
        
        /* --- VHV Mode Override --- */
        body.vhv-mode {
            /* Gold Gradient for VHV */
            background: linear-gradient(180deg, var(--gold-main) 0%, #ffffff 400px);
        }

        h1, h2, h3, h4, h5, h6 { font-weight: 700 !important; }
        
        .text-gold-dark { color: var(--gold-dark) !important; }
        .bg-gold-light { background-color: var(--gold-bg) !important; }

        /* =========================================
           2. NAVIGATION & TABS
           ========================================= */
        .app-header-spacer { height: 70px; }

        .nav-tabs-container {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background-color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 0;
        }

        .nav-tabs { border-bottom: none; width: 100%; display: flex; margin: 0; }
        .nav-item { flex: 1; text-align: center; }

        .nav-link { 
            font-size: 1.1rem; color: #999; border: none; border-radius: 0; 
            margin: 0; padding: 15px 0; font-weight: 700; background: #fff; width: 100%;
            transition: all 0.3s ease;
        }

        /* Active Tab: Health (Red) */
        .nav-link.active { 
            color: var(--theme-red); background: var(--theme-red-light); 
            border-bottom: 5px solid var(--theme-red);
        }

        /* Active Tab: VHV (Gold) - Apply when body has vhv-mode */
        body.vhv-mode .nav-link#vhv-tab-btn.active { 
            color: var(--gold-dark); background: var(--gold-bg); 
            border-bottom: 5px solid var(--gold-bright);
        }
        
        .nav-item:first-child .nav-link { border-right: 1px solid #eee; }

        /* =========================================
           3. CARDS & UI ELEMENTS
           ========================================= */
        .card { 
            border: none; box-shadow: 0 6px 15px rgba(0,0,0,0.08); 
            margin-bottom: 1.5rem; border-radius: 20px; overflow: hidden; 
            background-color: #fff; transition: background-color 0.3s;
        }

        /* VHV Card Theme Override */
        body.vhv-mode .card { 
            border: 1px solid rgba(212, 175, 55, 0.2); 
        }
        body.vhv-mode .card-header {
            background-color: var(--gold-bg);
            color: var(--gold-dark);
            border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }
        
        .section-title { 
            font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; 
            color: #333; display: flex; align-items: center; gap: 10px;
        }
        .section-title i { font-size: 1.4rem; color: var(--theme-red); }
        body.vhv-mode .section-title i { color: var(--gold-dark); }
        
        /* Buttons */
        .btn-main { 
            background-color: var(--theme-red); color: white; border-radius: 50px; 
            padding: 10px 25px; border: none; box-shadow: 0 4px 10px rgba(255, 54, 84, 0.4); 
            font-weight: 700;
        }
        .btn-main:hover { background-color: #d62540; color: white; }

        .btn-circle { 
            width: 40px; height: 40px; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; padding: 0; flex-shrink: 0; 
        }

        /* VHV Button Override */
        body.vhv-mode .btn-primary { 
            background-color: var(--gold-dark); border-color: var(--gold-dark); color: var(--gold-bright); 
        }
        body.vhv-mode .btn-outline-primary {
            color: var(--gold-dark); border-color: var(--gold-dark);
        }
        body.vhv-mode .btn-outline-primary:hover {
            background-color: var(--gold-dark); color: white;
        }

        /* Profile */
        .profile-img-lg { 
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover; 
            border: 3px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        
        /* Game Score Card */
        .game-score-card { background: linear-gradient(135deg, #fce4ec, #ffffff); border: 2px solid #fff; }
        .game-score-box { 
            background: #fff; border-radius: 15px; padding: 10px 5px; text-align: center; 
            border: 1px solid #f0f0f0; height: 100%; cursor: pointer; transition: transform 0.2s; 
        }
        .game-score-box:active { transform: scale(0.95); }
        .game-score-box h3 { color: var(--theme-red); margin-bottom: 0; font-size: 1.5rem; }
        .game-score-box small { font-size: 0.8rem; color: #666; }
        
        /* Risk Display */
        .risk-val { font-size: 3rem; font-weight: 900; line-height: 1; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .info-item { 
            background: #f8f9fa; border: 1px solid #eee; border-radius: 12px; 
            padding: 8px; display: flex; align-items: center; gap: 8px; 
        }
        .info-item i { font-size: 1.2rem; color: var(--theme-red); }
        .info-item div { line-height: 1.2; }
        .info-item small { font-size: 0.75rem; color: #888; display: block; }
        .info-item b { font-size: 0.9rem; }

        /* Emergency */
        .emergency-graphic { font-size: 2rem; margin: 0 10px; color: #dc3545; }
        
        /* VHV Specifics */
        .vhv-patient-item { 
            border-left: 6px solid #ccc; margin-bottom: 10px; border-radius: 10px; 
            background-color: #fff; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .vhv-risk-5 { border-left-color: #8B0000; background-color: #fff0f0; } /* Dangerous */
        .vhv-risk-4 { border-left-color: #dc3545; } /* High */
        .vhv-risk-3 { border-left-color: #fd7e14; } /* Moderate */
        .vhv-risk-2 { border-left-color: #ffc107; } /* Low */
        .vhv-risk-1 { border-left-color: #28a745; } /* Normal */

        /* Loading Overlay */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: none; justify-content: center; 
            align-items: center; color: white; z-index: 2000; flex-direction: column; backdrop-filter: blur(5px);
        }

        .app-footer { text-align: center; color: #aaa; font-size: 0.75rem; margin-top: 30px; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-light" role="status"></div>
        <div class="mt-3 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs-container">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="health-tab-btn">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vhv-tab-btn">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°.</button>
            </li>
        </ul>
    </div>
    
    <div class="app-header-spacer"></div>

    <!-- MAIN CONTAINER -->
    <div class="container" style="padding: 0 15px;">
        
        <!-- === TAB 1: HEALTH === -->
        <div id="health-view">
            <div id="health-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <div class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß...</div>
                </div>
            </div>
        </div>

        <!-- === TAB 2: VHV === -->
        <div id="vhv-view" style="display: none;">
            <div id="vhv-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-warning"></div>
                    <div class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏™‡∏°...</div>
                </div>
            </div>
        </div>

    </div>

    <div class="app-footer">
        ¬© 2025 ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏à.‡∏ä‡∏∏‡∏°‡∏û‡∏£<br>
        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á
    </div>

    <!-- ================= MODALS ================= -->

    <!-- 1. Call Permission Modal -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center pt-0">
                    <div class="mb-3">
                        <i class="bi bi-telephone-outbound-fill text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="fw-bold mb-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</h5>
                    <p class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-primary rounded-pill py-2" onclick="execCall()">‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ & ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
                        <button class="btn btn-light rounded-pill py-2 text-muted" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Edit Emergency Info Modal -->
    <div class="modal fade" id="editEmgModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-muted small">‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                        <select class="form-select" id="inpHelp">
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß">‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <select class="form-select" id="inpDec">
                            <option value="‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</option>
                            <option value="‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π">‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π</option>
                            <option value="‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢">‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢</option>
                            <option value="‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á">‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á</option>
                            <option value="‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö">‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100 rounded-pill" onclick="saveEmg()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3. VHV Visit Modal -->
    <div class="modal fade" id="visitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-house-heart-fill"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="visitUid">
                    <input type="hidden" id="visitName">
                    <h5 id="visitTitle" class="mb-3 fw-bold text-center"></h5>
                    
                    <div class="d-grid mb-4">
                        <button class="btn btn-warning text-dark fw-bold py-2" onclick="pinForUser()">
                            <i class="bi bi-geo-alt-fill"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                        </button>
                        <div class="form-text text-center">‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</label>
                        <div class="card p-2 bg-light border-0">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="chk1" checked>
                                <label class="form-check-label" for="chk1">‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ 5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="chk2" checked>
                                <label class="form-check-label" for="chk2">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß/‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏¢‡∏≤</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chk3">
                                <label class="form-check-label" for="chk3">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ADL / ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea class="form-control" id="visitNote" rows="2" placeholder="‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï..."></textarea>
                    </div>
                    
                    <button class="btn btn-success w-100 rounded-pill py-2 fw-bold" onclick="saveVisit()">
                        <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white text-center justify-content-center">
                <div class="modal-header border-0 position-absolute top-0 end-0">
                    <button class="btn-close btn-close-white m-3" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="mb-4 text-warning fw-bold">‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
                    <div class="bg-white p-3 d-inline-block rounded-4 mb-4 shadow-lg">
                        <img id="qrImg" src="" style="width:250px;height:250px;object-fit:contain;">
                    </div>
                    <p class="fs-4">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                    <div class="mt-3 px-4 py-2 bg-secondary bg-opacity-25 rounded-pill">
                        <small>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: <span id="refCodeDisplay" class="font-monospace text-warning"></span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // *** CONFIGURATION ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec'; // Replace with your Deployment ID
        const LIFF_ID = '2005789397-RLAGXrBJ';
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };

        let LIFF_PROFILE = {};
        let ALL_DATA = {};
        let CALL_TARGET = '';
        const MODALS = {};

        // --- Init ---
        window.onload = async () => {
            // Init Bootstrap Modals
            ['callModal', 'editEmgModal', 'visitModal', 'qrModal'].forEach(id => {
                MODALS[id] = new bootstrap.Modal(document.getElementById(id));
            });

            // Tabs Events
            document.getElementById('health-tab-btn').onclick = () => switchTab('health');
            document.getElementById('vhv-tab-btn').onclick = () => switchTab('vhv');

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return; 
                }
                LIFF_PROFILE = await liff.getProfile();
                
                // Fetch Data
                const ref = new URLSearchParams(location.search).get('ref') || '';
                const url = `${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}&ref=${ref}`;
                
                const res = await fetch(url).then(r => r.json());
                if(res.error) throw new Error(res.error);
                
                ALL_DATA = res;
                renderHealth();
                renderVhv();
                
            } catch(e) { 
                console.error(e);
                document.getElementById('health-content').innerHTML = `<div class="alert alert-danger m-3">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>`;
            }
        };

        function switchTab(mode) {
            const isVhv = mode === 'vhv';
            document.body.className = isVhv ? 'vhv-mode' : '';
            
            document.getElementById('health-tab-btn').className = `nav-link ${!isVhv?'active':''}`;
            document.getElementById('vhv-tab-btn').className = `nav-link ${isVhv?'active':''}`;
            
            document.getElementById('health-view').style.display = !isVhv ? 'block' : 'none';
            document.getElementById('vhv-view').style.display = isVhv ? 'block' : 'none';
            
            window.scrollTo(0, 0);
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // --- RENDER HEALTH TAB ---
        function renderHealth() {
            const div = document.getElementById('health-content');
            if(!ALL_DATA.userProfile) {
                div.innerHTML = `
                    <div class="card p-5 text-center mt-3 mx-3">
                        <i class="bi bi-person-exclamation text-secondary" style="font-size:3rem"></i>
                        <h5 class="mt-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5>
                        <p class="text-muted small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                        <a href="${LINKS.REGIS}" class="btn btn-main mt-3 rounded-pill w-100">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
                    </div>`;
                return;
            }
            
            const p = ALL_DATA.userProfile;
            const g = ALL_DATA.gamification || {};
            const emg = g.details || {};
            const dist = ALL_DATA.homeDistance;

            div.innerHTML = `
                <!-- 1. Profile -->
                <div class="card p-3 mb-3 d-flex flex-row align-items-center shadow-sm">
                    <img src="${p.pictureUrl}" class="profile-img-lg me-3">
                    <div class="flex-grow-1">
                        <h5 class="fw-bold mb-1">${p.name}</h5>
                        <div class="text-muted small"><i class="bi bi-telephone"></i> ${p.telephone}</div>
                        <span class="badge bg-light text-dark border mt-1">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${g.rank} ‡∏à‡∏≤‡∏Å ${g.totalUsers} ‡∏Ñ‡∏ô</span>
                    </div>
                </div>

                <!-- 2. Gamification Score -->
                <div class="card game-score-card mb-3">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="m-0 text-primary fw-bold"><i class="bi bi-trophy-fill"></i> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h5>
                            <span class="badge rounded-pill bg-${g.levelColor}">${g.levelName}</span>
                        </div>
                        
                        <div class="text-center my-3">
                            <div class="display-3 fw-bold text-primary" style="line-height:1;">${g.totalScore}</div>
                            <small class="text-muted">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</small>
                        </div>
                        
                        <div class="progress mb-2 bg-white" style="height:10px; border-radius:10px;">
                            <div class="progress-bar bg-${g.levelColor}" style="width:${Math.min(100,(g.totalScore/g.nextLevelScore)*100)}%"></div>
                        </div>
                        <div class="text-end small text-secondary mb-3">‡∏≠‡∏µ‡∏Å ${(g.nextLevelScore-g.totalScore).toFixed(1)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö</div>
                        
                        <div class="row g-2 text-center">
                            <div class="col-3" onclick="window.open('${LINKS.DAILY}')">
                                <div class="game-score-box"><h3>${g.checkScore}</h3><small>‡πÉ‡∏™‡πà‡πÉ‡∏à</small></div>
                            </div>
                            <div class="col-3">
                                <div class="game-score-box"><h3>${g.emergencyScore}</h3><small>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</small></div>
                            </div>
                            <div class="col-3" onclick="window.open('${LINKS.STICKER}')">
                                <div class="game-score-box"><h3>${g.stickerScore}</h3><small>‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠</small></div>
                            </div>
                            <div class="col-3" onclick="window.open('${LINKS.KNOWLEDGE}')">
                                <div class="game-score-box"><h3>${g.knowledgeScore}</h3><small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</small></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Risk Assessment -->
                ${buildRiskCard(p)}

                <!-- 4. Emergency Info -->
                <div class="card mb-3 border-danger shadow-sm">
                    <div class="card-body">
                        <h5 class="text-danger fw-bold section-title"><i class="bi bi-ambulance"></i> ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏£‡∏û.‡∏™‡∏ß‡∏µ)</h5>
                        
                        <div class="d-flex align-items-center justify-content-center my-3 text-danger">
                            <i class="bi bi-house-door-fill emergency-graphic"></i> 
                            <div class="text-center">
                                <i class="bi bi-arrow-right fs-1"></i><br>
                                <small class="fw-bold">${dist ? dist.distance_km : '?'} ‡∏Å‡∏°.</small>
                            </div> 
                            <i class="bi bi-hospital-fill emergency-graphic"></i>
                        </div>
                        
                        ${(dist && dist.distance_km > 40) ? '<div class="alert alert-warning small p-2 text-center rounded-3"><i class="bi bi-exclamation-triangle"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏Å‡∏°. ‡∏Ñ‡∏ß‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡∏£‡∏û. ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</div>' : ''}
                        
                        <div class="bg-light p-3 rounded-3 mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-secondary small">‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•:</span>
                                <span class="fw-bold">${emg.help || '-'}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-secondary small">‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à:</span>
                                <span class="fw-bold">${emg.decision || '-'}</span>
                            </div>
                            <div class="d-grid mt-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="openEditEmg('${emg.help}','${emg.decision}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-danger w-100 rounded-pill" onclick="pinMyHome()">
                            <i class="bi bi-geo-alt-fill"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                        </button>
                    </div>
                </div>

                <!-- 5. Community Leaders -->
                ${buildLeaders(ALL_DATA.communityLeaders)}
            `;
        }

        // --- RENDER VHV TAB ---
        function renderVhv() {
            const div = document.getElementById('vhv-content');
            if(!ALL_DATA.isVhv) {
                div.innerHTML = `
                    <div class="card p-5 text-center mt-3 mx-3 bg-gold-light border-warning">
                        <i class="bi bi-award text-warning" style="font-size:3rem"></i>
                        <h5 class="mt-3 text-gold-dark">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h5>
                        <p class="text-muted small">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡∏≠‡∏™‡∏°.</p>
                    </div>`;
                return;
            }

            const v = ALL_DATA.vhvDashboard;
            const sc = v.vhvScore || {total:0, breakdown:{}};
            const pts = v.patientList || [];

            div.innerHTML = `
                <!-- Card 1: VHV Profile -->
                <div class="card p-3 mb-3 shadow-sm" style="background: #FFF8E1; border: 1px solid #FFD700;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="text-gold-dark mb-0 fw-bold">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏≠‡∏™‡∏°. ${ALL_DATA.vhvProfile.name}</h5>
                        <span class="badge bg-warning text-dark border border-dark">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${ALL_DATA.vhvProfile.area}</span>
                    </div>
                    <hr style="border-color:#D4AF37; opacity:0.3">
                    
                    ${!v.checklist.hasPinned ? 
                        '<div class="alert alert-danger p-2 text-center small mb-2"><i class="bi bi-geo-alt"></i> ‡∏ó‡πà‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</div>' : ''}
                    
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-dark w-100 btn-sm" onclick="pinMyHome()">
                                <i class="bi bi-geo-alt"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary w-100 btn-sm" onclick="showQR()">
                                <i class="bi bi-qr-code"></i> QR Code
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Score Dashboard -->
                <div class="card p-3 mb-3 text-center">
                    <h5 class="text-gold-dark fw-bold mb-0">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏≠‡∏™‡∏°.</h5>
                    <div class="display-1 fw-bold" style="color: #B8860B; text-shadow: 1px 1px 0px #fff;">${sc.total}</div>
                    
                    <div class="row g-2 mt-2 small">
                        <div class="col-3 text-muted border-end">QR<br><b class="text-dark fs-5">${sc.breakdown.qr}</b><br><span style="font-size:0.6rem">30 ‡∏ß‡∏±‡∏ô</span></div>
                        <div class="col-3 text-muted border-end">Sticker<br><b class="text-dark fs-5">${sc.breakdown.sticker}</b><br><span style="font-size:0.6rem">30 ‡∏ß‡∏±‡∏ô</span></div>
                        <div class="col-3 text-muted border-end">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°<br><b class="text-dark fs-5">${sc.breakdown.action}</b><br><span style="font-size:0.6rem">‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û</span></div>
                        <div class="col-3 text-muted">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô<br><b class="text-dark fs-5">${sc.breakdown.reports}</b><br><span style="font-size:0.6rem">30 ‡∏ß‡∏±‡∏ô</span></div>
                    </div>
                </div>

                <!-- Card 3: Leaderboard -->
                <div class="mb-3">
                    <h5 class="text-gold-dark fw-bold px-2"><i class="bi bi-bar-chart-fill"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‡∏≠‡∏™‡∏°. ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h5>
                    ${buildVhvLeaderboards(v.leaderboards)}
                </div>

                <!-- Card 4: Patient List -->
                <div class="card mb-3">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-people-fill"></i> ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï (${pts.length})</span>
                        <a href="${LINKS.REGIS}" class="btn btn-sm btn-success rounded-pill px-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå</a>
                    </div>
                    
                    <div class="list-group list-group-flush p-2">
                        ${pts.length === 0 ? '<div class="text-center p-4 text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï</div>' : 
                          pts.map(p => `
                            <div class="list-group-item vhv-patient-item vhv-risk-${getRiskLevel(p.thai_cv_risk_score)}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold fs-6">${p.name} <span class="badge bg-secondary rounded-pill">${p.thai_cv_risk_score}%</span></div>
                                        <div class="text-muted small mt-1">
                                            <i class="bi bi-geo"></i> ‡∏´‡πà‡∏≤‡∏á ${p.distanceFromVhv_km} ‡∏Å‡∏°. <br>
                                            <i class="bi bi-clock-history"></i> ‡πÄ‡∏ä‡πá‡∏Ñ: ${p.daysSinceLastCheck} ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                                        </div>
                                    </div>
                                    <div class="d-flex flex-column gap-2 ms-2">
                                        <button class="btn btn-circle btn-success btn-sm shadow-sm" onclick="call('${p.telephone}')">
                                            <i class="bi bi-telephone-fill"></i>
                                        </button>
                                        <button class="btn btn-circle btn-warning btn-sm shadow-sm text-dark" onclick="visit('${p.userId}', '${p.name}')">
                                            <i class="bi bi-geo-alt-fill"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // --- HELPER FUNCTIONS ---
        function getRiskLevel(score) {
            if(!score) return 1;
            if(score >= 30) return 5;
            if(score >= 20) return 4;
            if(score >= 10) return 3;
            return 1;
        }

        function buildRiskCard(p) {
             const score = parseFloat(p.thai_cv_risk_score||0).toFixed(0);
             let color = '#28a745'; 
             let label = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥';
             if(score>=10) { color='#ffc107'; label='‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'; }
             if(score>=20) { color='#fd7e14'; label='‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á'; }
             if(score>=30) { color='#dc3545'; label='‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢'; }
             
             const items = [
                {l:'‡πÄ‡∏û‡∏®', v:p.gender==1?'‡∏ä‡∏≤‡∏¢':'‡∏´‡∏ç‡∏¥‡∏á', i:'bi-gender-ambiguous'}, {l:'‡∏≠‡∏≤‡∏¢‡∏∏', v:p.age, i:'bi-calendar'},
                {l:'‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', v:p.smoke==1?'‡∏™‡∏π‡∏ö':'‡πÑ‡∏°‡πà', i:'bi-fire'}, {l:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', v:p.dm==1?'‡πÄ‡∏õ‡πá‡∏ô':'‡πÑ‡∏°‡πà', i:'bi-droplet'},
                {l:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', v:p.sbp||'-', i:'bi-speedometer'}, {l:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', v:p.cholesterol||'-', i:'bi-heart'},
                {l:'‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', v:p.waist||'-', i:'bi-arrows-expand'}, {l:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', v:p.height||'-', i:'bi-rulers'}
             ].map(x=>`
                <div class="info-item">
                    <i class="bi ${x.i}"></i>
                    <div>
                        <small>${x.l}</small>
                        <b class="text-dark">${x.v}</b>
                    </div>
                </div>`).join('');
                
             return `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="section-title mb-0"><i class="bi bi-activity"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h5>
                        <div class="text-center my-4 position-relative">
                            <div style="font-size:3.5rem; font-weight:900; color:${color}; line-height:1;">${score}%</div>
                            <div style="color:${color}; font-weight:bold;">${label} (10 ‡∏õ‡∏µ)</div>
                            ${p['u/d'] ? `<span class="badge bg-danger mt-2">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${p['u/d']}</span>` : ''}
                        </div>
                        <div class="info-grid">${items}</div>
                        <a href="${LINKS.REGIS}" class="btn btn-outline-danger w-100 rounded-pill mt-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</a>
                    </div>
                </div>`;
        }

        function buildLeaders(l) {
            if(!l) return '';
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="section-title"><i class="bi bi-people-fill"></i> ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h5>
                        <ul class="list-group list-group-flush">
                            ${l.pcu ? `<li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="bi bi-hospital text-primary me-2"></i> ${l.pcu}</span> 
                                <button class="btn btn-circle btn-outline-primary btn-sm" onclick="call('${l.pcu_tel}')"><i class="bi bi-telephone-fill"></i></button>
                            </li>`:''}
                            ${l.headman ? `<li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="bi bi-person-badge text-dark me-2"></i> ${l.headman}</span> 
                                <button class="btn btn-circle btn-outline-dark btn-sm" onclick="call('${l.headman_tel}')"><i class="bi bi-telephone-fill"></i></button>
                            </li>`:''}
                            <li class="list-group-item bg-light text-center small rounded mt-2 py-1 text-muted">‡∏°‡∏µ ‡∏≠‡∏™‡∏°. ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ${l.vhvCount} ‡∏Ñ‡∏ô</li>
                        </ul>
                    </div>
                </div>`;
        }
        
        function buildVhvLeaderboards(lb) {
            if(!lb || lb.length === 0) return '<div class="text-center text-muted small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            // Show Top 3 as Cards, Rest as list? Or simple horizontal scroll
            let html = '<div class="d-flex gap-2 overflow-auto pb-2" style="white-space:nowrap;">';
            lb.forEach((u, idx) => {
                let badge = idx < 3 ? ['ü•á','ü•à','ü•â'][idx] : `#${idx+1}`;
                let border = idx === 0 ? 'border-warning' : '';
                html += `
                    <div class="card d-inline-block text-center p-2 shadow-sm ${border}" style="min-width:100px; width:100px;">
                        <div class="fs-4">${badge}</div>
                        <div class="text-truncate fw-bold small" style="max-width:90px;">${u.name}</div>
                        <span class="badge bg-success rounded-pill">${u.score}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // --- ACTIONS ---
        function openEditEmg(h, d) {
            document.getElementById('inpHelp').value = h && h !== '-' ? h : '‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
            document.getElementById('inpDec').value = d && d !== '-' ? d : '‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£';
            MODALS['editEmgModal'].show();
        }

        function saveEmg() {
            const h = document.getElementById('inpHelp').value;
            const d = document.getElementById('inpDec').value;
            toggleLoading(true);
            fetch(WEB_APP_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ 
                    action: 'updateEmergencyInfo', 
                    data: { userId: LIFF_PROFILE.userId, help: h, decision: d }
                }) 
            }).then(() => {
                setTimeout(() => location.reload(), 1500); // Give time for GAS
            });
        }

        function call(tel) {
            if(!tel || tel.length < 3) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");
            CALL_TARGET = tel.replace(/'/g, '');
            MODALS['callModal'].show();
        }

        function execCall() {
             navigator.geolocation.getCurrentPosition(pos => {
                 const latlong = `${pos.coords.latitude},${pos.coords.longitude}`;
                 fetch(WEB_APP_URL, { 
                     method: 'POST', 
                     mode: 'no-cors', 
                     body: JSON.stringify({ 
                         action: 'logTelCall', 
                         data: { userId: LIFF_PROFILE.userId, tel: CALL_TARGET, latlong: latlong }
                     }) 
                 });
                 window.location.href = `tel:${CALL_TARGET}`;
             }, () => {
                 window.location.href = `tel:${CALL_TARGET}`;
             });
        }
        
        function pinMyHome() {
             toggleLoading(true);
             navigator.geolocation.getCurrentPosition(p => {
                 fetch(WEB_APP_URL, { 
                     method: 'POST', 
                     mode: 'no-cors', 
                     body: JSON.stringify({ 
                         action: 'saveNewLocation', 
                         data: { 
                             userId: LIFF_PROFILE.userId, 
                             type: '‡∏ö‡πâ‡∏≤‡∏ô', 
                             latlong: `${p.coords.latitude},${p.coords.longitude}`, 
                             distance: 0, 
                             duration: 0 
                         } 
                     }) 
                 }).then(() => {
                     alert("‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                     location.reload();
                 });
             }, e => { 
                 alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"); 
                 toggleLoading(false); 
             });
        }
        
        function pinForUser() {
             const uid = document.getElementById('visitUid').value;
             if(!uid) return;
             if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì?")) return;
             
             toggleLoading(true);
             navigator.geolocation.getCurrentPosition(p => {
                 fetch(WEB_APP_URL, { 
                     method: 'POST', 
                     mode: 'no-cors', 
                     body: JSON.stringify({ 
                         action: 'saveNewLocation', 
                         data: { 
                             userId: uid, 
                             type: '‡∏ö‡πâ‡∏≤‡∏ô_‡πÇ‡∏î‡∏¢_‡∏≠‡∏™‡∏°', 
                             recorderId: LIFF_PROFILE.userId,
                             latlong: `${p.coords.latitude},${p.coords.longitude}`, 
                             distance: 0, 
                             duration: 0 
                         } 
                     }) 
                 }).then(() => {
                     alert("‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                     toggleLoading(false);
                 });
             });
        }

        function showQR() {
             const url = `https://liff.line.me/2005789397-nebQ8oJy?ref=${LIFF_PROFILE.userId}`;
             const api = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;
             document.getElementById('qrImg').src = api;
             document.getElementById('refCodeDisplay').innerText = LIFF_PROFILE.userId.substring(0,8) + "...";
             
             // Log Share
             fetch(`${WEB_APP_URL}?action=logQrShare&userId=${LIFF_PROFILE.userId}`);
             MODALS['qrModal'].show();
        }
        
        function visit(uid, name) {
             document.getElementById('visitUid').value = uid;
             document.getElementById('visitName').value = name;
             document.getElementById('visitTitle').innerHTML = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: <span class="text-primary">${name}</span>`;
             document.getElementById('visitNote').value = '';
             MODALS['visitModal'].show();
        }
        
        function saveVisit() {
             const note = document.getElementById('visitNote').value;
             const act = [];
             if(document.getElementById('chk1').checked) act.push('5Signs');
             if(document.getElementById('chk2').checked) act.push('Advice');
             if(document.getElementById('chk3').checked) act.push('ADL');
             
             const d = { 
                 vhvId: LIFF_PROFILE.userId, 
                 patientName: document.getElementById('visitName').value, 
                 activityType: act.join(','), 
                 note: note 
             };
             
             toggleLoading(true);
             fetch(WEB_APP_URL, { 
                 method: 'POST', 
                 mode: 'no-cors', 
                 body: JSON.stringify({ action: 'saveHomeVisit', data: d }) 
             }).then(() => { 
                 MODALS['visitModal'].hide();
                 toggleLoading(false);
                 alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); 
             });
        }
    </script>
</body>
</html>