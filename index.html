<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สวีรู้ทันสโตรก</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root {
            --theme-red: #d32f2f; 
            --theme-red-soft: #ffebee;
            --theme-gold: #876029;   
            --theme-gold-text: #eae2cd; 
            --bg-card: #fffbf0;
            --border-gold: #f2e6d0;
            --base-font: 18px; /* Reduced slightly for compactness */
            --border-radius: 20px;
        }
        
        html { font-size: var(--base-font); }
        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            background: linear-gradient(180deg, var(--theme-red) 0%, #ffffff 350px);
            margin: 0; padding-bottom: 50px; 
            color: #333; transition: background 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        body.vhv-mode { background: linear-gradient(180deg, var(--theme-gold) 0%, #ffffff 350px); }
        
        h1, h2, h3, h4, h5, h6 { font-weight: 700 !important; margin-bottom: 0.3rem; }

        /* TABS COMPACT */
        .nav-tabs-container { position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; height: 45px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-item { width: 50%; }
        .nav-link { 
            width: 100%; height: 100%; border: none; border-radius: 0; 
            font-weight: 700; font-size: 1rem; 
            display: flex; align-items: center; justify-content: center; 
            color: #aaa; background: #fff; transition: 0.2s; cursor: pointer;
        }
        /* Active States */
        #tab-health.active { background-color: var(--theme-red); color: white; }
        #tab-vhv.active { background-color: var(--theme-gold); color: var(--theme-gold-text); }
        
        .app-header-spacer { height: 55px; }
        .content-area { padding: 0 10px; }

        /* COMPACT CARDS */
        .card-box { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-gold); 
            border-radius: var(--border-radius); 
            padding: 12px; margin-bottom: 10px; /* Reduced margin */
            box-shadow: 0 2px 6px rgba(0,0,0,0.03); 
            position: relative;
        }
        .card-title { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #444; }
        .card-title i { font-size: 1.3rem; }

        /* COLORS */
        .text-gold { color: var(--theme-gold) !important; }
        .bg-gold-soft { background-color: #fff8e1; }

        /* BUTTONS */
        .btn-pill { border-radius: 50px; font-weight: 600; padding: 6px 15px; font-size: 0.9rem; }
        .btn-red { background: var(--theme-red); color: white; border: none; }
        .btn-gold { background: var(--theme-gold); color: var(--theme-gold-text); border: none; }
        .btn-outline { border: 1px solid #ddd; background: white; color: #555; }
        
        /* ICONS CIRCLE */
        .icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: white; border: 1px solid #eee; margin: 0 auto 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* PROFILE */
        .profile-pic { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .badge-regis { font-size: 0.75rem; background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 8px; color: #666; display: inline-block; }
        .badge-area { background-color: var(--theme-gold); color: white; border-radius: 15px; padding: 3px 10px; font-size: 0.8rem; }

        /* SCORE CARD */
        .level-bar { height: 20px; background: #e9ecef; border-radius: 10px; position: relative; margin: 10px 0; overflow: hidden; display: flex; }
        .level-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: white; font-weight: bold; text-shadow: 0 0 2px rgba(0,0,0,0.5); opacity: 0.3; transition: 0.3s; }
        .level-segment.active { opacity: 1; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .score-box { text-align: center; cursor: pointer; transition: 0.2s; padding: 5px; border-radius: 10px; }
        .score-box:active { background: rgba(0,0,0,0.05); transform: scale(0.98); }
        .score-val { font-weight: 900; font-size: 1.1rem; line-height: 1.2; }

        /* RISK CARD */
        .risk-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .risk-item { background: white; padding: 6px 10px; border-radius: 8px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-size: 0.85rem; color: #555; }
        .risk-item i { margin-right: 5px; color: #888; }

        /* HOSPITAL FLOW */
        .hospital-flow { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; padding: 0 10px; }
        .arrow-line { flex-grow: 1; height: 2px; background: #ddd; margin: 0 10px; position: relative; display: flex; align-items: center; justify-content: center; }
        .arrow-line::after { content: '>'; position: absolute; right: -5px; top: -11px; font-size: 16px; color: #999; font-weight: bold; }
        .dist-tag { background: #333; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; position: relative; top: -10px; }

        /* HELPER */
        .scan-anim { animation: pulseScan 2s infinite; color: var(--theme-gold); }
        @keyframes pulseScan { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.5; transform: scale(1); } }

        /* VHV SPECIFIC */
        .vhv-stat-box { background: white; border: 1px solid #eee; border-radius: 8px; padding: 5px; text-align: center; height: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .vhv-rank-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .rank-badge { width: 20px; height: 20px; background: #ccc; color: white; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        .rank-1 { background: #FFD700; } .rank-2 { background: #C0C0C0; } .rank-3 { background: #CD7F32; }
        
        .patient-row { display: flex; align-items: center; background: white; padding: 8px; border-radius: 10px; margin-bottom: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-left: 5px solid #ccc; position: relative; }
        .risk-danger { border-color: #dc3545; background: #fff5f5; }
        .risk-high { border-color: #fd7e14; }
        .risk-med { border-color: #ffc107; }
        .risk-low { border-color: #28a745; }
        .dist-badge { position: absolute; top: 8px; right: 8px; font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; }

        .footer { text-align: center; font-size: 0.7rem; color: #bbb; margin-top: 20px; margin-bottom: 0; }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#333; }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
    <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;"></div>
    <div class="fs-6 text-muted">กำลังโหลดข้อมูล...</div>
</div>

<!-- TABS -->
<div class="nav-tabs-container">
    <div class="nav-item"><div id="tab-health" class="nav-link active" onclick="setTab('health')">ข้อมูลสุขภาพ</div></div>
    <div class="nav-item"><div id="tab-vhv" class="nav-link" onclick="setTab('vhv')">สำหรับ อสม.</div></div>
</div>
<div class="app-header-spacer"></div>

<div class="content-area">

    <!-- HEALTH TAB -->
    <div id="view-health">
        
        <!-- 1. User Profile -->
        <div id="card-profile" class="card-box" style="margin-top: 10px;">
            <div class="text-center py-3"><div class="spinner-border spinner-border-sm text-secondary"></div></div>
        </div>

        <!-- 2. Awareness Score -->
        <div id="card-score" class="card-box"></div>

        <!-- 3. Risk Assessment -->
        <div id="card-risk"></div>

        <!-- 4. Hospital Prep -->
        <div id="card-hospital"></div>

        <!-- 5. Helper -->
        <div id="card-helper"></div>

        <!-- 6. Sticker -->
        <div id="card-sticker"></div>

        <!-- 7. Knowledge -->
        <div id="card-knowledge"></div>

    </div>

    <!-- VHV TAB -->
    <div id="view-vhv" style="display:none;">
        
        <!-- VHV Profile -->
        <div id="vhv-profile" class="card-box" style="margin-top: 10px; background-color: #fffbf0;"></div>
        
        <!-- VHV Performance -->
        <div id="vhv-perf" class="card-box"></div>
        
        <!-- VHV Leaderboard -->
        <div id="vhv-leader" class="card-box" style="max-height: 250px; overflow-y: auto;"></div>
        
        <!-- Patient List -->
        <div id="vhv-patients" class="card-box">
            <h5 class="card-title text-gold mb-3"><i class="bi bi-geo-alt-fill"></i> เยี่ยมบ้านปักหมุด</h5>
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-success btn-pill w-50" onclick="MODALS['modalQR'].show()"><i class="bi bi-qr-code"></i> ชาวบ้านมีไลน์</button>
                <button class="btn btn-outline btn-pill w-50" onclick="shareNoLine()"><i class="bi bi-link"></i> ชาวบ้านไม่มีไลน์</button>
            </div>
            <div id="patient-list-container" class="mt-2">
                <div class="text-center py-3 text-muted small">กำลังค้นหาลูกบ้าน...</div>
            </div>
        </div>

    </div>

    <div class="footer">จัดทำโดย สวีรู้ทันสโตรก รพ.สวี จ.ชุมพร</div>
</div>

<!-- MODALS -->

<!-- 1. Edit User Emergency -->
<div class="modal fade" id="modalEditEmg" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold">แก้ไขข้อมูลฉุกเฉิน</h6></div><div class="modal-body pt-2">
    <div class="mb-2"><label class="small text-muted">คนดูแลที่บ้าน</label><select class="form-select form-select-sm" id="inpHelp"><option>อยู่ตัวคนเดียว</option><option>อยู่กับผู้สูงอายุ/เด็กเล็ก</option><option>อยู่กับญาติผู้ใหญ่/คนวัยทำงาน</option></select></div>
    <div class="mb-3"><label class="small text-muted">การตัดสินใจ</label><select class="form-select form-select-sm" id="inpDec"><option>รอดูอาการ</option><option>โทรให้ญาติมาดู</option><option>ไปคลินิก-อนามัย</option><option>รีบไป รพ.เอง</option><option>โทร 1669 ให้รถมารับ</option></select></div>
    <button class="btn btn-red btn-pill w-100" onclick="saveEmg()">บันทึกข้อมูล</button>
</div></div></div></div>

<!-- 2. Edit VHV Profile -->
<div class="modal fade" id="modalEditVhv" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0"><div class="modal-header border-0 pb-0"><h6 class="modal-title fw-bold text-gold">แก้ไขข้อมูล อสม.</h6></div><div class="modal-body pt-2">
    <div class="mb-2"><label class="small">ชื่อ-สกุล</label><input type="text" class="form-control form-control-sm" id="vhvName"></div>
    <div class="mb-2"><label class="small">เบอร์โทร</label><input type="text" class="form-control form-control-sm" id="vhvPhone"></div>
    <div class="row g-2 mb-3">
        <div class="col-6">
            <label class="small">ตำบล</label>
            <select id="vhvDistrict" class="form-select form-select-sm">
                <option value="">เลือก</option>
                <option>ท่าหิน</option><option>ด่านสวี</option><option>เขาทะลุ</option>
                <option>เขาค่าย</option><option>ปากแพรก</option><option>สวี</option>
                <option>นาสัก</option><option>ทุ่งระยะ</option><option>วิสัยใต้</option>
                <option>ครน</option><option>นาโพธิ์</option>
            </select>
        </div>
        <div class="col-6">
            <label class="small">หมู่ที่</label>
            <select id="vhvVillage" class="form-select form-select-sm"></select>
        </div>
    </div>
    <button class="btn btn-gold btn-pill w-100" onclick="saveVhvProfile()">บันทึก</button>
</div></div></div></div>

<!-- 3. Consent Call -->
<div class="modal fade" id="modalCall" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 text-center p-4 border-0">
    <i class="bi bi-shield-lock-fill text-secondary display-4 mb-2"></i>
    <h5 class="fw-bold">ขออนุญาตโทรออก</h5>
    <p class="text-muted small mb-3">ระบบจะบันทึกประวัติการโทรเพื่อเป็นข้อมูลการช่วยเหลือ (PDPA)</p>
    <div class="d-grid gap-2"><button class="btn btn-success btn-pill" onclick="execCall()">ยินยอมและโทรออก</button><button class="btn btn-outline btn-pill" data-bs-dismiss="modal">ยกเลิก</button></div>
</div></div></div>

<!-- 4. Pin Home Alert -->
<div class="modal fade" id="modalPin" data-bs-backdrop="static" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 text-center p-4 border-0">
    <i class="bi bi-geo-alt-fill text-danger display-4 mb-2"></i>
    <h5 class="fw-bold">กรุณาปักหมุดบ้าน</h5>
    <p class="text-muted small mb-3">เพื่อความแม่นยำในการคำนวณระยะทาง</p>
    <div class="d-grid gap-2"><button class="btn btn-red btn-pill" onclick="pinHome(false)">ปักหมุดเลย</button><button class="btn btn-outline btn-pill" data-bs-dismiss="modal">ยังไม่ได้อยู่บ้าน</button></div>
</div></div></div>

<!-- 5. QR Code -->
<div class="modal fade" id="modalQR" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content bg-dark text-white text-center justify-content-center">
    <button class="btn-close btn-close-white position-absolute top-0 end-0 m-4" data-bs-dismiss="modal"></button>
    <h3 class="text-warning mb-4">ชาวบ้านมีไลน์</h3>
    <div class="bg-white p-3 rounded-4 d-inline-block"><img id="qrImg" src="https://qr-official.line.me/gs/M/2005789397_nebQ8oJy_GW.png" style="width:250px;"></div>
    <p class="mt-4 text-white-50">สแกนเพื่อเพิ่มเพื่อน</p>
</div></div></div>

<!-- 6. Info Score -->
<div class="modal fade" id="modalInfo" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 rounded-4 border-0">
    <h6 class="fw-bold mb-3">วิธีคิดคะแนน อสม.</h6>
    <ul class="small text-muted ps-3 mb-0">
        <li class="mb-1">บอกต่อ (แชร์ QR) = 10 คะแนน</li>
        <li class="mb-1">แชร์สติกเกอร์ = 1 คะแนน</li>
        <li class="mb-1">เยี่ยมบ้าน = 5 คะแนน</li>
        <li class="mb-1">รายงานเคส = 50 คะแนน</li>
    </ul>
    <button class="btn btn-outline w-100 btn-sm mt-3 rounded-pill" data-bs-dismiss="modal">ปิด</button>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    // Config
    const API_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec'; 
    const LIFF_ID = '2005789397-RLAGXrBJ';
    const LINKS = { 
        REGIS: 'https://liff.line.me/2005789397-nebQ8oJy', 
        STICKER: 'https://liff.line.me/2005789397-37lemBgX', 
        KNOWLEDGE: 'https://liff.line.me/2005789397-ROQvjpYk' 
    };
    
    let PROFILE={}, DATA={}, TARGET_TEL='', MODALS={};

    // Init Village Options
    const vSel = document.getElementById('vhvVillage');
    for(let i=1; i<=20; i++) vSel.add(new Option(i, i));

    window.onload = async () => {
        // Init Modals
        ['modalEditEmg','modalEditVhv','modalCall','modalPin','modalQR','modalInfo'].forEach(i=>MODALS[i]=new bootstrap.Modal(document.getElementById(i)));
        
        try {
            await liff.init({liffId:LIFF_ID});
            if(!liff.isLoggedIn()){ liff.login(); return; }
            PROFILE = await liff.getProfile();
            
            // Generate QR Image with Ref
            document.getElementById('qrImg').src = `https://qr-official.line.me/gs/M/2005789397_nebQ8oJy_GW.png?ref=${PROFILE.userId}`;

            const p = new URLSearchParams(location.search);
            fetchData(p.get('ref'));

        } catch(e){ alert("Init Err: "+e); document.getElementById('loader').style.display='none'; }
    };

    async function fetchData(ref) {
        try {
            const res = await fetch(`${API_URL}?action=getAllData&userId=${PROFILE.userId}&ref=${ref||''}`);
            DATA = await res.json();
            
            renderHealthTab();
            if(DATA.isVhv) {
                renderVhvTab();
            } else {
                // If not VHV, hide tab or keep disabled logic? User asked for tabs.
                // We keep tabs but maybe VHV tab is empty or shows register link.
            }
            
            // Check Pin for Normal User
            if(!DATA.isVhv && (!DATA.homeDistance || DATA.homeDistance.km === '?')) MODALS['modalPin'].show();

            document.getElementById('loader').style.display='none';
        } catch(e) { console.error(e); alert('โหลดข้อมูลล้มเหลว'); document.getElementById('loader').style.display='none'; }
    }

    function setTab(t) {
        document.getElementById('view-health').style.display = t==='health'?'block':'none';
        document.getElementById('view-vhv').style.display = t==='vhv'?'block':'none';
        document.getElementById('tab-health').className = `nav-link ${t==='health'?'active':''}`;
        document.getElementById('tab-vhv').className = `nav-link ${t==='vhv'?'active':''}`;
        
        document.body.className = t==='vhv' ? 'vhv-mode' : '';
        window.scrollTo(0,0);
    }

    // --- HEALTH RENDER ---
    function renderHealthTab() {
        const p = DATA.userProfile;
        const g = DATA.gamification || {};

        // 1. Profile
        let profileHtml = `<div class="text-center py-3"><p>ไม่พบข้อมูล</p><a href="${LINKS.REGIS}" class="btn btn-red btn-pill">ลงทะเบียน</a></div>`;
        if(p && p.name !== 'Guest') {
            profileHtml = `
            <div class="d-flex align-items-center">
                <img src="${PROFILE.pictureUrl}" class="profile-pic me-3">
                <div class="flex-grow-1">
                    <h5 class="fw-bold mb-1">${p.name}</h5>
                    <div class="badge-regis mb-1"><i class="bi bi-calendar"></i> ลงทะเบียน: ${p.regisDate}</div>
                    <div><a href="${LINKS.REGIS}" class="text-decoration-none small text-danger"><i class="bi bi-pencil-square"></i> แก้ไขข้อมูลส่วนตัว</a></div>
                </div>
            </div>`;
        }
        document.getElementById('card-profile').innerHTML = profileHtml;

        // 2. Score
        const lv = g.level || 'อนุบาลสโตรก';
        const lvClass = (lv.includes('ปริญญา')) ? 3 : (lv.includes('มัธยม')) ? 2 : 1;
        document.getElementById('card-score').innerHTML = `
            <div class="d-flex justify-content-between mb-2"><h5 class="card-title m-0 text-danger"><i class="bi bi-trophy-fill"></i> คะแนนตระหนักรู้</h5><div class="fw-bold text-danger fs-5">${g.total||0} คะแนน</div></div>
            <div class="level-bar">
                <div class="level-segment ${lvClass>=1?'active':''}" style="width:33%; background:#28a745;">ประถม</div>
                <div class="level-segment ${lvClass>=2?'active':''}" style="width:33%; background:#0d6efd;">มัธยม</div>
                <div class="level-segment ${lvClass>=3?'active':''}" style="width:34%; background:#0dcaf0;">ปริญญา</div>
            </div>
            <div class="d-flex justify-content-between text-muted small mb-3"><span>Level: ${lv}</span><span>(เต็ม 100+)</span></div>
            <div class="row text-center g-1">
                <div class="col-3 score-box" onclick="scroll2('card-risk')"><div class="icon-circle text-danger"><i class="bi bi-heart-pulse"></i></div><div class="score-val">${g.check||0}</div><small class="text-muted" style="font-size:0.7rem">ใส่ใจ</small></div>
                <div class="col-3 score-box" onclick="scroll2('card-hospital')"><div class="icon-circle text-primary"><i class="bi bi-backpack"></i></div><div class="score-val">${g.prep||0}</div><small class="text-muted" style="font-size:0.7rem">เตรียม</small></div>
                <div class="col-3 score-box" onclick="scroll2('card-sticker')"><div class="icon-circle text-success"><i class="bi bi-share"></i></div><div class="score-val">${g.sticker||0}</div><small class="text-muted" style="font-size:0.7rem">บอกต่อ</small></div>
                <div class="col-3 score-box" onclick="scroll2('card-knowledge')"><div class="icon-circle text-warning"><i class="bi bi-book"></i></div><div class="score-val">${g.know||0}</div><small class="text-muted" style="font-size:0.7rem">ความรู้</small></div>
            </div>`;

        // 3. Risk
        renderRiskCard(p, DATA.assessmentCount);

        // 4. Hospital
        renderHospitalCard(DATA.homeDistance, DATA.emergencyInfo);

        // 5. Helper
        renderHelperCard(DATA.communityLeaders);

        // 6. Sticker
        document.getElementById('card-sticker').innerHTML=`<div class="card-box text-center"><h5 class="card-title justify-content-center mb-2"><i class="bi bi-line text-success"></i> แชร์สติกเกอร์ไลน์</h5><div class="display-6 fw-bold text-success mb-2">${DATA.stickerCount||0} ครั้ง</div><a href="${LINKS.STICKER}" class="btn btn-success btn-pill w-100">แชร์สติกเกอร์ใหม่</a></div>`;

        // 7. Knowledge
        const k = DATA.knowledgeData || {pre:'-', post:'-', review:0, total:0};
        document.getElementById('card-knowledge').innerHTML=`<div class="card-box"><h5 class="card-title text-warning"><i class="bi bi-journal-text"></i> ประวัติการเรียนรู้</h5><div class="row text-center my-2 border rounded mx-0 py-2 bg-white"><div class="col-4 border-end"><small class="text-muted d-block">ก่อนเรียน</small><span class="fw-bold">${k.pre}</span></div><div class="col-4 border-end"><small class="text-muted d-block">หลังเรียน</small><span class="fw-bold text-success">${k.post}</span></div><div class="col-4"><small class="text-muted d-block">ทบทวน</small><span class="fw-bold text-warning">${k.review}</span></div></div><div class="text-center mb-2 small text-muted">คะแนนรวมสูงสุด (เต็ม 40): <span class="fw-bold text-dark fs-6">${k.total}</span></div><a href="${LINKS.KNOWLEDGE}" class="btn btn-outline btn-pill w-100 btn-sm">ทบทวนบทเรียน</a></div>`;
    }

    function renderRiskCard(p, count) {
        if(!p || !p.thai_cv_risk_score) {
            document.getElementById('card-risk').innerHTML = `<div class="card-box"><h5 class="card-title"><i class="bi bi-activity text-danger"></i> ความเสี่ยงสโตรก</h5><div class="text-center text-muted py-3">ยังไม่มีประวัติการประเมิน</div><a href="${LINKS.REGIS}" class="btn btn-red btn-pill w-100">ประเมินความเสี่ยง</a></div>`;
            return;
        }
        
        let s = parseFloat(p.thai_cv_risk_score);
        let color = '#28a745', text = 'เสี่ยงต่ำ';
        if(s>=10){ color='#ffc107'; text='ปานกลาง'; }
        if(s>=20){ color='#fd7e14'; text='สูง'; }
        if(s>=30){ color='#dc3545'; text='อันตราย'; }

        const items = [
            {i:'bi-gender-ambiguous', v: p.gender==1?'ชาย':'หญิง'},
            {i:'bi-calendar', v: p.age+' ปี'},
            {i:'bi-fire', v: p.smoke=='1'?'สูบ':'ไม่สูบ'},
            {i:'bi-droplet', v: p.dm=='1'?'เบาหวาน':'ไม่เป็น'},
            {i:'bi-speedometer2', v: (p.sbp||'-')+' mmHg'},
            {i:'bi-heart', v: (p.cholesterol||'-')+' mg'},
            {i:'bi-arrows-expand', v: (p.waist||'-')+' cm'},
            {i:'bi-rulers', v: (p.height||'-')+' cm'}
        ].map(x=>`<div class="risk-item"><span><i class="bi ${x.i}"></i> ${x.v}</span></div>`).join('');

        document.getElementById('card-risk').innerHTML = `
        <div class="card-box" style="border-top: 4px solid ${color}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title m-0 text-dark"><i class="bi bi-activity" style="color:${color}"></i> ความเสี่ยง</h5>
                <span class="badge rounded-pill bg-light text-dark border">ประเมิน ${count||0} ครั้ง</span>
            </div>
            <div class="text-center mb-3">
                <div class="display-4 fw-bold" style="color:${color}; line-height:1;">${s.toFixed(1)}%</div>
                <div class="fw-bold fs-5" style="color:${color}">${text}</div>
                <div class="small text-muted mt-1">อัพเดทล่าสุด: ${p.Last_Updated||'-'}</div>
            </div>
            <div class="risk-grid mb-3">${items}</div>
            <div class="risk-item mb-2 w-100 justify-content-center bg-light"><i class="bi bi-hospital me-2"></i> โรคประจำตัว: ${p['u/d']||'-'}</div>
            <a href="${LINKS.REGIS}" class="btn btn-pill w-100 text-white" style="background:${color}">ประเมินใหม่</a>
        </div>`;
    }

    function renderHospitalCard(dist, emg) {
        const d = dist || {km:'?', time:'?'};
        const e = emg || {help:'-', decision:'-'};
        
        document.getElementById('card-hospital').innerHTML = `
        <div class="card-box">
            <h5 class="card-title"><i class="bi bi-hospital text-danger"></i> เตรียมพร้อม (รพ.สวี)</h5>
            <div class="hospital-flow">
                <div class="text-center"><i class="bi bi-person-wheelchair fs-2 text-dark"></i></div>
                <div class="arrow-line"><span class="dist-tag">${d.km} กม.</span></div>
                <div class="text-center"><i class="bi bi-hospital fs-2 text-danger"></i><div style="font-size:0.6rem">รพ.สวี</div></div>
            </div>
            <div class="text-center fw-bold mb-3">${d.time} นาที</div>
            <div class="bg-white border rounded p-2 mb-3 small">
                <div class="d-flex justify-content-between mb-1"><span>คนดูแล:</span><strong class="text-primary">${e.help}</strong></div>
                <div class="d-flex justify-content-between"><span>ตัดสินใจ:</span><strong class="text-primary">${e.decision}</strong></div>
            </div>
            <div class="row g-2">
                <div class="col-6"><button class="btn btn-outline btn-pill w-100 btn-sm" onclick="openEditEmg('${e.help}','${e.decision}')">แก้ไขข้อมูล</button></div>
                <div class="col-6"><button class="btn btn-red btn-pill w-100 btn-sm" onclick="pinHome(true)">ปักหมุดใหม่</button></div>
            </div>
        </div>`;
    }

    function renderHelperCard(l) {
        if(!l) return;
        document.getElementById('card-helper').innerHTML = `
        <div class="card-box">
            <h5 class="card-title"><i class="bi bi-people-fill text-primary"></i> บุคคลช่วยเหลือ</h5>
            <div class="d-flex align-items-center py-2 border-bottom">
                <i class="bi bi-hospital text-danger fs-3 me-3"></i>
                <div><div class="fw-bold">${l.pcu||'-'}</div><small class="text-muted">รพ.สต. ในพื้นที่</small></div>
            </div>
            <div class="d-flex align-items-center py-2 border-bottom">
                <i class="bi bi-person-badge text-dark fs-3 me-3"></i>
                <div class="flex-grow-1"><div class="fw-bold">ผู้ใหญ่บ้าน</div><small class="text-muted">${l.area||'-'}</small></div>
                <button class="btn btn-success rounded-circle btn-sm" style="width:35px;height:35px;" onclick="call('${l.headman_tel}')"><i class="bi bi-telephone-fill"></i></button>
            </div>
            <div class="d-flex align-items-center py-2">
                <div class="me-3"><i class="bi bi-qr-code-scan text-warning fs-3 scan-anim"></i></div>
                <div><div class="fw-bold">อสม. ในเขต (${l.vhvCount} ท่าน)</div><small class="text-muted">กำลังสแตนด์บาย</small></div>
            </div>
        </div>`;
    }

    // --- VHV RENDER ---
    function renderVhvTab() {
        const v = DATA.vhvProfile;
        if(!v) return;

        // VHV Profile
        const verifiedIcon = v.verified ? '<i class="bi bi-patch-check-fill text-primary ms-1"></i>' : '';
        let warnPin = '';
        if(!v.asm_home || v.asm_home.length < 5) warnPin = `<div class="alert alert-warning py-1 small mt-2 text-center mb-0"><i class="bi bi-exclamation-triangle"></i> ท่านยังไม่ปักหมุดบ้าน</div>`;

        document.getElementById('vhv-profile').innerHTML = `
        <div class="d-flex align-items-center">
            <img src="${PROFILE.pictureUrl}" class="profile-pic me-3">
            <div class="flex-grow-1">
                <h5 class="fw-bold text-gold mb-1">${v.name} ${verifiedIcon}</h5>
                <span class="badge-area">${v.area}</span>
                <div class="text-muted small mt-1">ลงทะเบียน: ${v.date_regist||'-'}</div>
            </div>
            <div onclick="editVhv('${v.name}','${v.phone}','${v.area}')"><i class="bi bi-pencil-square fs-5 text-muted"></i></div>
        </div>
        ${warnPin}
        <button class="btn btn-outline btn-pill w-100 mt-2 btn-sm" onclick="pinAsm()">ปักหมุดบ้าน อสม.</button>`;

        // VHV Performance
        const s = DATA.vhvScore;
        document.getElementById('vhv-perf').innerHTML = `
        <div class="d-flex justify-content-between mb-2"><h5 class="card-title m-0 text-gold"><i class="bi bi-award-fill"></i> ผลงาน อสม.</h5><i class="bi bi-info-circle text-muted" onclick="MODALS['modalInfo'].show()"></i></div>
        <div class="text-center mb-3"><div class="display-3 fw-bold text-gold" style="line-height:1">${s.total}</div><small class="text-muted">คะแนนรวม</small></div>
        <div class="row g-1 text-center">
            <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted">บอกต่อ</small><strong>${s.breakdown.s}</strong></div></div>
            <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted">สติกเกอร์</small><strong>${s.breakdown.q}</strong></div></div>
            <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted">เยี่ยมบ้าน</small><strong>${s.breakdown.v}</strong></div></div>
            <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted">รายงาน</small><strong>${s.breakdown.r}</strong></div></div>
        </div>`;

        // Leaderboard
        let lbHtml = `<h5 class="card-title text-muted sticky-top bg-white pb-2 mb-0">อันดับ อสม.ดีเด่น</h5>`;
        DATA.leaderboards.forEach((u,i) => {
            const rClass = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'bg-light text-muted';
            lbHtml += `
            <div class="vhv-rank-row">
                <div class="rank-badge ${rClass}">${i+1}</div>
                <img src="${u.pic||'https://placehold.co/40'}" class="rounded-circle me-2" style="width:35px;height:35px;object-fit:cover;">
                <div class="flex-grow-1" style="line-height:1.2;">
                    <div class="fw-bold small">${u.name}</div>
                    <div class="text-muted" style="font-size:0.65rem;">${u.area}</div>
                </div>
                <div class="fw-bold text-gold small">${u.score}</div>
            </div>`;
        });
        document.getElementById('vhv-leader').innerHTML = lbHtml;

        // Patients
        renderPatientsList(DATA.patientList);
    }

    function renderPatientsList(list) {
        if(!list || list.length===0) {
            document.getElementById('patient-list-container').innerHTML = '<div class="text-center text-muted py-4">ไม่พบกลุ่มเสี่ยงในพื้นที่ของท่าน</div>';
            return;
        }

        const groups = { 'อันตราย (แดง)':[], 'สูง (ส้ม)':[], 'ปานกลาง (เหลือง)':[], 'ต่ำ (เขียว)':[] };
        list.forEach(p => {
            if(p.risk >= 30) groups['อันตราย (แดง)'].push(p);
            else if(p.risk >= 20) groups['สูง (ส้ม)'].push(p);
            else if(p.risk >= 10) groups['ปานกลาง (เหลือง)'].push(p);
            else groups['ต่ำ (เขียว)'].push(p);
        });

        let html = '';
        const mapGroup = (key, cls) => {
            if(groups[key].length > 0) {
                html += `<div class="small fw-bold mt-2 mb-1 ps-2 text-secondary" style="border-left:3px solid #ccc;">${key}</div>`;
                groups[key].forEach(p => {
                    html += `
                    <div class="patient-row ${cls}">
                        <div class="dist-badge"><i class="bi bi-geo"></i> ${p.dist} กม.</div>
                        <img src="${p.pic}" class="rounded-circle me-2" style="width:45px;height:45px;object-fit:cover;">
                        <div class="flex-grow-1" style="line-height:1.2">
                            <div class="fw-bold text-dark">${p.name}</div>
                            <div class="small text-muted">เสี่ยง ${p.risk}% | อัพเดท ${p.update} วัน</div>
                        </div>
                    </div>`;
                });
            }
        };

        mapGroup('อันตราย (แดง)', 'risk-danger');
        mapGroup('สูง (ส้ม)', 'risk-high');
        mapGroup('ปานกลาง (เหลือง)', 'risk-med');
        mapGroup('ต่ำ (เขียว)', 'risk-low');
        
        document.getElementById('patient-list-container').innerHTML = html;
    }

    // --- ACTIONS ---
    function scroll2(id){ document.getElementById(id).scrollIntoView({behavior:'smooth', block:'center'}); }
    
    function openEditEmg(h,d){ 
        document.getElementById('inpHelp').value=h; document.getElementById('inpDec').value=d; 
        MODALS['modalEditEmg'].show(); 
    }
    
    function saveEmg(){
        showLoad(true);
        const d = { userId:PROFILE.userId, help:document.getElementById('inpHelp').value, decision:document.getElementById('inpDec').value };
        fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'updateEmergencyInfo', data:d})})
        .then(()=>{ 
            showLoad(false); 
            MODALS['modalEditEmg'].hide(); 
            // Re-fetch to update score logic if needed, or manual update UI
            fetchData();
        });
    }

    function pinHome(isForce){
        if(!isForce) MODALS['modalPin'].hide();
        showLoad(true);
        navigator.geolocation.getCurrentPosition(p=>{
            const d = { userId:PROFILE.userId, type:'บ้าน', latlong:`${p.coords.latitude},${p.coords.longitude}`, distance:0, duration:0 };
            fetch(API_URL, {method:'POST', body:JSON.stringify({action:'saveNewLocation', data:d})})
            .then(r=>r.json()).then(res=>{ 
                showLoad(false); 
                alert('ปักหมุดเรียบร้อย คะแนนเตรียมพร้อมของท่านเพิ่มขึ้น!'); 
                fetchData();
            });
        }, ()=>{ showLoad(false); alert('ไม่สามารถระบุพิกัดได้'); });
    }

    function pinAsm(){
        if(!confirm('ยืนยันว่าท่านอยู่ที่บ้านพักของท่านในขณะนี้? ระบบจะใช้พิกัดนี้คำนวณระยะทางไปหาผู้ป่วย')) return;
        showLoad(true);
        navigator.geolocation.getCurrentPosition(p=>{
            fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'updateAsmHome', data:{userId:PROFILE.userId, latlong:`${p.coords.latitude},${p.coords.longitude}`}})})
            .then(()=>{ showLoad(false); alert('บันทึกพิกัดบ้าน อสม. แล้ว'); fetchData(); });
        });
    }

    function editVhv(n,p,areaStr){ 
        document.getElementById('vhvName').value=n; 
        document.getElementById('vhvPhone').value=p;
        
        // Parse "ต.XX ม.YY"
        try {
            const parts = areaStr.match(/ต\.(.+?)\s+ม\.(\d+)/);
            if(parts){
                document.getElementById('vhvDistrict').value = parts[1].trim();
                document.getElementById('vhvVillage').value = parts[2].trim();
            }
        } catch(e){}
        MODALS['modalEditVhv'].show(); 
    }

    function saveVhvProfile(){
        const dist = document.getElementById('vhvDistrict').value;
        const vil = document.getElementById('vhvVillage').value;
        if(!dist || !vil) { alert('กรุณาเลือกตำบลและหมู่'); return; }

        showLoad(true);
        const fullArea = `ต.${dist} ม.${vil}`;
        const d = { userId:PROFILE.userId, name:document.getElementById('vhvName').value, phone:document.getElementById('vhvPhone').value, area:fullArea };
        
        fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'updateAsmProfile', data:d})})
        .then(()=>{ showLoad(false); MODALS['modalEditVhv'].hide(); alert('บันทึกข้อมูลเรียบร้อย'); fetchData(); });
    }

    function call(t){ TARGET_TEL=t; MODALS['modalCall'].show(); }
    
    function execCall(){
        MODALS['modalCall'].hide();
        navigator.geolocation.getCurrentPosition(p=>{
            fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'logTelCall', data:{userId:PROFILE.userId, tel:TARGET_TEL, latlong:`${p.coords.latitude},${p.coords.longitude}`}})});
            window.location.href=`tel:${TARGET_TEL}`;
        }, ()=>window.location.href=`tel:${TARGET_TEL}`);
    }

    function shareNoLine(){
        location.href = `${LINKS.REGIS}?ref=${PROFILE.userId}`;
    }

    function showLoad(b){ document.getElementById('loader').style.display=b?'flex':'none'; }

</script>
</body>
</html>