<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å by ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* =========================================
           GLOBAL VARIABLES
           ========================================= */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            --vhv-bg: #ffc107; 
            --vhv-dark: #b88a00; 
            --base-size: 20px; 
        }

        html { 
            font-size: var(--base-size);
        }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 1rem; 
            background: linear-gradient(180deg, #ff3654 0%, #ffffff 450px);
            background-attachment: fixed;
            margin: 0; 
            padding-bottom: 5rem; 
            transition: background 0.5s ease;
        }
        
        /* --- VHV Mode Theme Overrides --- */
        body.vhv-mode {
            background: linear-gradient(180deg, #FFD700 0%, #ffffff 400px);
        }

        /* Typography Overrides */
        h1, h2, h3, h4, h5 { 
            font-weight: 700 !important; 
        }

        .h5, h5 { 
            font-size: 1.6rem; 
        }

        .small, small { 
            font-size: 0.85rem; 
        }

        .btn { 
            font-size: 1.1rem; 
            font-weight: 600; 
        }
        
        /* Floating Header */
        .app-header { 
            text-align: center; 
            padding: 110px 20px 20px; 
        }

        .app-title { 
            color: white; 
            font-weight: 900; 
            font-size: 2rem; 
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3); 
            margin: 0; 
        }

        body.vhv-mode .app-title { 
            color: #333; 
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5); 
        }

        /* Fixed Tabs Container */
        .nav-tabs-container {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 1000;
            background-color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            padding: 10px 0;
        }

        .nav-tabs { 
            border-bottom: none; 
            width: 100%;
            display: flex;
        }

        .nav-item {
            flex: 1;
            text-align: center;
        }

        .nav-link { 
            font-size: 1.3rem; 
            color: #999; 
            border: none; 
            border-radius: 0; 
            margin: 0; 
            padding: 15px 0; 
            font-weight: 700; 
            background: #fff;
            width: 100%;
        }

        /* Center Separator Line */
        .nav-item:first-child .nav-link {
            border-right: 1px solid #ddd;
        }

        .nav-link.active { 
            color: #ff3654; 
            background: #fff; 
        }

        body.vhv-mode .nav-link.active { 
            color: #b88a00; 
        }
        
        .bg-vhv-theme { 
            min-height: 100vh; 
            padding-bottom: 40px; 
        }
        
        /* Card Styles */
        .card { 
            border: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            margin-bottom: 1.5rem; 
            border-radius: 20px; 
            overflow: hidden; 
        }

        .section-title { 
            font-size: 1.4rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            color: #333; 
            display: flex; 
            align-items: center; 
        }

        .section-title i { 
            margin-right: 0.8rem; 
            color: #ff3654; 
            font-size: 1.6rem; 
        }

        body.vhv-mode .section-title i { 
            color: #b88a00; 
        }

        /* Loading Spinner (In-Card) */
        .loading-container {
            text-align: center;
            padding: 40px;
        }
        
        .spinner-border { 
            width: 4rem; 
            height: 4rem; 
            color: #ffc107; 
            margin-bottom: 20px; 
        }

        #loading-text { 
            font-size: 1.5rem; 
            font-weight: bold; 
        }

        /* Profile Card */
        .profile-img-lg {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* Game Score Box */
        .game-score-card { 
            border: 2px solid #fff; 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
        }

        .game-score-box { 
            background: #fff; 
            border-radius: 12px; 
            padding: 10px 5px; 
            text-align: center; 
            border: 1px solid #dee2e6; 
            height: 100%; 
            cursor: pointer; 
            transition: transform 0.2s; 
        }

        .game-score-box:active { 
            transform: scale(0.95); 
        }

        .game-score-box h3 { 
            margin: 5px 0; 
            font-weight: 800; 
            color: #0d6efd; 
            font-size: 1.8rem; 
        }

        .game-score-box span { 
            font-size: 0.9rem; 
            color: #666; 
            line-height: 1.2; 
            display: block; 
        }
        
        .profile-edit-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: rgba(255,255,255,0.9); 
            border: none; 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            color: #0d6efd; 
            font-size: 1.5rem; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        
        /* Risk Card */
        .risk-score-display {
            font-size: 4rem;
            font-weight: 900;
            line-height: 1;
        }

        .risk-label {
            font-size: 1.2rem;
            font-weight: bold;
            opacity: 0.8;
        }

        /* Info Grid */
        .info-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
            margin-top: 15px; 
        }
        
        .info-item { 
            background-color: #f8f9fa; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            padding: 10px; 
            display: flex; 
            align-items: center; 
            font-size: 0.9rem; 
        }
        
        .info-item i { 
            font-size: 1.5rem; 
            color: #ff3654; 
            margin-right: 10px; 
            width: 30px; 
            text-align: center; 
        }
        
        .info-item .label { 
            display: block; 
            font-size: 0.8rem; 
            color: #6c757d; 
            line-height: 1; 
        }
        
        .info-item b { 
            font-size: 1.1rem; 
            color: #333; 
        }

        /* Emergency Card */
        .emergency-graphic {
            font-size: 2.5rem;
            margin: 0 10px;
        }
        
        /* Leaderboard Styles */
        .leaderboard-card { 
            height: 100%; 
            border: 1px solid #dee2e6; 
        }

        .leaderboard-row { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            padding-bottom: 8px; 
            border-bottom: 1px solid #eee; 
        }

        .leaderboard-rank { 
            font-size: 1.2rem; 
            font-weight: bold; 
            width: 30px; 
            text-align: center; 
            color: #b88a00; 
        }

        .leaderboard-img { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover; 
            margin-right: 10px; 
            border: 1px solid #ddd; 
        }

        .leaderboard-score { 
            margin-left: auto; 
            font-weight: bold; 
            color: #198754; 
            font-size: 1rem; 
        }
        
        /* VHV Patient List Styles */
        .vhv-patient-item { 
            border-left: 8px solid #ccc; 
            margin-bottom: 15px; 
            border-radius: 12px; 
            background-color: #fff; 
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .vhv-risk-5 { border-left-color: #8B0000; }
        .vhv-risk-4 { border-left-color: #dc3545; }
        .vhv-risk-3 { border-left-color: #fd7e14; }
        .vhv-risk-2 { border-left-color: #ffc107; }
        .vhv-risk-1 { border-left-color: #28a745; }

        /* Buttons Adaptive */
        .btn-primary { 
            background-color: #ff3654; 
            border-color: #ff3654; 
        }
        
        body.vhv-mode .btn-primary { 
            background-color: #FFD700; 
            color: #000; 
            border-color: #FFD700; 
            font-weight: bold; 
        }
        
        .btn-main {
            background-color: #ff3654;
            color: white;
            border-radius: 30px;
            padding: 10px 30px;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 10px rgba(255, 54, 84, 0.4);
        }
        .btn-main:hover {
            background-color: #e62e4a;
            color: white;
        }

        /* Footer */
        .app-footer { 
            text-align: center; 
            color: #888; 
            font-size: 0.8rem; 
            margin-top: 30px; 
        }
        
        /* Loading Overlay (Hidden by default) */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay (For Form Submissions) -->
    <div id="loading">
        <div class="spinner-border text-light" role="status"></div>
        <div class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>

    <!-- Fixed Header Tabs -->
    <div class="nav-tabs-container">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="health-tab-btn" data-bs-toggle="tab" data-bs-target="#health-tab-content">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vhv-tab-btn" data-bs-toggle="tab" data-bs-target="#vhv-tab-content">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°.</button>
            </li>
        </ul>
    </div>

    <!-- App Title -->
    <div class="app-header">
        <h1 class="app-title">‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h1>
    </div>

    <!-- Main Content -->
    <div class="main-container" style="margin-top: 80px; padding: 0 15px;">
        <div class="tab-content">
            
            <!-- Tab 1: Health Information -->
            <div class="tab-pane fade show active" id="health-tab-content">
                <div id="dynamic-content-container">
                     <!-- Initial Loading Spinner -->
                     <div class="loading-container">
                         <div class="spinner-border text-light" role="status"></div>
                         <div class="text-white mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß...</div>
                     </div>
                </div>
            </div>
            
            <!-- Tab 2: VHV Dashboard -->
            <div class="tab-pane fade" id="vhv-tab-content">
                <div id="vhv-dashboard-area">
                    <!-- Initial Loading Spinner -->
                     <div class="loading-container">
                         <div class="spinner-border text-dark" role="status"></div>
                         <div class="text-dark mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏™‡∏°...</div>
                     </div>
                </div>
            </div>

        </div>
    </div>

    <div class="app-footer">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏à.‡∏ä‡∏∏‡∏°‡∏û‡∏£</div>

    <!-- ================= MODALS ================= -->

    <!-- 1. Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3 text-center">
                            <img id="edit-preview-img" src="" class="profile-img-lg mb-3">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control form-control-lg" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" class="form-control form-control-lg" id="editPhone" required pattern="[0-9]{10}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 2. Edit Emergency Modal -->
    <div class="modal fade" id="editEmergencyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏• (Help)</label>
                        <select class="form-select" id="editHelp">
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß">‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à (Decision)</label>
                        <select class="form-select" id="editDecision">
                            <option value="‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</option>
                            <option value="‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π">‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π</option>
                            <option value="‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢">‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢</option>
                            <option value="‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á">‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á</option>
                            <option value="‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö">‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="submitEmergencyEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Distance Modal -->
    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
                    <div class="mb-3">
                         <div class="form-check">
                             <input class="form-check-input" type="radio" name="locType" id="locType1" value="‡∏ö‡πâ‡∏≤‡∏ô" checked>
                             <label class="form-check-label" for="locType1">‡∏ö‡πâ‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)</label>
                         </div>
                         <div class="form-check">
                             <input class="form-check-input" type="radio" name="locType" id="locType2" value="‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô">
                             <label class="form-check-label" for="locType2">‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏â‡∏¢‡πÜ)</label>
                         </div>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. Score Info Modal -->
    <div class="modal fade" id="scoreInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><b>1. ‡πÉ‡∏™‡πà‡πÉ‡∏à (40%):</b> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ (‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≤‡∏î‡πÄ‡∏Å‡∏¥‡∏ô 7 ‡∏ß‡∏±‡∏ô)</li>
                        <li class="list-group-item"><b>2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (10%):</b> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á x ‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏• x ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</li>
                        <li class="list-group-item"><b>3. ‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠ (20%):</b> ‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ/‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</li>
                        <li class="list-group-item"><b>4. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (30%):</b> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 5. VHV Registration Modal -->
    <div class="modal fade" id="vhvRegisterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vhvForm">
                        <div class="mb-3">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control" id="vhvName">
                        </div>
                        <div class="mb-3">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                            <input type="tel" class="form-control" id="vhvPhone">
                        </div>
                        <div class="mb-3">
                            <label>Line ID</label>
                            <input type="text" class="form-control" id="vhvLineId">
                        </div>
                        <div class="mb-3">
                            <label>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select" id="vhvDistrict" onchange="updateVillages()">
                                        <option disabled selected>‡∏ï‡∏≥‡∏ö‡∏•</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="vhvVillage" disabled>
                                        <option disabled selected>‡∏´‡∏°‡∏π‡πà</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="vhvAsmHome" placeholder="‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô" readonly>
                                <button class="btn btn-primary" type="button" onclick="pinVhvHomeInForm()">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100" onclick="handleVhvRegistration()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 6. Register Offline Patient Modal -->
    <div class="modal fade" id="registerOfflineModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå)</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="offlineForm">
                        <div class="mb-3">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control" id="offName">
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label>‡∏≠‡∏≤‡∏¢‡∏∏</label>
                                <input type="number" class="form-control" id="offAge">
                            </div>
                            <div class="col-6">
                                <label>‡πÄ‡∏û‡∏®</label>
                                <select class="form-select" id="offSex">
                                    <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                                    <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                            <input type="tel" class="form-control" id="offPhone">
                        </div>
                        <div class="mb-3">
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</label>
                            <select class="form-select" id="offRisk">
                                <option value="0">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥</option>
                                <option value="10">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                                <option value="20">‡∏™‡∏π‡∏á</option>
                                <option value="30">‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å</option>
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-primary" onclick="pinOfflineLocation()">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
                            <input type="hidden" id="offLocation">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100" onclick="submitOfflinePatient()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="mb-4">‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
                    <!-- QR Code Generated via API for the specific link -->
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://lin.ee/qRgD07N" alt="QR Code" style="max-width:90%;width:350px;border:15px solid white;border-radius:15px;">
                    <p class="mt-4 fs-3">‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>
                    <a href="https://lin.ee/qRgD07N" class="btn btn-success btn-lg mt-3 rounded-pill px-5 fs-4">
                        <i class="bi bi-line"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                    </a>
                    <button class="btn btn-light btn-lg mt-5 rounded-pill px-5 py-3 fs-3" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 8. Share Profile Modal -->
    <div class="modal fade" id="shareProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">‡πÅ‡∏ä‡∏£‡πå‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ ‡∏≠‡∏™‡∏°.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô</p>
                    <button type="button" class="btn btn-primary btn-lg w-100" onclick="handleShareProfile()">
                        <i class="bi bi-line"></i> ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 9. Home Visit Modal -->
    <div class="modal fade" id="homeVisitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h1 class="modal-title fs-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="hvPatientId">
                    <input type="hidden" id="hvPatientNameVal">
                    <h5 id="hvTitle" class="mb-3">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: ...</h5>
                    
                    <div class="alert alert-warning d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-geo-alt-fill"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                        <button class="btn btn-warning btn-sm" onclick="pinForCurrentPatient()">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chkAdvice1" checked>
                            <label class="form-check-label" for="chkAdvice1">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chkAdvice2" checked>
                            <label class="form-check-label" for="chkAdvice2">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea class="form-control" id="hvNoteAdvice" rows="2"></textarea>
                    </div>
                    <button class="btn btn-success w-100 btn-lg" onclick="submitHomeVisit('Advice')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 10. Stroke Report Modal -->
    <div class="modal fade" id="strokeReportModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h1 class="modal-title fs-4">üöë ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏™‡∏™‡πÇ‡∏ï‡∏£‡∏Å (Fast Track)</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="strokeReportForm" class="p-2">
                        <div class="form-section-title">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
                        <div class="mb-3">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                            <input type="text" class="form-control" id="srName">
                        </div>
                        <div class="mb-3">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ç‡∏≤‡∏ï‡∏¥ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)</label>
                            <input type="tel" class="form-control border-danger" id="srRelPhone" required>
                        </div>

                        <div class="form-section-title text-danger">2. ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!)</div>
                        <div class="mb-3">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (Onset)</label>
                            <input type="time" class="form-control form-control-lg border-danger" id="srOnsetTime">
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-secondary" onclick="getLocationForReport()">
                                <i class="bi bi-geo-alt"></i> ‡πÅ‡∏ô‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                            </button>
                            <input type="text" id="srLocation" class="form-control text-center small" readonly placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-lg flex-grow-1" onclick="submitStrokeReport()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 11. Risk Info Modal (Re-added) -->
    <div class="modal fade" id="riskInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á ‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        const LINKS = { REGIS: "https://liff.line.me/2005789397-nebQ8oJy", DAILY: "https://liff.line.me/2005789397-WRm1lYd9", STICKER: "https://liff.line.me/2005789397-37lemBgX", KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk" };
        const SAWEE_LOCATIONS = { "‡∏ô‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå": 8, "‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏≤": 5, "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÉ‡∏ï‡πâ": 3, "‡∏î‡πà‡∏≤‡∏ô‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡πà‡∏≤‡∏´‡∏¥‡∏ô": 3, "‡∏õ‡∏≤‡∏Å‡πÅ‡∏û‡∏£‡∏Å": 4, "‡∏Ñ‡∏£‡∏ô": 4, "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": 3, "‡∏ô‡∏≤‡∏™‡∏±‡∏Å": 3, "‡πÄ‡∏Ç‡∏≤‡∏ó‡∏∞‡∏•‡∏∏": 3 };
        
        let LIFF_PROFILE, ALL_USER_DATA;
        let EDIT_PROFILE_MODAL, EDIT_EMERGENCY_MODAL, DISTANCE_MODAL, SCORE_INFO_MODAL, VHV_REG_MODAL, REGISTER_OFFLINE_MODAL, STROKE_REPORT_MODAL, HOME_VISIT_MODAL, QR_MODAL, SHARE_PROFILE_MODAL;

        function setAppMode(isVhv) {
            if (isVhv) document.body.classList.add('vhv-mode');
            else document.body.classList.remove('vhv-mode');
        }

        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        document.addEventListener('DOMContentLoaded', async () => {
            const initModal = (id) => new bootstrap.Modal(document.getElementById(id));
            EDIT_PROFILE_MODAL = initModal('editProfileModal');
            EDIT_EMERGENCY_MODAL = initModal('editEmergencyModal');
            DISTANCE_MODAL = initModal('distanceModal');
            SCORE_INFO_MODAL = initModal('scoreInfoModal');
            VHV_REG_MODAL = initModal('vhvRegisterModal');
            REGISTER_OFFLINE_MODAL = initModal('registerOfflineModal');
            STROKE_REPORT_MODAL = initModal('strokeReportModal');
            HOME_VISIT_MODAL = initModal('homeVisitModal');
            QR_MODAL = initModal('qrModal');
            SHARE_PROFILE_MODAL = initModal('shareProfileModal');
            
            document.getElementById('health-tab-btn').addEventListener('shown.bs.tab', () => setAppMode(false));
            document.getElementById('vhv-tab-btn').addEventListener('shown.bs.tab', () => setAppMode(true));

            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                LIFF_PROFILE = await liff.getProfile();
                
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref') || '';
                
                const url = `${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}&ref=${refCode}`;
                const res = await fetch(url).then(r=>r.json());
                ALL_USER_DATA = res;
                renderApp(res);
                
            } catch(e) { alert("Error: "+e.message); }
        });

        function renderApp(data) {
            const hDiv = document.getElementById('dynamic-content-container');
            if (!data.userProfile) {
                hDiv.innerHTML = `<div class="text-center py-5 card bg-white"><h5>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5><p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p><a href="${LINKS.REGIS}" class="btn btn-primary rounded-pill px-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></div>`;
            } else {
                hDiv.innerHTML = 
                    buildProfileHeadCard(data.userProfile) +
                    buildGamificationCard(data.gamification) +
                    buildRiskCard(data.userProfile) +
                    buildEmergencyCard(data.homeDistance, data.gamification.details || {}) +
                    buildCommunityLeadersCard(data.communityLeaders);
            }
            
            const vDiv = document.getElementById('vhv-dashboard-area');
            if (data.isVhv) {
                vDiv.innerHTML = 
                    buildVhvLeaderboards(data.vhvDashboard.leaderboards) +
                    `<div class="d-grid gap-2 mb-3"><button class="btn btn-primary shadow" onclick="REGISTER_OFFLINE_MODAL.show()"><i class="bi bi-person-plus-fill"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô (Offline)</button></div>` +
                    buildVhvPatientListCard(data.vhvDashboard.patientList);
            } else {
                vDiv.innerHTML = `<div class="text-center py-4 card bg-white"><p>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p><button class="btn btn-warning" onclick="openVhvModal()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</button></div>`;
            }
        }

        // --- Builders ---
        function buildProfileHeadCard(p) {
            const dateStr = p.timestamp ? new Date(p.timestamp).toLocaleDateString('th-TH') : '-';
            return `
            <div class="col-12 mb-3"><div class="card p-3 d-flex flex-row align-items-center bg-white shadow-sm">
                <img src="${p.pictureUrl}" class="profile-img-lg me-3">
                <div>
                    <h4 class="fw-bold mb-0">${p.name}</h4>
                    <div class="text-muted"><i class="bi bi-telephone"></i> ${p.telephone}</div>
                    <div class="small text-muted">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${dateStr}</div>
                </div>
                <div class="ms-auto"><button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="openEditProfile()"><i class="bi bi-pencil"></i></button></div>
            </div></div>`;
        }

        function buildGamificationCard(s) {
            const levelClass = s.levelColor === 'warning' ? 'bg-warning text-dark' : (s.levelColor === 'success' ? 'bg-success text-white' : 'bg-secondary text-white');
            return `
            <div class="col-12 mb-3"><div class="card game-score-card shadow-sm"><div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2"><h5 class="m-0 text-primary">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ</h5><button class="btn btn-sm btn-outline-info rounded-circle" onclick="SCORE_INFO_MODAL.show()">?</button></div>
                <div class="text-center mb-3">
                     <div class="display-3 fw-bold text-primary">${s.totalScore}</div>
                     <span class="badge rounded-pill ${levelClass} fs-6">${s.levelName}</span>
                     <div class="small text-muted mt-1">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${s.rank}/${s.totalUsers}</div>
                </div>
                <div class="row g-2 text-center">
                    <div class="col-3"><div class="game-score-box"><h3>${s.checkScore}</h3><span>‡πÉ‡∏™‡πà‡πÉ‡∏à</span></div></div>
                    <div class="col-3"><div class="game-score-box"><h3>${s.emergencyScore}</h3><span>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</span></div></div>
                    <div class="col-3"><div class="game-score-box"><h3>${s.stickerScore}</h3><span>‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠</span></div></div>
                    <div class="col-3"><div class="game-score-box"><h3>${s.knowledgeScore}</h3><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</span></div></div>
                </div>
            </div></div></div>`;
        }

        function buildRiskCard(p) {
             const score = parseInt(p.thai_cv_risk_score || 0);
             let color = '#28a745'; if(score>=10) color='#ffc107'; if(score>=20) color='#fd7e14'; if(score>=30) color='#dc3545';
             const items = [
                {l:'‡πÄ‡∏û‡∏®', v:p.gender==1?'‡∏ä‡∏≤‡∏¢':'‡∏´‡∏ç‡∏¥‡∏á', i:'bi-gender-ambiguous'}, {l:'‡∏≠‡∏≤‡∏¢‡∏∏', v:p.age, i:'bi-calendar'},
                {l:'‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', v:p.smoke==1?'‡∏™‡∏π‡∏ö':'‡πÑ‡∏°‡πà', i:'bi-fire'}, {l:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', v:p.dm==1?'‡πÄ‡∏õ‡πá‡∏ô':'‡πÑ‡∏°‡πà', i:'bi-droplet'},
                {l:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', v:p.sbp, i:'bi-speedometer'}, {l:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', v:p.cholesterol, i:'bi-heart'}
             ].map(x=>`<div class="info-item"><i class="bi ${x.i}"></i><div><small>${x.l}</small><b>${x.v}</b></div></div>`).join('');
             
             const statsHtml = p.stats ? buildStatsSection(p.stats) : '';

             return `<div class="col-12 mb-3"><div class="card"><div class="card-body">
                <h5 class="section-title"><i class="bi bi-activity"></i> ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h5>
                <div class="text-center mb-3">
                     <div class="risk-score-display" style="color: ${color}">${score}%</div>
                     <div class="risk-label" style="color: ${color}">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á 10 ‡∏õ‡∏µ</div>
                     ${statsHtml}
                     <div class="mt-2"><a href="${LINKS.REGIS}" class="btn btn-outline-danger rounded-pill">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</a></div>
                </div>
                <div class="info-grid">${items}</div>
             </div></div></div>`;
        }
        
        function buildStatsSection(s) {
            return `<div class="mt-2"><span class="badge bg-light text-dark border">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ${s.total_assessments} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span> <span class="badge bg-warning text-dark border">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á ${s.high_risk_count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span><div class="text-muted small mt-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${s.last_updated}</div></div>`;
        }

        function buildEmergencyCard(d, details) {
            const h = details.help || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const dec = details.decision || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const dist = d ? `${d.distance_km} ‡∏Å‡∏°. (${d.duration_mins} ‡∏ô‡∏≤‡∏ó‡∏µ)` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î';
            return `<div class="col-12 mb-3"><div class="card border-danger shadow-sm"><div class="card-body">
                <h5 class="text-danger fw-bold"><i class="bi bi-truck-front-fill"></i> ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏£‡∏û.‡∏™‡∏ß‡∏µ)</h5>
                <div class="d-flex align-items-center justify-content-center my-3 text-danger">
                    <i class="bi bi-person-fill emergency-graphic"></i> <i class="bi bi-arrow-right emergency-graphic"></i> <i class="bi bi-hospital-fill emergency-graphic"></i>
                </div>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item d-flex justify-content-between"><span>‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•:</span> <b>${h}</b></li>
                    <li class="list-group-item d-flex justify-content-between"><span>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à:</span> <b>${dec}</b></li>
                    <li class="list-group-item d-flex justify-content-between"><span>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</span> <b>${dist}</b></li>
                </ul>
                <div class="row g-2">
                     <div class="col-6"><button class="btn btn-outline-secondary w-100" onclick="openEditEmergency('${h}', '${dec}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
                     <div class="col-6"><button class="btn btn-primary w-100" onclick="DISTANCE_MODAL.show()">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà</button></div>
                </div>
            </div></div></div>`;
        }

        function buildVhvLeaderboards(lb) {
             const row = (t, l) => {
                 let content = l && l.length > 0 ? l.map((x,i)=>`<div class="leaderboard-row"><div class="leaderboard-rank">${i+1}</div><img src="${x.pic||'https://via.placeholder.com/40'}" class="leaderboard-img"><div class="small text-truncate" style="max-width:80px;">${x.name}</div><div class="leaderboard-score">${x.score}</div></div>`).join('') : '<div class="text-center text-muted small py-2">-</div>';
                 return `<div class="col-6 mb-2"><div class="card leaderboard-card"><div class="card-header bg-light small fw-bold text-center">${t}</div><div class="card-body p-2">${content}</div></div></div>`;
             };
             return `<div class="row g-2 mb-3">${row('‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô', lb.visits)}${row('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏', lb.reports)}${row('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏•‡∏ô‡πå', lb.exams)}${row('‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î', lb.pins)}</div>`;
        }

        function buildVhvPatientListCard(pts) {
            if(!pts || pts.length===0) return '<div class="alert alert-secondary">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï</div>';
            let html = pts.map(p => `
                <div class="vhv-patient-item vhv-risk-${Math.ceil(p.thai_cv_risk_score/10)}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold fs-5">${p.name} <span class="badge bg-secondary">${p.thai_cv_risk_score}%</span></div>
                            <div class="small text-muted">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô: ${p.latestCheckTimestamp ? p.latestCheckTimestamp.split('T')[0] : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢'}</div>
                            <div class="small text-muted">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: ${p.distanceFromVhv_km || '?'} ‡∏Å‡∏°.</div>
                        </div>
                        <div class="d-flex flex-column gap-2">
                             <a href="tel:${p.telephone}" class="btn btn-sm btn-outline-success rounded-circle"><i class="bi bi-telephone-fill"></i></a>
                             <button class="btn btn-sm btn-warning rounded-pill" onclick="openHomeVisit('${p.userId}', '${p.name}')">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</button>
                        </div>
                    </div>
                    ${p.isReferred ? '<div class="mt-1 badge bg-info text-dark"><i class="bi bi-link-45deg"></i> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏°‡∏≤</div>' : ''}
                </div>`).join('');
            return `<div class="card"><div class="card-header bg-white fw-bold d-flex justify-content-between"><span>‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï</span> <button class="btn btn-sm btn-danger" onclick="STROKE_REPORT_MODAL.show()">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏™</button></div><div class="card-body bg-light">${html}<div class="d-grid mt-3"><a href="https://sawee-hosp.github.io/stroke-risk/" target="_blank" class="btn btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Web)</a></div></div></div>`;
        }
        
        function buildCommunityLeadersCard(l) { 
             if(!l) return '';
             let html = '<ul class="list-group list-group-flush">';
             if(l.pcu) html += `<li class="list-group-item d-flex justify-content-between"><span>${l.pcu}</span><a href="tel:${l.pcu_tel}" class="btn btn-sm btn-outline-primary"><i class="bi bi-telephone"></i></a></li>`;
             if(l.headman) html += `<li class="list-group-item d-flex justify-content-between"><span>‡∏ú‡∏ç‡∏ö. ${l.headman}</span><a href="tel:${l.headman_tel}" class="btn btn-sm btn-outline-dark"><i class="bi bi-telephone"></i></a></li>`;
             html += '</ul>';
             return `<div class="col-12 mb-3"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-people-fill"></i> ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h5>${html}</div></div></div>`;
        }
        
        // Additional Builders for completeness (Daily Check, Sticker, Knowledge)
        function buildDailyCheckCard(info) {
             let daysSinceCheck = '';
             if (info.latestCheckTimestamp) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(info.latestCheckTimestamp).setHours(0,0,0,0)) / (864e5));
                if (diffDays > 7) daysSinceCheck = `<p class="text-center text-danger mt-2">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤ ${diffDays} ‡∏ß‡∏±‡∏ô (‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</p>`;
                else if (diffDays > 0) daysSinceCheck = `<p class="text-center text-muted mt-2">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤ ${diffDays} ‡∏ß‡∏±‡∏ô</p>`;
            } else { daysSinceCheck = `<p class="text-center text-danger mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>`; }
            return `<div class="col-12 mb-3"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-calendar-check-fill"></i>‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h5><div class="d-flex justify-content-around text-center"><div><div class="display-3 fw-bold text-danger">${info.symptomCount || 0}</div><div class="small">‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</div></div><div><div class="display-3 fw-bold text-success">${info.noSymptomCount || 0}</div><div class="small">‡∏õ‡∏Å‡∏ï‡∏¥</div></div></div>${daysSinceCheck}<p class="small text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πá‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</p><a href="${LINKS.DAILY}" class="btn btn-primary w-100 btn-lg mt-1">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</a></div></div></div>`;
        }

        function buildStickerCard(c) { 
            return `<div class="col-12 mb-3"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-send-check-fill"></i>‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏•‡∏ô‡πå</h5><div class="text-center"><h1>${c || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h1></div><a href="${LINKS.STICKER}" class="btn btn-info w-100 btn-lg text-white mt-2">‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</a></div></div></div>`; 
        }

        function buildKnowledgeTestCard(s) { 
            return `<div class="col-12 mb-3"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-book-half"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h5><div class="text-center"><h1>${s.maxScore || 0}/10</h1><small>‡∏™‡∏≠‡∏ö‡πÑ‡∏õ ${s.testCount || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small></div><a href="${LINKS.KNOWLEDGE}" class="btn btn-success w-100 btn-lg mt-2">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a></div></div></div>`; 
        }

        // Actions
        function openEditProfile() { document.getElementById('editName').value = ALL_USER_DATA.userProfile.name; document.getElementById('editPhone').value = ALL_USER_DATA.userProfile.telephone.replace(/'/g,''); document.getElementById('edit-preview-img').src = ALL_USER_DATA.userProfile.pictureUrl; EDIT_PROFILE_MODAL.show(); }
        function saveUserProfile() { const name = document.getElementById('editName').value; const phone = document.getElementById('editPhone').value; if(!name || !phone) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateUserProfile', data: { userId: LIFF_PROFILE.userId, name: name, phone: phone, pictureUrl: LIFF_PROFILE.pictureUrl } }) }).then(() => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.location.reload(); }).catch(e => alert(e.message)); }
        function openVhvModal() { const distSelect = document.getElementById('vhvDistrict'); distSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>'; for (const d in SAWEE_LOCATIONS) { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; distSelect.appendChild(opt); } VHV_REG_MODAL.show(); }
        function updateVillages() { const villSelect = document.getElementById('vhvVillage'); villSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>'; villSelect.disabled = false; for(let i=1; i<=20; i++) { const opt = document.createElement('option'); opt.value = "‡∏´‡∏°‡∏π‡πà " + i; opt.textContent = "‡∏´‡∏°‡∏π‡πà " + i; villSelect.appendChild(opt); } }
        function handleVhvRegistration() { const name = document.getElementById('vhvName').value; const phone = document.getElementById('vhvPhone').value; const dist = document.getElementById('vhvDistrict').value; const vill = document.getElementById('vhvVillage').value; if(!name || !phone || !dist || !vill) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); toggleLoading(true); const data = { userId: LIFF_PROFILE.userId, displayName: LIFF_PROFILE.displayName, profilePicture: LIFF_PROFILE.pictureUrl, name: name, phone: phone, line_id: document.getElementById('vhvLineId').value, areas: [`‡∏ï.${dist} ${vill}`], pdpa: "‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°", asm_home: document.getElementById('vhvAsmHome').value }; fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerVhv', data: data }) }).then(() => { alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.location.reload(); }); }
        function openEditEmergency(h, d) { document.getElementById('editHelp').value = h; document.getElementById('editDecision').value = d; EDIT_EMERGENCY_MODAL.show(); }
        function submitEmergencyEdit() { const h = document.getElementById('editHelp').value; const d = document.getElementById('editDecision').value; toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateEmergencyInfo', data: { userId: LIFF_PROFILE.userId, help: h, decision: d } }) }).then(() => { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); location.reload(); }); }
        function handlePinNewLocation() { const type = document.querySelector('input[name="locType"]:checked').value; navigator.geolocation.getCurrentPosition(p => { fetch(`${WEB_APP_URL}?action=calculateDistance&lat=${p.coords.latitude}&lon=${p.coords.longitude}`).then(r=>r.json()).then(d=> { fetch(WEB_APP_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({ action:'saveNewLocation', data: { userId:LIFF_PROFILE.userId, type: type, latlong:`${p.coords.latitude},${p.coords.longitude}`, distance:d.distance_km, duration:d.duration_mins } }) }).then(()=>{ alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.location.reload(); }); }); }); }
        function pinOfflineLocation() { navigator.geolocation.getCurrentPosition(p => { document.getElementById('offLocation').value = `${p.coords.latitude},${p.coords.longitude}`; }); }
        function submitOfflinePatient() { const data = { vhvId: LIFF_PROFILE.userId, vhvName: ALL_USER_DATA.vhvProfile.name, name: document.getElementById('offName').value, age: document.getElementById('offAge').value, gender: document.getElementById('offSex').value, phone: document.getElementById('offPhone').value, riskScore: document.getElementById('offRisk').value, latlong: document.getElementById('offLocation').value, district: ALL_USER_DATA.vhvProfile.area.split(' ')[0].replace('‡∏ï.', ''), village: ALL_USER_DATA.vhvProfile.area.split(' ')[1].replace('‡∏°.', '') }; toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerOfflinePatient', data: data }) }).then(() => { alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); window.location.reload(); }); }
        async function handleShareProfile() { toggleLoading(true); const res = await fetch(`${WEB_APP_URL}?action=getShareCard&userId=${LIFF_PROFILE.userId}`); const data = await res.json(); toggleLoading(false); if (data.success) liff.shareTargetPicker([data.flex]); else alert(data.message); }
        function pinVhvHomeInForm() { navigator.geolocation.getCurrentPosition(p => { document.getElementById('vhvAsmHome').value = `${p.coords.latitude},${p.coords.longitude}`; }); }
        function getLocationForReport() { navigator.geolocation.getCurrentPosition(p => { document.getElementById('srLocation').value = `${p.coords.latitude},${p.coords.longitude}`; }); }
        function submitStrokeReport() { const pn = document.getElementById('srName').value; const ph = document.getElementById('srRelPhone').value; const ot = document.getElementById('srOnsetTime').value; const loc = document.getElementById('srLocation').value; if(!pn || !ph || !ot || !loc) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveStrokeReport', data: { reporterId: LIFF_PROFILE.userId, reporterName: LIFF_PROFILE.displayName, patientName: pn, patientPhone: ph, onsetTime: ot, location: loc }}) }).then(() => { alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); window.location.reload(); }); }
        function openHomeVisit(uid, name) { document.getElementById('hvPatientId').value = uid; document.getElementById('hvPatientNameVal').value = name; document.getElementById('hvTitle').textContent = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: ${name}`; HOME_VISIT_MODAL.show(); }
        function pinForCurrentPatient() { const uid = document.getElementById('hvPatientId').value; const name = document.getElementById('hvPatientNameVal').value; if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${name} ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà?`)) return; navigator.geolocation.getCurrentPosition(p => { const latlong = `${p.coords.latitude},${p.coords.longitude}`; fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveNewLocation', data: { userId: uid, type: '‡∏ö‡πâ‡∏≤‡∏ô_‡πÇ‡∏î‡∏¢_‡∏≠‡∏™‡∏°', latlong: latlong, distance: 0, duration: 0, recorderId: LIFF_PROFILE.userId } }) }).then(() => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß"); }); }, handleFailure); }
        function submitHomeVisit(type) { const pname = document.getElementById('hvPatientNameVal').value; let data = { vhvId: LIFF_PROFILE.userId, patientName: pname, activityType: type, note: '' }; if (type === 'Advice') { let adv = []; if(document.getElementById('chkAdvice1').checked) adv.push("5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô"); if(document.getElementById('chkAdvice2').checked) adv.push("‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß"); data.note = adv.join(', ') + " : " + document.getElementById('hvNoteAdvice').value; } toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveHomeVisit', data: data }) }).then(() => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); HOME_VISIT_MODAL.hide(); toggleLoading(false); }); }
        function showQrModal() { fetch(`${WEB_APP_URL}?action=logQrShare&userId=${LIFF_PROFILE.userId}`); QR_MODAL.show(); }
    </script>
</body>
</html>