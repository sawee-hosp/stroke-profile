<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลสุขภาพ รู้ทันสโตรก by รพ.สวี</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root { --bs-primary-rgb: 13, 110, 253; }
        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 20px;
            background-color: #f0f2f5; 
            padding-top: 1rem; 
            padding-bottom: 1rem; 
            margin: 0; 
        }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1.25rem; }
        .section-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: #333; display: flex; align-items: center; }
        .section-title i { margin-right: 0.7rem; color: #0d6efd; font-size: 1.4rem; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1060; }
        .btn-call { background-color: transparent; border: 1px solid #198754; color: #198754; padding: 0.4rem 0.7rem; font-size: 1rem; line-height: 1; border-radius: 0.3rem; text-decoration: none; }
        .btn-call:hover { background-color: #198754; color: white; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .info-item { display: flex; align-items: center; font-size: 1rem; }
        .info-item i { font-size: 1.5rem; color: #0d6efd; min-width: 35px; }
        .info-item div { display: flex; flex-direction: column; }
        .info-item .label { font-size: 0.8em; color: #6c757d; }
        .bg-light-brown { background-color: #f0eade; border: 1px solid #d3c0a4; }
        .btn-copy { background: none; border: none; color: #0d6efd; padding: 0 0.5rem; }
        .details { font-size: 0.9em; color: #6c757d; }
        .flex-no-shrink { flex-shrink: 0; }
        .btn-call { white-space: nowrap; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <span id="loading-text">กำลังโหลดข้อมูล...</span>
    </div>

    <div class="container" id="main-content" style="display: none;">
        <div class="row" id="dynamic-content-container">
            </div>
        <div class="row" id="vhv-dashboard-container">
             </div>
        <div class="row" id="vhv-register-button-container">
             </div>
    </div>

    <div class="container" id="unregistered-user" style="display: none;">
        <div class="card text-center p-4">
            <div class="card-body">
                <h5 class="card-title">ไม่พบข้อมูลผู้ใช้</h5>
                <p class="card-text">กรุณาลงทะเบียนเพื่อเริ่มใช้งานระบบประเมินความเสี่ยงสโตรก</p>
                <a href="https://liff.line.me/2005789397-nebQ8oJy" class="btn btn-primary btn-lg">ลงทะเบียนครั้งแรก</a>
            </div>
        </div>
    </div>

    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">ปักหมุดตำแหน่งใหม่</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">กรุณากดปุ่มเพื่อระบุตำแหน่งปัจจุบันของคุณ ระบบจะคำนวณระยะทางและเวลาเดินทางไป รพ.สวี โดยอัตโนมัติ</p>
                    <div class="mb-3">
                        <label for="locationType" class="form-label">ประเภทตำแหน่ง</label>
                        <select class="form-select" id="locationType">
                            <option value="บ้าน">บ้าน</option>
                            <option value="ทางผ่าน">ทางผ่าน</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ปักหมุดตำแหน่งปัจจุบัน
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="vhvRegisterModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h1 class="modal-title fs-5" id="vhvRegisterModalLabel">ข้อมูล อสม.สโตรก</h1><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="vhvForm">
              <div class="mb-3">
                  <label for="vhvName" class="form-label">ชื่อ-นามสกุลจริง</label>
                  <input type="text" class="form-control" id="vhvName" required placeholder="ใช้ชื่อจริงเพื่อความน่าเชื่อถือ">
              </div>
              <div class="mb-3"><label for="vhvPhone" class="form-label">เบอร์โทรศัพท์ (10 หลัก)</label><input type="tel" class="form-control" id="vhvPhone" required pattern="[0-9]{10}"></div>
              <div class="mb-3"><label for="vhvLineId" class="form-label">LINE ID (ถ้ามี)</label><input type="text" class="form-control" id="vhvLineId"></div>
              <div class="mb-3">
                  <label for="vhvArea" class="form-label">เลือกพื้นที่ดูแล (เลือกได้หลายพื้นที่)</label>
                  <select class="form-select" id="vhvArea" multiple required size="5">
                      </select>
              </div>

            <div class="mb-3">
                <label class="form-label">ตำแหน่งบ้าน อสม. <span class="text-danger small">(ปักหมุดเมื่ออยู่ที่บ้านแล้วเท่านั้น)</span></label>
                <div class="input-group">
                    <input type="text" class="form-control" id="vhvAsmHome" placeholder="ยังไม่ได้ปักหมุด" readonly>
                    <button class="btn btn-outline-primary" type="button" onclick="pinVhvHomeInForm()"><i class="bi bi-geo-alt-fill"></i> ปักหมุดที่นี่</button>
                </div>
              </div>

              <div class="form-check"><input class="form-check-input" type="checkbox" id="vhvPdpa" checked><label class="form-check-label small" for="vhvPdpa">ข้าพเจ้ายินยอมให้ รพ.สวีเข้าถึงข้อมูล และยินยอมให้ผู้ป่วยในเขตพื้นที่ดูแลสามารถโทรศัพท์สอบถามได้</label></div>
            </form>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button><button type="button" class="btn btn-primary" onclick="handleVhvRegistration()">บันทึกข้อมูล</button></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="shareProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">เลือกข้อมูลที่จะแชร์</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">เลือกข้อมูลโปรไฟล์ อสม. ที่คุณต้องการส่งให้ผู้อื่น</p>
                    <div class="form-check fs-5">
                        <input class="form-check-input" type="checkbox" value="" id="sharePhone" checked>
                        <label class="form-check-label" for="sharePhone">
                            แชร์เบอร์โทรศัพท์
                        </label>
                    </div>
                    <div class="form-check fs-5 mt-2">
                        <input class="form-check-input" type="checkbox" value="" id="shareLine" checked>
                        <label class="form-check-label" for="shareLine">
                            แชร์ LINE
                        </label>
                    </div>
                    <div class="form-check fs-5 mt-2">
                        <input class="form-check-input" type="checkbox" value="" id="shareLocation">
                        <label class="form-check-label" for="shareLocation">
                            แชร์พิกัดบ้าน
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="handleShareProfile()"><i class="bi bi-share-fill"></i> แชร์เลย</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- Global Variables & Constants ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        const LIFF_ID_REGIS = "https://liff.line.me/2005789397-nebQ8oJy";
        const LIFF_ID_DAILY = "https://liff.line.me/2005789397-WRm1lYd9";
        const LIFF_ID_STICKER = "https://liff.line.me/2005789397-37lemBgX";
        const LIFF_ID_KNOWLEDGE = "https://liff.line.me/2005789397-ROQvjpYk";

        let LIFF_PROFILE = null;
        let ALL_USER_DATA = null;
        let DISTANCE_MODAL = null;
        let VHV_REG_MODAL = null;
        let SHARE_PROFILE_MODAL = null;
        
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', initializeLiff);

        async function initializeLiff() {
            DISTANCE_MODAL = new bootstrap.Modal(document.getElementById('distanceModal'));
            VHV_REG_MODAL = new bootstrap.Modal(document.getElementById('vhvRegisterModal'));
            SHARE_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('shareProfileModal'));
            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                if (!liff.isLoggedIn()) { liff.login(); return; } 
                
                LIFF_PROFILE = await liff.getProfile();
                fetchUserData(LIFF_PROFILE.userId);

            } catch (error) { handleFailure(error); }
        }

        // --- Data & Page Rendering ---
        function fetchUserData(userId) {
            showLoading(true, "กำลังโหลดข้อมูล...");
            fetch(`${WEB_APP_URL}?action=getUserData&userId=${userId}`)
                .then(res => res.json())
                .then(data => {
                    console.log("Server Response:", data);
                    if (data.error) throw new Error(data.error);
                    
                    if (!data.userProfile) {
                        document.getElementById('unregistered-user').style.display = 'block';
                    } else {
                        ALL_USER_DATA = data;
                        updatePage(data);
                        document.getElementById('main-content').style.display = 'block';
                    }
                })
                .catch(handleFailure)
                .finally(() => showLoading(false));
        }
        
        function updatePage(data) {
            const container = document.getElementById('dynamic-content-container');
            container.innerHTML = 
                buildProfileCard(data.userProfile) +
                buildDailyCheckCard(data.dailyCheckInfo) +
                buildCommunityLeadersCard(data.communityLeaders) +
                buildDistanceCard(data.homeDistance, data.userProfile.help) +
                buildStickerCard(data.stickerShareCount) +
                buildKnowledgeTestCard(data.knowledgeTestStats);
            
            if (data.isVhv) {
                document.getElementById('vhv-dashboard-container').innerHTML = 
                    buildVhvInfoCard(data.vhvProfile) +
                    buildVhvPatientListCard(data.vhvPatientList);
            } else {
                document.getElementById('vhv-register-button-container').innerHTML = buildVhvRegistrationButton();
            }
        }

        // --- HTML Builder Functions ---
        function buildProfileCard(p) {
            if (!p) return '';
            const riskValue = p.thai_cv_risk_score / 100;
            const riskInfo = classifyRisk(riskValue);

            const nonModifiableFactors = `
                <div class="info-item">
                    <i class="bi bi-gender-ambiguous"></i>
                    <div><span class="label">เพศ</span> <b>${p.gender == 1 ? 'ชาย' : 'หญิง'}</b></div>
                </div>
                <div class="info-item">
                    <i class="bi bi-calendar-event"></i>
                    <div><span class="label">อายุ</span> <b>${p.age || 'N/A'} ปี</b></div>
                </div>`;
            
            const modifiableFactors = `
                <div class="info-item">
                    <i class="bi bi-fire"></i>
                    <div><span class="label">สูบบุหรี่</span> <b>${p.smoke == 1 ? 'สูบ' : 'ไม่สูบ'}</b></div>
                </div>
                 <div class="info-item">
                    <i class="bi bi-bandaid"></i>
                    <div><span class="label">เบาหวาน</span> <b>${p.dm == 1 ? 'เป็น' : 'ไม่เป็น'}</b></div>
                </div>
                <div class="info-item">
                    <i class="bi bi-speedometer2"></i>
                    <div><span class="label">ความดัน (SBP)</span> <b>${p.sbp || 'N/A'} mmHg</b></div>
                </div>
                 <div class="info-item">
                    <i class="bi bi-droplet-half"></i>
                    <div><span class="label">ไขมัน (Cholesterol)</span> <b>${p.cholesterol || 'N/A'} mg/dL</b></div>
                </div>
                <div class="info-item">
                    <i class="bi bi-arrows-expand"></i>
                    <div><span class="label">รอบเอว</span> <b>${p.waist || 'N/A'} นิ้ว</b></div>
                </div>
                <div class="info-item">
                    <i class="bi bi-rulers"></i>
                    <div><span class="label">ส่วนสูง</span> <b>${p.height || 'N/A'} ซม.</b></div>
                </div>
                <div class="info-item" style="grid-column: span 2;">
                    <i class="bi bi-clipboard-plus"></i>
                    <div><span class="label">โรคประจำตัว</span> <b>${p['u/d'] || 'ไม่มี'}</b></div>
                </div>`;
            
            return `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-center text-center text-md-start mb-3">
                            <div class="d-flex align-items-center flex-column flex-md-row">
                                <img src="${p.pictureUrl || 'https://via.placeholder.com/90'}" alt="รูปโปรไฟล์" style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-right: 0; margin-bottom: 15px; margin-md-right: 20px; margin-md-bottom: 0;">
                                <div class="flex-grow-1">
                                    <h5 class="fw-bold mb-1">${p.name || 'N/A'}</h5>
                                    <div class="text-muted mb-1">โทร: ${p.telephone || 'N/A'}</div>
                                    <div class="text-muted mb-2">Line: ${p.line_id || 'N/A'}</div>
                                    <span class="badge bg-secondary fw-normal">ลงทะเบียน: ${p.timestamp ? new Date(p.timestamp).toLocaleDateString('th-TH') : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h6 class="text-center text-dark">ความเสี่ยงเกิดสโตรกที่เคยประเมิน</h6>
                        <div class="d-flex align-items-center justify-content-center mb-3">
                             <div class="text-center flex-grow-1">
                                <div style="color: ${riskInfo.color};">
                                    <div class="display-4 fw-bolder">${p.thai_cv_risk_score !== undefined ? `${p.thai_cv_risk_score}%` : 'N/A'}</div>
                                    <div class="fw-bold">${riskInfo.text}</div>
                                </div>
                            </div>
                            <a href="${LIFF_ID_REGIS}" class="btn btn-outline-primary ms-3">ประเมินใหม่</a>
                        </div>

                        <h6 class="section-title border-top pt-3"><i class="bi bi-person-slash"></i>ปัจจัยเสี่ยงที่เปลี่ยนแปลงไม่ได้</h6>
                        <div class="info-grid mb-3">${nonModifiableFactors}</div>
                        <hr>
                        <h6 class="section-title"><i class="bi bi-person-check"></i>ปัจจัยเสี่ยงที่ปรับพฤติกรรมได้</h6>
                        <div class="info-grid">${modifiableFactors}</div>
                    </div>
                </div>
            </div>`;
        }
        
        function buildDailyCheckCard(info) {
            let daysSinceCheck = '';
            if (info.latestCheckTimestamp) {
                const lastCheckDate = new Date(info.latestCheckTimestamp);
                const today = new Date();
                lastCheckDate.setHours(0,0,0,0);
                today.setHours(0,0,0,0);
                
                const diffTime = Math.abs(today - lastCheckDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 0) {
                    daysSinceCheck = `<p class="text-center text-danger small mt-3 mb-0">คุณไม่ได้ประเมินอาการมา ${diffDays} วัน</p>`;
                }
            } else {
                 daysSinceCheck = `<p class="text-center text-danger small mt-3 mb-0">คุณยังไม่เคยประเมินอาการสโตรก</p>`;
            }

            return `
                <div class="col-lg-6 col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title"><i class="bi bi-calendar-check-fill"></i>ประเมินอาการสโตรกประจำวัน</h5>
                            <div class="d-flex justify-content-around text-center mb-2">
                                <div><div class="fs-4 fw-bold text-danger">${info.symptomCount}</div><div class="small">มีอาการ</div></div>
                                <div><div class="fs-4 fw-bold text-success">${info.noSymptomCount}</div><div class="small">ไม่มีอาการ</div></div>
                            </div>
                            ${daysSinceCheck}
                            <a href="${LIFF_ID_DAILY}" class="btn btn-primary w-100 mt-3">เช็คอาการสโตรกตอนนี้</a>
                        </div>
                    </div>
                </div>`;
        }
        
        function buildCommunityLeadersCard(leaders) {
            let leaderHtml = `<p class="text-muted">ไม่พบข้อมูลผู้นำชุมชนในพื้นที่ของคุณ</p>`;
            if (leaders) {
                const pcuCallBtn = leaders.pcu_tel ? `<a href="#" onclick="trackTelCall('${leaders.pcu_tel}')" class="btn-call"><i class="bi bi-telephone-fill text-success"></i> โทร</a>` : '';
                
                const createVhvItem = (num, vhvData) => {
                    if (!vhvData.name || !vhvData.tel) return '';
                    const lineInfo = vhvData.line_id ? `Line: ${vhvData.line_id} <button class="btn-copy" onclick="copyToClipboard('${vhvData.line_id}')"><i class="bi bi-clipboard"></i></button>` : '';
                    const distanceInfo = vhvData.distance_km ? `<i class="bi bi-sign-turn-right-fill ms-2"></i> ${vhvData.distance_km} กม.` : '';
                    
                    return `<li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <b>อสม. ${num}: ${vhvData.name}</b>
                            <a href="#" onclick="trackTelCall('${vhvData.tel}')" class="btn-call"><i class="bi bi-telephone-fill text-success"></i> โทร</a>
                        </div>
                        <div class="details mt-1">${lineInfo} ${distanceInfo}</div>
                    </li>`;
                };

                let vhvItems = createVhvItem(1, {name: leaders.volunteer1, tel: leaders.volunteer1_tel, line_id: leaders.volunteer1_line_id, distance_km: leaders.volunteer1_distance_km});
                vhvItems += createVhvItem(2, {name: leaders.volunteer2, tel: leaders.volunteer2_tel, line_id: leaders.volunteer2_line_id, distance_km: leaders.volunteer2_distance_km});
                
                leaderHtml = `<ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center"><span>รพ.สต.: ${leaders.pcu || 'N/A'}</span> ${pcuCallBtn}</li>
                    ${vhvItems}
                </ul>`;
            }
            return `
                <div class="col-lg-6 col-12">
                    <div class="card"><div class="card-body">
                        <h5 class="section-title"><i class="bi bi-person-hearts"></i>อสม.สโตรกของฉัน</h5>
                        ${leaderHtml}
                    </div></div>
                </div>`;
        }

        function buildDistanceCard(distanceInfo, helpText) {
            let historyHtml = '<p class="text-muted">ไม่พบประวัติการปักหมุดตำแหน่ง "บ้าน"</p>';
            let cardClass = 'card';
            let analysisHtml = '';

            if (distanceInfo) {
                const durationMins = parseInt(distanceInfo.duration, 10);
                if (durationMins < 120) cardClass += ' bg-success-subtle';
                else if (durationMins < 210) cardClass += ' bg-warning-subtle';
                else cardClass += ' bg-danger-subtle';

                historyHtml = `<p class="mb-1"><strong>ระยะทางจากบ้าน:</strong> ${parseFloat(distanceInfo.distance).toFixed(1)} กม.</p>
                               <p><strong>ใช้เวลาเดินทาง:</strong> ${formatDuration(durationMins)}</p>`;
                
                const travelTimeHours = durationMins / 60;
                if (travelTimeHours * 2 > 3.5) {
                    analysisHtml = `<p class="small mb-1"><b>วิเคราะห์:</b> ด้วยระยะทางนี้หากท่านรอรถ รพ. ไปรับ อาจทำให้มารับยาไม่ทัน <b>โปรดวางแผนการเดินทางสำรองในกรณีฉุกเฉินด้วย</b></p>`;
                } else {
                     analysisHtml = `<p class="small mb-1"><b>วิเคราะห์:</b> ท่านสามารถเรียกรถ รพ. ไปรับได้ อย่างไรก็ตามควรวางแผนสำรองในกรณีฉุกเฉินด้วย</p>`;
                }
                analysisHtml += `<p class="small"><b>วิธีเดินทางที่วางแผนไว้:</b> ${helpText || 'ไม่ได้ระบุ'}</p>`;
            }

            return `
                <div class="col-lg-6 col-12">
                    <div class="${cardClass}">
                        <div class="card-body">
                            <h5 class="section-title"><i class="bi bi-hospital-fill"></i>ระยะทางไป รพ.สวี</h5>
                            ${historyHtml}
                            <p class="small text-danger fst-italic mt-2">"การรับยาละลายลิ่มเลือด (rT-PA) มีความสำคัญอย่างยิ่ง และต้องได้รับภายใน 4.5 ชั่วโมงหลังเกิดอาการ"</p>
                            <div class="border-top pt-2 mt-2">${analysisHtml}</div>
                            <button type="button" class="btn btn-secondary w-100 mt-2" onclick="DISTANCE_MODAL.show()">
                                <i class="bi bi-pin-map-fill"></i> ปักหมุดใหม่
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        
        function buildStickerCard(count) {
            const message = count > 10 ? '<p class="text-center small mt-2">คุณคือนักส่งสติกเกอร์ตัวยง และเป็นนักเผยแพร่ความรู้ ให้คนตระหนักในโรคสโตรก สุดยอดจริงๆ!</p>' : '';
            return `
                <div class="col-lg-6 col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title"><i class="bi bi-send-check-fill"></i>ส่งสติกเกอร์ประจำวัน</h5>
                            <p class="text-center mb-0">ส่งแล้ว <strong class="fs-4 mx-1">${count || 0}</strong> ครั้ง</p>
                            ${message}
                            <a href="${LIFF_ID_STICKER}" class="btn btn-info w-100 text-white mt-3">ส่งสติกเกอร์ตอนนี้</a>
                        </div>
                    </div>
                </div>`;
        }
        
        function buildKnowledgeTestCard(stats) {
             return `
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="section-title"><i class="bi bi-patch-question-fill"></i>ทดสอบความรู้สโตรก</h5>
                             <div class="d-flex justify-content-around text-center mb-3">
                                <div><div class="fs-4 fw-bold">${stats.testCount}</div><div class="small">ทดสอบแล้ว (ครั้ง)</div></div>
                                <div><div class="fs-4 fw-bold">${stats.maxScore}</div><div class="small">คะแนนสูงสุด</div></div>
                            </div>
                            <a href="${LIFF_ID_KNOWLEDGE}" class="btn btn-success w-100">ทำแบบทดสอบตอนนี้</a>
                        </div>
                    </div>
                </div>`;
        }

        function buildVhvInfoCard(vhv) {
            const testStatus = vhv.asm_test 
                ? `<span class="text-success">คะแนนสอบ: ${vhv.asm_test}</span> <a href="${LIFF_ID_KNOWLEDGE}" class="ms-2">สอบใหม่</a>` 
                : `<a href="${LIFF_ID_KNOWLEDGE}" class="btn btn-sm btn-info text-white">ทำแบบทดสอบ อสม.</a>`;
            
            return `<div class="col-12"><div class="card bg-light-brown"><div class="card-body">
                <h5 class="section-title"><i class="bi bi-person-badge"></i>แดชบอร์ด อสม.สโตรก</h5>
                <p class="mb-1"><b>ชื่อ:</b> ${vhv.name}</p>
                <p class="mb-1"><b>พื้นที่ดูแล:</b> ${vhv.area || 'ยังไม่ระบุ'}</p>
                <p><b>โทร:</b> ${vhv.phone} | <b>Line:</b> ${vhv.line_id || 'N/A'}</p>
                <div class="text-center my-3"><b>สถานะทดสอบ:</b> ${testStatus}</div>
                
                <button class="btn btn-primary w-100" onclick="SHARE_PROFILE_MODAL.show()">
                    <i class="bi bi-share-fill"></i> แชร์โปรไฟล์ อสม.สโตรกของฉัน
                </button>
                <button class="btn btn-secondary w-100 mt-2" onclick="openVhvModal()">แก้ไขข้อมูล</button>

            </div></div></div>`;
        }

function buildVhvPatientListCard(patients) {
            if (!patients || patients.length === 0) return '';
            
            let patientItems = patients.map(p => {
                const riskInfo = classifyRisk(p.thai_cv_risk_score/100);
                const lineInfo = p.line_id ? `Line: ${p.line_id} <button class="btn-copy" onclick="copyToClipboard('${p.line_id}')"><i class="bi bi-clipboard"></i></button>` : '';

                // --- ส่วนที่แก้ไข ---
                let distanceHtml = '';
                if (p.distanceFromVhv_km && p.latlong) {
                    // เปลี่ยนจาก span เป็น a (ลิงก์)
                    distanceHtml = `<a href="https://www.google.com/maps/dir/?api=1&destination=${p.latlong}" target="_blank" class="ms-2 text-decoration-none">
                        <span class="badge bg-secondary"><i class="bi bi-geo-alt-fill"></i> ${p.distanceFromVhv_km} กม.</span>
                    </a>`;
                }
                // --- จบส่วนที่แก้ไข ---

                let lastCheckHtml = '<small class="text-muted d-block">ยังไม่เคยเช็คอาการ</small>';
                if (p.latestCheckTimestamp) {
                    const lastCheckDate = new Date(p.latestCheckTimestamp);
                    const today = new Date();
                    const diffTime = Math.abs(today - lastCheckDate);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        lastCheckHtml = '<small class="text-success d-block">เช็คอาการวันนี้แล้ว</small>';
                    } else {
                        lastCheckHtml = `<small class="text-danger d-block">เช็คล่าสุด: ${diffDays} วันที่แล้ว</small>`;
                    }
                }

                return `<li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                       <div>
                           <h6 class="mb-0 fw-bold">${p.name} (${p.gender == 1 ? 'ช' : 'ญ'}, ${p.age} ปี) ${distanceHtml}</h6>
                           <small style="color:${riskInfo.color}; font-weight: 600;">เสี่ยง ${p.thai_cv_risk_score}% (${riskInfo.text})</small>
                           ${lastCheckHtml}
                       </div>
                       <div class="flex-no-shrink">
                           <a href="#" onclick="trackTelCall('${p.telephone}')" class="btn-call"><i class="bi bi-telephone-fill text-success"></i> โทร</a>
                       </div>
                    </div>
                    <div class="details mt-1">${lineInfo}</div>
                </li>`;
            }).join('');

            return `<div class="col-12"><div class="card bg-light-brown"><div class="card-body">
                <h5 class="section-title"><i class="bi bi-people-fill"></i>ผู้ป่วยในความรับผิดชอบ (${patients.length} คน)</h5>
                <ul class="list-group list-group-flush">${patientItems}</ul>
            </div></div></div>`;
        }

        function buildVhvRegistrationButton() {
            return `
                 <div class="col-12 mt-3">
                    <div class="card">
                        <div class="card-body text-center p-3">
                            <button class="btn btn-lg btn-warning" onclick="openVhvModal()">
                                <i class="bi bi-person-plus-fill"></i> ลงทะเบียน อสม.สโตรก
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        // --- Event Handlers & Modal Functions ---
        function handlePinNewLocation() {
            const type = document.getElementById('locationType').value;
            showLoading(true, "กำลังระบุตำแหน่ง...");

            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const latlong = `${lat},${lon}`;
                showLoading(true, "กำลังคำนวณระยะทาง...");

                fetch(`${WEB_APP_URL}?action=calculateDistance&lat=${lat}&lon=${lon}`)
                    .then(res => res.json()).then(distanceData => {
                        if (distanceData.error) throw new Error(distanceData.error);
                        
                        showLoading(true, "กำลังบันทึกข้อมูล...");
                        return fetch(WEB_APP_URL, {
                            method: 'POST', mode: 'no-cors',
                            body: JSON.stringify({ action: 'saveNewLocation', data: {
                                userId: LIFF_PROFILE.userId, type: type, latlong: latlong,
                                distance: distanceData.distance_km, duration: distanceData.duration_mins
                            }})
                        });
                    }).then(() => {
                        alert("บันทึกตำแหน่งสำเร็จ! กำลังโหลดข้อมูลใหม่");
                        window.location.reload();
                    }).catch(handleFailure);
            }, err => { handleFailure(new Error("ไม่สามารถเข้าถึงตำแหน่งได้: " + err.message)); }, { enableHighAccuracy: true });
        }
        
        function openVhvModal() {
            document.getElementById('vhvForm').reset();
            const vhvData = ALL_USER_DATA.vhvProfile || {};
            const userData = ALL_USER_DATA.userProfile || {};
            
            document.getElementById('vhvRegisterModalLabel').textContent = ALL_USER_DATA.isVhv ? 'แก้ไขข้อมูล อสม.สโตรก' : 'ลงทะเบียน อสม.สโตรก';
            document.getElementById('vhvName').value = vhvData.name || userData.name ||'';
            document.getElementById('vhvPhone').value = vhvData.phone || userData.telephone || '';
            document.getElementById('vhvLineId').value = vhvData.line_id || userData.line_id || '';
            document.getElementById('vhvAsmHome').value = vhvData.asm_home || '';
            document.getElementById('vhvAsmHome').value = vhvData.asm_home || ''; // <-- เพิ่มบรรทัดนี้
            document.getElementById('vhvPdpa').checked = true;
            const areaSelect = document.getElementById('vhvArea');
            areaSelect.innerHTML = ''; 
            const currentAreas = vhvData.area ? vhvData.area.split(',') : [];
            const availableAreas = new Set([...ALL_USER_DATA.availableVhvAreas, ...currentAreas]); // Combine available and current

            availableAreas.forEach(area => {
                if(area) {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    if(currentAreas.includes(area)) {
                        option.selected = true;
                    }
                    areaSelect.appendChild(option);
                }
            });
            
            VHV_REG_MODAL.show();
        }

        function handleVhvRegistration() {
            const form = document.getElementById('vhvForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            
            const selectedAreas = Array.from(document.getElementById('vhvArea').selectedOptions).map(opt => opt.value);
            if(selectedAreas.length === 0){
                alert("กรุณาเลือกพื้นที่ดูแลอย่างน้อย 1 พื้นที่");
                return;
            }

            showLoading(true, "กำลังบันทึกข้อมูล...");
            const pdpaCheckbox = document.getElementById('vhvPdpa');
            const pdpaText = pdpaCheckbox.checked ? pdpaCheckbox.nextElementSibling.textContent : "";

            const registrationData = {
                userId: LIFF_PROFILE.userId,
                displayName: LIFF_PROFILE.displayName,
                profilePicture: LIFF_PROFILE.pictureUrl,
                name: document.getElementById('vhvName').value.trim(),
                phone: document.getElementById('vhvPhone').value.trim(),
                line_id: document.getElementById('vhvLineId').value.trim(),
                areas: selectedAreas,
              pdpa: pdpaText,
                asm_home: document.getElementById('vhvAsmHome').value.trim(), // <-- เพิ่มบรรทัดนี้
                asm_test: ALL_USER_DATA.vhvProfile?.asm_test || '',
            };

            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action: 'registerVhv', data: registrationData })
            }).then(() => {
                VHV_REG_MODAL.hide();
                alert("บันทึกข้อมูลสำเร็จ! กรุณาเปิดหน้านี้ใหม่อีกครั้ง");
                window.location.reload(); 
            }).catch(handleFailure);
        }

        function pinVhvHomeInForm() {
            if (!confirm("คุณอยู่ที่บ้านพักของคุณแล้วใช่หรือไม่?")) return;
            showLoading(true, "กำลังระบุตำแหน่ง...");
            navigator.geolocation.getCurrentPosition(pos => {
                const latlong = `${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('vhvAsmHome').value = latlong;
                showLoading(false);
                alert("ปักหมุดสำเร็จ! กรุณากด 'บันทึกข้อมูล' เพื่อยืนยัน");
            }, err => { handleFailure(new Error("ไม่สามารถเข้าถึงตำแหน่งได้: " + err.message)); }, { enableHighAccuracy: true });
        }
function pinVhvHomeInForm() {
            if (!confirm("คุณอยู่ที่บ้านพักของคุณแล้วใช่หรือไม่?")) return;
            showLoading(true, "กำลังระบุตำแหน่ง...");
            navigator.geolocation.getCurrentPosition(pos => {
                const latlong = `${pos.coords.latitude},${pos.coords.longitude}`;
                document.getElementById('vhvAsmHome').value = latlong;
                showLoading(false);
                alert("ปักหมุดสำเร็จ! กรุณากด 'บันทึกข้อมูล' เพื่อยืนยันการเปลี่ยนแปลง");
            }, err => { handleFailure(new Error("ไม่สามารถเข้าถึงตำแหน่งได้: " + err.message)); }, { enableHighAccuracy: true });
        }
async function handleShareProfile() {
            // ไม่ต้องเช็ค liff.isInClient() เพื่อให้ทดสอบบนเว็บได้
            const vhv = ALL_USER_DATA.vhvProfile;
            if (!vhv) {
                alert("ไม่พบข้อมูล อสม. ที่จะแชร์");
                return;
            }
            
            const sharePhone = document.getElementById('sharePhone').checked;
            const shareLine = document.getElementById('shareLine').checked;
            const shareLocation = document.getElementById('shareLocation').checked;
            
            const footerButtons = [];

            if (sharePhone && vhv.phone) {
                const cleanPhone = String(vhv.phone).replace(/'/g, '');
                footerButtons.push({
                    "type": "button", "action": { "type": "uri", "label": "โทรศัพท์", "uri": `tel:${cleanPhone}` },
                    "style": "primary", "height": "sm", "color": "#FFC107"
                });
            }
            if (shareLine && vhv.line_id) {
                footerButtons.push({
                    "type": "button", "action": { "type": "uri", "label": "เพิ่มเพื่อน LINE", "uri": `https://line.me/R/ti/p/~${vhv.line_id}` },
                    "style": "primary", "height": "sm", "color": "#FFC107"
                });
            }
            if (shareLocation && vhv.asm_home) {
                footerButtons.push({
                    "type": "button", "action": { 
                        "type": "uri", 
                        "label": "ดูแผนที่", 
                        "uri": `https://www.google.com/maps?q=${vhv.asm_home}`},
                    "style": "primary", "height": "sm", "color": "#FFC107"
                });
            }

            if (footerButtons.length > 0) {
                 footerButtons.push({ "type": "separator", "margin": "md", "color": "#FFFFFF" });
            }
            footerButtons.push({
                "type": "text", "text": "แชร์จาก สวีรู้ทันสโตรก", "color": "#FFFFFF",
                "size": "xs", "align": "center", "margin": "md"
            });
            
            const flexMessage = {
                "type": "flex",
                "altText": `ข้อมูลติดต่อ อสม.สโตรก: ${vhv.name}`,
                "contents": {
                    "type": "bubble",
                    "size": "kilo",
                     "body": {
                        "type": "box",
                        "layout": "vertical",
                        "paddingAll": "20px",
                        "backgroundColor": "#007BFF",
                        "spacing": "md",
                        "contents": [
                            {
                                "type": "text",
                                "text": "อสม.สโตรกของคุณ",
                                "weight": "bold",
                                "color": "#FFFFFF",
                                "size": "xl",
                                "align": "center"
                            },
                            // --- vvv ส่วนที่แก้ไข vvv ---
                            {
                                "type": "box", // 1. สร้างกล่องใหม่ขึ้นมาครอบ
                                "layout": "vertical",
                                "alignItems": "center", // 2. สั่งให้ของข้างในกล่องนี้อยู่กึ่งกลาง
                                "margin": "lg",
                                "contents": [
                                    { // นี่คือกล่องรูปภาพเดิม
                                        "type": "box",
                                        "layout": "vertical",
                                        "cornerRadius": "150px",
                                        "width": "150px",
                                        "height": "150px",
                                        "contents": [{
                                            "type": "image",
                                            "url": vhv.profilePicture || 'https://scdn.line-apps.com/n/channel_devcenter/img/fx/01_1_cafe.png',
                                            "size": "full",
                                            "aspectMode": "cover",
                                            "aspectRatio": "1:1"
                                        }]
                                    }
                                ]
                            },
                            // --- ^^^ สิ้นสุดส่วนที่แก้ไข ^^^ ---
                            {
                                "type": "box", // กล่องข้อความจะกลับไปชิดซ้ายเหมือนเดิม
                                "layout": "vertical",
                                "margin": "lg",
                                "spacing": "sm",
                                "contents": [
                                    { "type": "text", "text": vhv.name || "ไม่มีข้อมูล", "weight": "bold", "size": "xl", "color": "#FFFFFF", "align": "center" },
                                    { "type": "separator", "margin": "lg", "color": "#FFFFFF" },
                                    { "type": "box", "layout": "horizontal", "contents": [
                                        { "type": "text", "text": "พื้นที่ดูแล:", "color": "#FFFFFF", "size": "sm", "flex": 2 },
                                        { "type": "text", "text": vhv.area || "ไม่มีข้อมูล", "color": "#FFFFFF", "size": "sm", "flex": 3, "wrap": true, "align": "end" }
                                    ]},
                                    { "type": "box", "layout": "horizontal", "contents": [
                                        { "type": "text", "text": "ผลทดสอบ:", "color": "#FFFFFF", "size": "sm", "flex": 2 },
                                        { "type": "text", "text": vhv.asm_test || "ยังไม่ทดสอบ", "color": "#FFFFFF", "size": "sm", "flex": 3, "align": "end" }
                                    ]},
                                    { "type": "box", "layout": "horizontal", "contents": [
                                        { "type": "text", "text": "ลงทะเบียน:", "color": "#FFFFFF", "size": "sm", "flex": 2 },
                                        { "type": "text", "text": vhv.date_regist ? new Date(vhv.date_regist).toLocaleDateString('th-TH') : "ไม่มีข้อมูล", "color": "#FFFFFF", "size": "sm", "flex": 3, "align": "end" }
                                    ]}
                                ]
                            }
                        ]
                        // **ลบ alignItems: "center" ออกจาก body หลักแล้ว**
                    },
                    "footer": {
                        "type": "box",
                        "layout": "vertical",
                        "spacing": "sm",
                        "contents": footerButtons,
                        "backgroundColor": "#007BFF",
                        "paddingAll": "md"
                    }
                }
            };
            
            console.log("Generated Flex Message JSON:", JSON.stringify(flexMessage, null, 2));

            try {
                SHARE_PROFILE_MODAL.hide();
                await liff.shareTargetPicker([flexMessage]);
            } catch (error) {
                handleFailure(new Error("ไม่สามารถแชร์ได้: " + error.message));
                alert("ไม่สามารถแชร์ได้ โปรดตรวจสอบ Console Log สำหรับข้อมูลเพิ่มเติม");
            }
        }

        // --- Utility Functions ---
        function trackTelCall(tel) {
            if (!tel) return;
            const cleanTel = String(tel).replace(/'/g, ''); 
            if (confirm(`คุณต้องการโทรออกไปยังหมายเลข ${cleanTel} หรือไม่?`)) {
                fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'logTelCall', data: { userId: LIFF_PROFILE.userId, tel: cleanTel } })
                }).catch(err => console.error('Failed to log call:', err));
                
                window.location.href = 'tel:' + cleanTel;
            }
        }

        function copyToClipboard(text) {
            if(!text) return;
            navigator.clipboard.writeText(text).then(() => {
                alert("คัดลอก Line ID แล้ว: " + text);
            }).catch(err => {
                alert("ไม่สามารถคัดลอกได้");
                console.error('Could not copy text: ', err);
            });
        }

        function classifyRisk(risk) {
            if (risk < 0.10) return { text: "เสี่ยงต่ำ", color: "#28a745" };
            if (risk < 0.20) return { text: "เสี่ยงปานกลาง", color: "#ffc107" };
            if (risk < 0.30) return { text: "เสี่ยงสูง", color: "#fd7e14" };
            if (risk < 0.40) return { text: "เสี่ยงสูงมาก", color: "#dc3545" };
            return { text: "เสี่ยงอันตราย", color: "#8B0000" };
        }

        function formatDuration(minutes) {
            if (!minutes || minutes < 1) return "N/A";
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            let result = '';
            if (h > 0) result += `${h} ชั่วโมง `;
            if (m > 0) result += `${m} นาที`;
            return result.trim() || 'น้อยกว่า 1 นาที';
        }

        function showLoading(show, text = "กำลังโหลด...") { 
            const loader = document.getElementById('loading');
            loader.style.display = show ? 'flex' : 'none';
            document.getElementById('loading-text').textContent = text;
        }

        function handleFailure(err) {
            const message = err.message || JSON.stringify(err);
            console.error("Operation Failed:", message, err.stack);
            alert("เกิดข้อผิดพลาด: " + message);
            showLoading(false);
        }
    </script>
</body>
</html>