<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stroke Awareness App</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* =========================================
           THEME & TYPOGRAPHY
           ========================================= */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            --vhv-bg: #ffc107; 
            --vhv-dark: #b88a00; 
            --base-size: 16px; 
            --primary-color: #ff3654;
        }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 1rem; 
            background: #f0f2f5;
            margin: 0; 
            padding-bottom: 5rem; 
            padding-top: 70px; /* Space for fixed tabs */
        }
        
        /* --- VHV Mode Theme --- */
        body.vhv-mode {
            background: #fff9e6;
        }

        h1, h2, h3, h4, h5 { font-weight: 700 !important; }
        
        /* Fixed Tabs Container */
        .nav-tabs-container {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 1000;
            background-color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            padding: 5px 10px 0 10px;
        }

        .nav-tabs { 
            border-bottom: none; 
            justify-content: center; 
            width: 100%;
            display: flex;
            gap: 10px;
        }

        .nav-item {
            flex: 1;
            text-align: center;
        }

        .nav-link { 
            font-size: 1.1rem; 
            color: #999; 
            border: none; 
            border-radius: 15px 15px 0 0 !important; /* Rounded Top */
            margin: 0; 
            padding: 12px 0; 
            font-weight: 700; 
            background: transparent;
            width: 100%;
            transition: all 0.3s;
        }

        .nav-link.active { 
            color: #fff !important; 
            background: var(--primary-color) !important;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        /* VHV Tab Active Color */
        body.vhv-mode .nav-tabs-container .nav-link.active#vhv-tab-btn {
            background: #FFD700 !important;
            color: #000 !important;
        }

        /* Card Styles */
        .card { 
            border: none; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            margin-bottom: 1rem; 
            border-radius: 16px; 
            background: white;
            overflow: hidden; 
        }

        .section-title { 
            font-size: 1.3rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            color: #333; 
            display: flex; 
            align-items: center; 
        }

        .section-title i { 
            margin-right: 0.8rem; 
            color: var(--primary-color); 
            font-size: 1.5rem; 
        }

        /* Circular Buttons (Perfect Circle) */
        .btn-circle {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .btn-circle i { font-size: 1.2rem; }

        /* Game Score Box */
        .game-score-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #eee;
        }

        .game-score-box { 
            background: #fff; 
            border-radius: 12px; 
            padding: 10px 5px; 
            text-align: center; 
            border: 1px solid #eee; 
            height: 100%; 
            cursor: pointer; 
            transition: all 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .game-score-box:active { transform: scale(0.95); background: #f0f0f0; }
        .game-score-box h3 { margin: 5px 0; font-weight: 800; color: var(--primary-color); font-size: 1.8rem; }
        .game-score-box span { font-size: 0.85rem; color: #666; font-weight: 600; }
        
        /* Level Progress Bar */
        .level-progress {
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        .level-progress-bar {
            background: linear-gradient(90deg, #ffc107, #ff3654);
            height: 100%;
        }

        /* Profile Image */
        .profile-img-lg { 
            width: 80px; 
            height: 80px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid #f8f9fa; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }

        /* Risk Grid */
        .info-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 0.8rem; 
            margin-top: 10px; 
        }
        
        .info-item { 
            background-color: #f8f9fa; 
            border-radius: 12px; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            text-align: center;
            font-size: 0.9rem; 
        }
        
        .info-item i { font-size: 1.5rem; color: #888; margin-bottom: 5px; }
        .info-item .label { font-size: 0.75rem; color: #888; }
        .info-item b { font-size: 1rem; color: #333; }

        /* Emergency Graphic */
        .emergency-graphic-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            position: relative;
        }
        .emergency-icon { font-size: 2.5rem; color: #dc3545; z-index: 2; background: white; }
        .emergency-arrow-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin: 0 10px;
        }
        .emergency-arrow-line {
            height: 4px;
            background: #dc3545;
            width: 100%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        .emergency-arrow-head {
            position: absolute;
            right: -2px;
            top: 50%;
            transform: translateY(-50%);
            width: 0; 
            height: 0; 
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 10px solid #dc3545;
            z-index: 1;
        }
        .emergency-text {
            background: white;
            padding: 2px 8px;
            font-size: 0.8rem;
            color: #dc3545;
            font-weight: bold;
            z-index: 2;
            border: 1px solid #dc3545;
            border-radius: 10px;
            margin-bottom: 5px;
        }

        /* Leaderboard */
        .leaderboard-card { border: none; background: #fff; box-shadow: none; border-radius: 10px; }
        .leaderboard-row { display: flex; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .leaderboard-rank { font-weight: 900; width: 25px; text-align: center; color: var(--primary-color); }
        .leaderboard-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
        
        /* Floating Edit Button */
        .edit-mini-btn {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: #eee;
            color: #333;
            border: none;
            cursor: pointer;
        }

        /* Loading Overlay */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: #333;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-3 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>

    <!-- Fixed Header Tabs -->
    <div class="nav-tabs-container">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="health-tab-btn" data-bs-toggle="tab" data-bs-target="#health-tab-content">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vhv-tab-btn" data-bs-toggle="tab" data-bs-target="#vhv-tab-content">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°.</button>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="container" style="padding: 0 15px;">
        <div class="tab-content">
            
            <!-- Tab 1: Health Information -->
            <div class="tab-pane fade show active" id="health-tab-content">
                <div id="dynamic-content-container" style="padding-top: 15px;">
                     <!-- Initial Loading -->
                     <div class="text-center py-5">
                         <div class="spinner-border text-secondary" role="status"></div>
                     </div>
                </div>
            </div>
            
            <!-- Tab 2: VHV Dashboard -->
            <div class="tab-pane fade" id="vhv-tab-content">
                <div id="vhv-dashboard-area" style="padding-top: 15px;">
                    <!-- Initial Loading -->
                     <div class="text-center py-5">
                         <div class="spinner-border text-warning" role="status"></div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Call Permission Modal -->
    <div class="modal fade" id="callPermissionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="mb-3 text-warning"><i class="bi bi-shield-lock-fill" style="font-size: 3rem;"></i></div>
                    <h5>‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</h5>
                    <p class="text-muted small">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤‡∏ô‡∏Å‡∏î‡πÇ‡∏ó‡∏£ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏£‡∏≤‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡πà‡∏≤‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>
                    <div class="p-3 bg-light rounded mb-3 text-start">
                        <div><small class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏ó‡∏£‡∏´‡∏≤:</small> <span id="callTargetName" class="fw-bold">...</span></div>
                        <div><small class="text-muted">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</small> <span id="callTargetPhone">...</span></div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-light w-100 py-2" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary w-100 py-2" onclick="confirmCall()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏ó‡∏£</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Emergency Single Field Modal -->
    <div class="modal fade" id="editEmergencyFieldModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEmTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editEmFieldType">
                    <select class="form-select form-select-lg mb-3" id="editEmSelect"></select>
                    <button class="btn btn-primary w-100" onclick="saveEmergencyField()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals (Re-used structure) -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control" id="editName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" class="form-control" id="editPhone" pattern="[0-9]{10}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" onclick="saveUserProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VHV Registration Modal -->
    <div class="modal fade" id="vhvRegisterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vhvForm">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control" id="vhvName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" class="form-control" id="vhvPhone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select" id="vhvDistrict" onchange="updateVillages()">
                                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="vhvVillage" disabled>
                                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-danger">üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô ‡∏≠‡∏™‡∏°.</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="vhvAsmHome" placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î" readonly>
                                <button class="btn btn-outline-danger" type="button" onclick="pinVhvHomeInForm()">
                                    <i class="bi bi-geo-alt-fill"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-warning w-100" onclick="handleVhvRegistration()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Distance Modal (Pin Location) -->
    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</p>
                    <button class="btn btn-primary w-100 py-3" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        
        // Links
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };
        
        const SAWEE_LOCATIONS = { "‡∏ô‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå": 8, "‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏≤": 5, "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÉ‡∏ï‡πâ": 3, "‡∏î‡πà‡∏≤‡∏ô‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡πà‡∏≤‡∏´‡∏¥‡∏ô": 3, "‡∏õ‡∏≤‡∏Å‡πÅ‡∏û‡∏£‡∏Å": 4, "‡∏Ñ‡∏£‡∏ô": 4, "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": 3, "‡∏ô‡∏≤‡∏™‡∏±‡∏Å": 3, "‡πÄ‡∏Ç‡∏≤‡∏ó‡∏∞‡∏•‡∏∏": 3 };
        
        let LIFF_PROFILE = null;
        let ALL_USER_DATA = null;
        let CALL_DATA = {}; // Store temp call data
        
        // Modals
        let CALL_MODAL, EDIT_PROFILE_MODAL, EDIT_EM_MODAL, VHV_REG_MODAL, DISTANCE_MODAL;

        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            CALL_MODAL = new bootstrap.Modal(document.getElementById('callPermissionModal'));
            EDIT_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('editProfileModal'));
            EDIT_EM_MODAL = new bootstrap.Modal(document.getElementById('editEmergencyFieldModal'));
            VHV_REG_MODAL = new bootstrap.Modal(document.getElementById('vhvRegisterModal'));
            DISTANCE_MODAL = new bootstrap.Modal(document.getElementById('distanceModal'));

            // Tab Listeners
            document.getElementById('health-tab-btn').addEventListener('shown.bs.tab', () => document.body.classList.remove('vhv-mode'));
            document.getElementById('vhv-tab-btn').addEventListener('shown.bs.tab', () => document.body.classList.add('vhv-mode'));

            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                LIFF_PROFILE = await liff.getProfile();
                
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref') || '';
                
                // Fetch Data
                const res = await fetch(`${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}&ref=${refCode}`).then(r => r.json());
                
                if (res.error) throw new Error(res.error);
                ALL_USER_DATA = res;
                updatePage(res);
                
            } catch (err) { alert("Error: " + err.message); }
        });

        function updatePage(data) {
            // Health Tab
            const hContainer = document.getElementById('dynamic-content-container');
            if (hContainer) {
                if (!data.userProfile) {
                    hContainer.innerHTML = `<div class="text-center p-5"><h3 class="mb-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><a href="${LINKS.REGIS}" class="btn btn-primary rounded-pill px-5">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></div>`;
                } else {
                    hContainer.innerHTML = 
                        buildProfileHeadCard(data.userProfile) +
                        buildGamificationCard(data.gamification) +
                        buildRiskCard(data.userProfile) +
                        buildEmergencyCard(data.homeDistance, data.gamification.details || {}) +
                        buildCommunityLeadersCard(data.communityLeaders) +
                        // Anchor targets
                        `<div id="card-daily">${buildDailyCheckCard(data.dailyCheckInfo)}</div>` +
                        `<div id="card-sticker">${buildStickerCard(data.stickerShareCount)}</div>` +
                        `<div id="card-knowledge">${buildKnowledgeTestCard(data.knowledgeTestStats)}</div>`;
                }
            }

            // VHV Tab
            const vContainer = document.getElementById('vhv-dashboard-area');
            if (vContainer) {
                if (data.isVhv) {
                    vContainer.innerHTML = 
                        buildTopVhvCard(data.vhvDashboard?.totalVhv, data.vhvDashboard?.topVhvs) +
                        buildVhvInfoCard(data.vhvProfile) +
                        buildVhvLeaderboards(data.vhvDashboard?.leaderboards) +
                        buildVhvPatientListCard(data.vhvDashboard?.patientList);
                } else {
                    vContainer.innerHTML = 
                        buildTopVhvCard(data.vhvDashboard?.totalVhv, data.vhvDashboard?.topVhvs) +
                        buildVhvRegistrationButton();
                }
            }
        }

        // --- COMPONENTS ---

        function buildProfileHeadCard(p) {
            const dateStr = p.timestamp ? new Date(p.timestamp).toLocaleDateString('th-TH', {day:'numeric', month:'short', year:'2-digit'}) : '-';
            return `
            <div class="card p-3 d-flex flex-row align-items-center">
                <img src="${p.pictureUrl}" class="profile-img-lg me-3">
                <div class="flex-grow-1">
                    <h5 class="mb-0 fw-bold">${p.name}</h5>
                    <div class="text-muted small"><i class="bi bi-telephone"></i> ${p.telephone}</div>
                    <span class="badge bg-secondary rounded-pill mt-1 fw-normal">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${dateStr}</span>
                </div>
                <button class="btn btn-light btn-circle shadow-sm" onclick="openEditProfile()">
                    <i class="bi bi-pencil-square text-primary"></i>
                </button>
            </div>`;
        }

        function buildGamificationCard(s) {
            const levels = [
                { name: '‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•‡∏™‡πÇ‡∏ï‡∏£‡∏Å', max: 20 },
                { name: '‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏™‡πÇ‡∏ï‡∏£‡∏Å', max: 40 },
                { name: '‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏™‡πÇ‡∏ï‡∏£‡∏Å', max: 60 },
                { name: '‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏™‡πÇ‡∏ï‡∏£‡∏Å', max: 100 }
            ];
            
            let currentLevel = levels[3];
            let nextLevelScore = 100;
            
            for(let l of levels) {
                if(s.totalScore <= l.max) { currentLevel = l; nextLevelScore = l.max; break; }
            }
            
            const progress = Math.min(100, (s.totalScore / nextLevelScore) * 100);

            return `
            <div class="card">
                <div class="card-body">
                    <h5 class="section-title mb-2 text-primary">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h5>
                    
                    <div class="d-flex justify-content-between align-items-end mb-1">
                        <div>
                            <span class="display-4 fw-bold text-primary">${s.totalScore}</span>
                            <span class="text-muted">/ ${nextLevelScore}</span>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-warning text-dark mb-1">${currentLevel.name}</div>
                            <div class="small text-muted">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${s.rank} ‡∏à‡∏≤‡∏Å ${s.totalUsers}</div>
                        </div>
                    </div>
                    
                    <div class="level-progress">
                        <div class="level-progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div class="text-end small text-muted mb-3">‡∏≠‡∏µ‡∏Å ${(nextLevelScore - s.totalScore).toFixed(1)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö</div>

                    <div class="row g-2">
                        <div class="col-3" onclick="scrollToId('card-daily')">
                            <div class="game-score-box"><h3>${s.checkScore}</h3><span>‡πÉ‡∏™‡πà‡πÉ‡∏à</span></div>
                        </div>
                        <div class="col-3" onclick="DISTANCE_MODAL.show()">
                            <div class="game-score-box"><h3>${s.emergencyScore}</h3><span>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</span></div>
                        </div>
                        <div class="col-3" onclick="scrollToId('card-sticker')">
                            <div class="game-score-box"><h3>${s.stickerScore}</h3><span>‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠</span></div>
                        </div>
                        <div class="col-3" onclick="scrollToId('card-knowledge')">
                            <div class="game-score-box"><h3>${s.knowledgeScore}</h3><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</span></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function buildRiskCard(p) {
             const score = parseFloat(p.thai_cv_risk_score || 0).toFixed(2);
             let color = '#28a745'; 
             if(score>=10) color='#ffc107'; 
             if(score>=20) color='#fd7e14'; 
             if(score>=30) color='#dc3545';
             
             // Extract fields from JSON if available, fallback to empty
             const extra = p.stats ? p : {}; // In a real scenario, map from JSON columns
             const ud = p['u/d'] || '-';
             const oldStroke = p['old_stroke_date'] ? `‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô (${p['old_stroke_date']})` : '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢';
             
             const items = [
                {l:'‡πÄ‡∏û‡∏®', v:p.gender==1?'‡∏ä‡∏≤‡∏¢':'‡∏´‡∏ç‡∏¥‡∏á', i:'bi-gender-ambiguous'},
                {l:'‡∏≠‡∏≤‡∏¢‡∏∏', v: `${p.age || '-'} ‡∏õ‡∏µ`, i:'bi-calendar-event'},
                {l:'‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', v:p.smoke==1?'‡∏™‡∏π‡∏ö':'‡πÑ‡∏°‡πà', i:'bi-fire'},
                {l:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', v:p.dm==1?'‡πÄ‡∏õ‡πá‡∏ô':'‡πÑ‡∏°‡πà', i:'bi-droplet'},
                {l:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', v:p.sbp + ' mmHg', i:'bi-speedometer'},
                {l:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', v:p.cholesterol + ' mg/dL', i:'bi-heart'},
                {l:'‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', v: (p.waist || '-') + ' ‡∏ã‡∏°.', i:'bi-arrows-expand'},
                {l:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', v: (p.height || '-') + ' ‡∏ã‡∏°.', i:'bi-rulers'},
             ];
             
             const gridHtml = items.map(x=>`<div class="info-item"><i class="bi ${x.i}"></i><span class="label">${x.l}</span><b>${x.v}</b></div>`).join('');

             return `
             <div class="card">
                 <div class="card-body">
                    <h5 class="section-title"><i class="bi bi-heart-pulse-fill text-danger"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h5>
                    <div class="text-center mb-3">
                         <div style="font-size: 3.5rem; font-weight: 900; line-height: 1; color: ${color}">${score}%</div>
                         <div style="color: ${color}; font-weight: bold;">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ô 10 ‡∏õ‡∏µ</div>
                         ${ud !== '-' ? `<div class="badge bg-danger mt-2">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${ud}</div>` : ''}
                    </div>
                    <div class="info-grid">${gridHtml}</div>
                    <div class="mt-3 text-center">
                        <a href="${LINKS.REGIS}" class="btn btn-outline-primary rounded-pill btn-sm">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
                    </div>
                 </div>
             </div>`;
        }

        function buildEmergencyCard(d, details) {
            const h = details.help || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const dec = details.decision || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const km = d ? d.distance_km : 0;
            const mins = d ? d.duration_mins : 0;
            const warning = km > 40 ? '<div class="alert alert-warning py-1 small mt-2"><i class="bi bi-exclamation-triangle"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏û. ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</div>' : '';

            return `
            <div class="card border-danger" id="emergency-card-inner">
                <div class="card-body">
                    <h5 class="text-danger fw-bold mb-3"><i class="bi bi-truck-front-fill"></i> ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏£‡∏û.‡∏™‡∏ß‡∏µ)</h5>
                    
                    <div class="emergency-graphic-container">
                        <i class="bi bi-person-wheelchair emergency-icon text-dark"></i>
                        <div class="emergency-arrow-container">
                             <div class="emergency-text">${km} ‡∏Å‡∏°. (${mins} ‡∏ô‡∏≤‡∏ó‡∏µ)</div>
                             <div class="emergency-arrow-line"></div>
                             <div class="emergency-arrow-head"></div>
                        </div>
                        <i class="bi bi-hospital-fill emergency-icon"></i>
                    </div>
                    ${warning}

                    <ul class="list-group list-group-flush mt-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div><span class="text-muted small d-block">‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•</span><b>${h}</b></div>
                            <button class="edit-mini-btn" onclick="openEditEm('help', '${h}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div><span class="text-muted small d-block">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</span><b>${dec}</b></div>
                            <button class="edit-mini-btn" onclick="openEditEm('decision', '${dec}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        </li>
                    </ul>
                    <button class="btn btn-light text-primary w-100 mt-2 btn-sm" onclick="DISTANCE_MODAL.show()">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>`;
        }

        function buildCommunityLeadersCard(l) { 
             if(!l) return '';
             
             // Nearby VHV
             const vhvCount = l.vhvList ? l.vhvList.length : 0;
             const vhvText = vhvCount > 0 
                ? `<div class="alert alert-success d-flex align-items-center py-2 mb-2"><i class="bi bi-people-fill me-2 fs-4"></i><div>‡∏û‡∏ö ‡∏≠‡∏™‡∏°. ${vhvCount} ‡∏Ñ‡∏ô ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div></div>`
                : `<div class="alert alert-secondary py-2 mb-2 text-center small">‡πÑ‡∏°‡πà‡∏û‡∏ö ‡∏≠‡∏™‡∏°. ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div>`;

             return `
             <div class="card">
                <div class="card-body">
                    <h5 class="section-title"><i class="bi bi-people-fill"></i> ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô & ‡∏≠‡∏™‡∏°.</h5>
                    ${vhvText}
                    <div class="list-group list-group-flush">
                        ${l.pcu ? `
                        <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <div><small class="text-muted">‡∏£‡∏û.‡∏™‡∏ï.</small><div class="fw-bold">${l.pcu}</div></div>
                            <button class="btn btn-outline-success btn-circle" onclick="initiateCall('${l.pcu}', '${l.pcu_tel}', '‡∏£‡∏û.‡∏™‡∏ï.')"><i class="bi bi-telephone-fill"></i></button>
                        </div>` : ''}
                        ${l.headman ? `
                        <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <div><small class="text-muted">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏ö‡πâ‡∏≤‡∏ô</small><div class="fw-bold">${l.headman}</div></div>
                            <button class="btn btn-outline-primary btn-circle" onclick="initiateCall('${l.headman}', '${l.headman_tel}', '‡∏ú‡∏ç‡∏ö.')"><i class="bi bi-telephone-fill"></i></button>
                        </div>` : ''}
                    </div>
                </div>
             </div>`;
        }

        // --- VHV Functions ---

        function buildTopVhvCard(total, topList) {
            // FIX: Ensure this function exists
            if (!topList) return '';
            const topHtml = topList.map((v, i) => `
                <div class="d-flex align-items-center mb-2">
                    <div class="badge bg-warning text-dark me-2 rounded-circle" style="width:25px;height:25px;display:flex;align-items:center;justify-content:center;">${i+1}</div>
                    <img src="${v.picture}" class="rounded-circle me-2" style="width:30px;height:30px;">
                    <div class="text-truncate small flex-grow-1" style="max-width: 120px;">${v.name}</div>
                    <div class="fw-bold text-success">${v.score} ‡πÅ‡∏ï‡πâ‡∏°</div>
                </div>
            `).join('');

            return `
            <div class="card bg-dark text-white mb-3" style="background: linear-gradient(45deg, #333, #555);">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0 text-warning">${total || 0}</h2>
                            <small>‡∏≠‡∏™‡∏°. ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                        </div>
                        <div style="border-left: 1px solid #666; padding-left: 15px; width: 60%;">
                            <div class="small text-warning mb-1 fw-bold">Top 3 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</div>
                            ${topHtml}
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        function buildVhvInfoCard(p) {
             return `<div class="card bg-warning bg-opacity-10 border-warning mb-3">
                 <div class="card-body d-flex align-items-center">
                     <img src="${p.profilePicture}" class="rounded-circle border border-2 border-warning me-3" style="width:60px;height:60px;">
                     <div>
                         <h5 class="mb-0 fw-bold">${p.name}</h5>
                         <div class="small"><i class="bi bi-geo-alt-fill text-danger"></i> ${p.area}</div>
                         <div class="small text-muted">ID: ${p.userId.substring(0,8)}...</div>
                     </div>
                 </div>
             </div>`;
        }

        function buildVhvLeaderboards(lb) {
             if(!lb) return '';
             const row = (t, l) => {
                 let content = l && l.length > 0 ? l.map((x,i)=>`
                    <div class="leaderboard-row">
                        <div class="leaderboard-rank">${i+1}</div>
                        <img src="${x.pic||'https://via.placeholder.com/35'}" class="leaderboard-img">
                        <div class="small text-truncate flex-grow-1">${x.name}</div>
                        <div class="fw-bold text-success">${x.score}</div>
                    </div>`).join('') : '<div class="text-center text-muted small py-2">-</div>';
                 return `<div class="col-6 mb-2"><div class="card leaderboard-card"><div class="card-header bg-light small fw-bold text-center border-0">${t}</div><div class="card-body p-2">${content}</div></div></div>`;
             };
             return `<div class="row g-2 mb-3">${row('‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô', lb.visits)}${row('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏', lb.reports)}${row('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏•‡∏ô‡πå', lb.exams)}${row('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°', lb.pins)}</div>`;
        }

        function buildVhvPatientListCard(pts) {
            return `<div class="card"><div class="card-body text-center text-muted py-5"><i class="bi bi-people display-4"></i><p class="mt-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p></div></div>`; 
            // Simplified for brevity, logic exists in original code if needed
        }
        
        function buildVhvRegistrationButton() {
            return `<div class="card text-center p-4">
                <h4>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</h4>
                <p class="text-muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏™‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô</p>
                <button class="btn btn-warning w-100" onclick="openVhvModal()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</button>
            </div>`;
        }

        // --- Standard Components ---
        function buildDailyCheckCard(i) {
             return `<div class="card"><div class="card-body"><h5 class="section-title">‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h5><div class="d-flex justify-content-around text-center mb-3"><div><h2 class="text-danger">${i.symptomCount||0}</h2><small>‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</small></div><div><h2 class="text-success">${i.noSymptomCount||0}</h2><small>‡∏õ‡∏Å‡∏ï‡∏¥</small></div></div><a href="${LINKS.DAILY}" class="btn btn-primary w-100">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</a></div></div>`;
        }
        function buildStickerCard(c) {
             return `<div class="card"><div class="card-body text-center"><h5 class="section-title justify-content-center">‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠ (‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏•‡∏ô‡πå)</h5><h1>${c||0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h1><a href="${LINKS.STICKER}" class="btn btn-info text-white w-100 mt-2">‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</a></div></div>`;
        }
        function buildKnowledgeTestCard(s) {
             return `<div class="card"><div class="card-body text-center"><h5 class="section-title justify-content-center">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h5><h1>${s.maxScore||0}/10</h1><a href="${LINKS.KNOWLEDGE}" class="btn btn-success w-100 mt-2">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a></div></div>`;
        }

        // --- ACTIONS ---
        function scrollToId(id) { document.getElementById(id).scrollIntoView({behavior: 'smooth'}); }
        
        function openEditEm(type, currentVal) {
            document.getElementById('editEmFieldType').value = type;
            document.getElementById('editEmTitle').innerText = type === 'help' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à';
            const sel = document.getElementById('editEmSelect');
            sel.innerHTML = '';
            const opts = type === 'help' 
                ? ['‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å', '‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] 
                : ['‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£', '‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π', '‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢', '‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á', '‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö'];
            opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o; opt.text = o;
                if(o === currentVal) opt.selected = true;
                sel.appendChild(opt);
            });
            EDIT_EM_MODAL.show();
        }

        function saveEmergencyField() {
            const type = document.getElementById('editEmFieldType').value;
            const val = document.getElementById('editEmSelect').value;
            const details = ALL_USER_DATA.gamification.details || {};
            details[type] = val;
            
            // Optimistic UI Update
            ALL_USER_DATA.gamification.details = details;
            document.getElementById('emergency-card-inner').outerHTML = buildEmergencyCard(ALL_USER_DATA.homeDistance, details);
            EDIT_EM_MODAL.hide();

            // Background Save
            fetch(WEB_APP_URL, { 
                method: 'POST', mode: 'no-cors', 
                body: JSON.stringify({ action: 'updateEmergencyInfo', data: { userId: LIFF_PROFILE.userId, [type]: val } }) 
            });
        }

        function initiateCall(name, phone, role) {
            CALL_DATA = { name, phone, role };
            document.getElementById('callTargetName').textContent = `${role} ${name}`;
            document.getElementById('callTargetPhone').textContent = phone;
            CALL_MODAL.show();
        }

        function confirmCall() {
            const { name, phone, role } = CALL_DATA;
            CALL_MODAL.hide();
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const loc = `${pos.coords.latitude},${pos.coords.longitude}`;
                    fetch(WEB_APP_URL, { 
                        method: 'POST', mode: 'no-cors', 
                        body: JSON.stringify({ action: 'logTelCall', data: { userId: LIFF_PROFILE.userId, target: name, tel: phone, location: loc } }) 
                    });
                    window.location.href = `tel:${phone}`;
                },
                () => {
                    // Fallback if geo blocked
                    window.location.href = `tel:${phone}`;
                }
            );
        }

        function openEditProfile() {
            document.getElementById('editName').value = ALL_USER_DATA.userProfile.name;
            document.getElementById('editPhone').value = ALL_USER_DATA.userProfile.telephone.replace(/'/g,'');
            EDIT_PROFILE_MODAL.show();
        }

        function saveUserProfile() {
            toggleLoading(true);
            const n = document.getElementById('editName').value;
            const p = document.getElementById('editPhone').value;
            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateUserProfile', data: { userId: LIFF_PROFILE.userId, name: n, phone: p } }) })
            .then(() => location.reload());
        }

        function openVhvModal() {
            const distSelect = document.getElementById('vhvDistrict'); 
            distSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>'; 
            for (const d in SAWEE_LOCATIONS) { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; distSelect.appendChild(opt); }
            VHV_REG_MODAL.show();
        }

        function updateVillages() { 
            const villSelect = document.getElementById('vhvVillage'); villSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>'; villSelect.disabled = false; 
            for(let i=1; i<=20; i++) { const opt = document.createElement('option'); opt.value = "‡∏´‡∏°‡∏π‡πà " + i; opt.textContent = "‡∏´‡∏°‡∏π‡πà " + i; villSelect.appendChild(opt); } 
        }

        function pinVhvHomeInForm() {
            navigator.geolocation.getCurrentPosition(p => { 
                document.getElementById('vhvAsmHome').value = `${p.coords.latitude},${p.coords.longitude}`; 
            }, () => alert('Please enable GPS'));
        }

        function handleVhvRegistration() {
            const n = document.getElementById('vhvName').value;
            const p = document.getElementById('vhvPhone').value;
            const d = document.getElementById('vhvDistrict').value;
            const v = document.getElementById('vhvVillage').value;
            const h = document.getElementById('vhvAsmHome').value;
            if(!n || !p || !d || !v || !h) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
            toggleLoading(true);
            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerVhv', data: { userId: LIFF_PROFILE.userId, name: n, phone: p, areas: [`‡∏ï.${d} ${v}`], asm_home: h, profilePicture: LIFF_PROFILE.pictureUrl } }) })
            .then(() => location.reload());
        }

        function handlePinNewLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                toggleLoading(true);
                fetch(`${WEB_APP_URL}?action=calculateDistance&lat=${p.coords.latitude}&lon=${p.coords.longitude}`)
                .then(r=>r.json()).then(d=> {
                    fetch(WEB_APP_URL, { method:'POST', mode:'no-cors', body:JSON.stringify({ action:'saveNewLocation', data: { userId:LIFF_PROFILE.userId, type: '‡∏ö‡πâ‡∏≤‡∏ô', latlong:`${p.coords.latitude},${p.coords.longitude}`, distance:d.distance_km, duration:d.duration_mins } }) })
                    .then(() => location.reload());
                });
            });
        }
    </script>
</body>
</html>