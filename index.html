<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å by ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            --vhv-bg: #ffc107; 
            --vhv-dark: #b88a00; 
            --base-size: 22px; 
        }
        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: var(--base-size); 
            background-color: #f0f2f5; 
            margin: 0; 
            padding-bottom: 5rem; 
        }
        
        /* Font Sizes */
        h1, h2, h3, h4, h5 { font-weight: 700 !important; }
        .h5, h5 { font-size: 1.6rem; }
        .small, small { font-size: 1rem; }
        .btn { font-size: 1.2rem; }
        
        /* --- Loading Screen Styles (Strictly as requested) --- */
        #loading { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: #000000; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            color: white; 
            text-align: center; 
            font-family: "Noto Sans Thai", sans-serif; 
        }
        
        /* Text at Top */
        #loading-text { 
            font-size: 1.5rem; 
            color: #aaaaaa; 
            margin-bottom: 40px; 
            position: absolute;
            top: 10%;
        }

        /* Container for Icon & Text */
        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.5s ease-in-out; 
            opacity: 1; 
        }

        /* Large Icon */
        #loading-icon {
            font-size: 7rem;
            margin-bottom: 10px;
        }

        /* Prefix Text */
        .loading-prefix { 
            font-size: 1.2rem; 
            color: #dddddd; 
            margin-bottom: 5px; 
        }
        
        /* Symptom Text */
        #loading-subtext { 
            font-size: 3rem; 
            font-weight: 800; 
            line-height: 1.2; 
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3); 
        }
        
        /* Standard UI Styles */
        .nav-tabs .nav-link { font-size: 1.3rem; font-weight: bold; color: #6c757d; padding: 15px 10px; background: #e9ecef; }
        .nav-tabs .nav-link.active { color: #0d6efd; background: #fff; }
        .nav-tabs .nav-link.vhv-tab.active { background: var(--vhv-bg); color: #000; }
        .bg-vhv-theme { background-color: var(--vhv-bg); min-height: 100vh; padding-bottom: 40px; }
        
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 1.5rem; border-radius: 15px; }
        .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #333; display: flex; align-items: center; }
        .section-title i { margin-right: 0.8rem; color: #0d6efd; font-size: 1.8rem; }
        
        .game-score-box { background: #fff; border-radius: 15px; padding: 15px 5px; text-align: center; border: 2px solid #fff; height: 100%; cursor: pointer; }
        .game-score-box h3 { margin: 5px 0; font-weight: 800; color: #0d6efd; font-size: 2.2rem; }
        .game-score-box span { font-size: 1.1rem; color: #666; line-height: 1.2; display: block; }
        
        .profile-edit-btn { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 50px; height: 50px; color: #0d6efd; font-size: 1.5rem; }
        
        .risk-1 { border-left: 15px solid #28a745; }
        .risk-2 { border-left: 15px solid #ffc107; }
        .risk-3 { border-left: 15px solid #fd7e14; }
        .risk-4 { border-left: 15px solid #dc3545; }
        .risk-5 { border-left: 15px solid #8B0000; }
        
        .text-line-id { font-size: 1rem; color: #0d6efd; cursor: pointer; background: #e3f2fd; padding: 2px 8px; border-radius: 5px; display: inline-block; }
        .highlight-alert { background-color: #ffebee; border: 2px solid red; }
        .form-section-title { background: #f8f9fa; padding: 10px; font-weight: bold; margin-bottom: 10px; border-left: 5px solid #0d6efd; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 10px; }
        .info-item { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 12px 10px; display: flex; align-items: center; font-size: 1rem; }
        .info-item i { font-size: 1.8rem; color: #0d6efd; margin-right: 10px; width: 30px; text-align: center; }
        .info-item .label { display: block; font-size: 0.85rem; color: #6c757d; line-height: 1; }
        .info-item b { font-size: 1.2rem; color: #333; }
        
        /* Leaderboard */
        .leaderboard-row { display: flex; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .leaderboard-rank { font-size: 1.2rem; font-weight: bold; width: 30px; text-align: center; color: #0d6efd; }
        .leaderboard-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
        .leaderboard-score { margin-left: auto; font-weight: bold; color: #198754; }
    </style>
</head>
<body>

    <div id="loading">
        <div id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        
        <!-- Fading Wrapper -->
        <div id="loading-content" class="loading-content">
            <i id="loading-icon" class="bi"></i>
            <div class="loading-prefix">‡∏à‡∏≥‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å:</div>
            <div id="loading-subtext"></div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs nav-justified fixed-top shadow-sm" id="mainTabs" role="tablist" style="height: 70px;">
        <li class="nav-item">
            <button class="nav-link active" id="health-tab-btn" data-bs-toggle="tab" data-bs-target="#health-tab-content">
                <i class="bi bi-heart-pulse-fill"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link vhv-tab" id="vhv-tab-btn" data-bs-toggle="tab" data-bs-target="#vhv-tab-content">
                <i class="bi bi-person-badge-fill"></i> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°.
            </button>
        </li>
    </ul>

    <div class="tab-content" style="margin-top: 80px;">
        <!-- Tab 1: Health -->
        <div class="tab-pane fade show active" id="health-tab-content">
            <div class="container tab-content-container">
                <div class="row" id="dynamic-content-container">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </div>
        <!-- Tab 2: VHV -->
        <div class="tab-pane fade" id="vhv-tab-content">
            <div class="bg-vhv-theme tab-content-container">
                <div class="container pt-3">
                    <div id="vhv-dashboard-area"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Edit Profile -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3 text-center">
                            <img id="edit-preview-img" src="" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:15px;">
                            <br><small class="text-muted">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏° LINE ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control form-control-lg" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" class="form-control form-control-lg" id="editPhone" required pattern="[0-9]{10}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="saveUserProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VHV Register -->
    <div class="modal fade" id="vhvRegisterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vhvForm">
                        <div class="mb-3"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" class="form-control" id="vhvName" required></div>
                        <div class="mb-3"><label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" class="form-control" id="vhvPhone" required></div>
                        <div class="mb-3"><label class="form-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</label>
                            <div class="row g-2">
                                <div class="col-6"><select class="form-select" id="vhvDistrict" onchange="updateVillages()"><option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option></select></div>
                                <div class="col-6"><select class="form-select" id="vhvVillage" disabled><option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option></select></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="handleVhvRegistration()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Offline Patient Modal -->
    <div class="modal fade" id="registerOfflineModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h1 class="modal-title fs-5">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå)</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="offlineForm">
                        <div class="mb-3"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" class="form-control" id="offName" required></div>
                        <div class="row mb-3">
                            <div class="col-6"><label>‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" class="form-control" id="offAge"></div>
                            <div class="col-6"><label>‡πÄ‡∏û‡∏®</label><select class="form-select" id="offSex"><option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option><option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option></select></div>
                        </div>
                        <div class="mb-3"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label><input type="tel" class="form-control" id="offPhone"></div>
                        <div class="mb-3"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ)</label>
                            <select class="form-select" id="offRisk">
                                <option value="0">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß)</option>
                                <option value="10">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)</option>
                                <option value="20">‡∏™‡∏π‡∏á (‡∏™‡πâ‡∏°)</option>
                                <option value="30">‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (‡πÅ‡∏î‡∏á)</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                             <button type="button" class="btn btn-outline-primary" onclick="pinOfflineLocation()"><i class="bi bi-geo-alt"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>
                             <input type="text" id="offLocation" class="form-control text-center small" readonly placeholder="‡∏û‡∏¥‡∏Å‡∏±‡∏î...">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitOfflinePatient()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Home Visit Modal (Updated with Pin Button) -->
    <div class="modal fade" id="homeVisitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h1 class="modal-title fs-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="hvPatientId"> <!-- Use ID not Name for logic -->
                    <input type="hidden" id="hvPatientNameVal">
                    <h5 id="hvTitle" class="mb-3">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: ...</h5>
                    
                    <!-- Moved Pin Button Here -->
                    <div class="alert alert-warning d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-geo-alt-fill"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</span>
                        <button class="btn btn-warning btn-sm" onclick="pinForCurrentPatient()">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chkAdvice1" checked>
                            <label class="form-check-label" for="chkAdvice1">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="chkAdvice2" checked>
                            <label class="form-check-label" for="chkAdvice2">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea class="form-control" id="hvNoteAdvice" rows="2"></textarea>
                    </div>
                    <button class="btn btn-success w-100 btn-lg" onclick="submitHomeVisit('Advice')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stroke Report Modal -->
    <div class="modal fade" id="strokeReportModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h1 class="modal-title fs-4">üöë ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏™‡∏™‡πÇ‡∏ï‡∏£‡∏Å (Fast Track)</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="strokeReportForm" class="p-2">
                        <div class="mb-3"><label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label><input type="text" class="form-control" id="srName"></div>
                        <div class="mb-3"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ç‡∏≤‡∏ï‡∏¥</label><input type="tel" class="form-control border-danger" id="srRelPhone" required></div>
                        <div class="mb-3"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</label><input type="time" class="form-control border-danger" id="srOnsetTime"></div>
                        <div class="d-grid gap-2 mt-4"><button type="button" class="btn btn-secondary" onclick="getLocationForReport()">‡πÅ‡∏ô‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button><input type="text" id="srLocation" class="form-control text-center small" readonly></div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-danger btn-lg flex-grow-1" onclick="submitStrokeReport()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="mb-4">‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
                    <!-- QR Code Generated via API for the specific link -->
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://lin.ee/qRgD07N" alt="QR Code" style="max-width:90%;width:350px;border:15px solid white;border-radius:15px;">
                    <p class="mt-4 fs-3">‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>
                    <a href="https://lin.ee/qRgD07N" class="btn btn-success btn-lg mt-3 rounded-pill px-5 fs-4">
                        <i class="bi bi-line"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                    </a>
                    <button class="btn btn-light btn-lg mt-5 rounded-pill px-5 py-3 fs-3" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Profile -->
    <div class="modal fade" id="shareProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">‡πÅ‡∏ä‡∏£‡πå‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ ‡∏≠‡∏™‡∏°.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô</p>
                    <button type="button" class="btn btn-primary btn-lg w-100" onclick="handleShareProfile()">
                        <i class="bi bi-line"></i> ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RTPA Info -->
    <div class="modal fade" id="rtpaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h1 class="modal-title fs-5">‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ ‡∏£‡∏û. ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 4.5 ‡∏ä‡∏°.?</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body fs-5">
                    <p>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡∏ï‡∏µ‡∏ö ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î (rT-PA) ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</p>
                    <ul>
                        <li><b>‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏≠‡∏á:</b> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 4.5 ‡∏ä‡∏°. ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</li>
                        <li><b>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</b> ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•</li>
                        <li><b>‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô:</b> 1669 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏µ‡∏ö‡∏ô‡∏≥‡∏™‡πà‡∏á ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg w-100" data-bs-dismiss="modal">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Info -->
    <div class="modal fade" id="riskInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h1 class="modal-title fs-5">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body fs-5">
                    <p>‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ % ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏•‡∏î‡∏•‡∏á</p>
                    <p class="text-danger fw-bold">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡πâ‡∏≥‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥!</p>
                    <p>‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û. ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg w-100" data-bs-dismiss="modal">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Distance Modal -->
    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£</p>
                    <div class="mb-3">
                        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                        <select class="form-select form-select-lg" id="locationType">
                            <option value="‡∏ö‡πâ‡∏≤‡∏ô">‡∏ö‡πâ‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)</option>
                            <option value="‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô">‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏â‡∏¢‡πÜ)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- 1. Global Config ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        const LINKS = { REGIS: "https://liff.line.me/2005789397-nebQ8oJy", DAILY: "https://liff.line.me/2005789397-WRm1lYd9", STICKER: "https://liff.line.me/2005789397-37lemBgX", KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk" };
        const SAWEE_LOCATIONS = { "‡∏ô‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå": 8, "‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏≤": 5, "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÉ‡∏ï‡πâ": 3, "‡∏î‡πà‡∏≤‡∏ô‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡πà‡∏≤‡∏´‡∏¥‡∏ô": 3, "‡∏õ‡∏≤‡∏Å‡πÅ‡∏û‡∏£‡∏Å": 4, "‡∏Ñ‡∏£‡∏ô": 4, "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": 3, "‡∏ô‡∏≤‡∏™‡∏±‡∏Å": 3, "‡πÄ‡∏Ç‡∏≤‡∏ó‡∏∞‡∏•‡∏∏": 3 };
        
        let LIFF_PROFILE = null;
        let ALL_USER_DATA = null;
        let loadingInterval;
        let EDIT_PROFILE_MODAL, VHV_REG_MODAL, STROKE_REPORT_MODAL, HOME_VISIT_MODAL, REGISTER_OFFLINE_MODAL, QR_MODAL, SHARE_PROFILE_MODAL, RTPA_MODAL, RISK_INFO_MODAL, DISTANCE_MODAL;

        // --- 2. Loading Animation (Fixed Logic) ---
        function startLoadingAnimation() {
            const msgs = [
                {t:"‡πÄ‡∏ã‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß", i:"bi-person-walking", c:"#ffc107"}, 
                {t:"‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏°‡∏≤‡∏Å", i:"bi-eye-slash-fill", c:"#9C27B0"}, 
                {t:"‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å", i:"bi-emoji-dizzy-fill", c:"#dc3545"}, 
                {t:"‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏Å", i:"bi-person-arms-up", c:"#0d6efd"}, 
                {t:"‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏û‡∏π‡∏î", i:"bi-mic-mute-fill", c:"#198754"}
            ];
            let i = 0;
            const sub = document.getElementById('loading-subtext');
            const icon = document.getElementById('loading-icon'); // Corrected ID reference
            const content = document.getElementById('loading-content');
            
            // Set Initial
            if(sub) {
                sub.textContent = msgs[0].t;
                sub.style.color = msgs[0].c;
                if(content) content.style.opacity = 1;
            }
            if(icon) {
                icon.className = `bi ${msgs[0].i}`;
                icon.style.color = msgs[0].c;
            }

            loadingInterval = setInterval(() => {
                if(content) content.style.opacity = 0; // Fade Out
                
                setTimeout(() => {
                    i = (i + 1) % msgs.length;
                    if(sub) {
                        sub.textContent = msgs[i].t;
                        sub.style.color = msgs[i].c;
                    }
                    if(icon) {
                        icon.className = `bi ${msgs[i].i}`;
                        icon.style.color = msgs[i].c;
                    }
                    if(content) content.style.opacity = 1; // Fade In
                }, 500); 
            }, 2500);
        }

        function stopLoadingAnimation() {
            if(loadingInterval) clearInterval(loadingInterval);
            const el = document.getElementById('loading');
            if(el) el.style.display = 'none';
        }
        
        function toggleLoading(show) {
            const el = document.getElementById('loading');
            if(el) el.style.display = show ? 'flex' : 'none';
        }

        function handleFailure(e) { 
            alert("Error: "+e.message); 
            stopLoadingAnimation(); 
        }

        // --- 3. Main Execution ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ** Call startLoadingAnimation immediately **
            startLoadingAnimation();
            
            EDIT_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('editProfileModal'));
            VHV_REG_MODAL = new bootstrap.Modal(document.getElementById('vhvRegisterModal'));
            QR_MODAL = new bootstrap.Modal(document.getElementById('qrModal'));
            RTPA_MODAL = new bootstrap.Modal(document.getElementById('rtpaModal'));
            SHARE_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('shareProfileModal'));
            STROKE_REPORT_MODAL = new bootstrap.Modal(document.getElementById('strokeReportModal'));
            HOME_VISIT_MODAL = new bootstrap.Modal(document.getElementById('homeVisitModal'));
            RISK_INFO_MODAL = new bootstrap.Modal(document.getElementById('riskInfoModal'));
            DISTANCE_MODAL = new bootstrap.Modal(document.getElementById('distanceModal'));
            REGISTER_OFFLINE_MODAL = new bootstrap.Modal(document.getElementById('registerOfflineModal'));
            
            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                LIFF_PROFILE = await liff.getProfile();
                
                let url = `${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}`;
                const ref = new URLSearchParams(window.location.search).get('ref');
                if(ref) url += `&ref=${ref}`;
                
                fetch(url).then(r => r.json()).then(data => {
                    if (data.error) throw new Error(data.error);
                    ALL_USER_DATA = data;
                    updatePage(data);
                }).catch(err => alert("Error: " + err.message)).finally(() => {
                    stopLoadingAnimation();
                });
            } catch (err) { alert(err.message); }
        });

        function updatePage(data) {
            const hContainer = document.getElementById('dynamic-content-container');
            if (hContainer) {
                if (!data.userProfile) {
                    hContainer.innerHTML = `
                        <div class="col-12 text-center p-5">
                            <h2 class="mb-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
                            <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                            <a href="${LINKS.REGIS}" class="btn btn-primary btn-lg rounded-pill px-5">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
                        </div>`;
                } else {
                    const gamification = data.gamification || {};
                    const dailyCheck = data.dailyCheckInfo || {};
                    const distance = data.homeDistance; 
                    const leaders = data.communityLeaders; 
                    const sticker = data.stickerShareCount || 0;
                    const exam = data.knowledgeTestStats || {};

                    hContainer.innerHTML = 
                        buildProfileCard(data.userProfile) +
                        buildGamificationCard(gamification) +
                        `<div id="card-risk">` + buildProfileCard(data.userProfile, true) + `</div>` +
                        `<div id="card-check">` + buildDailyCheckCard(dailyCheck) + `</div>` +
                        `<div id="card-emergency">` + buildDistanceCard(distance, data.userProfile.help) + `</div>` +
                        `<div id="card-leaders">` + buildCommunityLeadersCard(leaders) + `</div>` +
                        `<div id="card-sticker">` + buildStickerCard(sticker) + `</div>` +
                        `<div id="card-exam">` + buildKnowledgeTestCard(exam) + `</div>`;
                }
            }
            
            const vContainer = document.getElementById('vhv-dashboard-area');
            if (vContainer) {
                const dash = data.vhvDashboard || {};
                const vhvProf = data.vhvProfile || {};
                const vhvPatients = data.vhvPatientList || [];
                
                if (data.isVhv) {
                    vContainer.innerHTML = 
                        buildTopVhvCard(dash.totalVhv, dash.topVhvs) +
                        buildVhvInstructions(true, dash.checklist) +
                        buildVhvInfoCard(data.vhvProfile) +
                        buildVhvPatientListCard(data.vhvPatientList);
                } else {
                    vContainer.innerHTML = 
                        buildTopVhvCard(dash.totalVhv, dash.topVhvs) +
                        buildVhvInstructions(false) +
                        buildVhvRegistrationButton();
                }
            }
        }

        // --- Builders --- 
        function buildGamificationCard(scores) {
            if (!scores) return '';
            const rankText = `(${scores.totalScore || 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏™‡∏π‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${scores.rank || '-'} ‡∏à‡∏≤‡∏Å ${scores.totalUsers || '-'} ‡∏Ñ‡∏ô)`;
            return `<div class="col-12 mb-3"><div class="card bg-light-blue shadow-sm" style="background-color: #e3f2fd;"><div class="card-body p-3"><h5 class="section-title mb-2 text-primary"><i class="bi bi-trophy-fill text-warning"></i>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ</h5><div class="text-center mb-3"><div class="text-primary fw-bold fs-5">${rankText}</div></div>
            <div class="row g-2 text-center">
               <div class="col-3"><small>‡πÉ‡∏™‡πà‡πÉ‡∏à</small><br><b>${scores.checkScore}</b></div>
               <div class="col-3"><small>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</small><br><b>${scores.emergencyScore}</b></div>
               <div class="col-3"><small>‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠</small><br><b>${scores.stickerScore}</b></div>
               <div class="col-3"><small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</small><br><b>${scores.knowledgeScore}</b></div>
            </div></div></div></div>`;
        }
        
        function buildProfileCard(p, riskOnly = false) {
             if (!p) return '';
             const riskValue = (p.thai_cv_risk_score || 0) / 100;
             const color = classifyRisk(riskValue).color;
             const factors = [
                {l:'‡πÄ‡∏û‡∏®', v: p.gender == 1 ? '‡∏ä‡∏≤‡∏¢' : '‡∏´‡∏ç‡∏¥‡∏á'},
                {l:'‡∏≠‡∏≤‡∏¢‡∏∏', v: p.age || '‡πÑ‡∏°‡πà‡∏°‡∏µ'},
                {l:'‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', v: p.smoke == 1 ? '‡∏™‡∏π‡∏ö' : '‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö'},
                {l:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', v: p.dm == 1 ? '‡πÄ‡∏õ‡πá‡∏ô' : '‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô'},
                {l:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', v: p.sbp || '‡πÑ‡∏°‡πà‡∏°‡∏µ'},
                {l:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', v: p.cholesterol || '‡πÑ‡∏°‡πà‡∏°‡∏µ'},
                {l:'‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', v: p.waist || '‡πÑ‡∏°‡πà‡∏°‡∏µ'},
                {l:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', v: p.height || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}
            ];
            let factorHtml = '';
            factors.forEach(f => factorHtml += `<div class="info-item"><span class="label">${f.l}</span> <b>${f.v}</b></div>`);

            if(riskOnly) {
                 return `<div class="col-12"><div class="card"><div class="card-body">
                    <h6 class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h6>
                    <div class="text-center mb-3" style="color: ${color}"><h1>${p.thai_cv_risk_score}%</h1></div>
                    <div class="info-grid">${factorHtml}</div>
                </div></div></div>`;
            } else {
                 const regDate = p.timestamp ? new Date(p.timestamp).toLocaleDateString('th-TH') : '-';
                 return `<div class="col-12"><div class="card bg-white"><div class="card-body position-relative"><button class="profile-edit-btn shadow-sm" onclick="openEditProfile()"><i class="bi bi-pencil-fill"></i></button><div class="d-flex align-items-center"><img src="${p.pictureUrl || 'https://via.placeholder.com/90'}" class="rounded-circle border border-3 border-primary me-3" style="width: 110px; height: 110px; object-fit: cover;"><div><h3 class="fw-bold mb-1">${p.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h3><div class="text-muted fs-5"><i class="bi bi-telephone"></i> ${p.telephone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div><span class="badge bg-secondary fs-6 fw-normal mt-1">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${regDate}</span></div></div></div></div></div>`;
            }
        }

        function buildVhvChecklist(cl) {
            const getIcon = (ok) => ok ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-circle text-muted"></i>';
            return `<div class="card mb-3"><div class="card-header fw-bold">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‡∏≠‡∏™‡∏°.</div><ul class="list-group list-group-flush">
                <li class="list-group-item">${getIcon(true)} ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</li>
                <li class="list-group-item">${getIcon(cl.hasPinned)} ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</li>
                <li class="list-group-item">${getIcon(cl.hasSharedSticker)} ‡πÅ‡∏ä‡∏£‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå)</li>
            </ul></div>`;
        }

        function buildVhvLeaderboards(lb) {
            if(!lb) return '';
            const renderList = (list, title) => {
                let h = `<div class="col-6 mb-2"><div class="card h-100"><div class="card-header small fw-bold bg-light">${title}</div><div class="card-body p-2 small">`;
                if(list && list.length > 0) {
                    list.forEach((u, i) => h += `<div class="d-flex justify-content-between mb-1"><span>${i+1}. ${u.name.substring(0,8)}..</span><b>${u.score}</b></div>`);
                } else { h += '-'; }
                h += `</div></div></div>`;
                return h;
            };
            return `<div class="row g-2 mb-3">
                ${renderList(lb.visits, '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô')}
                ${renderList(lb.reports, '‡∏¢‡∏≠‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏')}
                ${renderList(lb.exams, '‡∏¢‡∏≠‡∏î‡∏Ñ‡∏ô‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô')}
                <div class="col-6 mb-2"><div class="card h-100"><div class="card-header small fw-bold bg-light">‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</div><div class="card-body p-2 small">‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</div></div></div>
            </div>`;
        }

        function buildVhvPatientListCard(pts) {
            if(!pts || pts.length===0) return '<div class="alert alert-secondary">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï</div>';
            
            // Group and Sort
            let html = '';
            pts.forEach(p => {
                const riskVal = (p.thai_cv_risk_score || 0) / 100;
                let c = 'risk-1';
                if(riskVal>=0.4) c='risk-5'; else if(riskVal>=0.3) c='risk-4'; else if(riskVal>=0.2) c='risk-3'; else if(riskVal>=0.1) c='risk-2';
                
                html += `<li class="list-group-item ${c}"><div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${p.name} <small class="text-muted">(${p.thai_cv_risk_score}%)</small></div>
                        <div class="small text-muted">${p.latestCheckTimestamp ? '‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Ñ'}</div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-primary rounded-pill" onclick="openHomeVisit('${p.userId}', '${p.name}')">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°/‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</button>
                    </div>
                </div></li>`;
            });
            return `<div class="card"><div class="card-header bg-white fw-bold d-flex justify-content-between"><span>‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</span> <button class="btn btn-sm btn-danger" onclick="STROKE_REPORT_MODAL.show()">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏™‡∏™‡πÇ‡∏ï‡∏£‡∏Å</button></div><ul class="list-group list-group-flush">${html}</ul></div>`;
        }

        function buildVhvRegistrationButton() {
            return `<div class="text-center p-5"><button class="btn btn-lg btn-warning" onclick="openVhvModal()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡∏≠‡∏™‡∏°.</button></div>`;
        }

        // --- Logic ---
        function openEditProfile() { EDIT_PROFILE_MODAL.show(); }
        function saveUserProfile() { /* Simplified */ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); }
        function openVhvModal() { 
            const distSelect = document.getElementById('vhvDistrict'); 
            distSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>';
            for (const d in SAWEE_LOCATIONS) {
                const opt = document.createElement('option');
                opt.value = d; opt.textContent = d; distSelect.appendChild(opt);
            }
            VHV_REG_MODAL.show(); 
        }
        function updateVillages() {
            const villSelect = document.getElementById('vhvVillage');
            villSelect.innerHTML = '';
            villSelect.disabled = false;
            for(let i=1; i<=20; i++) {
                 const opt = document.createElement('option');
                 opt.value = "‡∏´‡∏°‡∏π‡πà " + i; opt.textContent = "‡∏´‡∏°‡∏π‡πà " + i; villSelect.appendChild(opt);
            }
        }
        function handleVhvRegistration() {
            toggleLoading(true);
            const data = { userId: LIFF_PROFILE.userId, displayName: LIFF_PROFILE.displayName, pictureUrl: LIFF_PROFILE.pictureUrl,
                name: document.getElementById('vhvName').value, phone: document.getElementById('vhvPhone').value, 
                line_id: document.getElementById('vhvLineId').value, 
                areas: [`‡∏ï.${document.getElementById('vhvDistrict').value} ${document.getElementById('vhvVillage').value}`]
            };
             fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerVhv', data: data }) })
                .then(() => { alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.location.reload(); }).catch(handleFailure);
        }
        
        // ** Share Simple Flex **
        async function handleShareProfile() {
            toggleLoading(true);
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getShareCard&userId=${LIFF_PROFILE.userId}`);
                const data = await res.json();
                toggleLoading(false);
                if(data.success && data.flex) {
                    SHARE_PROFILE_MODAL.hide();
                    await liff.shareTargetPicker([data.flex]);
                } else { alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ: " + data.message); }
            } catch(e) { handleFailure(e); }
        }

        // ** Pin for Patient (Inside Home Visit) **
        function openHomeVisit(uid, name) {
            document.getElementById('hvPatientId').value = uid;
            document.getElementById('hvPatientNameVal').value = name;
            document.getElementById('hvTitle').textContent = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: ${name}`;
            HOME_VISIT_MODAL.show();
        }
        
        function pinForCurrentPatient() {
            const uid = document.getElementById('hvPatientId').value;
            const name = document.getElementById('hvPatientNameVal').value;
            if(!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${name} ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà?`)) return;
            toggleLoading(true);
             navigator.geolocation.getCurrentPosition(p => {
                 const latlong = `${p.coords.latitude},${p.coords.longitude}`;
                 fetch(WEB_APP_URL, {
                     method: 'POST', mode: 'no-cors',
                     body: JSON.stringify({
                         action: 'saveNewLocation',
                         data: { userId: uid, type: '‡∏ö‡πâ‡∏≤‡∏ô_‡πÇ‡∏î‡∏¢_‡∏≠‡∏™‡∏°', latlong: latlong, distance: 0, duration: 0, recorderId: LIFF_PROFILE.userId }
                     })
                 }).then(() => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß"); toggleLoading(false); });
             }, handleFailure);
        }
        
        // ** Offline Register **
        function pinOfflineLocation() {
            navigator.geolocation.getCurrentPosition(p => {
                document.getElementById('offLocation').value = `${p.coords.latitude},${p.coords.longitude}`;
            });
        }
        function submitOfflinePatient() {
            const data = {
                 vhvId: LIFF_PROFILE.userId, vhvName: ALL_USER_DATA.vhvProfile.name,
                 name: document.getElementById('offName').value,
                 age: document.getElementById('offAge').value,
                 gender: document.getElementById('offSex').value,
                 phone: document.getElementById('offPhone').value,
                 riskScore: document.getElementById('offRisk').value,
                 latlong: document.getElementById('offLocation').value,
                 district: ALL_USER_DATA.vhvProfile.area.split(' ')[0].replace('‡∏ï.', ''),
                 village: ALL_USER_DATA.vhvProfile.area.split(' ')[1].replace('‡∏°.', '')
            };
            toggleLoading(true);
            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerOfflinePatient', data: data }) })
            .then(() => { alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"); window.location.reload(); }).catch(handleFailure);
        }

        function classifyRisk(r) { return r<0.1?{text:"‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥",color:"#28a745"}:r<0.2?{text:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",color:"#ffc107"}:r<0.3?{text:"‡∏™‡∏π‡∏á",color:"#fd7e14"}:r<0.4?{text:"‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å",color:"#dc3545"}:{text:"‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢",color:"#8B0000"}; }
        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        function handleFailure(e) { alert("Error: "+e.message); toggleLoading(false); }
    </script>
</body>
</html>