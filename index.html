<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ข้อมูลสุขภาพ รู้ทันสโตรก by รพ.สวี</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* =========================================
           1. GLOBAL VARIABLES & RESET
           ========================================= */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            --theme-color: #ff3654; 
            --theme-bg-start: #ff3654;
            --theme-bg-end: #ffffff;
            
            --gold-primary: #D4AF37;
            --gold-light: #FFD700;
            --gold-card-bg: #FFFDF5;
            
            --base-size: 20px; 
            --header-height: 60px;
        }

        html { 
            font-size: var(--base-size);
        }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 1rem; 
            background: linear-gradient(180deg, var(--theme-bg-start) 0%, var(--theme-bg-end) 450px);
            background-attachment: fixed;
            margin: 0; 
            padding-bottom: 6rem; 
            transition: background 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- VHV Mode Theme --- */
        body.vhv-mode {
            --theme-bg-start: #FFD700;
        }

        /* =========================================
           2. TYPOGRAPHY
           ========================================= */
        h1, h2, h3, h4, h5, h6 { 
            font-weight: 700 !important; 
        }

        .btn { 
            font-size: 1.1rem; 
            font-weight: 600; 
        }
        
        /* =========================================
           3. LAYOUT & HEADER
           ========================================= */
        .app-header { 
            text-align: center; 
            padding: 110px 20px 20px; 
        }

        .app-title { 
            color: white; 
            font-weight: 900; 
            font-size: 2rem; 
            text-shadow: 2px 2px 5px rgba(0,0,0,0.3); 
            margin: 0; 
            line-height: 1.2;
        }

        body.vhv-mode .app-title { 
            color: #333; 
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5); 
        }
        
        .app-header-spacer { 
            height: 90px; 
        }

        /* =========================================
           4. NAVIGATION TABS (FIXED)
           ========================================= */
        .nav-tabs-container {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 1000;
            background-color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            padding: 0;
        }

        .nav-tabs { 
            border-bottom: none; 
            width: 100%; 
            display: flex; 
            margin: 0;
        }

        .nav-item { 
            flex: 1; 
            text-align: center; 
        }

        .nav-link { 
            font-size: 1.2rem; 
            color: #999; 
            border: none; 
            border-radius: 0; 
            margin: 0; 
            padding: 15px 0; 
            font-weight: 700; 
            background: #fff; 
            width: 100%;
            transition: all 0.3s ease;
        }

        .nav-item:first-child .nav-link { 
            border-right: 1px solid #eee; 
        }

        .nav-link.active { 
            color: #ff3654; 
            background: #fff; 
            border-bottom: 4px solid #ff3654; 
        }

        body.vhv-mode .nav-link.active { 
            color: #B8860B; 
            border-bottom-color: #FFD700; 
            background: #FFFAF0; 
        }
        
        .bg-vhv-theme { 
            min-height: 100vh; 
        }

        /* =========================================
           5. CARDS & SECTIONS
           ========================================= */
        .card { 
            border: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            margin-bottom: 1.5rem; 
            border-radius: 20px; 
            overflow: hidden; 
            background-color: #fff; 
            transition: transform 0.2s;
        }

        body.vhv-mode .card { 
            background-color: var(--gold-card-bg); 
            border: 1px solid rgba(212, 175, 55, 0.2); 
        }
        
        .section-title { 
            font-size: 1.4rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            color: #333; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }

        .section-title i { 
            font-size: 1.6rem; 
            color: #ff3654; 
        }

        body.vhv-mode .section-title i { 
            color: #B8860B; 
        }

        /* =========================================
           6. COMPONENTS
           ========================================= */
        
        /* Loading Spinner */
        .loading-container { 
            text-align: center; 
            padding: 40px; 
        }
        
        .spinner-border { 
            width: 4rem; 
            height: 4rem; 
            color: #ffc107; 
            margin-bottom: 20px; 
        }

        /* Profile Image */
        .profile-img-lg { 
            width: 100px; 
            height: 100px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 4px solid #fff; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }

        .profile-edit-btn { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: rgba(255,255,255,0.9); 
            border: none; 
            border-radius: 50%; 
            width: 45px; 
            height: 45px; 
            color: #0d6efd; 
            font-size: 1.2rem; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            z-index: 10;
        }

        /* Score Card */
        .game-score-card { 
            border: 2px solid #fff; 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
        }

        .game-score-box { 
            background: #fff; 
            border-radius: 12px; 
            padding: 10px 5px; 
            text-align: center; 
            border: 1px solid #dee2e6; 
            height: 100%; 
            cursor: pointer; 
            transition: 0.2s; 
        }
        
        .game-score-box:active { 
            transform: scale(0.95); 
        }

        .game-score-box h3 { 
            margin: 5px 0; 
            font-weight: 800; 
            color: #0d6efd; 
            font-size: 1.8rem; 
        }

        .score-num { 
            font-size: 1.8rem; 
            font-weight: 800; 
            color: #0d6efd; 
            line-height: 1; 
        }

        .level-badge { 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
            color: white; 
            font-weight: bold; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            margin-top: 5px;
            display: inline-block;
        }
        
        /* Risk Card */
        .risk-score-display { 
            font-size: 4rem; 
            font-weight: 900; 
            line-height: 1; 
        }

        .risk-label { 
            font-size: 1.2rem; 
            font-weight: bold; 
            opacity: 0.8; 
        }

        .info-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-top: 15px; 
        }

        .info-item { 
            background: #f8f9fa; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            padding: 10px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .info-item i { 
            font-size: 1.5rem; 
            color: #ff3654; 
        }
        
        /* Emergency Card */
        .emergency-graphic { 
            font-size: 2.5rem; 
            margin: 0 10px; 
            color: #dc3545;
        }

        .arrow-graphic { 
            font-size: 2rem; 
            color: #666; 
            animation: slideRight 1.5s infinite; 
        }

        @keyframes slideRight { 
            0% { transform: translateX(-5px); opacity: 0.5; } 
            100% { transform: translateX(5px); opacity: 1; } 
        }

        /* Video List Items */
        .video-item { 
            display: flex; 
            padding: 15px; 
            cursor: pointer; 
            border-bottom: 1px solid #eee; 
            background: #fff; 
            align-items: center;
        }
        .video-item:last-child { border-bottom: none; }
        .video-item:hover { background: #f9f9f9; }
        .video-thumb { 
            width: 120px; 
            height: 68px; 
            object-fit: cover; 
            border-radius: 8px; 
            margin-right: 15px; 
            flex-shrink: 0; 
        }
        
        /* Buttons */
        .btn-circle { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0; 
            flex-shrink: 0; 
        }

        .btn-primary { 
            background-color: #ff3654; 
            border-color: #ff3654; 
        }

        body.vhv-mode .btn-primary { 
            background-color: #B8860B; 
            border-color: #B8860B; 
            color: #fff; 
            font-weight: bold; 
        }
        
        .btn-main { 
            background-color: #ff3654; 
            color: white; 
            border-radius: 50px; 
            padding: 10px 25px; 
            border: none; 
            box-shadow: 0 4px 10px rgba(255, 54, 84, 0.4); 
            font-weight: bold;
        }
        
        .btn-main:hover { 
            background-color: #d62540; 
            color: white; 
        }

        /* Fullscreen Overlay */
        .fullscreen-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: white; 
            z-index: 2000; 
            display: none; 
            flex-direction: column; 
        }
        .overlay-header { 
            padding: 15px; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #f8f9fa; 
        }
        .overlay-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            background: #f0f2f5;
        }
        .overlay-footer { 
            padding: 15px; 
            border-top: 1px solid #ddd; 
            background: #fff; 
        }

        /* Loading Overlay */
        #loading { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: none; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            color: white; 
        }

        .app-footer { 
            text-align: center; 
            color: #888; 
            font-size: 0.8rem; 
            margin-top: 20px; 
        }

        /* VHV Specifics */
        .vhv-patient-item { 
            border-left: 8px solid #ccc; 
            margin-bottom: 15px; 
            border-radius: 12px; 
            background-color: #fff; 
            padding: 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .vhv-risk-5 { border-left-color: #8B0000; }
        .vhv-risk-4 { border-left-color: #dc3545; }
        .vhv-risk-3 { border-left-color: #fd7e14; }
        .vhv-risk-2 { border-left-color: #ffc107; }
        .vhv-risk-1 { border-left-color: #28a745; }
        
        .leaderboard-card { height: 100%; border: 1px solid #eee; background-color: #fff !important; }
    </style>
</head>
<body>

    <!-- Loading Overlay (For blocking actions) -->
    <div id="loading">
        <div class="spinner-border text-light" role="status"></div>
        <div class="mt-3">กำลังประมวลผล...</div>
    </div>

    <!-- Fixed Header Tabs -->
    <div class="nav-tabs-container">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="health-tab-btn" data-bs-toggle="tab" data-bs-target="#health-tab-content">ข้อมูลสุขภาพ</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vhv-tab-btn" data-bs-toggle="tab" data-bs-target="#vhv-tab-content">สำหรับ อสม.</button>
            </li>
        </ul>
    </div>
    
    <div class="app-header-spacer"></div>

    <!-- Main Content Container -->
    <div class="main-container" style="padding: 0 15px;">
        <div class="tab-content">
            
            <!-- Tab 1: Health Information -->
            <div class="tab-pane fade show active" id="health-tab-content">
                <div id="dynamic-content-container">
                     <!-- Initial Loading Spinner -->
                     <div class="loading-container">
                         <div class="spinner-border text-light" role="status"></div>
                         <div class="text-white mt-2">กำลังโหลดข้อมูลส่วนตัว...</div>
                     </div>
                </div>
            </div>
            
            <!-- Tab 2: VHV Dashboard -->
            <div class="tab-pane fade" id="vhv-tab-content">
                <div id="vhv-dashboard-area">
                     <!-- Initial Loading Spinner -->
                     <div class="loading-container">
                         <div class="spinner-border text-warning" role="status"></div>
                         <div class="text-dark mt-2">กำลังโหลดข้อมูล อสม...</div>
                     </div>
                </div>
            </div>

        </div>
    </div>

    <div class="app-footer">จัดทำโดย สวีรู้ทันสโตรก รพ.สวี จ.ชุมพร</div>

    <!-- ================= MODALS ================= -->

    <!-- 1. Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">แก้ไขข้อมูลส่วนตัว</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3 text-center">
                            <img id="edit-preview-img" src="" class="profile-img-lg mb-3">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ชื่อ-นามสกุล</label>
                            <input type="text" class="form-control form-control-lg" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">เบอร์โทรศัพท์</label>
                            <input type="tel" class="form-control form-control-lg" id="editPhone" required pattern="[0-9]{10}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserProfile()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 2. Edit Emergency Modal -->
    <div class="modal fade" id="editEmergencyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขข้อมูลฉุกเฉิน</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">คนดูแล (Help)</label>
                        <select class="form-select" id="editHelp">
                            <option value="อยู่ตัวคนเดียว">อยู่ตัวคนเดียว</option>
                            <option value="อยู่กับผู้สูงอายุ/เด็กเล็ก">อยู่กับผู้สูงอายุ/เด็กเล็ก</option>
                            <option value="อยู่กับญาติผู้ใหญ่/คนวัยทำงาน">อยู่กับญาติผู้ใหญ่/คนวัยทำงาน</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">การตัดสินใจ (Decision)</label>
                        <select class="form-select" id="editDecision">
                            <option value="รอดูอาการ">รอดูอาการ</option>
                            <option value="โทรให้ญาติมาดู">โทรให้ญาติมาดู</option>
                            <option value="ไปคลินิก-อนามัย">ไปคลินิก-อนามัย</option>
                            <option value="รีบไป รพ.เอง">รีบไป รพ.เอง</option>
                            <option value="โทร 1669 ให้รถมารับ">โทร 1669 ให้รถมารับ</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="submitEmergencyEdit()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3. Distance Modal -->
    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">ปักหมุดตำแหน่ง</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">สามารถปักหมุดได้เสมอ ไม่ว่าอยู่ที่ไหน โดยเลือกว่าตำแหน่งนี้คืออะไร</p>
                    <div class="mb-3">
                        <div class="form-check">
                             <input class="form-check-input" type="radio" name="locType" id="locType1" value="บ้าน" checked>
                             <label class="form-check-label" for="locType1">บ้าน (ใช้อ้างอิงระยะทาง)</label>
                        </div>
                        <div class="form-check">
                             <input class="form-check-input" type="radio" name="locType" id="locType2" value="ทางผ่าน">
                             <label class="form-check-label" for="locType2">ทางผ่าน (เช็คระยะทางเฉยๆ)</label>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ยืนยันพิกัดปัจจุบัน
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. Score Info Modal -->
    <div class="modal fade" id="scoreInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">เกณฑ์คะแนน</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><b>1. ใส่ใจ (40%):</b> ประเมินสม่ำเสมอ (ห้ามขาด >7 วัน)</li>
                        <li class="list-group-item"><b>2. เตรียมพร้อม (10%):</b> คะแนนจาก เวลาเดินทาง x คนดูแล x การตัดสินใจ</li>
                        <li class="list-group-item"><b>3. บอกต่อ (20%):</b> การแชร์ความรู้/สติกเกอร์ให้ผู้อื่น</li>
                        <li class="list-group-item"><b>4. ความรู้ (30%):</b> คะแนนสอบเรื่องสโตรกทั้งหมด</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 5. Call Permission Modal -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-telephone-outbound-fill text-primary"></i> ยืนยันการโทร</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p>ระบบจะทำการ <b>บันทึกพิกัดปัจจุบัน</b> และ <b>ข้อมูลผู้โทร</b> <br>เพื่อความปลอดภัยและประสานงานช่วยเหลือ</p>
                    <p class="text-muted small">ท่านอนุญาตให้ข้อมูลหรือไม่?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary w-50" data-bs-dismiss="modal">ยกเลิก</button>
                    <button class="btn btn-primary w-50" onclick="confirmCall()">ยืนยันและโทรออก</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 6. Education Video Modal (Fullscreen) -->
    <div id="videoModal" class="fullscreen-overlay">
        <div class="overlay-header">
            <h5 class="m-0"><i class="bi bi-youtube text-danger"></i> วิดีโอความรู้</h5>
            <button class="btn-close" onclick="closeFullscreen('videoModal')"></button>
        </div>
        <div class="overlay-content p-0" style="background: #000;">
            <div id="videoListContainer" class="bg-white"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // =========================================
        // 7. JAVASCRIPT LOGIC
        // =========================================
        
        // Use hardcoded URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };
        
        const SAWEE_LOCATIONS = { 
            "นาโพธิ์": 8, "สวี": 4, "ทุ่งคา": 5, "วิสัยใต้": 3,
            "ด่านสวี": 4, "ท่าหิน": 3, "ปากแพรก": 4, "ครน": 4,
            "วิสัยเหนือ": 3, "นาสัก": 3, "เขาทะลุ": 3 
        };
        
        // Mock Video Data
        const VIDEOS = [
            {id:'O7MRB-dXjEc', t:'วิธีสังเกตอาการ (FAST)'},
            {id:'AdSLYKZh1hk', t:'รู้เร็ว รักษาทัน'},
            {id:'G6Z9cHqT4Tc', t:'ผักพื้นบ้านต้านโรค'},
            {id:'m50O1bgnHWk', t:'กายภาพบำบัด'}
        ];
        
        let LIFF_PROFILE = null;
        let ALL_USER_DATA = null;
        let CALL_TARGET = '';
        
        // Modal Instances
        let EDIT_PROFILE_MODAL, EDIT_EMERGENCY_MODAL, DISTANCE_MODAL, SCORE_INFO_MODAL, CALL_MODAL;

        function toggleLoading(show) {
            const el = document.getElementById('loading');
            if (el) el.style.display = show ? 'flex' : 'none';
        }

        function handleFailure(e) { 
            alert("Error: " + e.message); 
            toggleLoading(false);
        }

        // --- Mode Switching Logic ---
        function setAppMode(isVhvMode) {
            if (isVhvMode) {
                document.body.classList.add('vhv-mode');
            } else {
                document.body.classList.remove('vhv-mode');
            }
        }

        // --- Main Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Init Modals
            const initModal = (id) => new bootstrap.Modal(document.getElementById(id));
            EDIT_PROFILE_MODAL = initModal('editProfileModal');
            EDIT_EMERGENCY_MODAL = initModal('editEmergencyModal');
            DISTANCE_MODAL = initModal('distanceModal');
            SCORE_INFO_MODAL = initModal('scoreInfoModal');
            CALL_MODAL = initModal('callModal');
            
            // Tab Listeners
            document.getElementById('health-tab-btn').addEventListener('shown.bs.tab', () => setAppMode(false));
            document.getElementById('vhv-tab-btn').addEventListener('shown.bs.tab', () => setAppMode(true));

            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return; 
                }
                LIFF_PROFILE = await liff.getProfile();
                
                const refCode = new URLSearchParams(window.location.search).get('ref') || '';
                const url = `${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}&ref=${refCode}`;
                
                const res = await fetch(url).then(r => r.json());
                
                if (res.error) throw new Error(res.error);
                
                ALL_USER_DATA = res;
                updatePage(res);
                
            } catch (err) { 
                handleFailure(err); 
            }
        });

        // --- Page Render Logic ---
        function updatePage(data) {
            const hContainer = document.getElementById('dynamic-content-container');
            
            // Health Tab
            if (hContainer) {
                if (!data.userProfile) {
                    hContainer.innerHTML = `<div class="card p-5 text-center mt-3"><h5>ไม่พบข้อมูลผู้ใช้</h5><p class="text-muted">กรุณาลงทะเบียนก่อนใช้งาน</p><a href="${LINKS.REGIS}" class="btn btn-main mt-3">ลงทะเบียน</a></div>`;
                } else {
                    const gamification = data.gamification || {};
                    const dailyCheck = data.dailyCheckInfo || {};
                    const distance = data.homeDistance; 
                    const leaders = data.communityLeaders; 
                    const sticker = data.stickerShareCount || 0;
                    const exam = data.knowledgeTestStats || {};

                    hContainer.innerHTML = 
                        buildProfileHeadCard(data.userProfile) +
                        buildGamificationCard(gamification) +
                        buildRiskCard(data.userProfile) +
                        buildEmergencyCard(distance, gamification.details || {}) +
                        buildEducationCard() + 
                        buildCommunityLeadersCard(leaders);
                }
            }
            
            // VHV Tab
            const vContainer = document.getElementById('vhv-dashboard-area');
            if (vContainer) {
                const dash = data.vhvDashboard || {};
                
                if (data.isVhv) {
                    vContainer.innerHTML = 
                        buildTopVhvCard(dash.totalVhv, dash.topVhvs) +
                        buildVhvInstructions(true, dash.checklist) +
                        buildVhvInfoCard(data.vhvProfile) +
                        buildVhvLeaderboards(dash.leaderboards) +
                        `<div class="alert alert-info text-center">ระบบเพิ่มชาวบ้านกำลังปรับปรุง</div>` +
                        buildVhvPatientListCard(data.vhvPatientList);
                } else {
                    vContainer.innerHTML = 
                        buildTopVhvCard(dash.totalVhv, dash.topVhvs) +
                        buildVhvInstructions(false) +
                        buildVhvRegistrationButton();
                }
            }
        }

        // --- Builders (Components) ---
        function buildProfileHeadCard(p) {
            const dateStr = p.timestamp ? new Date(p.timestamp).toLocaleDateString('th-TH') : '-';
            return `
            <div class="col-12 mb-3">
                <div class="card p-3 d-flex flex-row align-items-center bg-white shadow-sm">
                    <img src="${p.pictureUrl}" class="profile-img-lg me-3">
                    <div>
                        <h4 class="fw-bold mb-0">${p.name}</h4>
                        <div class="text-muted"><i class="bi bi-telephone"></i> ${p.telephone.replace(/'/g,'')}</div>
                        <div class="small text-muted">ลงทะเบียน: ${dateStr}</div>
                    </div>
                    <div class="ms-auto">
                        <button class="btn btn-sm btn-outline-secondary rounded-circle" onclick="openEditProfile()">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function buildGamificationCard(s) {
            const levelClass = s.levelColor === 'warning' ? 'bg-warning text-dark' : (s.levelColor === 'success' ? 'bg-success text-white' : 'bg-secondary text-white');
            const nextScore = s.nextLevelScore - s.totalScore;
            const progress = (s.totalScore / s.nextLevelScore) * 100;
            return `
            <div class="col-12 mb-3">
                <div class="card game-score-card shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                             <h5 class="section-title mb-0 text-primary"><i class="bi bi-trophy-fill text-warning"></i>คะแนนความตระหนักรู้</h5>
                             <button class="btn btn-sm btn-outline-info rounded-circle" onclick="SCORE_INFO_MODAL.show()">?</button>
                        </div>
                        <div class="text-center mb-3">
                             <div class="display-3 fw-bold text-primary">${s.totalScore}</div>
                             <span class="badge rounded-pill ${levelClass} fs-6">${s.levelName}</span>
                        </div>
                        <div class="progress mb-1" style="height: 8px;"><div class="progress-bar bg-${s.levelColor}" style="width: ${progress}%"></div></div>
                        <div class="text-end small text-muted mb-3">อีก ${Math.max(0, nextScore.toFixed(0))} คะแนน เลื่อนระดับ</div>
                        <div class="row g-2 text-center">
                            <div class="col-3"><div class="game-score-box" onclick="window.open('${LINKS.DAILY}')"><h3>${s.checkScore}</h3><span>ใส่ใจ</span></div></div>
                            <div class="col-3"><div class="game-score-box" onclick="DISTANCE_MODAL.show()"><h3>${s.emergencyScore}</h3><span>เตรียม</span></div></div>
                            <div class="col-3"><div class="game-score-box" onclick="window.open('${LINKS.STICKER}')"><h3>${s.stickerScore}</h3><span>บอกต่อ</span></div></div>
                            <div class="col-3"><div class="game-score-box" onclick="window.open('${LINKS.KNOWLEDGE}')"><h3>${s.knowledgeScore}</h3><span>ความรู้</span></div></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        function buildEducationCard() {
             // Added Video/Lesson Button Group
             return `
             <div class="col-12 mb-3">
                 <div class="card bg-light">
                     <div class="card-body">
                         <h5 class="section-title mb-3"><i class="bi bi-book-half text-success"></i> เรียนรู้สู้สโตรก</h5>
                         <div class="d-grid gap-2">
                             <button class="btn btn-outline-danger" onclick="openVideoList()"><i class="bi bi-youtube"></i> วิดีโอความรู้</button>
                             <button class="btn btn-outline-primary" onclick="window.open('${LINKS.KNOWLEDGE}')"><i class="bi bi-pencil-square"></i> ทำแบบทดสอบ</button>
                         </div>
                     </div>
                 </div>
             </div>`;
        }

        function buildRiskCard(p) {
             const score = parseFloat(p.thai_cv_risk_score||0).toFixed(2);
             let color = '#28a745'; 
             if(score>=10) color='#ffc107'; 
             if(score>=20) color='#fd7e14'; 
             if(score>=30) color='#dc3545';
             
             const items = [
                {l:'เพศ', v:p.gender==1?'ชาย':'หญิง', i:'bi-gender-ambiguous'},
                {l:'อายุ', v: `${p.age || '-'} ปี`, i:'bi-calendar-event'},
                {l:'สูบบุหรี่', v:p.smoke==1?'สูบ':'ไม่', i:'bi-fire'},
                {l:'เบาหวาน', v:p.dm==1?'เป็น':'ไม่', i:'bi-droplet'},
                {l:'ความดัน', v:p.sbp, i:'bi-speedometer'},
                {l:'ไขมัน', v:p.cholesterol, i:'bi-heart'}
             ].map(x=>`<div class="info-item"><i class="bi ${x.i}"></i><div><small>${x.l}</small><b>${x.v}</b></div></div>`).join('');
             
             return `
             <div class="col-12 mb-3">
                 <div class="card">
                     <div class="card-body">
                        <h5 class="section-title mb-0"><i class="bi bi-heart-pulse-fill text-danger"></i> ความเสี่ยง 10 ปี</h5>
                        <div class="text-center mb-3">
                             <div class="risk-score-display" style="color: ${color}">${score}%</div>
                             <div class="risk-label" style="color: ${color}">ระดับความเสี่ยง</div>
                             <div class="mt-2"><a href="${LINKS.REGIS}" class="btn btn-outline-danger rounded-pill px-4">ประเมินใหม่</a></div>
                        </div>
                        <div class="info-grid">${items}</div>
                     </div>
                 </div>
             </div>`;
        }

        function buildEmergencyCard(d, details) {
            const h = details.help || 'ไม่ระบุ';
            const dec = details.decision || 'ไม่ระบุ';
            const dist = d ? `${d.distance_km} กม. (${d.duration_mins} นาที)` : 'ยังไม่ปักหมุด';
            const warn = (d && d.distance_km > 40) ? '<div class="alert alert-warning mt-2 small">ระยะทางไกลเกิน 40 กม.</div>' : '';

            return `
            <div class="col-12 mb-3">
                <div class="card border-danger shadow-sm">
                    <div class="card-body">
                        <h5 class="text-danger fw-bold"><i class="bi bi-truck-front-fill"></i> ฉุกเฉิน (รพ.สวี)</h5>
                        <div class="d-flex align-items-center justify-content-center my-3 text-danger">
                            <i class="bi bi-person-fill emergency-graphic"></i> 
                            <div class="text-center"><i class="bi bi-arrow-right display-6"></i><br><small>${dist}</small></div>
                            <i class="bi bi-hospital-fill emergency-graphic"></i>
                        </div>
                        ${warn}
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between"><span>คนดูแล:</span> <b>${h}</b></li>
                            <li class="list-group-item d-flex justify-content-between"><span>การตัดสินใจ:</span> <b>${dec}</b></li>
                        </ul>
                        <div class="row g-2">
                             <div class="col-6"><button class="btn btn-outline-secondary w-100" onclick="openEditEmergency('${h}', '${dec}')">แก้ไขข้อมูล</button></div>
                             <div class="col-6"><button class="btn btn-primary w-100" onclick="DISTANCE_MODAL.show()">ปักหมุดใหม่</button></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function buildVhvLeaderboards(lb) {
             const row = (t, l) => {
                 let content = l && l.length > 0 ? l.map((x,i)=>`<div class="leaderboard-row"><div class="leaderboard-rank">${i+1}</div><img src="${x.pic||'https://via.placeholder.com/40'}" class="leaderboard-img"><div class="small text-truncate" style="max-width:80px;">${x.name}</div><div class="leaderboard-score">${x.score}</div></div>`).join('') : '<div class="text-center text-muted small py-2">-</div>';
                 return `<div class="col-6 mb-2"><div class="card leaderboard-card"><div class="card-header bg-light small fw-bold text-center">${t}</div><div class="card-body p-2">${content}</div></div></div>`;
             };
             return `<div class="row g-2 mb-3">${row('เยี่ยมบ้าน', lb.visits)}${row('แจ้งเหตุ', lb.reports)}${row('แนะนำไลน์', lb.exams)}${row('ปักหมุด', lb.pins)}</div>`;
        }

        function buildVhvPatientListCard(pts) {
            if(!pts || pts.length===0) return '<div class="alert alert-secondary">ยังไม่มีชาวบ้านในเขต</div>';
            let html = pts.map(p => `
                <div class="vhv-patient-item vhv-risk-${Math.ceil(p.thai_cv_risk_score/10)}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold fs-5">${p.name} <span class="badge bg-secondary">${p.thai_cv_risk_score}%</span></div>
                            <div class="small text-muted">ประเมิน: ${p.latestCheckTimestamp ? p.latestCheckTimestamp.split('T')[0] : 'ยังไม่เคย'}</div>
                            <div class="small text-muted">ระยะห่าง: ${p.distanceFromVhv_km || '?'} กม.</div>
                        </div>
                        <div class="d-flex flex-column gap-2">
                             <a href="tel:${p.telephone}" class="btn btn-sm btn-outline-success rounded-circle"><i class="bi bi-telephone-fill"></i></a>
                             <button class="btn btn-sm btn-warning rounded-pill" onclick="alert('Coming Soon')">เยี่ยม</button>
                        </div>
                    </div>
                    ${p.isReferred ? '<div class="mt-1 badge bg-info text-dark"><i class="bi bi-link-45deg"></i> แนะนำมา</div>' : ''}
                </div>`).join('');
            return `<div class="card"><div class="card-header bg-white fw-bold d-flex justify-content-between"><span>ชาวบ้านในเขต</span> <button class="btn btn-sm btn-danger">รายงานเคส</button></div><div class="card-body bg-light">${html}<div class="d-grid mt-3"><a href="https://sawee-hosp.github.io/stroke-risk/" target="_blank" class="btn btn-success">บันทึกการประเมินผู้ป่วย (Web)</a></div></div></div>`;
        }
        
        function buildCommunityLeadersCard(l) { 
             if(!l) return '';
             let html = '<ul class="list-group list-group-flush">';
             if(l.pcu) html += `<li class="list-group-item d-flex justify-content-between"><span>${l.pcu}</span><button class="btn btn-sm btn-outline-primary btn-circle" onclick="prepareCall('${l.pcu_tel}')"><i class="bi bi-telephone-fill"></i></button></li>`;
             if(l.headman) html += `<li class="list-group-item d-flex justify-content-between"><span>ผญบ. ${l.headman}</span><button class="btn btn-sm btn-outline-dark btn-circle" onclick="prepareCall('${l.headman_tel}')"><i class="bi bi-telephone-fill"></i></button></li>`;
             html += '</ul>';
             return `<div class="col-12 mb-3"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-people-fill"></i> ผู้นำชุมชน</h5>${html}</div></div></div>`;
        }

        function buildTopVhvCard(total, topList) {
            let listHtml = '';
            if(topList && topList.length > 0) {
                topList.forEach((t, i) => {
                    listHtml += `<div class="d-flex align-items-center mb-2"><div class="me-2 fw-bold text-primary">#${i+1}</div><img src="${t.picture}" class="rounded-circle me-2" style="width:40px;height:40px;"><div class="small fw-bold text-truncate" style="max-width:100px;">${t.name}</div><div class="ms-auto badge bg-success">${t.score} แชร์</div></div>`;
                });
            } else { listHtml = '<small class="text-muted">ยังไม่มีข้อมูล</small>'; }
            
            return `
            <div class="card mb-3 border-primary shadow">
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-5 text-center border-end">
                            <div class="text-muted small fw-bold">อสม.ทั้งหมด</div>
                            <div class="display-3 fw-bold text-primary">${total || 0}</div>
                            <div class="small">ท่าน</div>
                        </div>
                        <div class="col-7">
                            <div class="text-muted small fw-bold mb-2"><i class="bi bi-award-fill text-warning"></i> อสม. ยอดเยี่ยม (7 วัน)</div>
                            ${listHtml}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function buildVhvInstructions(isRegistered, cl) {
            const getIcon = (status) => status ? '<i class="bi bi-check-circle-fill check-icon check-ok"></i>' : '<i class="bi bi-x-circle-fill check-icon check-no"></i>';
            return `
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-dark mb-3"><i class="bi bi-list-check"></i> ขั้นตอนการทำงาน</h5>
                    <ul class="list-group list-group-flush fs-5">
                        <li class="list-group-item">${getIcon(true)} ลงทะเบียน อสม.</li>
                        <li class="list-group-item">${getIcon(cl?.hasPinned)} ปักหมุดบ้านตนเอง</li>
                        <li class="list-group-item">${getIcon(cl?.hasSharedSticker)} แชร์ความรู้ (สติกเกอร์)</li>
                    </ul>
                </div>
            </div>`;
        }

        function buildVhvInfoCard(vhv) {
            const pinBtnText = vhv.asm_home ? 'อัปเดตหมุดบ้าน' : 'ปักหมุดบ้าน อสม.';
            return `
            <div class="card border-warning shadow">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <button class="btn btn-dark btn-lg w-100 shadow rounded-pill py-3" onclick="showQrModal()"><i class="bi bi-qr-code fs-2"></i> แสดง QR Code</button>
                    </div>
                    <hr>
                    <h5 class="section-title text-dark">ข้อมูลส่วนตัว อสม.</h5>
                    <p class="mb-1 fs-5"><b>ชื่อ:</b> ${vhv.name || ''}</p>
                    <p class="mb-1 fs-5"><b>พื้นที่:</b> ${vhv.area || ''}</p>
                    <div class="row mt-3 g-2">
                        <div class="col-6"><button class="btn btn-primary w-100 btn-lg" onclick="handleShareProfile()"><i class="bi bi-share-fill"></i> แชร์นามบัตร</button></div>
                        <div class="col-6"><button class="btn btn-outline-dark w-100 btn-lg" onclick="alert('Opening modal...')">แก้ไขข้อมูล/ปักหมุด</button></div>
                    </div>
                </div>
            </div>`;
        }

        function buildVhvRegistrationButton() {
            return `<div class="card bg-white text-center p-4"><i class="bi bi-person-plus-fill display-1 text-warning mb-3"></i><h3>สมัครเป็น อสม.สโตรก</h3><p class="text-muted">สำหรับ อสม. รพ.สวี เท่านั้น</p><button class="btn btn-lg btn-warning fw-bold w-100" onclick="alert('Open VHV Reg')">ลงทะเบียน</button></div>`;
        }

        // Logic Functions
        function openEditProfile() { 
            document.getElementById('editName').value = ALL_USER_DATA.userProfile.name;
            document.getElementById('editPhone').value = ALL_USER_DATA.userProfile.telephone.replace(/'/g,'');
            document.getElementById('edit-preview-img').src = ALL_USER_DATA.userProfile.pictureUrl;
            EDIT_PROFILE_MODAL.show(); 
        }
        function saveUserProfile() { const n = document.getElementById('editName').value; const p = document.getElementById('editPhone').value; if(!n || !p) return alert("กรุณากรอกข้อมูลให้ครบ"); toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateUserProfile', data: { userId: LIFF_PROFILE.userId, name: n, phone: p, pictureUrl: LIFF_PROFILE.pictureUrl } }) }).then(() => { alert("บันทึกสำเร็จ"); window.location.reload(); }).catch(e => alert(e.message)); }
        function openEditEmergency(h, d) { document.getElementById('editHelp').value = h; document.getElementById('editDecision').value = d; EDIT_EMERGENCY_MODAL.show(); }
        function submitEmergencyEdit() { const h = document.getElementById('editHelp').value; const d = document.getElementById('editDecision').value; toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateEmergencyInfo', data: { userId: LIFF_PROFILE.userId, help: h, decision: d } }) }).then(() => { alert('บันทึกเรียบร้อย'); location.reload(); }).catch(handleFailure); }
        function handlePinNewLocation() { const type = document.querySelector('input[name="locType"]:checked').value; toggleLoading(true); navigator.geolocation.getCurrentPosition(p => { fetch(`${WEB_APP_URL}?action=calculateDistance&lat=${p.coords.latitude}&lon=${p.coords.longitude}`).then(r=>r.json()).then(d=> { fetch(WEB_APP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'saveNewLocation',data:{userId:LIFF_PROFILE.userId,type:type,latlong:`${p.coords.latitude},${p.coords.longitude}`,distance:d.distance_km,duration:d.duration_mins}})}).then(()=>{alert("บันทึกสำเร็จ"); window.location.reload();}); }); }, e=>handleFailure(e), {enableHighAccuracy: true}); }
        function prepareCall(tel) { CALL_TARGET = tel; CALL_MODAL.show(); }
        function confirmCall() { navigator.geolocation.getCurrentPosition(p => { fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'logTelCall', data: { userId: LIFF_PROFILE.userId, tel: CALL_TARGET, latlong: `${p.coords.latitude},${p.coords.longitude}` } }) }); window.location.href = `tel:${CALL_TARGET}`; }, () => window.location.href = `tel:${CALL_TARGET}`); }
        function openVideoList() { document.getElementById('videoModal').style.display='flex'; document.getElementById('videoListContainer').innerHTML = VIDEOS.map(v=>`<div class="video-item" onclick="window.open('https://youtube.com/watch?v=${v.id}')"><img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg" class="video-thumb"><div>${v.t}</div></div>`).join(''); }
        function closeFullscreen(id) { document.getElementById(id).style.display='none'; }
        function handleShareProfile() { toggleLoading(true); fetch(`${WEB_APP_URL}?action=getShareCard&userId=${LIFF_PROFILE.userId}`).then(r=>r.json()).then(d => { toggleLoading(false); if(d.success) liff.shareTargetPicker([d.flex]); else alert(d.message); }); }
    </script>
</body>
</html>