<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สวีรู้ทันสโตรก</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* --- CORE THEME --- */
        :root {
            --theme-red: #d32f2f; 
            --theme-red-soft: #ffebee;
            --theme-gold: #876029;   
            --theme-gold-text: #eae2cd; 
            --bg-card: #fffbf0;
            --border-gold: #f2e6d0;
            --base-font: 18px; 
            --border-radius: 20px;
        }
        
        html { font-size: var(--base-font); }
        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            background: linear-gradient(180deg, var(--theme-red) 0%, #ffffff 400px);
            margin: 0; padding-bottom: 80px; 
            color: #333; transition: background 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        body.vhv-mode { background: linear-gradient(180deg, var(--theme-gold) 0%, #ffffff 400px); }
        
        h1, h2, h3, h4, h5, h6 { font-weight: 700 !important; margin-bottom: 0.3rem; }

        /* --- TABS --- */
        .nav-tabs-container { position: fixed; top: 0; width: 100%; z-index: 1000; display: flex; height: 50px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .nav-item { width: 50%; }
        .nav-link { 
            width: 100%; height: 100%; border: none; border-radius: 0; 
            font-weight: 700; font-size: 1.1rem; 
            display: flex; align-items: center; justify-content: center; 
            color: #aaa; background: #fff; transition: 0.2s; cursor: pointer;
        }
        #tab-health.active { background-color: var(--theme-red); color: white; }
        #tab-vhv.active { background-color: var(--theme-gold); color: var(--theme-gold-text); }
        
        .app-header-spacer { height: 65px; }
        .content-area { padding: 0 10px; }

        /* --- CARDS (BIG STYLE) --- */
        .card-box { 
            background-color: var(--bg-card); 
            border: 1px solid var(--border-gold); 
            border-radius: var(--border-radius); 
            padding: 15px; margin-bottom: 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            position: relative;
            min-height: 120px; /* กัน Card ยุบ */
        }
        .card-title { font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: #444; }
        .card-title i { font-size: 1.5rem; }

        /* --- LOADING SPINNER IN CARD --- */
        .card-loader {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; min-height: 100px;
        }
        .spinner-border { width: 2.5rem; height: 2.5rem; opacity: 0.6; }

        /* COLORS */
        .text-gold { color: var(--theme-gold) !important; }
        .bg-gold-soft { background-color: #fff8e1; }
        .text-red { color: var(--theme-red) !important; }

        /* BUTTONS */
        .btn-pill { border-radius: 50px; font-weight: 700; padding: 10px 20px; font-size: 1rem; width: 100%; }
        .btn-red { background: var(--theme-red); color: white; border: none; box-shadow: 0 4px 6px rgba(211, 47, 47, 0.2); }
        .btn-gold { background: var(--theme-gold); color: var(--theme-gold-text); border: none; box-shadow: 0 4px 6px rgba(135, 96, 41, 0.2); }
        .btn-outline { border: 2px solid #ddd; background: white; color: #555; }
        
        /* ICONS CIRCLE */
        .icon-circle { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; background: white; border: 1px solid #eee; margin: 0 auto 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* PROFILE */
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .badge-regis { font-size: 0.8rem; background: rgba(0,0,0,0.05); padding: 4px 10px; border-radius: 10px; color: #666; display: inline-block; margin-top: 5px; }
        .badge-area { background-color: var(--theme-gold); color: white; border-radius: 15px; padding: 4px 12px; font-size: 0.85rem; }

        /* SCORE CARD */
        .level-bar { height: 24px; background: #e9ecef; border-radius: 12px; position: relative; margin: 15px 0; overflow: hidden; display: flex; }
        .level-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: white; font-weight: bold; text-shadow: 0 0 2px rgba(0,0,0,0.5); opacity: 0.3; transition: 0.3s; }
        .level-segment.active { opacity: 1; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .score-box { text-align: center; cursor: pointer; transition: 0.2s; padding: 5px; border-radius: 10px; }
        .score-box:active { background: rgba(0,0,0,0.05); transform: scale(0.98); }
        .score-val { font-weight: 900; font-size: 1.2rem; line-height: 1.2; }

        /* RISK CARD */
        .risk-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .risk-item { background: white; padding: 8px 10px; border-radius: 10px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; color: #555; }
        .risk-item i { margin-right: 5px; color: #888; font-size: 1.1rem; }

        /* HOSPITAL FLOW */
        .hospital-flow { display: flex; align-items: center; justify-content: space-between; margin: 20px 0; padding: 0 5px; }
        .arrow-line { flex-grow: 1; height: 3px; background: #ddd; margin: 0 10px; position: relative; display: flex; align-items: center; justify-content: center; }
        .arrow-line::after { content: ''; position: absolute; right: -6px; top: -6px; border: 7px solid transparent; border-left-color: #ddd; }
        .dist-tag { background: #444; color: white; padding: 3px 10px; border-radius: 5px; font-size: 0.85rem; position: relative; top: -12px; font-weight: bold; }

        /* VHV SPECIFIC */
        .vhv-stat-box { background: white; border: 1px solid #eee; border-radius: 10px; padding: 8px; text-align: center; height: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .vhv-rank-row { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .rank-badge { width: 24px; height: 24px; background: #ccc; color: white; border-radius: 50%; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-weight: bold; }
        .rank-1 { background: #FFD700; } .rank-2 { background: #C0C0C0; } .rank-3 { background: #CD7F32; }
        
        .patient-row { display: flex; align-items: center; background: white; padding: 10px; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 6px solid #ccc; position: relative; }
        .risk-danger { border-color: #dc3545; background: #fff8f8; }
        .risk-high { border-color: #fd7e14; }
        .risk-med { border-color: #ffc107; }
        .risk-low { border-color: #28a745; }
        .dist-badge { position: absolute; top: 10px; right: 10px; font-size: 0.75rem; background: #eee; padding: 3px 8px; border-radius: 5px; }
        
        /* Helper Animations */
        .scan-anim { animation: pulseScan 2s infinite; color: var(--theme-gold); }
        @keyframes pulseScan { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.5; transform: scale(1); } }

        .footer { text-align: center; font-size: 0.8rem; color: #bbb; margin-top: 30px; margin-bottom: 20px; }
        
        /* Global Loader (Only for actions like Saving) */
        #action-loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:2000; display:none; flex-direction:column; justify-content:center; align-items:center; color:#333; }
    </style>
</head>
<body>

<!-- Action Loader (ใช้ตอนกดปุ่มบันทึกเท่านั้น ไม่ใช่ตอนเข้าเว็บ) -->
<div id="action-loader">
    <div class="spinner-border text-danger mb-3"></div>
    <div class="fw-bold">กำลังบันทึก...</div>
</div>

<!-- TABS -->
<div class="nav-tabs-container">
    <div class="nav-item"><div id="tab-health" class="nav-link active" onclick="setTab('health')">ข้อมูลสุขภาพ</div></div>
    <div class="nav-item"><div id="tab-vhv" class="nav-link" onclick="setTab('vhv')">สำหรับ อสม.</div></div>
</div>
<div class="app-header-spacer"></div>

<!-- CONTENT AREA -->
<div class="content-area">

    <!-- === VIEW: HEALTH === -->
    <div id="view-health">
        
        <!-- 1. Profile -->
        <div id="card-profile" class="card-box" style="margin-top: 10px;">
            <div class="card-loader text-danger"><div class="spinner-border"></div></div>
        </div>

        <!-- 2. Score -->
        <div id="card-score" class="card-box">
            <div class="d-flex justify-content-between"><h5 class="card-title text-red m-0"><i class="bi bi-trophy-fill"></i> คะแนนตระหนักรู้</h5><i class="bi bi-info-circle text-muted" onclick="MODALS.info.show()"></i></div>
            <div class="card-loader text-danger"><div class="spinner-border"></div></div>
        </div>

        <!-- 3. Risk -->
        <div id="card-risk" class="card-box">
            <h5 class="card-title text-red"><i class="bi bi-activity"></i> ประเมินความเสี่ยง</h5>
            <div class="card-loader text-danger"><div class="spinner-border"></div></div>
        </div>

        <!-- 4. Hospital -->
        <div id="card-hospital" class="card-box">
            <h5 class="card-title text-red"><i class="bi bi-hospital"></i> การเตรียมพร้อม</h5>
            <div class="card-loader text-danger"><div class="spinner-border"></div></div>
        </div>

        <!-- 5. Helper -->
        <div id="card-helper" class="card-box">
            <h5 class="card-title text-primary"><i class="bi bi-people-fill"></i> บุคคลช่วยเหลือ</h5>
            <div class="card-loader text-primary"><div class="spinner-border"></div></div>
        </div>

        <!-- 6. Sticker -->
        <div id="card-sticker" class="card-box">
            <h5 class="card-title justify-content-center text-success"><i class="bi bi-line"></i> แชร์สติกเกอร์</h5>
            <div class="card-loader text-success"><div class="spinner-border"></div></div>
        </div>

        <!-- 7. Knowledge -->
        <div id="card-knowledge" class="card-box">
            <h5 class="card-title text-warning"><i class="bi bi-journal-text"></i> คะแนนสอบวัดความรู้</h5>
            <div class="card-loader text-warning"><div class="spinner-border"></div></div>
        </div>

    </div>

    <!-- === VIEW: VHV === -->
    <div id="view-vhv" style="display:none;">
        
        <!-- VHV Profile -->
        <div id="vhv-profile" class="card-box" style="margin-top: 10px; background-color: #fffbf0; border-color: #f2e6d0;">
            <div class="card-loader text-gold"><div class="spinner-border"></div></div>
        </div>
        
        <!-- VHV Performance -->
        <div id="vhv-perf" class="card-box" style="background-color: #fffbf0; border-color: #f2e6d0;">
            <div class="d-flex justify-content-between"><h5 class="card-title text-gold m-0"><i class="bi bi-star-fill"></i> ผลงาน อสม.</h5><i class="bi bi-info-circle text-muted" onclick="MODALS.info.show()"></i></div>
            <div class="card-loader text-gold"><div class="spinner-border"></div></div>
        </div>
        
        <!-- VHV Leaderboard -->
        <div id="vhv-leader" class="card-box" style="background-color: #fffbf0; border-color: #f2e6d0; max-height: 350px; overflow-y: auto;">
             <h5 class="card-title text-gold"><i class="bi bi-award-fill"></i> อันดับ อสม.ดีเด่น</h5>
             <div class="card-loader text-gold"><div class="spinner-border"></div></div>
        </div>
        
        <!-- Patient List -->
        <div id="vhv-patients" class="card-box" style="background-color: #fffbf0; border-color: #f2e6d0;">
            <h5 class="card-title text-gold mb-3"><i class="bi bi-geo-alt-fill"></i> เยี่ยมบ้านปักหมุด</h5>
            <div class="card-loader text-gold"><div class="spinner-border"></div><div class="mt-2 small text-muted">กำลังค้นหาลูกบ้าน...</div></div>
        </div>

    </div>

    <div class="footer">จัดทำโดย สวีรู้ทันสโตรก รพ.สวี จ.ชุมพร</div>
</div>

<!-- MODALS -->

<!-- 1. Edit User Emergency -->
<div class="modal fade" id="modalEditEmg" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0 p-3"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">แก้ไขข้อมูลฉุกเฉิน</h5></div><div class="modal-body pt-2">
    <div class="mb-3"><label class="text-muted mb-1">คนดูแลที่บ้าน</label><input type="text" class="form-control" id="inpHelp" placeholder="เช่น สามี, ลูกสาว"></div>
    <div class="mb-4"><label class="text-muted mb-1">การตัดสินใจ</label><select class="form-select" id="inpDec"><option>รอดูอาการ</option><option>โทรให้ญาติมาดู</option><option>ไปคลินิก-อนามัย</option><option>รีบไป รพ.เอง</option><option>โทร 1669 ให้รถมารับ</option></select></div>
    <button class="btn btn-red btn-pill w-100" onclick="saveEmg()">บันทึกข้อมูล</button>
</div></div></div></div>

<!-- 2. Edit VHV Profile -->
<div class="modal fade" id="modalEditVhv" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 border-0 p-3"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold text-gold">แก้ไขข้อมูล อสม.</h5></div><div class="modal-body pt-2">
    <div class="mb-3"><label class="text-muted mb-1">ชื่อ-สกุล</label><input type="text" class="form-control" id="vhvName"></div>
    <div class="mb-3"><label class="text-muted mb-1">เบอร์โทร</label><input type="tel" class="form-control" id="vhvPhone"></div>
    <div class="bg-light p-3 rounded mb-3">
        <label class="fw-bold mb-2 text-gold">พื้นที่รับผิดชอบ</label>
        <div class="row g-2">
            <div class="col-6">
                <select id="vhvDistrict" class="form-select" onchange="updateVillages()"><option value="">ตำบล</option></select>
            </div>
            <div class="col-6">
                <select id="vhvVillage" class="form-select"><option value="">หมู่</option></select>
            </div>
        </div>
    </div>
    <button class="btn btn-gold btn-pill w-100" onclick="saveVhvProfile()">บันทึก</button>
</div></div></div></div>

<!-- 3. Consent Call -->
<div class="modal fade" id="modalCall" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 text-center p-4 border-0">
    <i class="bi bi-shield-lock-fill text-secondary display-4 mb-2"></i>
    <h4 class="fw-bold">ขออนุญาตโทรออก</h4>
    <p class="text-muted mb-4">ระบบจะบันทึกประวัติการโทรเพื่อเป็นข้อมูลการช่วยเหลือ (PDPA)</p>
    <div class="d-grid gap-2"><button class="btn btn-success btn-pill" onclick="execCall()">ยินยอมและโทรออก</button><button class="btn btn-outline btn-pill" data-bs-dismiss="modal">ยกเลิก</button></div>
</div></div></div>

<!-- 4. Pin Home Alert -->
<div class="modal fade" id="modalPin" data-bs-backdrop="static" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content rounded-4 text-center p-4 border-0">
    <i class="bi bi-geo-alt-fill text-danger display-3 mb-2"></i>
    <h4 class="fw-bold">กรุณาปักหมุดบ้าน</h4>
    <p class="text-muted mb-4">เพื่อให้ระบบคำนวณระยะทางได้ถูกต้อง</p>
    <div class="d-grid gap-2"><button class="btn btn-red btn-pill" onclick="pinHome(false)">ปักหมุดเลย</button><button class="btn btn-outline btn-pill" data-bs-dismiss="modal">ยังไม่ได้อยู่บ้าน</button></div>
</div></div></div>

<!-- 5. QR Code -->
<div class="modal fade" id="modalQR" tabindex="-1"><div class="modal-dialog modal-fullscreen"><div class="modal-content bg-dark text-white text-center justify-content-center">
    <button class="btn-close btn-close-white position-absolute top-0 end-0 m-4" data-bs-dismiss="modal"></button>
    <h2 class="text-warning mb-4">ชาวบ้านมีไลน์</h2>
    <div class="bg-white p-3 rounded-4 d-inline-block"><img id="qrImg" src="" style="width:250px;"></div>
    <p class="mt-4 fs-5 text-white-50">สแกนเพื่อเพิ่มเพื่อน</p>
</div></div></div>

<!-- 6. Info Score -->
<div class="modal fade" id="modalInfo" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-4 rounded-4 border-0">
    <h5 class="fw-bold mb-3">วิธีคิดคะแนน อสม.</h5>
    <ul class="text-muted ps-3 mb-0">
        <li class="mb-2">บอกต่อ (แชร์ QR) = 10 คะแนน</li>
        <li class="mb-2">แชร์สติกเกอร์ = 1 คะแนน</li>
        <li class="mb-2">เยี่ยมบ้าน = 5 คะแนน</li>
        <li class="mb-2">รายงานเคส = 50 คะแนน</li>
    </ul>
    <button class="btn btn-outline w-100 btn-pill mt-4" data-bs-dismiss="modal">ปิด</button>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    // Config
    const API_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec'; 
    const LIFF_ID = '2005789397-RLAGXrBJ';
    const LINKS = { 
        REGIS: 'https://liff.line.me/2005789397-nebQ8oJy', 
        STICKER: 'https://liff.line.me/2005789397-37lemBgX', 
        KNOWLEDGE: 'https://liff.line.me/2005789397-ROQvjpYk' 
    };
    
    let USER_ID = '', PROFILE = {}, DATA = {}, TARGET_TEL = '';
    const MODALS = {};

    window.onload = async () => {
        // 1. Init UI
        initDropdowns();
        ['modalEditEmg','modalEditVhv','modalCall','modalPin','modalQR','modalInfo'].forEach(i=>MODALS[i]=new bootstrap.Modal(document.getElementById(i)));

        // 2. Init LIFF & Load Data (Parallel)
        try {
            await liff.init({liffId:LIFF_ID});
            if(!liff.isLoggedIn()){ liff.login(); return; }
            
            PROFILE = await liff.getProfile();
            USER_ID = PROFILE.userId;
            
            // --- Loading Strategy: Structure 100% first (HTML) -> Then load data chunks ---
            loadBasicInfo();    // Profile, Risk, Hospital, Helper
            loadGamification(); // Score, Sticker, Knowledge

        } catch(e){ 
            console.error(e);
            // Fallback for testing
            // USER_ID='TEST_USER'; loadBasicInfo(); loadGamification(); 
        }
    };

    function setTab(t) {
        document.getElementById('view-health').style.display = t==='health'?'block':'none';
        document.getElementById('view-vhv').style.display = t==='vhv'?'block':'none';
        document.getElementById('tab-health').className = `nav-link ${t==='health'?'active':''}`;
        document.getElementById('tab-vhv').className = `nav-link ${t==='vhv'?'active':''}`;
        document.body.className = t==='vhv' ? 'vhv-mode' : '';
        window.scrollTo(0,0);
    }

    // --- PART 1: LOAD BASIC INFO ---
    async function loadBasicInfo() {
        try {
            const res = await fetch(`${API_URL}?action=getBasicInfo&userId=${USER_ID}`);
            const data = await res.json();
            DATA = {...DATA, ...data};

            // 1. Profile
            const u = DATA.userProfile;
            document.getElementById('card-profile').innerHTML = `
                <div class="d-flex align-items-center">
                    <img src="${PROFILE.pictureUrl}" class="profile-pic me-3">
                    <div class="flex-grow-1">
                        <h4 class="fw-bold mb-1">${u.name}</h4>
                        <div class="text-muted small">${u.telephone}</div>
                        <span class="badge-regis"><i class="bi bi-clock"></i> ลงทะเบียน: ${u.regisDate}</span>
                    </div>
                    <button class="btn btn-outline rounded-circle" style="width:45px;height:45px;" onclick="location.href='${LINKS.REGIS}'"><i class="bi bi-pencil"></i></button>
                </div>`;

            // 3. Risk
            renderRiskCard(u);

            // 4. Hospital
            renderHospitalCard();

            // 5. Helper
            const l = DATA.communityLeaders;
            document.getElementById('card-helper').innerHTML = `
                <h5 class="card-title text-primary"><i class="bi bi-people-fill"></i> บุคคลช่วยเหลือ</h5>
                <div class="d-flex align-items-center py-3 border-bottom"><i class="bi bi-hospital fs-1 text-danger me-3"></i><div><div class="fw-bold fs-5">${l.pcu}</div><small class="text-muted">รพ.สต. ในพื้นที่</small></div></div>
                <div class="d-flex align-items-center py-3 border-bottom"><i class="bi bi-person-badge fs-1 text-dark me-3"></i><div class="flex-grow-1"><div class="fw-bold fs-5">ผู้ใหญ่บ้าน</div><small class="text-muted">${l.area}</small></div><button class="btn btn-success rounded-circle" style="width:45px;height:45px;" onclick="call('${l.headTel}')"><i class="bi bi-telephone-fill"></i></button></div>
                <div class="d-flex align-items-center py-3"><i class="bi bi-qr-code-scan fs-1 me-3 scan-anim text-warning"></i><div class="fw-bold text-secondary">พบ อสม. ${l.vhvCount} ท่าน ในพื้นที่</div></div>`;

            // Check Pin
            if(!DATA.isVhv && (!DATA.homeDistance || DATA.homeDistance.km === '?')) MODALS.modalPin.show();

            // Trigger VHV Load if eligible
            if(DATA.isVhv) loadVhvData();
            else document.getElementById('tab-vhv').style.display='none';

        } catch(e) { console.error('BasicInfo Err',e); }
    }

    // --- PART 2: LOAD GAMIFICATION ---
    async function loadGamification() {
        try {
            const res = await fetch(`${API_URL}?action=getGamification&userId=${USER_ID}`);
            const data = await res.json();
            DATA = {...DATA, ...data};
            
            const g = DATA.gamification;
            const k = DATA.knowledgeData;
            
            // 2. Score
            const lvClass = g.level.includes('ปริญญา')?3:g.level.includes('มัธยม')?2:1;
            document.getElementById('card-score').innerHTML = `
                <div class="d-flex justify-content-between mb-2"><h5 class="card-title m-0 text-red"><i class="bi bi-trophy-fill"></i> คะแนนตระหนักรู้</h5><div class="fw-bold text-danger fs-4">${g.total}</div></div>
                <div class="level-bar">
                    <div class="level-segment ${lvClass>=1?'active':''}" style="width:33%; background:#28a745;">ประถม</div>
                    <div class="level-segment ${lvClass>=2?'active':''}" style="width:33%; background:#0d6efd;">มัธยม</div>
                    <div class="level-segment ${lvClass>=3?'active':''}" style="width:34%; background:#0dcaf0;">ปริญญา</div>
                </div>
                <div class="d-flex justify-content-between text-muted small mb-3"><span>Level: ${g.level}</span><span>คะแนนเต็ม 100+</span></div>
                <div class="row text-center g-2">
                    <div class="col-3 score-box" onclick="scroll2('card-risk')"><div class="icon-circle text-danger"><i class="bi bi-heart-pulse"></i></div><div class="score-val">${g.care}</div><small class="text-muted d-block mt-1">ใส่ใจ</small></div>
                    <div class="col-3 score-box" onclick="scroll2('card-hospital')"><div class="icon-circle text-primary"><i class="bi bi-backpack"></i></div><div class="score-val">${g.prep}</div><small class="text-muted d-block mt-1">เตรียม</small></div>
                    <div class="col-3 score-box" onclick="scroll2('card-sticker')"><div class="icon-circle text-success"><i class="bi bi-share"></i></div><div class="score-val">${g.share}</div><small class="text-muted d-block mt-1">บอกต่อ</small></div>
                    <div class="col-3 score-box" onclick="scroll2('card-knowledge')"><div class="icon-circle text-warning"><i class="bi bi-book"></i></div><div class="score-val">${g.know}</div><small class="text-muted d-block mt-1">ความรู้</small></div>
                </div>`;

            // 6. Sticker
            document.getElementById('card-sticker').innerHTML = `<div class="text-center"><h5 class="card-title justify-content-center mb-3 text-success"><i class="bi bi-line"></i> แชร์สติกเกอร์ไลน์</h5><div class="display-4 fw-bold text-success mb-3">${DATA.stickerCount} ครั้ง</div><a href="${LINKS.STICKER}" class="btn btn-success btn-pill w-100">แชร์สติกเกอร์ใหม่</a></div>`;

            // 7. Knowledge
            document.getElementById('card-knowledge').innerHTML = `
                <h5 class="card-title text-warning"><i class="bi bi-journal-text"></i> คะแนนสอบวัดความรู้</h5>
                <div class="row text-center my-3 bg-white border rounded py-3 mx-0">
                    <div class="col-4 border-end"><small class="text-muted d-block mb-1">ก่อนเรียน</small><span class="fs-4 fw-bold">${k.pre}</span></div>
                    <div class="col-4 border-end"><small class="text-muted d-block mb-1">หลังเรียน</small><span class="fs-4 fw-bold text-success">${k.post}</span></div>
                    <div class="col-4"><small class="text-muted d-block mb-1">ทบทวน</small><span class="fs-4 fw-bold text-warning">${k.review}</span></div>
                </div>
                <div class="text-center mb-3 small text-muted">รวมสูงสุด (เต็ม 40): <span class="fw-bold text-dark fs-6">${k.total}</span></div>
                <a href="${LINKS.KNOWLEDGE}" class="btn btn-outline btn-pill w-100">ทบทวนบทเรียน</a>`;

        } catch(e) { console.error('Gamification Err',e); }
    }

    // --- PART 3: LOAD VHV INFO ---
    async function loadVhvData() {
        try {
            const res = await fetch(`${API_URL}?action=getVhvData&userId=${USER_ID}`);
            const data = await res.json();
            DATA = {...DATA, ...data};
            
            const v = DATA.vhvProfile;
            const s = DATA.vhvScore;

            // VHV Profile
            const verified = v.verified ? '<i class="bi bi-patch-check-fill text-primary ms-1"></i>' : '';
            let warn = (!v.asm_home || v.asm_home.length<5) ? '<div class="alert alert-warning py-2 small mt-3 mb-0 text-center"><i class="bi bi-exclamation-triangle-fill"></i> ยังไม่ปักหมุดบ้าน อสม.</div>' : '';
            
            document.getElementById('vhv-profile').innerHTML = `
                <div class="d-flex align-items-center">
                    <img src="${PROFILE.pictureUrl}" class="profile-pic me-3">
                    <div class="flex-grow-1">
                        <h4 class="fw-bold text-gold mb-1">อสม. ${v.name} ${verified}</h4>
                        <span class="badge-area">${v.area}</span>
                        <div class="text-muted mt-2 small">ลงทะเบียน: ${v.date_regist||DATA.userProfile.regisDate}</div>
                    </div>
                    <div onclick="editVhv('${v.name}','${v.phone}','${v.area}')"><i class="bi bi-pencil-square display-6 text-black-50" style="cursor:pointer"></i></div>
                </div>
                ${warn}
                <button class="btn btn-outline btn-pill w-100 mt-3 btn-sm" onclick="pinAsm()">ปักหมุดบ้าน อสม.</button>`;

            // Perf
            document.getElementById('vhv-perf').innerHTML = `
                <div class="d-flex justify-content-between mb-2"><h5 class="card-title m-0 text-gold"><i class="bi bi-star-fill"></i> ผลงาน อสม.</h5><i class="bi bi-info-circle text-muted" onclick="MODALS.info.show()"></i></div>
                <div class="text-center mb-4"><div class="display-3 fw-bold text-gold" style="line-height:1">${s.total}</div><small class="text-muted">คะแนนรวม</small></div>
                <div class="row g-2 text-center">
                    <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted mb-1">บอกต่อ</small><strong class="fs-5">${s.breakdown.s}</strong></div></div>
                    <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted mb-1">สติกเกอร์</small><strong class="fs-5">${s.breakdown.q}</strong></div></div>
                    <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted mb-1">เยี่ยมบ้าน</small><strong class="fs-5">${s.breakdown.v}</strong></div></div>
                    <div class="col-3"><div class="vhv-stat-box"><small class="d-block text-muted mb-1">รายงาน</small><strong class="fs-5">${s.breakdown.r}</strong></div></div>
                </div>`;

            // Leader
            let lb = DATA.leaderboards.map((u,i)=>`
                <div class="vhv-rank-row">
                    <div class="rank-badge ${i==0?'rank-1':i==1?'rank-2':i==2?'rank-3':'bg-light text-muted'}">${i+1}</div>
                    <img src="${u.pic||'https://placehold.co/40'}" class="rounded-circle me-3" style="width:40px;height:40px;">
                    <div class="flex-grow-1"><div class="fw-bold small">${u.name}</div><div class="text-muted" style="font-size:0.7rem;">${u.area}</div></div>
                    <div class="fw-bold text-gold">${u.score}</div>
                </div>`).join('');
            document.getElementById('vhv-leader').innerHTML = `<h5 class="card-title text-gold sticky-top bg-gold-soft pb-2 mb-0" style="background:#fffbf0"><i class="bi bi-award-fill"></i> อันดับ อสม.ดีเด่น</h5><div class="mt-2">${lb}</div>`;

            // Patients
            document.getElementById('vhv-patients').innerHTML = `
                <h5 class="card-title text-gold mb-3"><i class="bi bi-geo-alt-fill"></i> เยี่ยมบ้านปักหมุด</h5>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-success w-50 btn-pill" onclick="showQR()"><i class="bi bi-qr-code"></i> ชาวบ้านมีไลน์</button>
                    <button class="btn btn-outline w-50 btn-pill" onclick="location.href='${LINKS.REGIS}?ref=${USER_ID}'"><i class="bi bi-link"></i> ไม่มีไลน์</button>
                </div>
                ${renderPatients(DATA.patientList)}`;

        } catch(e) { console.error('VHV Err',e); }
    }

    // --- RENDER HELPERS ---
    function renderRiskCard(p) {
        if(!p || !p.thai_cv_risk_score) {
            document.getElementById('card-risk').innerHTML = `<div class="card-box text-center py-5"><h5 class="card-title mb-3"><i class="bi bi-activity text-danger"></i> ความเสี่ยงสโตรก</h5><div class="text-muted mb-3">ท่านยังไม่เคยประเมินความเสี่ยง</div><a href="${LINKS.REGIS}" class="btn btn-red btn-pill">ประเมินความเสี่ยงเดี๋ยวนี้</a></div>`;
            return;
        }
        let s = parseFloat(p.thai_cv_risk_score);
        let c='#28a745', t='เสี่ยงต่ำ';
        if(s>=10){c='#ffc107';t='ปานกลาง';} if(s>=20){c='#fd7e14';t='สูง';} if(s>=30){c='#dc3545';t='อันตราย';}
        
        const g = [
            {i:'gender-ambiguous',v:p.gender==1?'ชาย':'หญิง'}, {i:'calendar',v:p.age+' ปี'},
            {i:'fire',v:p.smoke=='1'?'สูบ':'ไม่'}, {i:'droplet',v:p.dm=='1'?'เบาหวาน':'ไม่'},
            {i:'speedometer2',v:(p.sbp||'-')+' mmHg'}, {i:'heart',v:(p.cholesterol||'-')+' mg'},
            {i:'arrows-expand',v:(p.waist||'-')+' cm'}, {i:'rulers',v:(p.height||'-')+' cm'}
        ].map(x=>`<div class="risk-item"><span><i class="bi bi-${x.i}"></i> ${x.v}</span></div>`).join('');

        document.getElementById('card-risk').innerHTML = `
            <div class="d-flex justify-content-between mb-2"><h5 class="card-title m-0 text-red"><i class="bi bi-activity"></i> ประเมินความเสี่ยง</h5><span class="badge bg-light text-dark border align-self-center">ประเมิน ${DATA.assessmentCount||0} ครั้ง</span></div>
            <div class="text-center my-3"><div class="display-3 fw-bold" style="color:${c};line-height:1">${s.toFixed(1)}%</div><div class="fs-4 fw-bold" style="color:${c}">${t}</div><div class="small text-muted mt-1">อัพเดท: ${p.Last_Updated||'-'}</div></div>
            <div class="risk-grid mb-3">${g}<div class="risk-item" style="grid-column:span 2"><span class="d-flex align-items-center"><i class="bi bi-hospital"></i> โรคประจำตัว: ${p['u/d']||'-'}</span></div></div>
            <a href="${LINKS.REGIS}" class="btn btn-pill text-white w-100" style="background:${c}">ประเมินใหม่</a>`;
    }

    function renderHospitalCard() {
        const d = DATA.homeDistance || {km:'?',time:'?'};
        const e = DATA.emergencyInfo || {help:'-',decision:'-'};
        document.getElementById('card-hospital').innerHTML = `
            <h5 class="card-title text-red"><i class="bi bi-hospital"></i> การเตรียมพร้อม (รพ.สวี)</h5>
            <div class="hospital-flow">
                <i class="bi bi-person-wheelchair display-4 text-dark"></i>
                <div class="arrow-line"><span class="dist-tag">${d.km} กม.</span></div>
                <div class="text-center"><i class="bi bi-hospital-fill display-4 text-danger"></i><div class="small fw-bold">รพ.สวี</div></div>
            </div>
            <div class="text-center fw-bold fs-4 mb-3">${d.time} นาที</div>
            <div class="bg-white border rounded p-3 mb-3 small">
                <div class="d-flex justify-content-between mb-2"><span>คนดูแล:</span><strong class="text-primary fs-6">${e.help}</strong></div>
                <div class="d-flex justify-content-between"><span>ตัดสินใจ:</span><strong class="text-primary fs-6">${e.decision}</strong></div>
            </div>
            <div class="row g-2">
                <div class="col-6"><button class="btn btn-outline btn-pill btn-sm" onclick="openEditEmg('${e.help}','${e.decision}')">แก้ไขข้อมูล</button></div>
                <div class="col-6"><button class="btn btn-red btn-pill btn-sm" onclick="pinHome(true)">ปักหมุดใหม่</button></div>
            </div>`;
    }

    function renderPatients(list) {
        if(!list || list.length===0) return '<div class="text-center text-muted py-3">ยังไม่มีข้อมูลกลุ่มเสี่ยงในพื้นที่</div>';
        const renderG = (min,t,c,bg) => {
            const g = list.filter(p=>{ if(min==30)return p.risk>=30; if(min==20)return p.risk>=20&&p.risk<30; if(min==10)return p.risk>=10&&p.risk<20; return p.risk<10; });
            if(g.length==0) return '';
            return `<div class="small fw-bold mt-3 mb-2 ps-2 text-secondary border-start border-4 border-${bg}">${t}</div>` + g.map(p=>`
                <div class="patient-row ${c}">
                    <div class="dist-badge"><i class="bi bi-geo"></i> ${p.dist} กม.</div>
                    <img src="${p.pic}" class="rounded-circle me-3" style="width:50px;height:50px;">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${p.name}</div>
                        <div class="small text-muted">เสี่ยง ${p.risk}% | ${p.update} วันก่อน</div>
                    </div>
                </div>`).join('');
        };
        return renderG(30,'อันตราย (แดง)','risk-danger','danger') + renderG(20,'สูง (ส้ม)','risk-high','warning') + renderG(10,'ปานกลาง (เหลือง)','risk-med','warning') + renderG(0,'ต่ำ (เขียว)','risk-low','success');
    }

    // --- ACTIONS ---
    function scroll2(id){ document.getElementById(id).scrollIntoView({behavior:'smooth', block:'center'}); }
    function showLoad(b){ document.getElementById('action-loader').style.display=b?'flex':'none'; }

    // Dropdowns
    const TAMBONS = ["ท่าหิน","ด่านสวี","เขาทะลุ","เขาค่าย","ปากแพรก","สวี","นาสัก","ทุ่งระยะ","วิสัยใต้","ครน","นาโพธิ์"];
    function initDropdowns() {
        const s = document.getElementById('vhvDistrict');
        TAMBONS.forEach(t => s.add(new Option(t, t)));
    }
    function updateVillages() {
        const v = document.getElementById('vhvVillage'); v.innerHTML='<option value="">หมู่</option>';
        if(document.getElementById('vhvDistrict').value) for(let i=1; i<=20; i++) v.add(new Option('ม.'+i, 'ม.'+i));
    }

    // Function calls
    function openEditEmg(h,d){ document.getElementById('inpHelp').value=(h!='-')?h:''; document.getElementById('inpDec').value=(d!='-')?d:'รอดูอาการ'; MODALS.modalEditEmg.show(); }
    function saveEmg(){
        showLoad(true);
        const d = { userId:USER_ID, help:document.getElementById('inpHelp').value, decision:document.getElementById('inpDec').value };
        fetch(API_URL, {method:'POST', body:JSON.stringify({action:'updateEmergencyInfo', data:d})}).then(()=>{
            DATA.emergencyInfo=d; renderHospitalCard(); MODALS.modalEditEmg.hide(); showLoad(false);
            // Refresh Score Logic if needed by reloading gamification silently
            loadGamification();
        });
    }

    function pinHome(force){
        if(!force) MODALS.modalPin.hide();
        showLoad(true);
        navigator.geolocation.getCurrentPosition(p=>{
            const d = { userId:USER_ID, latlong:`${p.coords.latitude},${p.coords.longitude}` };
            fetch(API_URL, {method:'POST', body:JSON.stringify({action:'saveNewLocation', data:d})}).then(r=>r.json()).then(res=>{
                DATA.homeDistance = { km:0, time:0 }; // Pending real calc
                renderHospitalCard(); showLoad(false); alert('ปักหมุดสำเร็จ!');
                loadGamification(); // Refresh score
            });
        }, ()=>{ showLoad(false); alert('ไม่สามารถระบุพิกัดได้'); });
    }

    function pinAsm(){
        if(!confirm('ยืนยันว่าท่านอยู่ที่บ้านพัก อสม. ขณะนี้?')) return;
        showLoad(true);
        navigator.geolocation.getCurrentPosition(p=>{
            fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'updateAsmHome', data:{userId:USER_ID, latlong:`${p.coords.latitude},${p.coords.longitude}`}})})
            .then(()=>{ showLoad(false); alert('บันทึกพิกัดบ้าน อสม. แล้ว'); loadVhvData(); });
        });
    }

    function editVhv(n,p,area){
        document.getElementById('vhvName').value=n; document.getElementById('vhvPhone').value=p;
        const matches = area.match(/ต\.(.+?)\s+ม\.(.+)/);
        if(matches){
            document.getElementById('vhvDistrict').value = matches[1];
            updateVillages();
            document.getElementById('vhvVillage').value = 'ม.'+matches[2];
        }
        MODALS.modalEditVhv.show();
    }

    function saveVhvProfile(){
        const t = document.getElementById('vhvDistrict').value;
        const m = document.getElementById('vhvVillage').value;
        if(!t || !m){ alert('กรุณาเลือกพื้นที่'); return; }
        
        showLoad(true);
        const d = { userId:USER_ID, name:document.getElementById('vhvName').value, phone:document.getElementById('vhvPhone').value, area:`ต.${t} ${m}` };
        fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'updateAsmProfile', data:d})}).then(()=>{
             location.reload();
        });
    }

    function call(t){ TARGET_TEL=t; MODALS.modalCall.show(); }
    function execCall(){
        navigator.geolocation.getCurrentPosition(p=>{
            fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'logTelCall', data:{userId:USER_ID, tel:TARGET_TEL, latlong:`${p.coords.latitude},${p.coords.longitude}`}})});
            window.location.href=`tel:${TARGET_TEL}`;
        }, ()=>window.location.href=`tel:${TARGET_TEL}`);
    }

    function showQR(){
        document.getElementById('qrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(LINKS.REGIS+'?ref='+USER_ID)}`;
        MODALS.modalQR.show();
    }
</script>
</body>
</html>