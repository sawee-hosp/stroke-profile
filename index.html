<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สวีรู้ทันสโตรก</title>
    
    <!-- Fonts: Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* =========================================
           1. THEME VARIABLES & GLOBAL STYLES
           ========================================= */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            
            /* HEALTH THEME (RED) */
            --theme-red: #d32f2f; 
            --theme-red-light: #ffebee;
            --theme-red-dark: #b71c1c;

            /* VHV THEME (GOLD) */
            --gold-dark: #876029;   
            --gold-main: #D4AF37;   
            --gold-bg: #FFF8E1;     
            --gold-text: #eae2cd;   
            
            /* ELDERLY SETTINGS */
            --base-size: 20px; 
            --border-radius-lg: 25px;
        }

        html { font-size: var(--base-size); }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 1rem; 
            line-height: 1.5;
            /* Default Red Gradient */
            background: linear-gradient(180deg, var(--theme-red) 0%, #ffffff 450px);
            background-attachment: fixed;
            margin: 0; 
            padding-bottom: 8rem;
            color: #212529; 
            -webkit-tap-highlight-color: transparent;
            transition: background 0.5s ease;
        }
        
        /* VHV MODE BACKGROUND */
        body.vhv-mode {
            background: linear-gradient(180deg, var(--gold-dark) 0%, #ffffff 400px);
        }

        h1, h2, h3, h4, h5, h6 { 
            font-weight: 700 !important; 
            margin-bottom: 0.8rem;
        }
        
        .fw-black { font-weight: 900 !important; }

        /* =========================================
           2. NAVIGATION TABS
           ========================================= */
        .app-header-spacer { height: 90px; }

        .nav-tabs-container {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background-color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }

        .nav-link { 
            font-size: 1.2rem; 
            padding: 20px 0; 
            font-weight: 700; color: #aaa; 
            border: none; background: #fff; width: 100%;
            transition: all 0.3s ease;
        }

        /* Health Tab Active (Red/White) */
        .nav-link#health-tab-btn.active { 
            color: white; 
            background: var(--theme-red); 
        }

        /* VHV Tab Active (Gold/Text) */
        body.vhv-mode .nav-link#vhv-tab-btn.active { 
            color: var(--gold-text); 
            background: var(--gold-dark); 
        }
        
        /* =========================================
           3. CARD & COMPONENT STYLES
           ========================================= */
        .card { 
            border: none; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.08); 
            margin-bottom: 2rem; 
            border-radius: var(--border-radius-lg); 
            overflow: hidden; 
            background-color: #fff; 
        }

        .section-title { 
            font-size: 1.4rem; 
            font-weight: 800; 
            margin-bottom: 1.2rem; 
            color: #333; 
            display: flex; align-items: center; gap: 12px;
        }
        .section-title i { font-size: 1.8rem; color: var(--theme-red); }
        
        /* VHV Title Override */
        body.vhv-mode .section-title i { color: var(--gold-dark); }
        
        /* BUTTONS (ELDERLY) */
        .btn { border-radius: 50px; font-weight: 700; padding: 12px 24px; font-size: 1.1rem; }
        .btn-main { background-color: var(--theme-red); color: white; border: none; box-shadow: 0 4px 10px rgba(255,54,84,0.3); }
        .btn-main:hover { background-color: #b71c1c; color: white; }
        
        .btn-circle { 
            width: 60px; height: 60px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.8rem; padding: 0; 
        }

        /* PROFILE */
        .profile-img-lg { 
            width: 100px; height: 100px; 
            border-radius: 50%; object-fit: cover; 
            border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }

        /* BADGES */
        .badge-regis { background-color: #eee; color: #555; border-radius: 20px; font-weight: 500; font-size: 0.8rem; padding: 5px 10px; }
        .badge-vhv { background-color: var(--gold-dark); color: white; border-radius: 20px; padding: 5px 15px; font-weight: normal; }

        /* SCORE CARD & BAR */
        .level-bar-container { position: relative; height: 25px; background: #e0e0e0; border-radius: 15px; margin: 20px 0; overflow: hidden; }
        .level-bar-fill { height: 100%; background: linear-gradient(90deg, #ffc107, #fd7e14, #dc3545); transition: width 1s; }
        .level-marker { position: absolute; top: 0; height: 100%; border-right: 2px solid white; font-size: 0.6rem; color: #fff; padding-left: 5px; line-height: 25px; text-shadow: 0 0 2px black; }
        
        .score-icon-box { text-align: center; cursor: pointer; transition: transform 0.2s; }
        .score-icon-box:active { transform: scale(0.9); }
        .score-icon-circle { width: 60px; height: 60px; background: #fff5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; color: var(--theme-red); font-size: 1.8rem; border: 1px solid #ffcdd2; }
        
        /* RISK CARD */
        .risk-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .risk-item { background: #f9f9f9; padding: 10px; border-radius: 15px; display: flex; align-items: center; gap: 8px; border: 1px solid #eee; }
        .risk-item i { font-size: 1.5rem; color: #555; }
        
        /* HOSPITAL PREP */
        .hospital-path { display: flex; align-items: center; justify-content: space-between; position: relative; margin: 30px 0; }
        .hospital-arrow { flex-grow: 1; height: 4px; background: #333; margin: 0 15px; position: relative; }
        .hospital-arrow::after { content: ''; position: absolute; right: -5px; top: -6px; border: 8px solid transparent; border-left-color: #333; }
        .hospital-icon { font-size: 3rem; color: var(--theme-red); }
        
        /* HELPER */
        .helper-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .scan-anim { animation: pulse 2s infinite; color: var(--theme-red); }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        /* VHV */
        .vhv-card-bg { background: #fff; border: 1px solid rgba(135, 96, 41, 0.2); }
        .vhv-stat-box { background: #fdfdfd; border: 1px solid #eee; border-radius: 15px; padding: 10px; height: 100%; }
        
        /* PATIENT LIST */
        .risk-group-title { font-size: 1.2rem; font-weight: 800; margin: 20px 0 10px; padding-left: 10px; border-left: 5px solid; }
        .patient-card { display: flex; align-items: center; background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .patient-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; background: #eee; }

        /* LOADING */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 2000; backdrop-filter: blur(5px); }
        
        /* Utility */
        .mt-card-top { margin-top: 2rem; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner-border text-light" style="width: 4rem; height: 4rem;"></div>
        <div class="mt-3 fs-3 fw-bold">กำลังประมวลผล...</div>
    </div>

    <!-- Navigation -->
    <div class="nav-tabs-container">
        <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="health-tab-btn">ข้อมูลสุขภาพ</button></li>
            <li class="nav-item"><button class="nav-link" id="vhv-tab-btn">สำหรับ อสม.</button></li>
        </ul>
    </div>
    <div class="app-header-spacer"></div>

    <div class="container px-3">
        
        <!-- ======================= TAB 1: HEALTH ======================= -->
        <div id="health-view">
            
            <!-- 1. PROFILE CARD -->
            <div id="profile-container" class="mt-card-top">
                <div class="card p-5 text-center">
                    <div class="spinner-border text-primary"></div>
                    <div class="mt-2 text-muted">กำลังโหลด...</div>
                </div>
            </div>

            <!-- 2. SCORE CARD -->
            <div id="score-container"></div>
            
            <!-- 3. RISK CARD -->
            <div id="risk-container"></div>

            <!-- 4. HOSPITAL PREP CARD -->
            <div id="hospital-container"></div>
            
            <!-- 5. HELPER CARD -->
            <div id="helper-container"></div>

            <!-- 6. STICKER CARD -->
            <div id="sticker-container"></div>
            
            <!-- 7. HISTORY CARD -->
            <div id="history-container"></div>

        </div>

        <!-- ======================= TAB 2: VHV ======================= -->
        <div id="vhv-view" style="display: none;">
            
            <!-- 1. VHV PROFILE -->
            <div id="vhv-profile-container" class="mt-card-top"></div>
            
            <!-- 2. PERFORMANCE -->
            <div id="vhv-perf-container"></div>
            
            <!-- 3. LEADERBOARD -->
            <div id="vhv-leader-container"></div>
            
            <!-- 4. PATIENT LIST -->
            <div id="vhv-patient-container">
                 <div class="text-center py-5">
                    <div class="spinner-border text-warning" style="width: 3rem; height: 3rem;"></div>
                    <div class="mt-3 text-muted fs-4">กำลังโหลดข้อมูลลูกบ้าน...</div>
                </div>
            </div>

        </div>
    </div>

    <div class="app-footer">
        © 2025 สวีรู้ทันสโตรก รพ.สวี
    </div>

    <!-- ================= MODALS ================= -->
    
    <!-- Edit Emergency Modal -->
    <div class="modal fade" id="editEmgModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h4 class="modal-title">แก้ไขข้อมูลฉุกเฉิน</h4>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="text-muted mb-2">คนดูแลที่บ้าน</label>
                        <select class="form-select form-select-lg" id="inpHelp">
                            <option value="อยู่ตัวคนเดียว">อยู่ตัวคนเดียว</option>
                            <option value="อยู่กับผู้สูงอายุ/เด็กเล็ก">อยู่กับผู้สูงอายุ/เด็กเล็ก</option>
                            <option value="อยู่กับญาติผู้ใหญ่/คนวัยทำงาน">อยู่กับญาติผู้ใหญ่/คนวัยทำงาน</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="text-muted mb-2">การตัดสินใจ</label>
                        <select class="form-select form-select-lg" id="inpDec">
                            <option value="รอดูอาการ">รอดูอาการ</option>
                            <option value="โทรให้ญาติมาดู">โทรให้ญาติมาดู</option>
                            <option value="ไปคลินิก-อนามัย">ไปคลินิก-อนามัย</option>
                            <option value="รีบไป รพ.เอง">รีบไป รพ.เอง</option>
                            <option value="โทร 1669 ให้รถมารับ">โทร 1669 ให้รถมารับ</option>
                        </select>
                    </div>
                    <button class="btn btn-main w-100" onclick="saveEmg()">บันทึกข้อมูล</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Modal -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 text-center p-4">
                <i class="bi bi-telephone-outbound-fill text-primary" style="font-size: 4rem;"></i>
                <h3 class="my-3">ยืนยันการโทร</h3>
                <p class="text-muted fs-5">ระบบจะบันทึกประวัติการโทรและตำแหน่งของคุณ</p>
                <div class="d-grid gap-3 mt-3">
                    <button class="btn btn-main btn-lg" onclick="execCall()">โทรออก</button>
                    <button class="btn btn-light btn-lg text-muted" data-bs-dismiss="modal">ยกเลิก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white text-center justify-content-center">
                <button class="btn-close btn-close-white position-absolute top-0 end-0 m-4" data-bs-dismiss="modal"></button>
                <h1 class="text-warning mb-4">ชาวบ้านมีไลน์</h1>
                <div class="bg-white p-3 rounded-4 d-inline-block">
                    <img id="qrImg" src="" style="width:280px;">
                </div>
                <p class="mt-4 fs-4">สแกนเพื่อเพิ่มเพื่อน</p>
            </div>
        </div>
    </div>
    
    <!-- Info Score Modal -->
    <div class="modal fade" id="infoScoreModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4">
                <h4>วิธีคิดคะแนน อสม.</h4>
                <ul class="fs-5">
                    <li>บอกต่อ (Sticker) = 1 คะแนน</li>
                    <li>สแกน QR (เพื่อนใหม่) = 10 คะแนน</li>
                    <li>เยี่ยมบ้าน = 5 คะแนน</li>
                    <li>รายงานเคส = 50 คะแนน</li>
                </ul>
                <button class="btn btn-secondary w-100" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID = '2005789397-RLAGXrBJ';
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };

        let LIFF_PROFILE = {};
        let BASIC_DATA = {};
        let GLOBAL_RANK_DATA = {}; // Store rank data for reuse
        let CALL_TARGET = '';
        const MODALS = {};

        // --- INIT ---
        window.onload = async () => {
            ['editEmgModal', 'callModal', 'qrModal', 'infoScoreModal'].forEach(id => MODALS[id] = new bootstrap.Modal(document.getElementById(id)));
            
            document.getElementById('health-tab-btn').onclick = () => switchTab('health');
            document.getElementById('vhv-tab-btn').onclick = () => switchTab('vhv');

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                LIFF_PROFILE = await liff.getProfile();
                
                // --- STEP 1: Basic Info ---
                const ref = new URLSearchParams(location.search).get('ref') || '';
                const basicUrl = `${WEB_APP_URL}?action=getBasicInfo&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}&ref=${ref}`;
                BASIC_DATA = await fetch(basicUrl).then(r => r.json());
                
                renderProfileCard(BASIC_DATA.userProfile);
                renderHospitalCard(BASIC_DATA.homeDistance, BASIC_DATA.emergencyInfo);
                renderHelperCard(BASIC_DATA.communityLeaders);
                
                if (BASIC_DATA.isVhv) {
                    renderVhvProfile(BASIC_DATA.vhvProfile);
                }

                // --- STEP 2: Gamification ---
                loadGamification();

                // --- STEP 3: VHV Data ---
                if (BASIC_DATA.isVhv) {
                    loadVhvData();
                } else {
                    document.getElementById('vhv-view').innerHTML = `<div class="p-5 text-center text-muted fs-4 mt-5">สำหรับ อสม. เท่านั้น</div>`;
                }

            } catch(e) {
                console.error(e);
                document.getElementById('profile-container').innerHTML = `<div class="alert alert-danger m-3 text-center">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>`;
            }
        };

        function switchTab(mode) {
            const isVhv = mode === 'vhv';
            document.body.className = isVhv ? 'vhv-mode' : '';
            document.getElementById('health-tab-btn').className = `nav-link ${!isVhv?'active':''}`;
            document.getElementById('vhv-tab-btn').className = `nav-link ${isVhv?'active':''}`;
            document.getElementById('health-view').style.display = !isVhv ? 'block' : 'none';
            document.getElementById('vhv-view').style.display = isVhv ? 'block' : 'none';
            window.scrollTo(0, 0);
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // ======================= RENDER FUNCTIONS: HEALTH =======================

        function renderProfileCard(p) {
            if(!p) {
                document.getElementById('profile-container').innerHTML = `<div class="card p-5 text-center"><h3 class="mb-3">ไม่พบข้อมูล</h3><a href="${LINKS.REGIS}" class="btn btn-main w-100">ลงทะเบียน</a></div>`;
                return;
            }
            const regDate = p.regisDate ? new Date(p.regisDate).toLocaleDateString('th-TH') : '-';
            const html = `
                <div class="card p-4 d-flex flex-row align-items-center shadow-sm">
                    <img src="${p.pictureUrl}" class="profile-img-lg me-4">
                    <div class="flex-grow-1">
                        <h3 class="fw-bold mb-1">${p.name}</h3>
                        <div class="text-muted fs-5 mb-2"><i class="bi bi-telephone-fill"></i> ${p.telephone}</div>
                        <span class="badge-regis">ลงทะเบียนเมื่อ ${regDate}</span>
                    </div>
                </div>`;
            document.getElementById('profile-container').innerHTML = html;
        }

        async function loadGamification() {
            const res = await fetch(`${WEB_APP_URL}?action=getGamification&userId=${LIFF_PROFILE.userId}`).then(r => r.json());
            const g = res.gamification;
            GLOBAL_RANK_DATA = g;

            // 1. Score Awareness Stroke Card
            renderScoreCard(g);
            
            // 2. Risk Card (ใช้ข้อมูลจาก User Profile แต่รอโหลดพร้อมเกมก็ได้ เพื่อให้ UI ไหลมาพร้อมกัน)
            renderRiskCard(BASIC_DATA.userProfile);
            
            // 3. Sticker Share Card
            renderStickerCard(res.stickerCount);
            
            // 4. Knowledge History Card
            renderHistoryCard(res.knowledgeData);
        }

        function renderScoreCard(g) {
            // Level Bar Calculation
            const range = g.nextLevelScore - g.currentLevelMin;
            const progress = g.totalScore - g.currentLevelMin;
            const percent = Math.min(100, Math.max(0, (progress / range) * 100));

            const html = `
                <div class="card game-score-card p-4">
                    <h4 class="section-title text-center justify-content-center">คะแนนตระหนักรู้ทันสโตรก</h4>
                    
                    <div class="text-center my-3">
                        <div class="display-1 fw-black text-danger" style="line-height:1;">${g.totalScore}</div>
                        <div class="fs-4 fw-bold text-muted">คะแนนรวม</div>
                    </div>

                    <div class="level-bar-container">
                        <div class="level-bar-fill" style="width: ${percent}%"></div>
                        <div class="level-marker" style="left:33%">ประถม</div>
                        <div class="level-marker" style="left:66%">มัธยม</div>
                    </div>
                    <div class="d-flex justify-content-between fs-6 text-muted mb-3">
                        <span>Level: ${g.levelName}</span>
                        <span>อันดับรวม #${g.rank}</span>
                    </div>

                    <div class="row g-3">
                        <div class="col-3 score-icon-box" onclick="scrollToCard('daily-check-anchor')"> <!-- Placeholder Anchor -->
                            <div class="score-icon-circle"><i class="bi bi-heart-pulse"></i></div>
                            <small>ใส่ใจ<br>${g.checkScore}</small>
                        </div>
                        <div class="col-3 score-icon-box" onclick="scrollToCard('hospital-container')">
                            <div class="score-icon-circle"><i class="bi bi-backpack2"></i></div>
                            <small>เตรียมพร้อม<br>${g.emergencyScore}</small>
                        </div>
                        <div class="col-3 score-icon-box" onclick="scrollToCard('sticker-container')">
                            <div class="score-icon-circle"><i class="bi bi-share"></i></div>
                            <small>บอกต่อ<br>${g.stickerScore}</small>
                        </div>
                        <div class="col-3 score-icon-box" onclick="scrollToCard('history-container')">
                            <div class="score-icon-circle"><i class="bi bi-book"></i></div>
                            <small>ความรู้<br>${g.knowledgeScore}</small>
                        </div>
                    </div>
                </div>`;
            document.getElementById('score-container').innerHTML = html;
        }

        function renderRiskCard(p) {
            if(!p) return;
            const score = parseFloat(p.thai_cv_risk_score||0).toFixed(1);
            
            let color = '#28a745'; let label = 'ความเสี่ยงต่ำ';
            if(score>=10) { color='#ffc107'; label='ความเสี่ยงปานกลาง'; }
            if(score>=20) { color='#fd7e14'; label='ความเสี่ยงสูง'; }
            if(score>=30) { color='#dc3545'; label='อันตราย'; }

            const html = `
                <div class="card p-4 border-2" style="border-color:${color}">
                    <div class="d-flex justify-content-between mb-3">
                        <h4 class="section-title m-0"><i class="bi bi-activity"></i> ประเมินความเสี่ยงสโตรก</h4>
                        <span class="badge bg-secondary rounded-pill align-self-center">1 ครั้ง</span>
                    </div>
                    
                    <div class="text-center my-4">
                        <div style="font-size:4.5rem; font-weight:900; color:${color}; line-height:1;">${score}%</div>
                        <div class="fs-2 fw-bold mt-2" style="color:${color}">${label}</div>
                        <span class="badge bg-light text-dark border mt-2">ประเมินเมื่อ ${new Date().toLocaleDateString('th-TH')}</span>
                    </div>

                    <div class="risk-grid">
                        <div class="risk-item"><i class="bi bi-person"></i><div><small>อายุ</small><b>${p.age} ปี</b></div></div>
                        <div class="risk-item"><i class="bi bi-speedometer2"></i><div><small>ความดัน</small><b>${p.sbp||'-'} mmHg</b></div></div>
                        <div class="risk-item"><i class="bi bi-droplet"></i><div><small>เบาหวาน</small><b>${p.dm==1?'เป็น':'ไม่'}</b></div></div>
                        <div class="risk-item"><i class="bi bi-fire"></i><div><small>สูบบุหรี่</small><b>${p.smoke==1?'สูบ':'ไม่'}</b></div></div>
                        <div class="risk-item"><i class="bi bi-heart"></i><div><small>ไขมัน</small><b>${p.cholesterol||'-'} mg</b></div></div>
                        <div class="risk-item"><i class="bi bi-arrows-expand"></i><div><small>รอบเอว</small><b>${p.waist||'-'} cm</b></div></div>
                    </div>

                    <a href="${LINKS.REGIS}" class="btn w-100 mt-4 text-white fw-bold" style="background-color:${color}">ประเมินใหม่</a>
                </div>`;
            document.getElementById('risk-container').innerHTML = html;
        }

        function renderHospitalCard(dist, emg) {
            const km = dist ? dist.distance_km : '?';
            const duration = dist && dist.duration ? dist.duration : '? นาที';
            
            const html = `
                <div class="card p-4" id="hospital-card-inner">
                    <h4 class="section-title"><i class="bi bi-hospital"></i> การเตรียมพร้อมมารพ. (รพ.สวี)</h4>
                    
                    <div class="hospital-path">
                        <div class="text-center">
                            <i class="bi bi-house-door-fill text-dark" style="font-size:3rem;"></i>
                            <div class="small fw-bold mt-1">บ้าน</div>
                        </div>
                        <div class="hospital-arrow">
                            <div class="position-absolute top-0 start-50 translate-middle-x bg-white px-2 fw-bold fs-5" style="top:-15px !important;">
                                ${km} กม.
                            </div>
                             <div class="position-absolute top-100 start-50 translate-middle-x text-muted small mt-1">
                                ${duration}
                            </div>
                        </div>
                        <div class="text-center">
                            <i class="bi bi-hospital-fill text-danger" style="font-size:3rem;"></i>
                            <div class="small fw-bold mt-1 text-danger">รพ.สวี</div>
                        </div>
                    </div>

                    <div class="bg-light p-3 rounded-4 mb-3 border">
                        <div class="d-flex justify-content-between mb-2 border-bottom pb-2">
                            <span class="text-muted">คนดูแล:</span>
                            <span class="fw-bold text-primary">${emg ? emg.help : '-'}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">การตัดสินใจ:</span>
                            <span class="fw-bold text-primary">${emg ? emg.decision : '-'}</span>
                        </div>
                    </div>

                    <button class="btn btn-outline-dark w-100 rounded-pill" onclick="openEditEmg('${emg?emg.help:''}','${emg?emg.decision:''}')">
                        <i class="bi bi-pencil-square"></i> แก้ไขข้อมูล
                    </button>
                </div>`;
            document.getElementById('hospital-container').innerHTML = html;
        }

        function renderHelperCard(leaders) {
            if(!leaders) return;
            const html = `
                <div class="card p-4">
                    <h4 class="section-title"><i class="bi bi-people-fill"></i> บุคคลที่อาจช่วยเหลือท่าน</h4>
                    
                    <div class="helper-item">
                        <i class="bi bi-hospital text-primary me-3 fs-1"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold fs-5">รพ.สต. ${leaders.pcu || '-'}</div>
                        </div>
                    </div>

                    <div class="helper-item">
                        <i class="bi bi-person-badge text-dark me-3 fs-1"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold fs-5">ผู้ใหญ่บ้าน ${leaders.headman_area || '-'}</div>
                        </div>
                        <button class="btn btn-success btn-circle" onclick="call('${leaders.headman_tel}')"><i class="bi bi-telephone-fill"></i></button>
                    </div>

                    <div class="helper-item border-0 pb-0">
                        <i class="bi bi-heart-pulse text-danger me-3 fs-1 scan-anim"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold fs-5">อสม. ในเขตพื้นที่</div>
                            <div class="text-muted small">จำนวน ${leaders.vhvCount} ท่าน</div>
                        </div>
                        <span class="badge bg-danger rounded-pill">กำลังค้นหา...</span>
                    </div>
                </div>`;
            document.getElementById('helper-container').innerHTML = html;
        }

        function renderStickerCard(count) {
            const html = `
                <div class="card p-4 text-center bg-light border">
                    <h4 class="section-title justify-content-center mb-4">แชร์สติกเกอร์</h4>
                    <div class="display-1 fw-bold text-success mb-2">${count || 0}</div>
                    <p class="text-muted fs-5">ครั้งที่ส่งต่อความห่วงใย</p>
                    <a href="${LINKS.STICKER}" class="btn btn-success btn-lg w-100 rounded-pill">
                        <i class="bi bi-line"></i> แชร์สติกเกอร์ใหม่
                    </a>
                </div>`;
            document.getElementById('sticker-container').innerHTML = html;
        }

        function renderHistoryCard(data) {
            // Data = { total: X, breakdown: [] }
            const html = `
                <div class="card p-4">
                    <h4 class="section-title"><i class="bi bi-clock-history"></i> ประวัติการทบทวนความรู้</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fs-5">คะแนนรวมสูงสุด</span>
                        <span class="fs-3 fw-bold text-primary">${data.total}/40</span>
                    </div>
                    <div class="progress mb-3" style="height:10px;">
                        <div class="progress-bar" style="width:${(data.total/40)*100}%"></div>
                    </div>
                    <a href="${LINKS.KNOWLEDGE}" class="btn btn-outline-primary w-100 rounded-pill">ทบทวนบทเรียน</a>
                </div>`;
            document.getElementById('history-container').innerHTML = html;
        }

        // ======================= RENDER FUNCTIONS: VHV =======================

        function renderVhvProfile(p) {
            if(!p) return;
            const asmHomeFilled = p.asm_home && p.asm_home.length > 5;
            const html = `
                <div class="card p-4 vhv-card-bg">
                    <div class="d-flex align-items-center mb-3">
                        <img src="${LIFF_PROFILE.pictureUrl}" class="profile-img-lg me-3">
                        <div>
                            <h4 class="mb-1 text-gold-dark">อสม. ${p.name}</h4>
                            <span class="badge-vhv">พื้นที่: ${p.area}</span>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-dark" onclick="alert('แก้ไขประวัติที่ Line OA')">แก้ไขประวัติ</button>
                        <button class="btn ${asmHomeFilled ? 'btn-success' : 'btn-danger'}" onclick="pinAsmHome()">
                            <i class="bi bi-geo-alt-fill"></i> ปักหมุดบ้าน
                        </button>
                    </div>
                    ${!asmHomeFilled ? '<div class="alert alert-danger mt-3 mb-0 text-center"><i class="bi bi-exclamation-circle"></i> ท่านยังไม่ปักหมุด กรุณากดปักหมุดตอนอยู่ที่บ้านจริงๆ</div>' : ''}
                </div>`;
            document.getElementById('vhv-profile-container').innerHTML = html;
        }

        function loadVhvData() {
            fetch(`${WEB_APP_URL}?action=getVhvData&userId=${LIFF_PROFILE.userId}`)
                .then(r => r.json())
                .then(res => {
                    renderVhvPerformance(res.vhvScore);
                    renderVhvLeaderboard(res.leaderboards);
                    renderVhvPatients(res.patientList, res.asmHome);
                });
        }

        function renderVhvPerformance(s) {
            const html = `
                <div class="card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="m-0 text-gold-dark">ผลงาน อสม.ของท่าน</h4>
                        <button class="btn btn-sm btn-outline-secondary rounded-circle" data-bs-toggle="modal" data-bs-target="#infoScoreModal">i</button>
                    </div>
                    <div class="text-center mb-4">
                        <div class="display-2 fw-black text-gold-dark">${s.total}</div>
                        <div class="text-muted">คะแนนรวม</div>
                    </div>
                    <div class="row g-2 text-center">
                        <div class="col-3"><div class="vhv-stat-box"><small>บอกต่อ</small><div class="fs-4 fw-bold">${s.breakdown.sticker}</div></div></div>
                        <div class="col-3"><div class="vhv-stat-box"><small>สติกเกอร์</small><div class="fs-4 fw-bold">${s.breakdown.qr}</div></div></div>
                        <div class="col-3"><div class="vhv-stat-box"><small>เยี่ยมบ้าน</small><div class="fs-4 fw-bold">${s.breakdown.action}</div></div></div>
                        <div class="col-3"><div class="vhv-stat-box"><small>รายงานเคส</small><div class="fs-4 fw-bold">${s.breakdown.reports}</div></div></div>
                    </div>
                </div>`;
            document.getElementById('vhv-perf-container').innerHTML = html;
        }

        function renderVhvLeaderboard(list) {
            let items = '';
            list.slice(0, 5).forEach((u, i) => {
                items += `
                    <div class="d-flex align-items-center p-2 border-bottom">
                        <div class="fw-bold fs-4 text-muted me-3" style="width:30px;">#${i+1}</div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${u.name}</div>
                            <small class="text-muted">${u.area}</small>
                        </div>
                        <span class="badge bg-warning text-dark rounded-pill fs-6">${u.score}</span>
                    </div>`;
            });
            const html = `
                <div class="card p-4" style="max-height: 400px; overflow-y: auto;">
                    <h4 class="section-title text-gold-dark">อันดับ อสม.ดีเด่น</h4>
                    ${items}
                </div>`;
            document.getElementById('vhv-leader-container').innerHTML = html;
        }

        function renderVhvPatients(patients, asmHome) {
            const html = `
                <div class="card p-4">
                    <h4 class="section-title text-gold-dark mb-4">เยี่ยมบ้านปักหมุด</h4>
                    
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-success btn-lg" onclick="showQR()">
                            <i class="bi bi-qr-code"></i> ชาวบ้านมีไลน์
                        </button>
                        <a href="${LINKS.REGIS}?ref=${LIFF_PROFILE.userId}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-link-45deg"></i> ชาวบ้านไม่มี Line
                        </a>
                    </div>
                    
                    ${renderPatientGroup(patients, 'อันตราย (สีแดง)', 30, 'vhv-risk-5')}
                    ${renderPatientGroup(patients, 'ความเสี่ยงสูง (สีส้ม)', 20, 'vhv-risk-4')}
                    ${renderPatientGroup(patients, 'ความเสี่ยงปานกลาง (สีเหลือง)', 10, 'vhv-risk-2')}
                    ${renderPatientGroup(patients, 'ความเสี่ยงต่ำ (สีเขียว)', 0, 'vhv-risk-1')}
                </div>`;
            document.getElementById('vhv-patient-container').innerHTML = html;
        }

        function renderPatientGroup(list, title, minScore, cssClass) {
            const filtered = list.filter(p => {
                if(minScore === 30) return p.thai_cv_risk_score >= 30;
                if(minScore === 20) return p.thai_cv_risk_score >= 20 && p.thai_cv_risk_score < 30;
                if(minScore === 10) return p.thai_cv_risk_score >= 10 && p.thai_cv_risk_score < 20;
                return p.thai_cv_risk_score < 10;
            });

            if(filtered.length === 0) return '';

            let items = filtered.map(p => `
                <div class="patient-card ${cssClass}">
                    <img src="${p.pictureUrl || 'https://via.placeholder.com/60'}" class="patient-img">
                    <div class="flex-grow-1">
                        <div class="fw-bold fs-5">${p.name}</div>
                        <div class="text-muted small">เสี่ยง ${p.thai_cv_risk_score}%</div>
                        <div class="text-muted small mt-1">
                            <i class="bi bi-geo-alt"></i> ${p.distanceFromVhv_km} กม.
                            <i class="bi bi-clock ms-2"></i> ${p.lastCheckStr}
                        </div>
                    </div>
                </div>`).join('');

            return `<div class="risk-group-title text-muted" style="border-left-color: ${minScore>=30?'#dc3545':(minScore>=20?'#fd7e14':(minScore>=10?'#ffc107':'#28a745'))}">${title}</div>${items}`;
        }

        // ======================= ACTIONS =======================

        function scrollToCard(id) {
            const el = document.getElementById(id);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function openEditEmg(h, d) {
            document.getElementById('inpHelp').value = (h && h!=='-') ? h : 'อยู่ตัวคนเดียว';
            document.getElementById('inpDec').value = (d && d!=='-') ? d : 'รอดูอาการ';
            MODALS['editEmgModal'].show();
        }

        function saveEmg() {
            const h = document.getElementById('inpHelp').value;
            const d = document.getElementById('inpDec').value;
            toggleLoading(true);
            
            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action: 'updateEmergencyInfo', data: { userId: LIFF_PROFILE.userId, help: h, decision: d } })
            }).then(() => {
                // Partial Update Logic (Mocking successful response since no-cors doesn't return body in browser fetch)
                // In reality, GAS no-cors is opaque. We assume success and update UI.
                toggleLoading(false);
                MODALS['editEmgModal'].hide();
                
                // Update specific card ONLY
                const newEmg = { help: h, decision: d };
                // Need to redraw hospital card with new info + existing distance
                renderHospitalCard(BASIC_DATA.homeDistance, newEmg); // Re-render function
                alert('บันทึกข้อมูลแล้ว');
            });
        }

        function execCall() {
            // ... (Same Call Logic as before) ...
            navigator.geolocation.getCurrentPosition(pos => {
                const latlong = `${pos.coords.latitude},${pos.coords.longitude}`;
                fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'logTelCall', data: { userId: LIFF_PROFILE.userId, tel: CALL_TARGET, latlong: latlong } }) });
                window.location.href = `tel:${CALL_TARGET}`;
            }, () => window.location.href = `tel:${CALL_TARGET}`);
        }
        function call(t) { CALL_TARGET=t; MODALS['callModal'].show(); }

        function pinAsmHome() {
            if(!confirm("กรุณากดปักหมุดตอนอยู่ที่บ้านจริงๆ ยืนยัน?")) return;
            toggleLoading(true);
            navigator.geolocation.getCurrentPosition(pos => {
                const latlong = `${pos.coords.latitude},${pos.coords.longitude}`;
                fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateAsmHome', data: { userId: LIFF_PROFILE.userId, latlong: latlong } }) })
                .then(() => {
                    toggleLoading(false);
                    alert("บันทึกพิกัดบ้าน อสม. เรียบร้อย");
                    // Update UI Badge locally if needed
                });
            }, () => { toggleLoading(false); alert("ไม่สามารถระบุพิกัดได้"); });
        }
        
        function pinMyHome() {
            toggleLoading(true);
            navigator.geolocation.getCurrentPosition(p => {
                 fetch(WEB_APP_URL, { 
                     method: 'POST', mode: 'no-cors', 
                     body: JSON.stringify({ action: 'saveNewLocation', data: { userId: LIFF_PROFILE.userId, type: 'บ้าน', latlong: `${p.coords.latitude},${p.coords.longitude}`, distance: 0, duration: 0 } }) 
                 }).then(() => {
                     toggleLoading(false);
                     alert("บันทึกพิกัดบ้านเรียบร้อย");
                     // Optional: Reload logic
                 });
            }, () => { toggleLoading(false); alert("Error GPS"); });
        }

        function showQR() {
            const url = `https://liff.line.me/2005789397-nebQ8oJy?ref=${LIFF_PROFILE.userId}`;
            const api = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;
            document.getElementById('qrImg').src = api;
            MODALS['qrModal'].show();
        }

    </script>
</body>
</html>