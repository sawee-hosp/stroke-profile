<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å by ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root { --bs-primary-rgb: 13, 110, 253; --vhv-bg: #ffc107; --vhv-dark: #b88a00; --base-size: 22px; }
        body { font-family: "Noto Sans Thai", sans-serif; font-size: var(--base-size); background-color: #f0f2f5; margin: 0; padding-bottom: 4rem; }
        h1, h2, h3, h4, h5 { font-weight: 700 !important; }
        .h5, h5 { font-size: 1.6rem; }
        .small, small { font-size: 1rem; }
        .btn { font-size: 1.2rem; }
        
        .nav-tabs .nav-link { font-size: 1.3rem; font-weight: bold; color: #6c757d; padding: 15px 10px; background: #e9ecef; }
        .nav-tabs .nav-link.active { color: #0d6efd; background: #fff; }
        .nav-tabs .nav-link.vhv-tab.active { background: var(--vhv-bg); color: #000; }
        .bg-vhv-theme { background-color: var(--vhv-bg); min-height: 100vh; padding-bottom: 40px; }
        
        .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 1.5rem; border-radius: 15px; }
        .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #333; display: flex; align-items: center; }
        .section-title i { margin-right: 0.8rem; color: #0d6efd; font-size: 1.8rem; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: white; text-align: center; }
        #loading-text { font-size: 2rem; font-weight: bold; margin-bottom: 20px; }
        #loading-subtext { font-size: 3.5rem; font-weight: 800; color: #ffc107; min-height: 100px; line-height: 1.2; text-shadow: 0 0 15px rgba(255, 193, 7, 0.5); opacity: 1; transition: opacity 0.5s ease-in-out; }
        #loading-icon { font-size: 6rem; margin-bottom: 20px; animation: pulse 1s infinite; opacity: 1; transition: opacity 0.5s ease-in-out; }
        .loading-prefix { font-size: 1.5rem; color: #aaa; margin-bottom: 5px; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        .game-score-box { background: #fff; border-radius: 15px; padding: 15px 5px; text-align: center; border: 2px solid #fff; height: 100%; cursor: pointer; }
        .game-score-box h3 { margin: 5px 0; font-weight: 800; color: #0d6efd; font-size: 2.2rem; }
        .game-score-box span { font-size: 1.1rem; color: #666; line-height: 1.2; display: block; }
        
        .profile-edit-btn { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 50px; height: 50px; color: #0d6efd; font-size: 1.5rem; }
        
        .check-icon { font-size: 1.8rem; margin-right: 10px; }
        .check-ok { color: #198754; }
        .check-no { color: #dc3545; opacity: 0.5; }
        
        .risk-1 { border-left: 15px solid #28a745; }
        .risk-2 { border-left: 15px solid #ffc107; }
        .risk-3 { border-left: 15px solid #fd7e14; }
        .risk-4 { border-left: 15px solid #dc3545; }
        .risk-5 { border-left: 15px solid #8B0000; }
        
        .text-line-id { font-size: 1rem; color: #0d6efd; cursor: pointer; background: #e3f2fd; padding: 2px 8px; border-radius: 5px; display: inline-block; }
        .highlight-alert { background-color: #ffebee; border: 2px solid red; }
        .form-section-title { background: #f8f9fa; padding: 10px; font-weight: bold; margin-bottom: 10px; border-left: 5px solid #0d6efd; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .info-item { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 12px 10px; display: flex; align-items: center; font-size: 1rem; }
        .info-item i { font-size: 1.8rem; color: #0d6efd; margin-right: 10px; width: 30px; text-align: center; }
        .info-item .label { display: block; font-size: 0.85rem; color: #6c757d; line-height: 1; }
        .info-item b { font-size: 1.2rem; color: #333; }
    </style>
</head>
<body>

    <div id="loading">
        <div id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        <i id="loading-icon" class="bi"></i>
        <div class="loading-prefix">‡∏à‡∏≥‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡πÇ‡∏ï‡∏£‡∏Å:</div>
        <div id="loading-subtext"></div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs nav-justified fixed-top shadow-sm" id="mainTabs" role="tablist" style="height: 70px;">
        <li class="nav-item">
            <button class="nav-link active" id="health-tab-btn" data-bs-toggle="tab" data-bs-target="#health-tab-content">
                <i class="bi bi-heart-pulse-fill"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link vhv-tab" id="vhv-tab-btn" data-bs-toggle="tab" data-bs-target="#vhv-tab-content">
                <i class="bi bi-person-badge-fill"></i> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°.
            </button>
        </li>
    </ul>

    <div class="tab-content" style="margin-top: 80px;">
        <!-- Tab 1: Health -->
        <div class="tab-pane fade show active" id="health-tab-content">
            <div class="container tab-content-container">
                <div class="row" id="dynamic-content-container"></div>
            </div>
        </div>
        <!-- Tab 2: VHV -->
        <div class="tab-pane fade" id="vhv-tab-content">
            <div class="bg-vhv-theme tab-content-container">
                <div class="container pt-3">
                    <div id="vhv-dashboard-area"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Edit Profile -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3 text-center">
                            <img id="edit-preview-img" src="" style="width:120px;height:120px;border-radius:50%;object-fit:cover;margin-bottom:15px;">
                            <br><small class="text-muted">‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏° LINE ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control form-control-lg" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" class="form-control form-control-lg" id="editPhone" required pattern="[0-9]{10}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="saveUserProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- RTPA Info -->
    <div class="modal fade" id="rtpaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h1 class="modal-title fs-5">‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ ‡∏£‡∏û. ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 4.5 ‡∏ä‡∏°.?</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body fs-5">
                    <p>‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á‡∏ï‡∏µ‡∏ö ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î (rT-PA) ‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</p>
                    <ul>
                        <li><b>‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏≠‡∏á:</b> ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 4.5 ‡∏ä‡∏°. ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</li>
                        <li><b>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</b> ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏™‡∏µ‡∏¢‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•</li>
                        <li><b>‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô:</b> 1669 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏µ‡∏ö‡∏ô‡∏≥‡∏™‡πà‡∏á ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg w-100" data-bs-dismiss="modal">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Info -->
    <div class="modal fade" id="riskInfoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h1 class="modal-title fs-5">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body fs-5">
                    <p>‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ % ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏•‡∏î‡∏•‡∏á</p>
                    <p class="text-danger fw-bold">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡πâ‡∏≥‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥!</p>
                    <p>‡∏Ñ‡∏ß‡∏£‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏°‡∏≠ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û. ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg w-100" data-bs-dismiss="modal">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Distance Modal -->
    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£</p>
                    <div class="mb-3">
                        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                        <select class="form-select form-select-lg" id="locationType">
                            <option value="‡∏ö‡πâ‡∏≤‡∏ô">‡∏ö‡πâ‡∏≤‡∏ô (‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)</option>
                            <option value="‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô">‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÄ‡∏â‡∏¢‡πÜ)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100 btn-lg" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VHV Register/Edit -->
    <div class="modal fade" id="vhvRegisterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏™‡∏°.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vhvForm">
                        <div class="mb-3">
                            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" class="form-control" id="vhvName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                            <input type="tel" class="form-control" id="vhvPhone" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">LINE ID</label>
                            <input type="text" class="form-control" id="vhvLineId">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏•</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <select class="form-select" id="vhvDistrict" onchange="updateVillages()">
                                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="vhvVillage" disabled>
                                        <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3 p-3 bg-light border rounded">
                            <label class="form-label text-danger fw-bold">üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô ‡∏≠‡∏™‡∏°.</label>
                            <p class="small text-muted mb-2">* ‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                            <div class="input-group">
                                <input type="text" class="form-control" id="vhvAsmHome" placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î" readonly>
                                <button class="btn btn-primary" type="button" onclick="pinVhvHomeInForm()">
                                    <i class="bi bi-geo-alt-fill"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    <button class="btn btn-primary" onclick="handleVhvRegistration()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="mb-4">‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
                    <!-- QR Code with correct link -->
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://lin.ee/qRgD07N" alt="QR Code" style="max-width:90%;width:350px;border:15px solid white;border-radius:15px;">
                    <p class="mt-4 fs-3">‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>
                    <a href="https://lin.ee/qRgD07N" class="btn btn-success btn-lg mt-3 rounded-pill px-5 fs-4">
                        <i class="bi bi-line"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                    </a>
                    <button class="btn btn-light btn-lg mt-5 rounded-pill px-5 py-3 fs-3" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Profile -->
    <div class="modal fade" id="shareProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">‡πÅ‡∏ä‡∏£‡πå‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ ‡∏≠‡∏™‡∏°.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô</p>
                    <button type="button" class="btn btn-primary btn-lg w-100" onclick="handleShareProfile()">
                        <i class="bi bi-line"></i> ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stroke Report Modal (Detailed) -->
    <div class="modal fade" id="strokeReportModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h1 class="modal-title fs-4">üöë ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡πÇ‡∏ï‡∏£‡∏Å (Fast Track)</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <form id="strokeReportForm" class="p-2">
                        <div class="form-section-title">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
                        <div class="mb-3">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                            <input type="text" class="form-control" id="srName">
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label>‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                                <input type="number" class="form-control" id="srAge">
                            </div>
                            <div class="col-6">
                                <label>‡πÄ‡∏û‡∏®</label>
                                <select class="form-select" id="srSex">
                                    <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                                    <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><br>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô" name="srUD"><label class="form-check-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏Ø</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô" name="srUD"><label class="form-check-label">‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="‡πÑ‡∏Ç‡∏°‡∏±‡∏ô" name="srUD"><label class="form-check-label">‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏Ø</label></div>
                            <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à" name="srUD"><label class="form-check-label">‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à</label></div>
                        </div>
                        <div class="mb-3">
                            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ç‡∏≤‡∏ï‡∏¥ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)</label>
                            <input type="tel" class="form-control border-danger" id="srRelPhone" required>
                        </div>

                        <div class="form-section-title text-danger">2. ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!)</div>
                        <div class="mb-3">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (Onset)</label>
                            <input type="time" class="form-control form-control-lg border-danger" id="srOnsetTime">
                        </div>
                        <div class="mb-3">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</label>
                            <input type="time" class="form-control" id="srLastSeen">
                        </div>

                        <div class="form-section-title">3. ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (F.A.S.T.)</div>
                        <div class="mb-3">
                            <label>F - ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</label>
                            <select class="form-select" id="srFace">
                                <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="‡∏õ‡∏≤‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢">‡∏õ‡∏≤‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡∏ã‡πâ‡∏≤‡∏¢</option>
                                <option value="‡∏õ‡∏≤‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤">‡∏õ‡∏≤‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡∏Ç‡∏ß‡∏≤</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>A - ‡πÅ‡∏Ç‡∏ô‡∏Ç‡∏≤</label>
                            <select class="form-select" id="srArm">
                                <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏ã‡πâ‡∏≤‡∏¢">‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏ã‡πâ‡∏≤‡∏¢</option>
                                <option value="‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏ß‡∏≤">‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á‡∏Ç‡∏ß‡∏≤</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>S - ‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î</label>
                            <select class="form-select" id="srSpeech">
                                <option value="‡∏õ‡∏Å‡∏ï‡∏¥">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î">‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î/‡∏•‡∏¥‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á</option>
                                <option value="‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å">‡∏û‡∏π‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å/‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à</option>
                            </select>
                        </div>

                        <div class="form-section-title">4. ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á" name="srOther"><label class="form-check-label">‡∏õ‡∏ß‡∏î‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡πÄ‡∏â‡∏µ‡∏¢‡∏ö‡∏û‡∏•‡∏±‡∏ô</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞/‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ã" name="srOther"><label class="form-check-label">‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞ / ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ã</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="‡∏ï‡∏≤‡∏°‡∏±‡∏ß" name="srOther"><label class="form-check-label">‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏±‡∏ô‡πÉ‡∏î</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="‡∏ã‡∏∂‡∏°/‡∏´‡∏°‡∏î‡∏™‡∏ï‡∏¥" name="srOther"><label class="form-check-label">‡∏ã‡∏∂‡∏°‡∏•‡∏á / ‡∏´‡∏°‡∏î‡∏™‡∏ï‡∏¥</label></div>

                        <div class="form-section-title">5. ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
                        <div class="row mb-3">
                            <div class="col-4"><input type="text" class="form-control" id="srBP" placeholder="BP (mmHg)"></div>
                            <div class="col-4"><input type="text" class="form-control" id="srPR" placeholder="Pulse"></div>
                            <div class="col-4"><input type="text" class="form-control" id="srDTX" placeholder="DTX (mg%)"></div>
                        </div>

                        <div class="form-section-title">6. ‡∏Å‡∏≤‡∏£‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏™‡∏π‡∏á 30" name="srFirstAid"><label class="form-check-label">‡∏à‡∏±‡∏î‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏ô‡∏®‡∏µ‡∏£‡∏©‡∏∞‡∏™‡∏π‡∏á 30 ‡∏≠‡∏á‡∏®‡∏≤</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="‡∏ô‡∏≠‡∏ô‡∏ï‡∏∞‡πÅ‡∏Ñ‡∏á" name="srFirstAid"><label class="form-check-label">‡∏à‡∏±‡∏î‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏ô‡∏ï‡∏∞‡πÅ‡∏Ñ‡∏á (‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡∏¥)</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="NPO" name="srFirstAid"><label class="form-check-label">‡∏á‡∏î‡∏ô‡πâ‡∏≥ ‡∏á‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label></div>

                        <div class="form-section-title">7. ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏™‡πà‡∏á</div>
                        <div class="mb-2">
                            <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏™‡πà‡∏á</label>
                            <select class="form-select" id="srTransferMethod">
                                <option value="1669">‡πÇ‡∏ó‡∏£‡πÅ‡∏à‡πâ‡∏á 1669 ‡πÅ‡∏•‡πâ‡∏ß</option>
                                <option value="‡∏£‡∏ñ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">‡∏ô‡∏≥‡∏™‡πà‡∏á‡πÄ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏ñ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                                <option value="‡∏£‡∏≠‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•">‡∏£‡∏≠‡∏£‡∏ñ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏°‡∏≤‡∏£‡∏±‡∏ö</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="srTransferDetail" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ / ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏û‡∏ö">
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-secondary" onclick="getLocationForReport()">
                                <i class="bi bi-geo-alt"></i> ‡πÅ‡∏ô‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                            </button>
                            <input type="text" id="srLocation" class="form-control text-center small" readonly placeholder="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-danger btn-lg flex-grow-1" onclick="submitStrokeReport()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Home Visit Modal -->
    <div class="modal fade" id="homeVisitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h1 class="modal-title fs-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="hvPatientName">
                    <h5 id="hvTitle" class="mb-3">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: ...</h5>
                    
                    <ul class="nav nav-pills mb-3 nav-fill" id="pills-tab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="pills-advice-tab" data-bs-toggle="pill" data-bs-target="#pills-advice">‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="pills-adl-tab" data-bs-toggle="pill" data-bs-target="#pills-adl">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ADL (‡∏´‡∏•‡∏±‡∏á‡∏õ‡πà‡∏ß‡∏¢)</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane fade show active" id="pills-advice">
                            <div class="form-check fs-5 mb-2">
                                <input class="form-check-input" type="checkbox" id="chkAdvice1" checked>
                                <label class="form-check-label" for="chkAdvice1">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á 5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</label>
                            </div>
                            <div class="form-check fs-5 mb-2">
                                <input class="form-check-input" type="checkbox" id="chkAdvice2" checked>
                                <label class="form-check-label" for="chkAdvice2">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</label>
                            </div>
                            <div class="mb-3 mt-3">
                                <label class="form-label">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                                <textarea class="form-control" id="hvNoteAdvice" rows="2"></textarea>
                            </div>
                            <button class="btn btn-success w-100 btn-lg" onclick="submitHomeVisit('Advice')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</button>
                        </div>
                        <div class="tab-pane fade" id="pills-adl">
                            <p class="text-muted small">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ß‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</p>
                            <div class="mb-2"><label>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (Feeding)</label><select class="form-select" id="adlFeeding"><option value="10">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á (10)</option><option value="5">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (5)</option><option value="0">‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (0)</option></select></div>
                            <div class="mb-2"><label>‡∏Å‡∏≤‡∏£‡∏•‡∏∏‡∏Å‡∏ô‡∏±‡πà‡∏á/‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢ (Transfer)</label><select class="form-select" id="adlTransfer"><option value="15">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á (15)</option><option value="10">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (10)</option><option value="5">‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏∏‡∏á (5)</option><option value="0">‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (0)</option></select></div>
                            <div class="mb-2"><label>‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Grooming)</label><select class="form-select" id="adlGrooming"><option value="5">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á (5)</option><option value="0">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (0)</option></select></div>
                            <div class="mb-2"><label>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥ (Toilet)</label><select class="form-select" id="adlToilet"><option value="10">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á (10)</option><option value="5">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (5)</option><option value="0">‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (0)</option></select></div>
                            <div class="mb-2"><label>‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ö‡∏ô‡πâ‡∏≥ (Bathing)</label><select class="form-select" id="adlBathing"><option value="5">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á (5)</option><option value="0">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (0)</option></select></div>
                            <div class="mb-2"><label>‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô/‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (Mobility)</label><select class="form-select" id="adlMobility"><option value="15">‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á (15)</option><option value="10">‡πÄ‡∏î‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ñ‡∏ô‡∏û‡∏¢‡∏∏‡∏á (10)</option><option value="5">‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô (5)</option><option value="0">‡∏ó‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (0)</option></select></div>
                            <button class="btn btn-primary w-100 btn-lg mt-3" onclick="submitHomeVisit('ADL')">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡∏™‡πÇ‡∏ï‡∏£‡∏Å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT (Loading functions defined BEFORE use) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // --- 1. Global Configurations & Variables ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };

        const SAWEE_LOCATIONS = {
            "‡∏ô‡∏≤‡πÇ‡∏û‡∏ò‡∏¥‡πå": 8, "‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏≤": 5, "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÉ‡∏ï‡πâ": 3,
            "‡∏î‡πà‡∏≤‡∏ô‡∏™‡∏ß‡∏µ": 4, "‡∏ó‡πà‡∏≤‡∏´‡∏¥‡∏ô": 3, "‡∏õ‡∏≤‡∏Å‡πÅ‡∏û‡∏£‡∏Å": 4, "‡∏Ñ‡∏£‡∏ô": 4,
            "‡∏ß‡∏¥‡∏™‡∏±‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠": 3, "‡∏ô‡∏≤‡∏™‡∏±‡∏Å": 3, "‡πÄ‡∏Ç‡∏≤‡∏ó‡∏∞‡∏•‡∏∏": 3
        };

        let LIFF_PROFILE = null;
        let ALL_USER_DATA = null;
        let loadingInterval;
        let EDIT_PROFILE_MODAL, VHV_REG_MODAL, QR_MODAL, RTPA_MODAL, SHARE_PROFILE_MODAL, STROKE_REPORT_MODAL, HOME_VISIT_MODAL, RISK_INFO_MODAL, DISTANCE_MODAL;

        // --- 2. Loading Animation Functions (Defined First to prevent ReferenceError) ---
        function startLoadingAnimation() {
            const msgs = [
                {t:"‡πÄ‡∏ã‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß", i:"bi-person-walking", c:"#ffc107"}, 
                {t:"‡∏ï‡∏≤‡∏°‡∏±‡∏ß‡∏°‡∏≤‡∏Å", i:"bi-eye-slash-fill", c:"#9C27B0"}, 
                {t:"‡∏°‡∏∏‡∏°‡∏õ‡∏≤‡∏Å‡∏ï‡∏Å", i:"bi-emoji-dizzy-fill", c:"#dc3545"}, 
                {t:"‡∏¢‡∏Å‡πÅ‡∏Ç‡∏ô‡∏¢‡∏≤‡∏Å", i:"bi-person-arms-up", c:"#0d6efd"}, 
                {t:"‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏û‡∏π‡∏î", i:"bi-mic-mute-fill", c:"#198754"}
            ];
            let i = 0;
            const sub = document.getElementById('loading-subtext');
            const icon = document.getElementById('loading-icon');
            
            // Initial State
            if(sub) {
                sub.textContent = msgs[0].t;
                sub.style.color = msgs[0].c;
                sub.style.opacity = 1;
            }
            if(icon) {
                icon.className = `bi ${msgs[0].i}`;
                icon.style.color = msgs[0].c;
                icon.style.opacity = 1;
            }

            // Loop every 2.5s
            loadingInterval = setInterval(() => {
                // Fade out
                if(sub) sub.style.opacity = 0;
                if(icon) icon.style.opacity = 0;
                
                setTimeout(() => {
                    i = (i + 1) % msgs.length;
                    if(sub) {
                        sub.textContent = msgs[i].t;
                        sub.style.color = msgs[i].c;
                        sub.style.opacity = 1;
                    }
                    if(icon) {
                        icon.className = `bi ${msgs[i].i}`;
                        icon.style.color = msgs[i].c;
                        icon.style.opacity = 1;
                    }
                }, 500); // Wait for fade out
            }, 2500); // Total cycle
        }

        function toggleLoading(show) {
            const el = document.getElementById('loading');
            if(el) el.style.display = show ? 'flex' : 'none';
        }

        function stopLoadingAnimation() {
            if(loadingInterval) clearInterval(loadingInterval);
            toggleLoading(false);
        }

        function handleFailure(e) { 
            alert("Error: "+e.message); 
            stopLoadingAnimation(); 
        }

        // --- 3. Main Execution ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Start Loading immediately
            startLoadingAnimation();
            
            // Init Modals
            EDIT_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('editProfileModal'));
            VHV_REG_MODAL = new bootstrap.Modal(document.getElementById('vhvRegisterModal'));
            QR_MODAL = new bootstrap.Modal(document.getElementById('qrModal'));
            RTPA_MODAL = new bootstrap.Modal(document.getElementById('rtpaModal'));
            SHARE_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('shareProfileModal'));
            STROKE_REPORT_MODAL = new bootstrap.Modal(document.getElementById('strokeReportModal'));
            HOME_VISIT_MODAL = new bootstrap.Modal(document.getElementById('homeVisitModal'));
            RISK_INFO_MODAL = new bootstrap.Modal(document.getElementById('riskInfoModal'));
            DISTANCE_MODAL = new bootstrap.Modal(document.getElementById('distanceModal'));
            
            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                LIFF_PROFILE = await liff.getProfile();
                
                let url = `${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}`;
                const ref = new URLSearchParams(window.location.search).get('ref');
                if(ref) url += `&ref=${ref}`;
                
                fetch(url).then(r => r.json()).then(data => {
                    if (data.error) throw new Error(data.error);
                    ALL_USER_DATA = data;
                    updatePage(data);
                }).catch(err => alert("Error: " + err.message)).finally(() => {
                    stopLoadingAnimation();
                });
            } catch (err) { alert(err.message); }
        });

        // --- 4. Page Logic ---
        function updatePage(data) {
            const hContainer = document.getElementById('dynamic-content-container');
            if (hContainer) {
                if (!data.userProfile) {
                    hContainer.innerHTML = `
                        <div class="col-12 text-center p-5">
                            <h2 class="mb-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
                            <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                            <a href="${LINKS.REGIS}" class="btn btn-primary btn-lg rounded-pill px-5">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
                        </div>`;
                } else {
                    const gamification = data.gamification || {};
                    const dailyCheck = data.dailyCheckInfo || {};
                    const distance = data.homeDistance; 
                    const leaders = data.communityLeaders; 
                    const sticker = data.stickerShareCount || 0;
                    const exam = data.knowledgeTestStats || {};

                    hContainer.innerHTML = 
                        buildProfileCard(data.userProfile) +
                        buildGamificationCard(gamification) +
                        `<div id="card-risk">` + buildProfileCard(data.userProfile, true) + `</div>` +
                        `<div id="card-check">` + buildDailyCheckCard(dailyCheck) + `</div>` +
                        `<div id="card-emergency">` + buildDistanceCard(distance, data.userProfile.help) + `</div>` +
                        `<div id="card-leaders">` + buildCommunityLeadersCard(leaders) + `</div>` +
                        `<div id="card-sticker">` + buildStickerCard(sticker) + `</div>` +
                        `<div id="card-exam">` + buildKnowledgeTestCard(exam) + `</div>`;
                }
            }
            
            const vContainer = document.getElementById('vhv-dashboard-area');
            if (vContainer) {
                const dash = data.vhvDashboard || {};
                const vhvProf = data.vhvProfile || {};
                const vhvPatients = data.vhvPatientList || [];
                
                if (data.isVhv) {
                    vContainer.innerHTML = 
                        buildTopVhvCard(dash.totalVhv, dash.topVhvs) +
                        buildVhvInstructions(true, dash.checklist) +
                        buildVhvInfoCard(data.vhvProfile) +
                        buildVhvPatientListCard(data.vhvPatientList);
                } else {
                    vContainer.innerHTML = 
                        buildTopVhvCard(dash.totalVhv, dash.topVhvs) +
                        buildVhvInstructions(false) +
                        buildVhvRegistrationButton();
                }
            }
        }

        // --- 5. Builders --- 
        function buildGamificationCard(scores) {
            // FIX: Show card even if score is 0
            if (!scores) return '';
            const rankText = `(${scores.totalScore || 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏™‡∏π‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${scores.rank || '-'} ‡∏à‡∏≤‡∏Å ${scores.totalUsers || '-'} ‡∏Ñ‡∏ô)`;
            
            return `
            <div class="col-12 mb-3">
                <div class="card bg-light-blue shadow-sm" style="background-color: #e3f2fd;">
                    <div class="card-body p-3">
                        <h5 class="section-title mb-2 text-primary"><i class="bi bi-trophy-fill text-warning"></i>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h5>
                        <div class="text-center mb-3">
                             <div class="text-primary fw-bold fs-5">${rankText}</div>
                        </div>
                        <div class="row g-3">
                            <div class="col-6 col-md-3" onclick="scrollToId('card-check')">
                                <div class="game-score-box">
                                    <div class="game-icon text-primary"><i class="bi bi-clipboard-check"></i></div>
                                    <h3>${scores.checkScore || 0}</h3>
                                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏≠‡∏≤‡∏Å‡∏≤‡∏£(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3" onclick="scrollToId('card-emergency')">
                                <div class="game-score-box">
                                    <div class="game-icon text-danger"><i class="bi bi-truck-front-fill"></i></div>
                                    <h3>${scores.emergencyScore || 0}</h3>
                                    <span>‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô(‡∏£‡∏û.‡∏™‡∏ß‡∏µ)</span>
                                </div>
                            </div>
                             <div class="col-6 col-md-3" onclick="scrollToId('card-sticker')">
                                <div class="game-score-box">
                                    <div class="game-icon text-info"><i class="bi bi-emoji-smile"></i></div>
                                    <h3>${scores.stickerScore || 0}</h3>
                                    <span>‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span>
                                </div>
                            </div>
                             <div class="col-6 col-md-3" onclick="scrollToId('card-exam')">
                                <div class="game-score-box">
                                    <div class="game-icon text-success"><i class="bi bi-book"></i></div>
                                    <h3>${scores.knowledgeScore || 0}</h3>
                                    <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å(‡πÄ‡∏ï‡πá‡∏°10)</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-2 small text-muted">* ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</div>
                    </div>
                </div>
            </div>`;
        }

        function buildProfileCard(p, riskOnly = false) {
            if (!p) return '';
            const riskValue = (p.thai_cv_risk_score || 0) / 100;
            const riskInfo = classifyRisk(riskValue);
            
            if (riskOnly) {
                const factors = [
                    {i: 'bi-gender-ambiguous', l:'‡πÄ‡∏û‡∏®', v: p.gender == 1 ? '‡∏ä‡∏≤‡∏¢' : '‡∏´‡∏ç‡∏¥‡∏á'},
                    {i: 'bi-calendar-event', l:'‡∏≠‡∏≤‡∏¢‡∏∏', v: `${p.age || '‡πÑ‡∏°‡πà‡∏°‡∏µ'} ‡∏õ‡∏µ`},
                    {i: 'bi-fire', l:'‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', v: p.smoke == 1 ? '‡∏™‡∏π‡∏ö' : '‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ö'},
                    {i: 'bi-bandaid', l:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', v: p.dm == 1 ? '‡πÄ‡∏õ‡πá‡∏ô' : '‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô'},
                    {i: 'bi-speedometer2', l:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', v: `${p.sbp || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`},
                    {i: 'bi-droplet', l:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', v: `${p.cholesterol || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`},
                    {i: 'bi-arrows-expand', l:'‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', v: `${p.waist || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`},
                    {i: 'bi-rulers', l:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', v: `${p.height || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`}
                ];
                let factorHtml = '';
                factors.forEach(f => factorHtml += `<div class="info-item"><i class="bi ${f.i}"></i><div><span class="label">${f.l}</span> <b>${f.v}</b></div></div>`);

                return `
                <div class="col-12">
                <div class="card">
                    <div class="card-body">
                         <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="section-title mb-0"><i class="bi bi-activity"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h6>
                            <button class="btn btn-warning btn-sm fw-bold" onclick="RISK_INFO_MODAL.show()">‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</button>
                         </div>
                        <div class="d-flex align-items-center justify-content-center mb-3">
                             <div class="text-center">
                                <div style="color: ${riskInfo.color};">
                                    <div class="display-3 fw-bolder">${p.thai_cv_risk_score !== undefined ? `${p.thai_cv_risk_score}%` : '‡πÑ‡∏°‡πà‡∏°‡∏µ'}</div>
                                    <div class="fw-bold fs-4">${riskInfo.text}</div>
                                </div>
                            </div>
                            <a href="${LINKS.REGIS}" class="btn btn-outline-primary ms-4 align-self-center btn-lg">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</a>
                        </div>
                        <hr>
                        <h6 class="section-title"><i class="bi bi-person-check"></i>‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h6>
                         <div class="info-grid">${factorHtml}</div>
                    </div>
                </div>
                </div>`;
            }

            const regDate = p.timestamp ? new Date(p.timestamp).toLocaleDateString('th-TH') : '-';
            return `
            <div class="col-12">
                <div class="card bg-white">
                    <div class="card-body position-relative">
                        <button class="profile-edit-btn shadow-sm" onclick="openEditProfile()"><i class="bi bi-pencil-fill"></i></button>
                        <div class="d-flex align-items-center">
                            <img src="${p.pictureUrl || 'https://via.placeholder.com/90'}" class="rounded-circle border border-3 border-primary me-3" style="width: 110px; height: 110px; object-fit: cover;">
                            <div>
                                <h3 class="fw-bold mb-1">${p.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h3>
                                <div class="text-muted fs-5"><i class="bi bi-telephone"></i> ${p.telephone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                                <span class="badge bg-secondary fs-6 fw-normal mt-1">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${regDate}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function buildVhvPatientListCard(pts) {
            if(!pts || pts.length===0) return '<div class="card"><div class="card-body text-center p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</div></div>';
            
            const groups = { 'risk-5': [], 'risk-4': [], 'risk-3': [], 'risk-2': [], 'risk-1': [] };
            const titles = { 'risk-5': '‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° (‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)', 'risk-4': '‡∏™‡∏µ‡πÅ‡∏î‡∏á (‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å)', 'risk-3': '‡∏™‡∏µ‡∏™‡πâ‡∏° (‡∏™‡∏π‡∏á)', 'risk-2': '‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)', 'risk-1': '‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥)' };
            
            pts.forEach(p => {
                const riskVal = (p.thai_cv_risk_score || 0) / 100;
                let c = 'risk-1';
                if(riskVal>=0.4) c='risk-5'; else if(riskVal>=0.3) c='risk-4'; else if(riskVal>=0.2) c='risk-3'; else if(riskVal>=0.1) c='risk-2';

                const distHtml = (p.distanceFromVhv_km) ? 
                    `<small class="text-muted ms-2"><i class="bi bi-geo-alt"></i> ‡∏´‡πà‡∏≤‡∏á ${p.distanceFromVhv_km} ‡∏Å‡∏°.</small>` : '';
                
                let alertClass = '';
                let lastCheckText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£';
                if(p.latestCheckTimestamp) {
                    const diff = Math.floor((new Date() - new Date(p.latestCheckTimestamp)) / (864e5));
                    lastCheckText = `‡πÄ‡∏ä‡πá‡∏Ñ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${diff} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
                    if(diff > 7 && riskVal >= 0.3) alertClass = 'highlight-alert';
                }

                const lineBtn = p.line_id && p.line_id !== 'null' ? `<span class="text-line-id ms-2" onclick="copyToClipboard('${p.line_id}')"><i class="bi bi-line"></i> ${p.line_id}</span>` : '';

                const itemHtml = `<li class="list-group-item ${alertClass} ${c}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="fw-bold mb-1">${p.name} <small class="text-muted">(${p.thai_cv_risk_score}%)</small></h5>
                            <div class="small">${distHtml}</div>
                            <div class="small text-muted">${lastCheckText}</div>
                            <div class="mt-1">${lineBtn}</div>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            <a href="#" onclick="trackTelCall('${p.telephone}')" class="btn btn-outline-success rounded-circle p-2"><i class="bi bi-telephone-fill fs-4"></i></a>
                            <button onclick="openHomeVisit('${p.name}')" class="btn btn-primary btn-sm rounded-pill">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</button>
                        </div>
                    </div>
                </li>`;
                
                groups[c].push(itemHtml);
            });

            let fullHtml = '';
            for(const key in groups) {
                if(groups[key].length > 0) {
                     fullHtml += `<div class="card mb-3"><div class="card-header fw-bold text-white" style="background-color: ${getColor(key)}">${titles[key]} (${groups[key].length})</div><ul class="list-group list-group-flush">${groups[key].join('')}</ul></div>`;
                }
            }

            return `<div class="mb-3">
                <div class="d-grid gap-2 mb-3"><button class="btn btn-danger btn-lg py-3 shadow" onclick="STROKE_REPORT_MODAL.show()"><i class="bi bi-ambulance fs-1"></i><br>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏Ñ‡∏™‡∏™‡πÇ‡∏ï‡∏£‡∏Å (Fast Track)</button></div>
                <h5 class="section-title">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</h5>
                ${fullHtml}
            </div>`;
        }
        
        function getColor(riskClass) {
            if(riskClass==='risk-5') return '#8B0000';
            if(riskClass==='risk-4') return '#dc3545';
            if(riskClass==='risk-3') return '#fd7e14';
            if(riskClass==='risk-2') return '#ffc107';
            return '#28a745';
        }

        // ... [Reused Builders: buildTopVhvCard, buildVhvInstructions, buildVhvInfoCard, buildVhvRegistrationButton, buildDistanceCard, etc.] ...
        
        function buildTopVhvCard(total, topList) {
            let listHtml = '';
            if(topList && topList.length > 0) {
                topList.forEach((t, i) => {
                    listHtml += `<div class="d-flex align-items-center mb-2">
                        <div class="me-2 fw-bold text-primary">#${i+1}</div>
                        <img src="${t.picture}" class="rounded-circle me-2" style="width:40px;height:40px;">
                        <div class="small fw-bold text-truncate" style="max-width:100px;">${t.name}</div>
                        <div class="ms-auto badge bg-success">${t.score} ‡πÅ‡∏ä‡∏£‡πå</div>
                    </div>`;
                });
            } else { listHtml = '<small class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>'; }
            return `<div class="card mb-3 border-primary shadow"><div class="card-body p-3"><div class="row"><div class="col-5 text-center border-end"><div class="text-muted small fw-bold">‡∏≠‡∏™‡∏°.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="display-3 fw-bold text-primary">${total || 0}</div><div class="small">‡∏ó‡πà‡∏≤‡∏ô</div></div><div class="col-7"><div class="text-muted small fw-bold mb-2"><i class="bi bi-award-fill text-warning"></i> ‡∏≠‡∏™‡∏°. ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (7 ‡∏ß‡∏±‡∏ô)</div>${listHtml}</div></div></div></div>`;
        }

        function buildVhvInstructions(isRegistered, cl) {
            const getIcon = (status) => status ? '<i class="bi bi-check-circle-fill check-icon check-ok"></i>' : '<i class="bi bi-x-circle-fill check-icon check-no"></i>';
            const items = [
                { txt: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô ‡∏≠‡∏™‡∏°.‡∏™‡πÇ‡∏ï‡∏£‡∏Å", ok: isRegistered },
                { txt: "‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°", ok: cl?.hasExam },
                { txt: "‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô", ok: cl?.hasPinned },
                { txt: "‡πÅ‡∏ä‡∏£‡πå QR Code ‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡πÅ‡∏Å‡∏ô", ok: cl?.hasSharedQr },
                { txt: "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö", ok: cl?.hasRecommended },
                { txt: "‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á", ok: cl?.hasSharedSticker }
            ];
            const listHtml = items.map(it => `<li class="list-group-item bg-transparent d-flex align-items-start border-0 px-0 py-2">${getIcon(it.ok)}<span>${it.txt}</span></li>`).join('');
            return `<div class="card mb-4"><div class="card-body"><h5 class="fw-bold text-dark mb-3"><i class="bi bi-list-check"></i> ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h5><ul class="list-group list-group-flush fs-5">${listHtml}</ul></div></div>`;
        }

        function buildVhvInfoCard(vhv) {
            const pinBtnText = vhv.asm_home ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô' : '‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô ‡∏≠‡∏™‡∏°.';
            // Corrected Update Pin Button Action: opens openVhvModal()
            return `<div class="card border-warning shadow"><div class="card-body"><div class="text-center mb-3"><button class="btn btn-dark btn-lg w-100 shadow rounded-pill py-3" onclick="showQrModal()"><i class="bi bi-qr-code fs-2"></i> ‡πÅ‡∏™‡∏î‡∏á QR Code</button></div><hr><h5 class="section-title text-dark">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡∏≠‡∏™‡∏°.</h5><p class="mb-1 fs-5"><b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${vhv.name || ''}</p><p class="mb-1 fs-5"><b>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà:</b> ${vhv.area || ''}</p><div class="row mt-3 g-2"><div class="col-6"><button class="btn btn-primary w-100 btn-lg" onclick="handleShareProfile()"><i class="bi bi-share-fill"></i> ‡πÅ‡∏ä‡∏£‡πå‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ ‡∏≠‡∏™‡∏°.</button></div><div class="col-6"><button class="btn btn-outline-dark w-100 btn-lg" onclick="openVhvModal()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</button></div><div class="col-12 mt-2"><button class="btn btn-secondary w-100" onclick="pinVhvHomeInForm()"><i class="bi bi-geo-alt-fill"></i> ${pinBtnText}</button></div><div class="col-12 mt-2"><a href="${LINKS.KNOWLEDGE}" class="btn btn-info w-100 text-white">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</a></div></div></div></div>`;
        }

        function buildVhvRegistrationButton() {
            return `<div class="card bg-white text-center p-4"><i class="bi bi-person-plus-fill display-1 text-warning mb-3"></i><h3>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô ‡∏≠‡∏™‡∏°.‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h3><p class="text-muted">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°. ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p><button class="btn btn-lg btn-warning fw-bold w-100" onclick="openVhvModal()">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button></div>`;
        }

        function buildDistanceCard(d, help) {
             let html = '<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô</p>';
             let cls = 'card';
             // Card visual graphic
             let graphic = '';
             let advice = '';

             if(d) {
                 const min = parseInt(d.duration_mins); // Corrected property name from backend
                 const dist = parseFloat(d.distance_km).toFixed(1);
                 cls += min < 150 ? ' bg-success-subtle' : min < 210 ? ' bg-warning-subtle' : ' bg-danger-subtle';
                 
                 // Advice logic
                 if(min < 150) {
                     advice = `<div class="alert alert-success mt-2"><b>‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤!</b> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>`;
                 } else if (min < 210) {
                     advice = `<div class="alert alert-warning mt-2"><b>‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á!</b> ‡∏≠‡∏≤‡∏à‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡∏°‡∏≤ ‡∏£‡∏û. ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>`;
                 } else {
                     advice = `<div class="alert alert-danger mt-2"><b>‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏¢‡∏≤!</b> ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</div>`;
                 }

                 graphic = `
                 <div class="d-flex align-items-center justify-content-center my-3">
                    <div class="text-center">
                        <i class="bi bi-person-fill-exclamation text-danger" style="font-size: 3rem;"></i>
                        <div>‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</div>
                    </div>
                    <div class="flex-grow-1 text-center px-2 position-relative">
                        <div style="border-top: 3px dashed #666; width: 100%; position: absolute; top: 50%;"></div>
                        <i class="bi bi-arrow-right-circle-fill text-primary position-relative" style="font-size: 2rem; background: #fff; z-index: 1;"></i>
                        <div class="small fw-bold mt-1">${dist} ‡∏Å‡∏°.</div>
                        <div class="small text-muted">${Math.floor(min/60)} ‡∏ä‡∏°. ${min%60} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>
                    <div class="text-center">
                        <i class="bi bi-hospital-fill text-success" style="font-size: 3rem;"></i>
                        <div>‡∏£‡∏û.‡∏™‡∏ß‡∏µ</div>
                    </div>
                 </div>`;
                 
                 html = graphic + advice;
             } else {
                 html = `<div class="alert alert-light mt-2">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ ‡∏£‡∏û.‡∏™‡∏ß‡∏µ</div>`;
             }

             return `<div class="col-12"><div class="${cls}"><div class="card-body"><h5 class="section-title"><i class="bi bi-truck-front-fill text-danger"></i>‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏£‡∏û.‡∏™‡∏ß‡∏µ)</h5>${html}<div class="d-flex gap-2 mt-2"><button class="btn btn-outline-danger w-50" onclick="RTPA_MODAL.show()">‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á 4.5 ‡∏ä‡∏°.?</button><button class="btn btn-secondary w-50" onclick="DISTANCE_MODAL.show()"><i class="bi bi-geo-alt-fill"></i> ‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏õ‡∏£‡∏û.</button></div></div></div></div>`;
        }

        function buildDailyCheckCard(info) {
             let daysSinceCheck = '';
            if (info.latestCheckTimestamp) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(info.latestCheckTimestamp).setHours(0,0,0,0)) / (864e5));
                if (diffDays > 7) daysSinceCheck = `<p class="text-center text-danger mt-2">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤ ${diffDays} ‡∏ß‡∏±‡∏ô (‡∏ñ‡∏π‡∏Å‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</p>`;
                else if (diffDays > 0) daysSinceCheck = `<p class="text-center text-muted mt-2">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏°‡∏≤ ${diffDays} ‡∏ß‡∏±‡∏ô</p>`;
            } else { daysSinceCheck = `<p class="text-center text-danger mt-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</p>`; }
            return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-calendar-check-fill"></i>‡πÉ‡∏™‡πà‡πÉ‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h5><div class="d-flex justify-content-around text-center"><div><div class="display-3 fw-bold text-danger">${info.symptomCount || 0}</div><div class="small">‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</div></div><div><div class="display-3 fw-bold text-success">${info.noSymptomCount || 0}</div><div class="small">‡∏õ‡∏Å‡∏ï‡∏¥</div></div></div>${daysSinceCheck}<p class="small text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πá‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏î‡πâ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</p><a href="${LINKS.DAILY}" class="btn btn-primary w-100 btn-lg mt-1">‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</a></div></div></div>`;
        }
        function buildStickerCard(c) { return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-send-check-fill"></i>‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÑ‡∏•‡∏ô‡πå</h5><div class="text-center"><h1>${c || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</h1></div><a href="${LINKS.STICKER}" class="btn btn-info w-100 btn-lg text-white mt-2">‡∏™‡πà‡∏á‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</a></div></div></div>`; }
        function buildKnowledgeTestCard(s) { return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-book-half"></i>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h5><div class="text-center"><h1>${s.maxScore || 0}/10</h1><small>‡∏™‡∏≠‡∏ö‡πÑ‡∏õ ${s.testCount || 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</small></div><a href="${LINKS.KNOWLEDGE}" class="btn btn-success w-100 btn-lg mt-2">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</a></div></div></div>`; }
        function buildCommunityLeadersCard(l) { 
            if(!l) return '<div class="col-12"><div class="card"><div class="card-body text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</div></div></div>';
            let html = '<ul class="list-group list-group-flush fs-5">';
            if(l.pcu) html += `<li class="list-group-item d-flex justify-content-between"><span>‡∏£‡∏û.‡∏™‡∏ï.: ${l.pcu}</span>${l.pcu_tel?`<a href="tel:${l.pcu_tel}" class="btn-call">‡πÇ‡∏ó‡∏£</a>`:''}</li>`;
            if(l.volunteer1) html += `<li class="list-group-item d-flex justify-content-between"><span>‡∏≠‡∏™‡∏°.1: ${l.volunteer1}</span><a href="tel:${l.volunteer1_tel}" class="btn-call">‡πÇ‡∏ó‡∏£</a></li>`;
            html += '</ul>';
            return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-people-fill"></i>‡∏≠‡∏™‡∏°.‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô</h5>${html}</div></div></div>`;
        }
        function openEditProfile() { document.getElementById('editName').value = ALL_USER_DATA.userProfile.name; document.getElementById('editPhone').value = ALL_USER_DATA.userProfile.telephone ? ALL_USER_DATA.userProfile.telephone.replace(/'/g,'') : ''; document.getElementById('edit-preview-img').src = ALL_USER_DATA.userProfile.pictureUrl; EDIT_PROFILE_MODAL.show(); }
        function saveUserProfile() { const name = document.getElementById('editName').value; const phone = document.getElementById('editPhone').value; if(!name || !phone) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateUserProfile', data: { userId: LIFF_PROFILE.userId, name: name, phone: phone, pictureUrl: LIFF_PROFILE.pictureUrl } }) }).then(() => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.location.reload(); }).catch(handleFailure); }
        function openVhvModal() { const distSelect = document.getElementById('vhvDistrict'); distSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏•</option>'; for (const d in SAWEE_LOCATIONS) { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; distSelect.appendChild(opt); } const vhv = ALL_USER_DATA.vhvProfile || {}; const user = ALL_USER_DATA.userProfile || {}; document.getElementById('vhvName').value = vhv.name || user.name || ''; document.getElementById('vhvPhone').value = vhv.phone ? vhv.phone.replace(/'/g,'') : (user.telephone ? user.telephone.replace(/'/g,'') : ''); document.getElementById('vhvLineId').value = vhv.line_id || user.line_id || ''; document.getElementById('vhvAsmHome').value = vhv.asm_home || ''; if (vhv.area) { const parts = vhv.area.match(/‡∏ï\.(.*?) ‡∏°\.(.*)/); if (parts && parts[1] && parts[2]) { distSelect.value = parts[1].trim(); updateVillages(); document.getElementById('vhvVillage').value = "‡∏´‡∏°‡∏π‡πà " + parts[2].trim(); } } VHV_REG_MODAL.show(); }
        
        // ** FIX: Force 1-20 for all districts **
        function updateVillages() { 
            const dist = document.getElementById('vhvDistrict').value; 
            const villSelect = document.getElementById('vhvVillage'); 
            villSelect.innerHTML = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏π‡πà</option>'; 
            villSelect.disabled = false; 
            for(let i=1; i<=20; i++) { 
                const v = "‡∏´‡∏°‡∏π‡πà " + i; 
                const opt = document.createElement('option'); 
                opt.value = v; opt.textContent = v; 
                villSelect.appendChild(opt); 
            } 
        }
        
        function showQrModal() { fetch(`${WEB_APP_URL}?action=logQrShare&userId=${LIFF_PROFILE.userId}`); QR_MODAL.show(); }
        function scrollToId(id) { const el = document.getElementById(id); if(el) { const tabBtn = document.getElementById('health-tab-btn'); const tab = new bootstrap.Tab(tabBtn); tab.show(); setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300); } }
        function handlePinNewLocation() { toggleLoading(true); navigator.geolocation.getCurrentPosition(p => { fetch(`${WEB_APP_URL}?action=calculateDistance&lat=${p.coords.latitude}&lon=${p.coords.longitude}`).then(r=>r.json()).then(d=> { fetch(WEB_APP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'saveNewLocation',data:{userId:LIFF_PROFILE.userId,type:document.getElementById('locationType').value,latlong:`${p.coords.latitude},${p.coords.longitude}`,distance:d.distance_km,duration:d.duration_mins}})}).then(()=>{alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.location.reload();}); }); }, e=>handleFailure(e), {enableHighAccuracy: true}); }
        function pinVhvHomeInForm() { toggleLoading(true); navigator.geolocation.getCurrentPosition(p => { document.getElementById('vhvAsmHome').value = `${p.coords.latitude},${p.coords.longitude}`; toggleLoading(false); }, e=>handleFailure(e), {enableHighAccuracy: true}); }
        function getLocationForReport() { toggleLoading(true); navigator.geolocation.getCurrentPosition(p => { document.getElementById('srLocation').value = `${p.coords.latitude},${p.coords.longitude}`; toggleLoading(false); }, e=>handleFailure(e)); }
        function submitStrokeReport() { const pn = document.getElementById('srPatientName').value; const ph = document.getElementById('srPhone').value; const ot = document.getElementById('srOnsetTime').value; const loc = document.getElementById('srLocation').value; if(!pn || !ph || !ot || !loc) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); let sym = []; ['B','E','F','A','S'].forEach(k => { if(document.getElementById('sym'+k).checked) sym.push(document.getElementById('sym'+k).value); }); toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveStrokeReport', data: { reporterId: LIFF_PROFILE.userId, reporterName: LIFF_PROFILE.displayName, patientName: pn, patientPhone: ph, onsetTime: ot, location: loc, symptoms: sym.join(',') }}) }).then(() => { alert("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏µ‡∏°‡∏™‡πÇ‡∏ï‡∏£‡∏Å‡∏à‡∏∞‡∏£‡∏µ‡∏ö‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"); window.location.reload(); }).catch(handleFailure); }
        function openHomeVisit(name) { document.getElementById('hvPatientName').value = name; document.getElementById('hvTitle').textContent = "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: " + name; HOME_VISIT_MODAL.show(); }
        function submitHomeVisit(type) { const pname = document.getElementById('hvPatientName').value; let data = { vhvId: LIFF_PROFILE.userId, patientName: pname, activityType: type, note: '' }; if (type === 'Advice') { let adv = []; if(document.getElementById('chkAdvice1').checked) adv.push("5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô"); if(document.getElementById('chkAdvice2').checked) adv.push("‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß"); data.note = adv.join(', ') + " : " + document.getElementById('hvNoteAdvice').value; } else { data.adl = { feeding: document.getElementById('adlFeeding').value, transfer: document.getElementById('adlTransfer').value, grooming: document.getElementById('adlGrooming').value, toilet: document.getElementById('adlToilet').value, bathing: document.getElementById('adlBathing').value, mobility: document.getElementById('adlMobility').value }; } toggleLoading(true); fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveHomeVisit', data: data }) }).then(() => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); HOME_VISIT_MODAL.hide(); toggleLoading(false); }).catch(handleFailure); }
        function handleVhvRegistration() { const name = document.getElementById('vhvName').value; const phone = document.getElementById('vhvPhone').value; const line = document.getElementById('vhvLineId').value; const dist = document.getElementById('vhvDistrict').value; const vill = document.getElementById('vhvVillage').value; const home = document.getElementById('vhvAsmHome').value; if(!name || !phone || !dist || !vill) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); const villNum = vill.replace('‡∏´‡∏°‡∏π‡πà ', ''); const areaString = `‡∏ï.${dist} ‡∏°.${villNum}`; toggleLoading(true); const data = { userId: LIFF_PROFILE.userId, displayName: LIFF_PROFILE.displayName, profilePicture: LIFF_PROFILE.pictureUrl, name: name, phone: phone, line_id: line, areas: [areaString], pdpa: "‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°", asm_home: home, asm_test: ALL_USER_DATA.vhvProfile?.asm_test || '' }; fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerVhv', data: data }) }).then(() => { alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.location.reload(); }).catch(handleFailure); }
        
        // ** Updated Share Function for Client-Side **
        async function handleShareProfile() { 
            toggleLoading(true); 
            try { 
                const res = await fetch(`${WEB_APP_URL}?action=getShareCard&userId=${LIFF_PROFILE.userId}`); 
                const data = await res.json(); 
                toggleLoading(false); 
                if (data.success && data.flex) { 
                    SHARE_PROFILE_MODAL.hide(); 
                    await liff.shareTargetPicker([data.flex]); 
                } else { 
                    alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + data.message); 
                } 
            } catch (err) { handleFailure(err); } 
        }
        
        function trackTelCall(tel) { if(confirm("‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å?")) window.location.href = 'tel:'+tel.replace(/'/g,''); }
        function copyToClipboard(txt) { navigator.clipboard.writeText(txt).then(()=>alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Line ID ‡πÅ‡∏•‡πâ‡∏ß")).catch(()=>alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")); }
        function classifyRisk(r) { return r<0.1?{text:"‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥",color:"#28a745"}:r<0.2?{text:"‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",color:"#ffc107"}:r<0.3?{text:"‡∏™‡∏π‡∏á",color:"#fd7e14"}:r<0.4?{text:"‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å",color:"#dc3545"}:{text:"‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢",color:"#8B0000"}; }
        
        // --- Safe Toggle Loading Function ---
        function toggleLoading(show) {
            const el = document.getElementById('loading');
            if(el) el.style.display = show ? 'flex' : 'none';
        }

        // ** 3. Define stopLoadingAnimation (wrapper for toggleLoading(false)) **
        function stopLoadingAnimation() {
            if(loadingInterval) clearInterval(loadingInterval);
            toggleLoading(false);
        }
        
        function handleFailure(e) { 
            alert("Error: "+e.message); 
            stopLoadingAnimation(); 
        }
    </script>
</body>
</html>