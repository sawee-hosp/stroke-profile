<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* =========================================
           1. VARIABLES & THEME
           ========================================= */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            /* Health Theme (Red) */
            --theme-red: #ff3654; 
            --theme-red-light: #ffebee;
            
            /* VHV Theme (Gold) */
            --gold-dark: #8B4513;   /* SaddleBrown for Text */
            --gold-main: #D4AF37;   /* Metallic Gold */
            --gold-bright: #FFD700; /* Gold */
            --gold-bg: #FFF8E1;     /* Cornsilk/Cream */
            --gold-card: #FFFCF2;   /* Very Light Gold */
            
            --base-size: 20px; 
        }

        html { 
            font-size: var(--base-size);
        }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 1rem; 
            /* Default Red Gradient */
            background: linear-gradient(180deg, var(--theme-red) 0%, #ffffff 450px);
            background-attachment: fixed;
            margin: 0; 
            padding-bottom: 6rem; 
            transition: background 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* --- VHV Mode Override --- */
        body.vhv-mode {
            /* Gold Gradient */
            background: linear-gradient(180deg, var(--gold-main) 0%, #ffffff 400px);
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 { 
            font-weight: 700 !important; 
        }
        
        .text-gold-dark {
            color: var(--gold-dark) !important;
        }

        /* =========================================
           2. HEADER & TABS
           ========================================= */
        /* Remove Title Text as requested, just spacing */
        .app-header-spacer { 
            height: 70px; 
        }

        .nav-tabs-container {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            z-index: 1000;
            background-color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            padding: 0;
        }

        .nav-tabs { 
            border-bottom: none; 
            width: 100%; 
            display: flex; 
            margin: 0;
        }

        .nav-item { 
            flex: 1; 
            text-align: center; 
        }

        .nav-link { 
            font-size: 1.2rem; 
            color: #999; 
            border: none; 
            border-radius: 0; /* Squared top */
            margin: 0; 
            padding: 15px 0; 
            font-weight: 700; 
            background: #fff; 
            width: 100%;
            transition: all 0.3s ease;
        }

        /* Active Tab: Health (Red) */
        .nav-link.active { 
            color: var(--theme-red); 
            background: var(--theme-red-light); 
            border-bottom: 5px solid var(--theme-red);
            border-top-left-radius: 15px; /* Rounded Top */
            border-top-right-radius: 15px; 
        }

        /* Active Tab: VHV (Gold) - Override via JS class on body */
        body.vhv-mode .nav-link#vhv-tab-btn.active { 
            color: var(--gold-dark); 
            background: var(--gold-bg); 
            border-bottom: 5px solid var(--gold-bright);
        }
        
        /* Divider */
        .nav-item:first-child .nav-link { 
            border-right: 1px solid #eee; 
        }

        /* =========================================
           3. CARDS & LAYOUT
           ========================================= */
        .card { 
            border: none; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); 
            margin-bottom: 1.5rem; 
            border-radius: 20px; 
            overflow: hidden; 
            background-color: #fff; 
            transition: background-color 0.3s;
        }

        /* VHV Card Theme */
        body.vhv-mode .card { 
            background-color: var(--gold-card); 
            border: 1px solid rgba(212, 175, 55, 0.3); /* Gold Border */
        }
        
        .section-title { 
            font-size: 1.3rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            color: #333; 
            display: flex; 
            align-items: center; 
            gap: 10px;
        }

        .section-title i { 
            font-size: 1.5rem; 
            color: var(--theme-red); 
        }

        body.vhv-mode .section-title i { 
            color: var(--gold-dark); 
        }
        
        body.vhv-mode .text-muted {
            color: #6c5b4c !important; /* Brownish gray */
        }

        /* =========================================
           4. COMPONENTS
           ========================================= */
        
        /* Buttons */
        .btn-main { 
            background-color: var(--theme-red); 
            color: white; 
            border-radius: 50px; 
            padding: 10px 25px; 
            border: none; 
            box-shadow: 0 4px 10px rgba(255, 54, 84, 0.4); 
            font-weight: 700;
        }
        .btn-main:hover { background-color: #d62540; color: white; }

        /* Symmetrical Circle Buttons */
        .btn-circle { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0; 
            flex-shrink: 0; /* Important: prevents squeezing */
        }

        /* VHV Button Override */
        body.vhv-mode .btn-primary { 
            background-color: var(--gold-dark); 
            border-color: var(--gold-dark); 
            color: var(--gold-bright); 
        }
        body.vhv-mode .btn-outline-dark {
            color: var(--gold-dark);
            border-color: var(--gold-dark);
        }

        /* Profile */
        .profile-img-lg { 
            width: 90px; 
            height: 90px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid #fff; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        
        /* Score Card */
        .game-score-card { 
            border: 2px solid #fff; 
            background: linear-gradient(135deg, #fce4ec, #ffffff); 
        }
        
        .game-score-box { 
            background: #fff; 
            border-radius: 15px; 
            padding: 10px 5px; 
            text-align: center; 
            border: 1px solid #f0f0f0; 
            height: 100%; 
            cursor: pointer; 
            transition: transform 0.2s; 
        }
        .game-score-box:active { transform: scale(0.95); }
        .score-num { font-size: 1.8rem; font-weight: 800; color: var(--theme-red); line-height: 1; }
        
        /* Risk Card */
        .risk-val { font-size: 3.5rem; font-weight: 900; line-height: 1; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .info-item { background: #f8f9fa; border: 1px solid #eee; border-radius: 12px; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .info-item i { font-size: 1.5rem; color: var(--theme-red); }

        /* Emergency */
        .emergency-graphic { font-size: 2.5rem; margin: 0 10px; color: #dc3545; }
        
        /* VHV Patient List */
        .vhv-patient-item { 
            border-left: 8px solid #ccc; 
            margin-bottom: 12px; 
            border-radius: 12px; 
            background-color: #fff; 
            padding: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .vhv-risk-5 { border-left-color: #8B0000; background-color: #fff5f5; }
        .vhv-risk-4 { border-left-color: #dc3545; }
        .vhv-risk-3 { border-left-color: #fd7e14; }
        .vhv-risk-2 { border-left-color: #ffc107; }
        .vhv-risk-1 { border-left-color: #28a745; }

        /* Loaders */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; 
            justify-content: center; align-items: center; color: white; 
            z-index: 2000; flex-direction: column; 
        }
        .spinner-container { text-align: center; padding: 50px; }
        .spinner-border { width: 3rem; height: 3rem; }

        .app-footer { 
            text-align: center; color: #888; font-size: 0.8rem; margin-top: 30px; 
        }
    </style>
</head>
<body>

    <!-- Loading Overlay (Action Blocking) -->
    <div id="loading-overlay">
        <div class="spinner-border text-light" role="status"></div>
        <div class="mt-3">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>

    <!-- Fixed Tabs -->
    <div class="nav-tabs-container">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="health-tab-btn">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vhv-tab-btn">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°.</button>
            </li>
        </ul>
    </div>
    
    <div class="app-header-spacer"></div>

    <!-- Main Content -->
    <div class="container" style="padding: 0 15px;">
        
        <!-- Tab 1: Health -->
        <div id="health-view">
            <div id="health-content">
                <div class="spinner-container">
                    <div class="spinner-border text-primary"></div>
                    <div class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß...</div>
                </div>
            </div>
        </div>

        <!-- Tab 2: VHV -->
        <div id="vhv-view" style="display: none;">
            <div id="vhv-content">
                <div class="spinner-container">
                    <div class="spinner-border text-warning"></div>
                    <div class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏™‡∏°...</div>
                </div>
            </div>
        </div>

    </div>

    <div class="app-footer">‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏à.‡∏ä‡∏∏‡∏°‡∏û‡∏£</div>

    <!-- ================= MODALS ================= -->

    <!-- Call Permission Modal -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-primary"><i class="bi bi-telephone-outbound"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="fs-5">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á <b>‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</b> ‡πÅ‡∏•‡∏∞ <b>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå</b> ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏£‡∏≤‡∏ö</p>
                    <p class="text-muted">‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary w-50" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn btn-primary w-50" onclick="confirmCall()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Emergency Modal -->
    <div class="modal fade" id="editEmgModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•</label>
                        <select class="form-select" id="inpHelp">
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß">‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</label>
                        <select class="form-select" id="inpDec">
                            <option value="‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</option>
                            <option value="‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π">‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π</option>
                            <option value="‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢">‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢</option>
                            <option value="‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á">‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á</option>
                            <option value="‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö">‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö</option>
                        </select>
                    </div>
                    <button class="btn btn-primary w-100" onclick="saveEmg()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Score Criteria Modal -->
    <div class="modal fade" id="scoreModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><b>1. ‡πÉ‡∏™‡πà‡πÉ‡∏à (40%):</b> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠</li>
                        <li class="list-group-item"><b>2. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (10%):</b> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á x ‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏• x ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</li>
                        <li class="list-group-item"><b>3. ‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠ (20%):</b> ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏ï‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå</li>
                        <li class="list-group-item"><b>4. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (30%):</b> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VHV Visit Modal -->
    <div class="modal fade" id="visitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="visitUid">
                    <input type="hidden" id="visitName">
                    <h5 id="visitTitle" class="mb-3"></h5>
                    <div class="d-grid mb-3">
                        <button class="btn btn-warning text-dark" onclick="pinForUser()">üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="chk1" checked><label class="form-check-label">‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ 5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="chk2" checked><label class="form-check-label">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" id="chk3"><label class="form-check-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ADL</label></div>
                    </div>
                    <button class="btn btn-success w-100" onclick="saveVisit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white text-center justify-content-center">
                <div class="modal-header border-0"><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <h2 class="mb-4 text-warning">‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h2>
                    <div class="bg-white p-3 d-inline-block rounded mb-4">
                        <img id="qrImg" src="" style="width:250px;height:250px;">
                    </div>
                    <p class="fs-4">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                    <p class="text-muted small">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: <span id="refCodeDisplay"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // *** CONFIG ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID = '2005789397-RLAGXrBJ';
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };

        let LIFF_PROFILE, ALL_DATA, CALL_TARGET;
        let MODALS = {};

        // --- Init ---
        window.onload = async () => {
            // Init Modals
            ['callModal', 'editEmgModal', 'scoreModal', 'visitModal', 'qrModal'].forEach(id => {
                MODALS[id] = new bootstrap.Modal(document.getElementById(id));
            });

            // Tabs
            document.getElementById('health-tab-btn').onclick = () => switchTab('health');
            document.getElementById('vhv-tab-btn').onclick = () => switchTab('vhv');

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                LIFF_PROFILE = await liff.getProfile();
                
                const ref = new URLSearchParams(location.search).get('ref') || '';
                const url = `${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}&ref=${ref}`;
                
                const res = await fetch(url).then(r=>r.json());
                if(res.error) throw new Error(res.error);
                
                ALL_DATA = res;
                renderHealth();
                renderVhv();
                
            } catch(e) { 
                alert("Error: " + e.message); 
            }
        };

        function switchTab(mode) {
            const isVhv = mode === 'vhv';
            document.body.className = isVhv ? 'vhv-mode' : '';
            
            document.getElementById('health-tab-btn').className = `nav-link ${!isVhv?'active':''}`;
            document.getElementById('vhv-tab-btn').className = `nav-link ${isVhv?'active':''}`;
            
            document.getElementById('health-view').style.display = !isVhv ? 'block' : 'none';
            document.getElementById('vhv-view').style.display = isVhv ? 'block' : 'none';
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // --- Render Health ---
        function renderHealth() {
            const div = document.getElementById('health-content');
            if(!ALL_DATA.userProfile) {
                div.innerHTML = `<div class="card p-5 text-center mt-3"><h5>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5><a href="${LINKS.REGIS}" class="btn btn-main mt-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></div>`;
                return;
            }
            
            const p = ALL_DATA.userProfile;
            const g = ALL_DATA.gamification || {};
            const emg = g.details || {};
            const dist = ALL_DATA.homeDistance;

            div.innerHTML = `
                <!-- 1. Profile -->
                <div class="card p-3 mb-3 d-flex flex-row align-items-center shadow-sm">
                    <img src="${p.pictureUrl}" class="profile-img-lg me-3">
                    <div>
                        <h5 class="fw-bold mb-0">${p.name}</h5>
                        <div class="text-muted"><i class="bi bi-telephone"></i> ${p.telephone}</div>
                        <span class="badge bg-secondary rounded-pill">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${p.timestamp ? p.timestamp.split('T')[0] : '-'}</span>
                    </div>
                </div>

                <!-- 2. Score -->
                <div class="card game-score-card mb-3"><div class="card-body p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <h5 class="m-0 text-primary">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏π‡πâ</h5>
                        <button class="btn btn-sm btn-outline-info rounded-circle" onclick="MODALS['scoreModal'].show()">?</button>
                    </div>
                    <div class="text-center my-3">
                        <div class="display-3 fw-bold text-primary">${g.totalScore}</div>
                        <span class="badge rounded-pill bg-${g.levelColor} fs-6">${g.levelName}</span>
                    </div>
                    <div class="progress mb-2" style="height:8px"><div class="progress-bar bg-${g.levelColor}" style="width:${Math.min(100,(g.totalScore/g.nextLevelScore)*100)}%"></div></div>
                    <div class="text-end small text-muted">‡∏≠‡∏µ‡∏Å ${(g.nextLevelScore-g.totalScore).toFixed(1)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö</div>
                    
                    <div class="row g-2 mt-3 text-center">
                        <div class="col-3"><div class="game-score-box" onclick="window.open('${LINKS.DAILY}')"><h3>${g.checkScore}</h3><small>‡πÉ‡∏™‡πà‡πÉ‡∏à</small></div></div>
                        <div class="col-3"><div class="game-score-box"><h3>${g.emergencyScore}</h3><small>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</small></div></div>
                        <div class="col-3"><div class="game-score-box" onclick="window.open('${LINKS.STICKER}')"><h3>${g.stickerScore}</h3><small>‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠</small></div></div>
                        <div class="col-3"><div class="game-score-box" onclick="window.open('${LINKS.KNOWLEDGE}')"><h3>${g.knowledgeScore}</h3><small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</small></div></div>
                    </div>
                </div></div>

                <!-- 3. Risk -->
                ${buildRiskCard(p)}

                <!-- 4. Emergency -->
                <div class="card mb-3 border-danger shadow-sm"><div class="card-body">
                    <h5 class="text-danger fw-bold"><i class="bi bi-truck-front-fill"></i> ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏£‡∏û.‡∏™‡∏ß‡∏µ)</h5>
                    <div class="d-flex align-items-center justify-content-center my-3 text-danger">
                        <i class="bi bi-person-fill emergency-graphic"></i> 
                        <div class="text-center"><i class="bi bi-arrow-right fs-1"></i><br><small>${dist ? dist.distance_km : '?'} ‡∏Å‡∏°.</small></div> 
                        <i class="bi bi-hospital-fill emergency-graphic"></i>
                    </div>
                    ${(dist && dist.distance_km > 40) ? '<div class="alert alert-warning small p-1 text-center">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏Å‡∏°. ‡πÇ‡∏õ‡∏£‡∏î‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏£‡∏û. ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</div>' : ''}
                    
                    <div class="bg-light p-2 rounded mb-2 d-flex justify-content-between align-items-center">
                        <span>‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•: <b>${emg.help || '-'}</b></span>
                        <i class="bi bi-pencil-square text-secondary" onclick="openEditEmg('${emg.help}','${emg.decision}')" style="cursor:pointer;"></i>
                    </div>
                    <div class="bg-light p-2 rounded mb-3 d-flex justify-content-between align-items-center">
                        <span>‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à: <b>${emg.decision || '-'}</b></span>
                        <i class="bi bi-pencil-square text-secondary" onclick="openEditEmg('${emg.help}','${emg.decision}')" style="cursor:pointer;"></i>
                    </div>
                    <button class="btn btn-outline-danger w-100 rounded-pill" onclick="pinMyHome()">üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                </div></div>

                <!-- 5. Leaders -->
                ${buildLeaders(ALL_DATA.communityLeaders)}
            `;
        }

        // --- Render VHV ---
        function renderVhv() {
            const div = document.getElementById('vhv-content');
            if(!ALL_DATA.isVhv) {
                div.innerHTML = `<div class="card p-5 text-center mt-3"><p>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p></div>`;
                return;
            }

            const v = ALL_DATA.vhvDashboard;
            const sc = v.vhvScore || {total:0, breakdown:{}};
            const pts = v.patientList || [];

            div.innerHTML = `
                <!-- Card 1: Profile -->
                <div class="card p-3 mb-3 shadow-sm" style="background: #FFF8E1; border: 1px solid #FFD700;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="text-gold-dark mb-0">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏≠‡∏™‡∏°. ${ALL_DATA.vhvProfile.name}</h5>
                        <span class="badge bg-warning text-dark">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${ALL_DATA.vhvProfile.area}</span>
                    </div>
                    <hr>
                    ${!v.checklist.hasPinned ? '<div class="alert alert-danger p-1 text-center small mb-2">‡∏ó‡πà‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô!</div>' : ''}
                    <div class="row g-2">
                        <div class="col-6"><button class="btn btn-outline-dark w-100 btn-sm" onclick="pinMyHome()">üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô</button></div>
                        <div class="col-6"><button class="btn btn-primary w-100 btn-sm" onclick="showQR()">üì± QR Code</button></div>
                    </div>
                </div>

                <!-- Card 2: Score -->
                <div class="card p-3 mb-3 text-center">
                    <h5 class="text-gold-dark">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡∏≠‡∏™‡∏°. (30 ‡∏ß‡∏±‡∏ô)</h5>
                    <div class="display-1 fw-bold text-gold-dark" style="color: #B8860B">${sc.total}</div>
                    <div class="row g-2 mt-2 small text-muted">
                        <div class="col-3">QR<br><b>${sc.breakdown.qr}</b></div>
                        <div class="col-3">Sticker<br><b>${sc.breakdown.sticker}</b></div>
                        <div class="col-3">Action<br><b>${sc.breakdown.action}</b></div>
                        <div class="col-3">Report<br><b>${sc.breakdown.reports}</b></div>
                    </div>
                </div>

                <!-- Card 3: Leaderboard -->
                ${buildVhvLeaderboards(v.leaderboards)}

                <!-- Card 4: Action -->
                <div class="card mb-3">
                    <div class="card-header bg-white fw-bold d-flex justify-content-between">
                        <span>‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô / ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span>
                        <a href="https://liff.line.me/2005789397-nebQ8oJy" class="btn btn-sm btn-success">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå</a>
                    </div>
                    <div class="d-grid p-2"><button class="btn btn-outline-primary btn-sm" onclick="showQR()">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏•‡∏ô‡πå (QR)</button></div>
                    
                    <div class="list-group list-group-flush">
                        ${pts.map(p => `
                        <div class="list-group-item vhv-patient-item vhv-risk-${Math.ceil(p.thai_cv_risk_score/10)||1}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${p.name} <span class="badge bg-secondary">${p.thai_cv_risk_score}%</span></div>
                                    <small class="text-muted">‡∏´‡πà‡∏≤‡∏á ${p.distanceFromVhv_km} ‡∏Å‡∏°. | ‡πÄ‡∏ä‡πá‡∏Ñ: ${p.daysSinceLastCheck} ‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-circle btn-success btn-sm" onclick="call('${p.telephone}')"><i class="bi bi-telephone"></i></button>
                                    <button class="btn btn-circle btn-warning btn-sm text-white" onclick="visit('${p.userId}', '${p.name}')"><i class="bi bi-geo-alt"></i></button>
                                </div>
                            </div>
                        </div>`).join('')}
                    </div>
                    ${pts.length===0 ? '<div class="p-3 text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</div>' : ''}
                </div>
            `;
        }

        // --- Helpers ---
        function buildRiskCard(p) {
             const score = parseFloat(p.thai_cv_risk_score||0).toFixed(2);
             let color = '#28a745'; if(score>=10) color='#ffc107'; if(score>=20) color='#fd7e14'; if(score>=30) color='#dc3545';
             const items = [
                {l:'‡πÄ‡∏û‡∏®', v:p.gender==1?'‡∏ä‡∏≤‡∏¢':'‡∏´‡∏ç‡∏¥‡∏á', i:'bi-gender-ambiguous'}, {l:'‡∏≠‡∏≤‡∏¢‡∏∏', v:p.age, i:'bi-calendar'},
                {l:'‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', v:p.smoke==1?'‡∏™‡∏π‡∏ö':'‡πÑ‡∏°‡πà', i:'bi-fire'}, {l:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', v:p.dm==1?'‡πÄ‡∏õ‡πá‡∏ô':'‡πÑ‡∏°‡πà', i:'bi-droplet'},
                {l:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', v:p.sbp+' mmHg', i:'bi-speedometer'}, {l:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', v:p.cholesterol+' mg%', i:'bi-heart'},
                {l:'‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', v:p.waist+' ‡∏ã‡∏°.', i:'bi-arrows-expand'}, {l:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', v:p.height+' ‡∏ã‡∏°.', i:'bi-rulers'}
             ].map(x=>`<div class="info-item"><i class="bi ${x.i}"></i><div><small>${x.l}</small><b>${x.v}</b></div></div>`).join('');
             return `<div class="card mb-3"><div class="card-body"><h5 class="section-title mb-0"><i class="bi bi-activity text-danger"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h5><div class="text-center my-3"><div class="risk-score-display" style="color:${color}">${score}%</div><div class="risk-label" style="color:${color}">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á 10 ‡∏õ‡∏µ</div>${p['u/d']?`<span class="badge bg-danger mt-2">UD: ${p['u/d']}</span>`:''}</div><div class="info-grid">${items}</div><a href="${LINKS.REGIS}" class="btn btn-outline-danger w-100 rounded-pill mt-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</a></div></div>`;
        }

        function buildLeaders(l) {
            if(!l) return '';
            return `<div class="card mb-3"><div class="card-body"><h5 class="section-title"><i class="bi bi-people-fill"></i> ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h5><ul class="list-group list-group-flush">
                ${l.pcu ? `<li class="list-group-item d-flex justify-content-between"><span>üè• ${l.pcu}</span> <button class="btn btn-circle btn-outline-primary btn-sm" onclick="call('${l.pcu_tel}')"><i class="bi bi-telephone"></i></button></li>`:''}
                ${l.headman ? `<li class="list-group-item d-flex justify-content-between"><span>üëÆ ${l.headman}</span> <button class="btn btn-circle btn-outline-dark btn-sm" onclick="call('${l.headman_tel}')"><i class="bi bi-telephone"></i></button></li>`:''}
                <li class="list-group-item bg-light text-center small">‡∏°‡∏µ ‡∏≠‡∏™‡∏°. ${l.vhvCount} ‡∏Ñ‡∏ô</li>
            </ul></div></div>`;
        }
        
        function buildVhvLeaderboards(lb) {
            const row = (t, l) => {
                const top = l && l.length > 0 ? l[0] : {name:'-', score:0};
                return `<div class="col-6"><div class="card bg-white p-2 text-center h-100 border shadow-sm"><small class="text-muted d-block">${t}</small><div class="fw-bold text-primary text-truncate">${top.name}</div><div class="badge bg-success">${top.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div></div></div>`;
            };
            return `<div class="row g-2 mb-3">${row('‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô', lb.visits)}${row('‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏™', lb.reports)}${row('‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏•‡∏ô‡πå', lb.exams)}${row('‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î', lb.pins)}</div>`;
        }

        // --- Logic ---
        function openEditEmg(h, d) {
            document.getElementById('inpHelp').value = h || '‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
            document.getElementById('inpDec').value = d || '‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£';
            MODALS['editEmgModal'].show();
        }
        function saveEmg() {
            const h = document.getElementById('inpHelp').value;
            const d = document.getElementById('inpDec').value;
            toggleOverlay(true);
            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'updateEmergencyInfo', data: { userId: LIFF_PROFILE.userId, help: h, decision: d }}) })
            .then(() => location.reload());
        }

        function call(tel) {
            CALL_TARGET = tel;
            MODALS['callModal'].show();
        }
        function execCall() {
             navigator.geolocation.getCurrentPosition(pos => {
                 fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'logTelCall', data: { userId: LIFF_PROFILE.userId, tel: CALL_TARGET, latlong: `${pos.coords.latitude},${pos.coords.longitude}` }}) });
                 window.location.href = `tel:${CALL_TARGET}`;
             }, () => window.location.href = `tel:${CALL_TARGET}`);
        }
        
        function pinMyHome() {
             toggleOverlay(true);
             navigator.geolocation.getCurrentPosition(p => {
                 fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveNewLocation', data: { userId: LIFF_PROFILE.userId, type: '‡∏ö‡πâ‡∏≤‡∏ô', latlong: `${p.coords.latitude},${p.coords.longitude}`, distance: 0, duration: 0 } }) })
                 .then(() => location.reload());
             }, e => { alert("GPS Error"); toggleOverlay(false); });
        }
        
        function showQR() {
             const url = `https://liff.line.me/2005789397-nebQ8oJy?ref=${LIFF_PROFILE.userId}`;
             const api = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;
             document.getElementById('qrImg').src = api;
             document.getElementById('refCodeDisplay').innerText = LIFF_PROFILE.userId;
             
             // Log Share
             fetch(`${WEB_APP_URL}?action=logQrShare&userId=${LIFF_PROFILE.userId}`);
             MODALS['qrModal'].show();
        }
        
        function visit(uid, name) {
             document.getElementById('visitUid').value = uid;
             document.getElementById('visitName').value = name;
             document.getElementById('visitTitle').innerText = "‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: " + name;
             MODALS['visitModal'].show();
        }
        
        function saveVisit() {
             const d = { 
                 vhvId: LIFF_PROFILE.userId, 
                 patientName: document.getElementById('visitName').value, 
                 activityType: 'Advice', 
                 note: document.getElementById('hvNoteAdvice').value 
             };
             toggleOverlay(true);
             fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveHomeVisit', data: d }) })
             .then(() => { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß"); location.reload(); });
        }

        function toggleOverlay(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
    </script>
</body>
</html>