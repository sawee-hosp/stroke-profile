<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</title>
    
    <!-- Fonts: ‡πÉ‡∏ä‡πâ Noto Sans Thai ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å font ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* =========================================
           1. CORE VARIABLES & THEME (ELDERLY FRIENDLY)
           ========================================= */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            
            /* Health Theme (Red) - ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠ Contrast */
            --theme-red: #d32f2f; 
            --theme-red-light: #ffebee;
            --theme-red-dark: #b71c1c;

            /* VHV Theme (Gold) */
            --gold-dark: #8B4513;   
            --gold-main: #D4AF37;   
            --gold-bright: #FFD700; 
            --gold-bg: #FFF8E1;     
            --gold-card: #FFFCF2;   
            
            /* Base Size ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥) */
            --base-size: 20px; 
            --border-radius-lg: 20px;
        }

        html { 
            font-size: var(--base-size); 
        }

        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 1rem; 
            line-height: 1.6;
            background: linear-gradient(180deg, var(--theme-red) 0%, #ffffff 450px);
            background-attachment: fixed;
            margin: 0; 
            padding-bottom: 8rem; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏á */
            transition: background 0.5s ease;
            -webkit-tap-highlight-color: transparent;
            color: #212529; /* ‡∏™‡∏µ‡∏î‡∏≥‡πÄ‡∏Ç‡πâ‡∏° ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
        }
        
        /* --- VHV Mode Background --- */
        body.vhv-mode {
            background: linear-gradient(180deg, var(--gold-main) 0%, #ffffff 400px);
        }

        h1, h2, h3, h4, h5, h6 { 
            font-weight: 700 !important; 
            letter-spacing: 0.5px;
            margin-bottom: 0.8rem;
        }
        
        .text-gold-dark { color: var(--gold-dark) !important; }
        .bg-gold-light { background-color: var(--gold-bg) !important; }

        /* =========================================
           2. NAVIGATION & TABS (Big Touch Targets)
           ========================================= */
        .app-header-spacer { height: 85px; }

        .nav-tabs-container {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background-color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            padding: 0;
        }

        .nav-tabs { border-bottom: none; width: 100%; display: flex; margin: 0; }
        .nav-item { flex: 1; text-align: center; }

        .nav-link { 
            font-size: 1.25rem; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏ç‡πà */
            color: #888; 
            border: none; border-radius: 0; 
            margin: 0; padding: 20px 0; 
            font-weight: 700; background: #fff; width: 100%;
            transition: all 0.3s ease;
        }

        /* Active Tab Styling */
        .nav-link.active { 
            color: var(--theme-red); 
            background: var(--theme-red-light); 
            border-bottom: 6px solid var(--theme-red);
        }

        body.vhv-mode .nav-link#vhv-tab-btn.active { 
            color: var(--gold-dark); 
            background: var(--gold-bg); 
            border-bottom: 6px solid var(--gold-bright);
        }
        
        .nav-item:first-child .nav-link { border-right: 1px solid #eee; }

        /* =========================================
           3. CARDS & UI ELEMENTS (Spacious)
           ========================================= */
        .card { 
            border: none; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
            margin-bottom: 1.5rem; 
            border-radius: var(--border-radius-lg); 
            overflow: hidden; 
            background-color: #fff; 
        }

        body.vhv-mode .card { 
            border: 1px solid rgba(212, 175, 55, 0.3); 
        }
        
        .section-title { 
            font-size: 1.4rem; 
            font-weight: 800; 
            margin-bottom: 1.2rem; 
            color: #333; 
            display: flex; align-items: center; gap: 12px;
        }
        .section-title i { font-size: 1.8rem; color: var(--theme-red); }
        body.vhv-mode .section-title i { color: var(--gold-dark); }
        
        /* Buttons - ‡πÉ‡∏´‡∏ç‡πà ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢ */
        .btn {
            font-size: 1.1rem;
            padding: 12px 20px;
            border-radius: 50px;
            font-weight: 600;
        }
        
        .btn-main { 
            background-color: var(--theme-red); color: white; 
            border: none; box-shadow: 0 4px 10px rgba(255, 54, 84, 0.4); 
            font-weight: 700;
            font-size: 1.2rem;
        }
        .btn-main:hover { background-color: #d62540; color: white; }

        .btn-circle { 
            width: 55px; height: 55px; /* ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; 
            font-size: 1.6rem;
            padding: 0; flex-shrink: 0; 
        }
        
        /* Form Inputs - ‡πÉ‡∏´‡∏ç‡πà */
        .form-control, .form-select {
            padding: 12px 15px;
            font-size: 1.1rem;
            border-radius: 15px;
            border: 1px solid #ccc;
        }
        .form-check-input {
            width: 1.5em; height: 1.5em;
            margin-top: 0.2em;
            margin-right: 0.5em;
        }

        /* Profile */
        .profile-img-lg { 
            width: 100px; height: 100px; 
            border-radius: 50%; object-fit: cover; 
            border: 4px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        
        /* Game Score Card */
        .game-score-card { background: linear-gradient(135deg, #ffebee, #ffffff); border: 2px solid #fff; }
        .game-score-box { 
            background: #fff; border-radius: 15px; padding: 15px 5px; text-align: center; 
            border: 2px solid #f0f0f0; height: 100%; cursor: pointer; transition: transform 0.2s; 
        }
        .game-score-box:active { transform: scale(0.95); background: #fafafa; }
        .game-score-box h3 { color: var(--theme-red); margin-bottom: 5px; font-size: 1.8rem; font-weight: 800; }
        .game-score-box small { font-size: 1rem; color: #555; font-weight: 600; }
        
        /* Risk Display */
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .info-item { 
            background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; 
            padding: 12px; display: flex; align-items: center; gap: 12px; 
        }
        .info-item i { font-size: 1.8rem; color: var(--theme-red); }
        .info-item div { line-height: 1.3; }
        .info-item small { font-size: 0.9rem; color: #666; display: block; }
        .info-item b { font-size: 1.1rem; color: #000; }

        /* VHV Patient List */
        .vhv-patient-item { 
            border-left: 10px solid #ccc; margin-bottom: 15px; border-radius: 15px; 
            background-color: #fff; padding: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.06); 
        }
        .vhv-risk-5 { border-left-color: #8B0000; background-color: #fff0f0; } 
        .vhv-risk-4 { border-left-color: #dc3545; } 
        .vhv-risk-3 { border-left-color: #fd7e14; } 
        .vhv-risk-2 { border-left-color: #ffc107; } 
        .vhv-risk-1 { border-left-color: #28a745; } 

        /* Loading Overlay */
        #loading-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; justify-content: center; 
            align-items: center; color: white; z-index: 2000; flex-direction: column; backdrop-filter: blur(5px);
        }

        .app-footer { text-align: center; color: #888; font-size: 0.9rem; margin-top: 40px; margin-bottom: 20px; }

        /* SKELETON LOADING ANIMATION */
        .skeleton {
            background: #eee;
            background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%);
            border-radius: 10px;
            background-size: 200% 100%;
            animation: 1.5s shine linear infinite;
        }
        @keyframes shine { to { background-position-x: -200%; } }
        .sk-text { height: 1.2rem; margin-bottom: 8px; width: 100%; }
        .sk-circle { width: 100px; height: 100px; border-radius: 50%; }
    </style>
</head>
<body>

    <!-- Loading Overlay (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å) -->
    <div id="loading-overlay">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3 fs-3 fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs-container">
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="health-tab-btn">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vhv-tab-btn">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°.</button>
            </li>
        </ul>
    </div>
    
    <div class="app-header-spacer"></div>

    <!-- MAIN CONTAINER -->
    <div class="container" style="padding: 0 15px;">
        
        <!-- === TAB 1: HEALTH === -->
        <div id="health-view">
            
            <!-- 1. PROFILE CONTAINER (‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô) -->
            <div id="profile-container" class="mb-4">
                <!-- Skeleton Structure -->
                <div class="card p-4 d-flex flex-row align-items-center shadow-sm">
                    <div class="skeleton sk-circle me-4"></div>
                    <div class="flex-grow-1">
                        <div class="skeleton sk-text w-50"></div>
                        <div class="skeleton sk-text w-75"></div>
                    </div>
                </div>
            </div>

            <!-- 2. GAME SCORE CONTAINER (‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á) -->
            <div id="score-container" class="mb-4">
                 <div class="card p-5 text-center">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                    <div class="mt-3 text-muted fs-5">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û...</div>
                 </div>
            </div>

            <!-- 3. EMERGENCY CONTAINER (‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö Basic Info) -->
            <div id="emergency-container" class="mb-4"></div>

            <!-- 4. LEADERS CONTAINER (‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö Basic Info) -->
            <div id="leaders-container" class="mb-4"></div>

        </div>

        <!-- === TAB 2: VHV === -->
        <div id="vhv-view" style="display: none;">
            
            <!-- VHV Info Header -->
            <div id="vhv-info-container"></div>
            
            <!-- Heavy Data Container (Patient List) -->
            <div id="vhv-data-container">
                <div class="text-center py-5">
                    <div class="spinner-border text-warning" style="width: 3rem; height: 3rem;"></div>
                    <div class="mt-3 text-muted fs-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô...</div>
                    <div class="text-muted small">(‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏¢‡∏≠‡∏∞)</div>
                </div>
            </div>

        </div>

    </div>

    <div class="app-footer">
        ¬© 2025 ‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å ‡∏£‡∏û.‡∏™‡∏ß‡∏µ ‡∏à.‡∏ä‡∏∏‡∏°‡∏û‡∏£<br>
        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ‡∏´‡∏•‡∏≠‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏°‡∏≠‡∏á
    </div>

    <!-- ================= MODALS ================= -->

    <!-- 1. Call Permission Modal -->
    <div class="modal fade" id="callModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header border-0 pb-0">
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center pt-0 p-4">
                    <div class="mb-3">
                        <i class="bi bi-telephone-outbound-fill text-primary" style="font-size: 4rem;"></i>
                    </div>
                    <h3 class="fw-bold mb-3">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£</h3>
                    <p class="text-muted fs-5">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
                    <div class="d-grid gap-3 mt-4">
                        <button class="btn btn-primary btn-lg rounded-pill py-3" onclick="execCall()">
                            <i class="bi bi-telephone-fill me-2"></i> ‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ & ‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î
                        </button>
                        <button class="btn btn-light btn-lg rounded-pill py-3 text-muted" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Edit Emergency Info Modal -->
    <div class="modal fade" id="editEmgModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4">
                <div class="modal-header">
                    <h4 class="modal-title fw-bold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h4>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-4">
                        <label class="form-label text-muted fs-5">‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                        <select class="form-select form-select-lg" id="inpHelp">
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß">‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏/‡πÄ‡∏î‡πá‡∏Å‡πÄ‡∏•‡πá‡∏Å</option>
                            <option value="‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ç‡∏≤‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà/‡∏Ñ‡∏ô‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label text-muted fs-5">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <select class="form-select form-select-lg" id="inpDec">
                            <option value="‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</option>
                            <option value="‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π">‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ç‡∏≤‡∏ï‡∏¥‡∏°‡∏≤‡∏î‡∏π</option>
                            <option value="‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢">‡πÑ‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å-‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢</option>
                            <option value="‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á">‡∏£‡∏µ‡∏ö‡πÑ‡∏õ ‡∏£‡∏û.‡πÄ‡∏≠‡∏á</option>
                            <option value="‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö">‡πÇ‡∏ó‡∏£ 1669 ‡πÉ‡∏´‡πâ‡∏£‡∏ñ‡∏°‡∏≤‡∏£‡∏±‡∏ö</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-lg w-100 rounded-pill" onclick="saveEmg()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3. VHV Visit Modal -->
    <div class="modal fade" id="visitModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 rounded-4">
                <div class="modal-header bg-success text-white p-3">
                    <h4 class="modal-title"><i class="bi bi-house-heart-fill"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h4>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <input type="hidden" id="visitUid">
                    <input type="hidden" id="visitName">
                    <h4 id="visitTitle" class="mb-4 fw-bold text-center"></h4>
                    
                    <div class="d-grid mb-4">
                        <button class="btn btn-warning btn-lg text-dark fw-bold py-3 border border-dark" onclick="pinForUser()">
                            <i class="bi bi-geo-alt-fill fs-4"></i> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
                        </button>
                        <div class="form-text text-center fs-6 mt-1">‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold fs-5">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</label>
                        <div class="card p-3 bg-light border-0">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="chk1" checked>
                                <label class="form-check-label fs-5" for="chk1">‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ 5 ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="chk2" checked>
                                <label class="form-check-label fs-5" for="chk2">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß/‡∏≠‡∏≤‡∏´‡∏≤‡∏£/‡∏¢‡∏≤</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="chk3">
                                <label class="form-check-label fs-5" for="chk3">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ADL / ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold fs-5">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                        <textarea class="form-control" id="visitNote" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥, ‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏î‡∏π‡∏™‡∏î‡πÉ‡∏™..."></textarea>
                    </div>
                    
                    <button class="btn btn-success btn-lg w-100 rounded-pill py-3 fw-bold" onclick="saveVisit()">
                        <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white text-center justify-content-center">
                <div class="modal-header border-0 position-absolute top-0 end-0">
                    <button class="btn-close btn-close-white m-3 p-3" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                    <h1 class="mb-4 text-warning fw-bold">‡∏™‡∏ß‡∏µ‡∏£‡∏π‡πâ‡∏ó‡∏±‡∏ô‡∏™‡πÇ‡∏ï‡∏£‡∏Å</h1>
                    <div class="bg-white p-4 d-inline-block rounded-4 mb-4 shadow-lg">
                        <img id="qrImg" src="" style="width:280px;height:280px;object-fit:contain;">
                    </div>
                    <p class="fs-3">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
                    <div class="mt-3 px-4 py-2 bg-secondary bg-opacity-25 rounded-pill">
                        <small>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: <span id="refCodeDisplay" class="font-monospace text-warning fs-5"></span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // *** CONFIGURATION ***
        // ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID = '2005789397-RLAGXrBJ';
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };

        let LIFF_PROFILE = {};
        let BASIC_DATA = {};
        let CALL_TARGET = '';
        const MODALS = {};

        // --- Init ---
        window.onload = async () => {
            // Init Bootstrap Modals
            ['callModal', 'editEmgModal', 'visitModal', 'qrModal'].forEach(id => {
                MODALS[id] = new bootstrap.Modal(document.getElementById(id));
            });

            // Tabs Events
            document.getElementById('health-tab-btn').onclick = () => switchTab('health');
            document.getElementById('vhv-tab-btn').onclick = () => switchTab('vhv');

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { 
                    liff.login(); 
                    return; 
                }
                LIFF_PROFILE = await liff.getProfile();
                
                // =========================================================
                // LOGIC LAZY LOADING: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô 3 ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å)
                // =========================================================

                // --- STEP 1: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Basic Info) ---
                console.log("Step 1: Fetching Basic Info...");
                const ref = new URLSearchParams(location.search).get('ref') || '';
                const basicUrl = `${WEB_APP_URL}?action=getBasicInfo&userId=${LIFF_PROFILE.userId}&pictureUrl=${encodeURIComponent(LIFF_PROFILE.pictureUrl)}&ref=${ref}`;
                
                // ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                BASIC_DATA = await fetch(basicUrl).then(r => r.json());
                
                if(BASIC_DATA.error) throw new Error(BASIC_DATA.error);

                renderBasicInfo(BASIC_DATA); // ‡πÅ‡∏™‡∏î‡∏á Profile, Emergency, Leaders

                // --- STEP 2: ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Gamification) ---
                console.log("Step 2: Fetching Gamification...");
                loadGamification(); // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á await ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ render ‡πÄ‡∏≠‡∏á

                // --- STEP 3: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏™‡∏°. (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡∏≠‡∏™‡∏°.) ---
                if (BASIC_DATA.isVhv) {
                    console.log("Step 3: Fetching VHV Data...");
                    loadVhvData();
                } else {
                    document.getElementById('vhv-data-container').innerHTML = `
                        <div class="card p-5 text-center mt-3 mx-3 bg-gold-light border-warning">
                            <i class="bi bi-award text-warning" style="font-size:3rem"></i>
                            <h4 class="mt-3 text-gold-dark">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏™‡∏°. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h4>
                            <p class="text-muted fs-5">‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞ ‡∏≠‡∏™‡∏°. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÅ‡∏•‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô</p>
                        </div>`;
                }
                
            } catch(e) { 
                console.error(e);
                document.getElementById('profile-container').innerHTML = `
                    <div class="alert alert-danger m-3 text-center fs-5">
                        <i class="bi bi-exclamation-triangle-fill fs-1"></i><br>
                        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${e.message}<br>
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï
                    </div>`;
            }
        };

        function switchTab(mode) {
            const isVhv = mode === 'vhv';
            document.body.className = isVhv ? 'vhv-mode' : '';
            
            document.getElementById('health-tab-btn').className = `nav-link ${!isVhv?'active':''}`;
            document.getElementById('vhv-tab-btn').className = `nav-link ${isVhv?'active':''}`;
            
            document.getElementById('health-view').style.display = !isVhv ? 'block' : 'none';
            document.getElementById('vhv-view').style.display = isVhv ? 'block' : 'none';
            
            window.scrollTo(0, 0);
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // --- RENDER FUNCTIONS (STEP 1: Basic Info) ---
        function renderBasicInfo(data) {
            const p = data.userProfile;
            const dist = data.homeDistance;
            
            // 1. Profile
            let profileHTML = '';
            if(!p) {
                 profileHTML = `
                    <div class="card p-5 text-center">
                        <i class="bi bi-person-exclamation text-secondary" style="font-size:4rem"></i>
                        <h3 class="mt-3">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
                        <p class="text-muted fs-5">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                        <a href="${LINKS.REGIS}" class="btn btn-main btn-lg w-100 rounded-pill mt-3">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
                    </div>`;
            } else {
                profileHTML = `
                <div class="card p-4 d-flex flex-row align-items-center shadow-sm">
                    <img src="${p.pictureUrl}" class="profile-img-lg me-4">
                    <div class="flex-grow-1">
                        <h3 class="fw-bold mb-1">${p.name}</h3>
                        <div class="text-muted fs-5 mb-2"><i class="bi bi-telephone"></i> ${p.telephone}</div>
                        <span id="rank-badge-placeholder" class="badge bg-light text-dark border fs-6">
                            <span class="spinner-border spinner-border-sm"></span> ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...
                        </span>
                    </div>
                </div>`;
            }
            document.getElementById('profile-container').innerHTML = profileHTML;

            // 2. Emergency & Leaders (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ Profile)
            if (p) {
                document.getElementById('emergency-container').innerHTML = buildEmergencyCard(dist, p.district);
                document.getElementById('leaders-container').innerHTML = buildLeaders(data.communityLeaders);
            }

            // 3. VHV Info Header (‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏≠‡∏™‡∏°. ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
            if (data.isVhv) {
                document.getElementById('vhv-info-container').innerHTML = `
                <div class="card p-4 mb-3 shadow-sm" style="background: #FFF8E1; border: 1px solid #FFD700;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="text-gold-dark mb-0 fw-bold">‡∏≠‡∏™‡∏°. ${data.vhvProfile.name}</h4>
                            <span class="badge bg-warning text-dark border border-dark fs-6 mt-1">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${data.vhvProfile.area}</span>
                        </div>
                        <button class="btn btn-outline-dark btn-circle bg-white shadow-sm" onclick="showQR()">
                            <i class="bi bi-qr-code"></i>
                        </button>
                    </div>
                    <hr style="border-color:#D4AF37; opacity:0.3">
                    <button class="btn btn-outline-dark btn-lg w-100" onclick="pinMyHome()">
                        <i class="bi bi-geo-alt"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
                    </button>
                </div>`;
            }
        }

        // --- RENDER FUNCTIONS (STEP 2: Gamification) ---
        async function loadGamification() {
            try {
                const url = `${WEB_APP_URL}?action=getGamification&userId=${LIFF_PROFILE.userId}`;
                const res = await fetch(url).then(r => r.json());
                const g = res.gamification;
                
                // Update Badge Profile
                const badge = document.getElementById('rank-badge-placeholder');
                if(badge) badge.innerHTML = `‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ${g.rank} ‡∏à‡∏≤‡∏Å ${g.totalUsers} ‡∏Ñ‡∏ô`;

                // Render Score Card
                document.getElementById('score-container').innerHTML = `
                <div class="card game-score-card mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h4 class="m-0 text-primary fw-bold"><i class="bi bi-trophy-fill"></i> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h4>
                            <span class="badge rounded-pill bg-${g.levelColor} fs-6 px-3 py-2 border">${g.levelName}</span>
                        </div>
                        
                        <div class="text-center my-4">
                            <div class="display-1 fw-bold text-primary" style="line-height:1; letter-spacing:-2px;">${g.totalScore}</div>
                            <small class="text-muted fs-5">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏°</small>
                        </div>
                        
                        <div class="progress mb-2 bg-white border" style="height:15px; border-radius:10px;">
                            <div class="progress-bar bg-${g.levelColor}" style="width:${Math.min(100,(g.totalScore/g.nextLevelScore)*100)}%"></div>
                        </div>
                        <div class="text-end small text-secondary mb-4 fs-6">‡∏≠‡∏µ‡∏Å ${(g.nextLevelScore-g.totalScore).toFixed(1)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡∏±‡πâ‡∏ô</div>
                        
                        <div class="row g-2 text-center">
                            <div class="col-3" onclick="window.open('${LINKS.DAILY}')">
                                <div class="game-score-box"><h3>${g.checkScore}</h3><small>‡πÉ‡∏™‡πà‡πÉ‡∏à</small></div>
                            </div>
                            <div class="col-3">
                                <div class="game-score-box"><h3>${g.emergencyScore}</h3><small>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°</small></div>
                            </div>
                            <div class="col-3" onclick="window.open('${LINKS.STICKER}')">
                                <div class="game-score-box"><h3>${g.stickerScore}</h3><small>‡∏ö‡∏≠‡∏Å‡∏ï‡πà‡∏≠</small></div>
                            </div>
                            <div class="col-3" onclick="window.open('${LINKS.KNOWLEDGE}')">
                                <div class="game-score-box"><h3>${g.knowledgeScore}</h3><small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ</small></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡πÅ‡∏ó‡∏£‡∏Å Risk Card ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÉ‡∏ô Basic ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÄ‡∏≠‡∏≤‡∏ä‡∏±‡∏ß‡∏£‡πå -->
                ${buildRiskCard(BASIC_DATA.userProfile)}
                `;
                
                // Update Emergency Details (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Help/Decision ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏≤‡∏Å DB)
                const emg = g.details || {};
                const emgBox = document.getElementById('emg-details-box');
                if(emgBox) {
                    emgBox.innerHTML = `
                        <div class="fs-5 mb-2"><span class="text-secondary">‡∏Ñ‡∏ô‡∏î‡∏π‡πÅ‡∏•:</span> <b class="text-dark">${emg.help || '-'}</b></div>
                        <div class="fs-5 mb-3"><span class="text-secondary">‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à:</span> <b class="text-dark">${emg.decision || '-'}</b></div>
                        <button class="btn btn-outline-secondary w-100 rounded-pill py-2" onclick="openEditEmg('${emg.help}','${emg.decision}')">
                            <i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    `;
                }

            } catch(e) { 
                console.error("Game load error", e);
                document.getElementById('score-container').innerHTML = `<div class="alert alert-warning">‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
            }
        }

        // --- RENDER FUNCTIONS (STEP 3: VHV Data) ---
        async function loadVhvData() {
            try {
                const url = `${WEB_APP_URL}?action=getVhvData&userId=${LIFF_PROFILE.userId}`;
                const res = await fetch(url).then(r => r.json());
                
                const sc = res.vhvScore;
                const pts = res.patientList;
                
                let html = `
                <!-- Card 2: Score Dashboard -->
                <div class="card p-4 mb-4 text-center">
                    <h4 class="text-gold-dark fw-bold mb-0">‡∏ú‡∏•‡∏á‡∏≤‡∏ô ‡∏≠‡∏™‡∏°.</h4>
                    <div class="display-2 fw-bold my-2" style="color: #B8860B; text-shadow: 1px 1px 0px #fff;">${sc.total}</div>
                    
                    <div class="row g-2 mt-3">
                        <div class="col-3 text-muted border-end">QR<br><b class="text-dark fs-3">${sc.breakdown.qr}</b><br><span style="font-size:0.7rem">30 ‡∏ß‡∏±‡∏ô</span></div>
                        <div class="col-3 text-muted border-end">Sticker<br><b class="text-dark fs-3">${sc.breakdown.sticker}</b><br><span style="font-size:0.7rem">30 ‡∏ß‡∏±‡∏ô</span></div>
                        <div class="col-3 text-muted border-end">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°<br><b class="text-dark fs-3">${sc.breakdown.action}</b><br><span style="font-size:0.7rem">‡∏ï‡∏•‡∏≠‡∏î‡∏ä‡∏µ‡∏û</span></div>
                        <div class="col-3 text-muted">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô<br><b class="text-dark fs-3">${sc.breakdown.reports}</b><br><span style="font-size:0.7rem">30 ‡∏ß‡∏±‡∏ô</span></div>
                    </div>
                </div>

                <!-- Card 3: Leaderboard -->
                <div class="mb-4">
                    <h4 class="text-gold-dark fw-bold px-2 mb-3"><i class="bi bi-bar-chart-fill"></i> ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‡∏≠‡∏™‡∏°. ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h4>
                    ${buildVhvLeaderboards(res.leaderboards)}
                </div>

                <!-- Card 4: Patient List -->
                <div class="card mb-4">
                    <div class="card-header fw-bold d-flex justify-content-between align-items-center bg-gold-light p-3">
                        <span class="fs-4"><i class="bi bi-people-fill"></i> ‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô (${pts.length})</span>
                        <a href="${LINKS.REGIS}" class="btn btn-sm btn-success rounded-pill px-3 py-2 fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡∏ô‡πå</a>
                    </div>
                    
                    <div class="p-3 bg-light">
                        ${pts.length === 0 ? '<div class="text-center p-5 text-muted fs-5">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</div>' : 
                          pts.map(p => `
                            <div class="vhv-patient-item vhv-risk-${getRiskLevel(p.thai_cv_risk_score)}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="fw-bold fs-4">${p.name}</div>
                                        <div class="mb-2"><span class="badge bg-secondary rounded-pill fs-6">‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ${p.thai_cv_risk_score}%</span></div>
                                        <div class="text-muted fs-6">
                                            <i class="bi bi-geo-alt-fill text-danger"></i> ‡∏´‡πà‡∏≤‡∏á ${p.distanceFromVhv_km} ‡∏Å‡∏°.
                                        </div>
                                    </div>
                                    <div class="d-flex flex-column gap-2 ms-3">
                                        <button class="btn btn-circle btn-success shadow-sm" onclick="call('${p.telephone}')">
                                            <i class="bi bi-telephone-fill"></i>
                                        </button>
                                        <button class="btn btn-circle btn-warning shadow-sm text-dark" onclick="visit('${p.userId}', '${p.name}')">
                                            <i class="bi bi-geo-alt-fill"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                `;
                
                document.getElementById('vhv-data-container').innerHTML = html;

            } catch(e) { 
                document.getElementById('vhv-data-container').innerHTML = `
                    <div class="alert alert-danger fs-5 text-center">
                        ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>
                        <button class="btn btn-outline-danger mt-2" onclick="loadVhvData()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                    </div>`;
            }
        }

        // --- HELPER BUILDERS ---

        function buildRiskCard(p) {
             if(!p) return '';
             const score = parseFloat(p.thai_cv_risk_score||0).toFixed(0);
             let color = '#28a745'; 
             let label = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥';
             if(score>=10) { color='#ffc107'; label='‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'; }
             if(score>=20) { color='#fd7e14'; label='‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á'; }
             if(score>=30) { color='#dc3545'; label='‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢'; }
             
             const items = [
                {l:'‡πÄ‡∏û‡∏®', v:p.gender==1?'‡∏ä‡∏≤‡∏¢':'‡∏´‡∏ç‡∏¥‡∏á', i:'bi-gender-ambiguous'}, {l:'‡∏≠‡∏≤‡∏¢‡∏∏', v:p.age, i:'bi-calendar'},
                {l:'‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà', v:p.smoke==1?'‡∏™‡∏π‡∏ö':'‡πÑ‡∏°‡πà', i:'bi-fire'}, {l:'‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô', v:p.dm==1?'‡πÄ‡∏õ‡πá‡∏ô':'‡πÑ‡∏°‡πà', i:'bi-droplet'},
                {l:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô', v:p.sbp||'-', i:'bi-speedometer'}, {l:'‡πÑ‡∏Ç‡∏°‡∏±‡∏ô', v:p.cholesterol||'-', i:'bi-heart'},
                {l:'‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß', v:p.waist||'-', i:'bi-arrows-expand'}, {l:'‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á', v:p.height||'-', i:'bi-rulers'}
             ].map(x=>`
                <div class="info-item">
                    <i class="bi ${x.i}"></i>
                    <div>
                        <small>${x.l}</small>
                        <b class="text-dark">${x.v}</b>
                    </div>
                </div>`).join('');
                
             return `
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="section-title mb-0"><i class="bi bi-activity fs-2"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (10 ‡∏õ‡∏µ)</h4>
                        <div class="text-center my-4 position-relative">
                            <div style="font-size:5rem; font-weight:900; color:${color}; line-height:1; letter-spacing:-3px;">${score}%</div>
                            <div class="fs-2 mt-2" style="color:${color}; font-weight:bold;">${label}</div>
                            ${p['u/d'] ? `<span class="badge bg-danger mt-2 fs-6 p-2">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${p['u/d']}</span>` : ''}
                        </div>
                        <div class="info-grid">${items}</div>
                        <a href="${LINKS.REGIS}" class="btn btn-outline-danger w-100 rounded-pill mt-4 btn-lg">
                            <i class="bi bi-arrow-repeat"></i> ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                        </a>
                    </div>
                </div>`;
        }

        function buildEmergencyCard(dist, district) {
            return `
            <div class="card mb-4 border-danger shadow-sm">
                <div class="card-body p-4">
                    <h4 class="text-danger fw-bold section-title"><i class="bi bi-ambulance fs-2"></i> ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡∏£‡∏û.‡∏™‡∏ß‡∏µ)</h4>
                    
                    <div class="d-flex align-items-center justify-content-center my-4 text-danger">
                        <i class="bi bi-house-door-fill" style="font-size:3.5rem"></i> 
                        <div class="text-center mx-4">
                            <i class="bi bi-arrow-right" style="font-size:3rem"></i><br>
                            <span class="fw-bold fs-3">${dist ? dist.distance_km : '?'} ‡∏Å‡∏°.</span>
                        </div> 
                        <i class="bi bi-hospital-fill" style="font-size:3.5rem"></i>
                    </div>
                    
                    ${(dist && dist.distance_km > 40) ? '<div class="alert alert-warning text-center fs-5 rounded-4"><i class="bi bi-exclamation-triangle"></i> ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 40 ‡∏Å‡∏°. ‡∏Ñ‡∏ß‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á ‡∏£‡∏û. ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</div>' : ''}
                    
                    <div id="emg-details-box" class="bg-light p-4 rounded-4 mb-3 border">
                        <div class="text-center py-3"><div class="spinner-border text-secondary"></div><br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                    
                    <button class="btn btn-outline-danger w-100 rounded-pill btn-lg" onclick="pinMyHome()">
                        <i class="bi bi-geo-alt-fill"></i> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>`;
        }

        function buildLeaders(l) {
            if(!l) return '';
            return `
                <div class="card mb-4">
                    <div class="card-body p-4">
                        <h4 class="section-title"><i class="bi bi-people-fill fs-2"></i> ‡∏ú‡∏π‡πâ‡∏ô‡∏≥‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h4>
                        <ul class="list-group list-group-flush mt-2">
                            ${l.pcu ? `<li class="list-group-item d-flex justify-content-between align-items-center py-3 px-0 border-bottom">
                                <span class="fs-5"><i class="bi bi-hospital text-primary me-2"></i> ${l.pcu}</span> 
                                <button class="btn btn-circle btn-outline-primary" onclick="call('${l.pcu_tel}')"><i class="bi bi-telephone-fill"></i></button>
                            </li>`:''}
                            ${l.headman ? `<li class="list-group-item d-flex justify-content-between align-items-center py-3 px-0">
                                <span class="fs-5"><i class="bi bi-person-badge text-dark me-2"></i> ${l.headman}</span> 
                                <button class="btn btn-circle btn-outline-dark" onclick="call('${l.headman_tel}')"><i class="bi bi-telephone-fill"></i></button>
                            </li>`:''}
                            <li class="list-group-item bg-light text-center small rounded-pill mt-3 py-2 text-muted fs-6">‡∏°‡∏µ ‡∏≠‡∏™‡∏°. ‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ${l.vhvCount || 0} ‡∏Ñ‡∏ô</li>
                        </ul>
                    </div>
                </div>`;
        }
        
        function buildVhvLeaderboards(lb) {
            if(!lb || lb.length === 0) return '<div class="text-center text-muted fs-5 py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            let html = '<div class="d-flex gap-3 overflow-auto pb-3" style="white-space:nowrap;">';
            lb.forEach((u, idx) => {
                let badge = idx < 3 ? ['ü•á','ü•à','ü•â'][idx] : `#${idx+1}`;
                let border = idx === 0 ? 'border-warning border-2' : '';
                let bg = idx === 0 ? 'bg-warning bg-opacity-10' : 'bg-white';
                html += `
                    <div class="card d-inline-block text-center p-3 shadow-sm ${border} ${bg}" style="min-width:140px; width:140px; border-radius:15px;">
                        <div class="display-6 mb-2">${badge}</div>
                        <div class="text-truncate fw-bold fs-5 mb-1" style="max-width:120px;">${u.name}</div>
                        <span class="badge bg-success rounded-pill fs-6 px-3">${u.score}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function getRiskLevel(score) {
            if(!score) return 1;
            if(score >= 30) return 5;
            if(score >= 20) return 4;
            if(score >= 10) return 3;
            return 1;
        }

        // --- ACTIONS & MODAL LOGIC ---
        
        function openEditEmg(h, d) {
            document.getElementById('inpHelp').value = h && h !== '-' ? h : '‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏±‡∏ß‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
            document.getElementById('inpDec').value = d && d !== '-' ? d : '‡∏£‡∏≠‡∏î‡∏π‡∏≠‡∏≤‡∏Å‡∏≤‡∏£';
            MODALS['editEmgModal'].show();
        }

        function saveEmg() {
            const h = document.getElementById('inpHelp').value;
            const d = document.getElementById('inpDec').value;
            toggleLoading(true);
            fetch(WEB_APP_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ 
                    action: 'updateEmergencyInfo', 
                    data: { userId: LIFF_PROFILE.userId, help: h, decision: d }
                }) 
            }).then(() => {
                // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏û‡∏±‡∏Å‡πÉ‡∏´‡πâ GAS ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡πâ‡∏ß Reload
                setTimeout(() => location.reload(), 2000);
            });
        }

        function call(tel) {
            if(!tel || tel.length < 3) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå");
            CALL_TARGET = tel.replace(/'/g, '');
            MODALS['callModal'].show();
        }

        function execCall() {
             // 1. ‡∏•‡∏≠‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î
             navigator.geolocation.getCurrentPosition(pos => {
                 const latlong = `${pos.coords.latitude},${pos.coords.longitude}`;
                 // ‡∏™‡πà‡∏á Log ‡πÑ‡∏õ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ
                 fetch(WEB_APP_URL, { 
                     method: 'POST', 
                     mode: 'no-cors', 
                     body: JSON.stringify({ 
                         action: 'logTelCall', 
                         data: { userId: LIFF_PROFILE.userId, tel: CALL_TARGET, latlong: latlong }
                     }) 
                 });
                 // ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å
                 window.location.href = `tel:${CALL_TARGET}`;
             }, (err) => {
                 // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡πá‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢
                 console.warn("GPS Error", err);
                 window.location.href = `tel:${CALL_TARGET}`;
             }, { timeout: 5000 });
        }
        
        function pinMyHome() {
             toggleLoading(true);
             navigator.geolocation.getCurrentPosition(p => {
                 fetch(WEB_APP_URL, { 
                     method: 'POST', 
                     mode: 'no-cors', 
                     body: JSON.stringify({ 
                         action: 'saveNewLocation', 
                         data: { 
                             userId: LIFF_PROFILE.userId, 
                             type: '‡∏ö‡πâ‡∏≤‡∏ô', 
                             latlong: `${p.coords.latitude},${p.coords.longitude}`, 
                             distance: 0, 
                             duration: 0 
                         } 
                     }) 
                 }).then(() => {
                     alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                     location.reload();
                 });
             }, e => { 
                 alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á"); 
                 toggleLoading(false); 
             });
        }
        
        function pinForUser() {
             const uid = document.getElementById('visitUid').value;
             if(!uid) return;
             if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì?")) return;
             
             toggleLoading(true);
             navigator.geolocation.getCurrentPosition(p => {
                 fetch(WEB_APP_URL, { 
                     method: 'POST', 
                     mode: 'no-cors', 
                     body: JSON.stringify({ 
                         action: 'saveNewLocation', 
                         data: { 
                             userId: uid, 
                             type: '‡∏ö‡πâ‡∏≤‡∏ô_‡πÇ‡∏î‡∏¢_‡∏≠‡∏™‡∏°', 
                             recorderId: LIFF_PROFILE.userId,
                             latlong: `${p.coords.latitude},${p.coords.longitude}`, 
                             distance: 0, 
                             duration: 0 
                         } 
                     }) 
                 }).then(() => {
                     alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡πâ‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                     toggleLoading(false);
                 });
             }, e => {
                 alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö GPS");
                 toggleLoading(false);
             });
        }

        function showQR() {
             const url = `https://liff.line.me/2005789397-nebQ8oJy?ref=${LIFF_PROFILE.userId}`;
             const api = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}`;
             document.getElementById('qrImg').src = api;
             document.getElementById('refCodeDisplay').innerText = LIFF_PROFILE.userId.substring(0,8) + "...";
             
             // Log Share ‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
             fetch(`${WEB_APP_URL}?action=logQrShare&userId=${LIFF_PROFILE.userId}`);
             MODALS['qrModal'].show();
        }
        
        function visit(uid, name) {
             document.getElementById('visitUid').value = uid;
             document.getElementById('visitName').value = name;
             document.getElementById('visitTitle').innerHTML = `‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: <span class="text-primary">${name}</span>`;
             document.getElementById('visitNote').value = '';
             MODALS['visitModal'].show();
        }
        
        function saveVisit() {
             const note = document.getElementById('visitNote').value;
             const act = [];
             if(document.getElementById('chk1').checked) act.push('5Signs');
             if(document.getElementById('chk2').checked) act.push('Advice');
             if(document.getElementById('chk3').checked) act.push('ADL');
             
             const d = { 
                 vhvId: LIFF_PROFILE.userId, 
                 patientName: document.getElementById('visitName').value, 
                 activityType: act.join(','), 
                 note: note 
             };
             
             toggleLoading(true);
             fetch(WEB_APP_URL, { 
                 method: 'POST', 
                 mode: 'no-cors', 
                 body: JSON.stringify({ action: 'saveHomeVisit', data: d }) 
             }).then(() => { 
                 MODALS['visitModal'].hide();
                 toggleLoading(false);
                 alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); 
             });
        }
    </script>
</body>
</html>