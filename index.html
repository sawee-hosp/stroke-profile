<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลสุขภาพ รู้ทันสโตรก by รพ.สวี</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        :root { --bs-primary-rgb: 13, 110, 253; --vhv-bg: #ffc107; --vhv-dark: #b88a00; }
        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: 20px;
            background-color: #f0f2f5; 
            margin: 0; 
            padding-bottom: 2rem;
        }
        
        /* Navigation Tabs */
        .nav-tabs .nav-link {
            font-size: 1.1rem;
            font-weight: bold;
            color: #6c757d;
            border-radius: 0;
            padding: 15px 10px;
            background: #e9ecef;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background: #fff;
            border-bottom-color: #fff;
        }
        /* VHV Tab Style */
        .nav-tabs .nav-link.vhv-tab {
            background: #fff3cd;
            color: #856404;
        }
        .nav-tabs .nav-link.vhv-tab.active {
            background: var(--vhv-bg);
            color: #000;
            border-color: #dee2e6 #dee2e6 var(--vhv-bg);
        }

        .tab-content-container { padding-top: 20px; }
        
        /* VHV Theme Background */
        .bg-vhv-theme {
            background-color: var(--vhv-bg);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 1.25rem; }
        .section-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: #333; display: flex; align-items: center; }
        .section-title i { margin-right: 0.7rem; color: #0d6efd; font-size: 1.4rem; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        .btn-call { background-color: transparent; border: 1px solid #198754; color: #198754; padding: 0.4rem 0.7rem; font-size: 1rem; line-height: 1; border-radius: 0.3rem; text-decoration: none; }
        .btn-call:hover { background-color: #198754; color: white; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .info-item { display: flex; align-items: center; font-size: 1rem; }
        .info-item i { font-size: 1.5rem; color: #0d6efd; min-width: 35px; }
        .info-item div { display: flex; flex-direction: column; }
        .info-item .label { font-size: 0.8em; color: #6c757d; }
        .bg-light-brown { background-color: #f0eade; border: 1px solid #d3c0a4; }
        .btn-copy { background: none; border: none; color: #0d6efd; padding: 0 0.5rem; }
        .details { font-size: 0.9em; color: #6c757d; }
        .flex-no-shrink { flex-shrink: 0; }
        
        /* Gamification Styles */
        .game-score-box {
            background: #fff; border-radius: 10px; padding: 10px; text-align: center; border: 1px solid #eee; height: 100%;
        }
        .game-score-box h3 { margin: 0; font-weight: 800; color: #0d6efd; }
        .game-score-box span { font-size: 0.8rem; color: #666; }
        .game-icon { font-size: 2rem; margin-bottom: 5px; }

    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <span id="loading-text">กำลังโหลดข้อมูล...</span>
    </div>

    <!-- Main Navigation Tabs -->
    <ul class="nav nav-tabs nav-justified fixed-top shadow-sm" id="mainTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="health-tab-btn" data-bs-toggle="tab" data-bs-target="#health-tab-content" type="button" role="tab"><i class="bi bi-heart-pulse-fill"></i> ข้อมูลสุขภาพ</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link vhv-tab" id="vhv-tab-btn" data-bs-toggle="tab" data-bs-target="#vhv-tab-content" type="button" role="tab"><i class="bi bi-person-badge-fill"></i> สำหรับ อสม.</button>
        </li>
    </ul>

    <!-- Tab Contents -->
    <div class="tab-content" style="margin-top: 60px;">
        
        <!-- Tab 1: Health Info (Original Content) -->
        <div class="tab-pane fade show active" id="health-tab-content" role="tabpanel">
            <div class="container tab-content-container">
                <div class="row" id="dynamic-content-container">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- Tab 2: VHV Dashboard -->
        <div class="tab-pane fade" id="vhv-tab-content" role="tabpanel">
            <div class="bg-vhv-theme tab-content-container">
                <div class="container">
                    
                    <!-- VHV Header Actions -->
                    <div class="text-center mb-4 pt-3">
                        <button class="btn btn-dark btn-lg w-100 shadow rounded-pill" onclick="showQrModal()">
                            <i class="bi bi-qr-code"></i> แสดง QR Code สวีรู้ทันสโตรก
                        </button>
                    </div>

                    <div class="alert alert-warning border-2 border-dark text-dark fw-bold text-center">
                        <i class="bi bi-exclamation-triangle-fill"></i> สำหรับ อสม. ที่ผ่านการอบรมเรื่องสโตรกแล้วเท่านั้น
                    </div>

                    <!-- VHV Content -->
                    <div class="row" id="vhv-content-container">
                        <!-- VHV Dashboard or Register Button will be injected here -->
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <div class="container" id="unregistered-user" style="display: none;">
        <div class="card text-center p-4 mt-5">
            <div class="card-body">
                <h5 class="card-title">ไม่พบข้อมูลผู้ใช้</h5>
                <p class="card-text">กรุณาลงทะเบียนเพื่อเริ่มใช้งานระบบประเมินความเสี่ยงสโตรก</p>
                <a href="https://liff.line.me/2005789397-nebQ8oJy" class="btn btn-primary btn-lg">ลงทะเบียนครั้งแรก</a>
            </div>
        </div>
    </div>

    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">ปักหมุดตำแหน่งใหม่</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">กรุณากดปุ่มเพื่อระบุตำแหน่งปัจจุบันของคุณ ระบบจะคำนวณระยะทางและเวลาเดินทางไป รพ.สวี โดยอัตโนมัติ</p>
                    <div class="mb-3">
                        <label for="locationType" class="form-label">ประเภทตำแหน่ง</label>
                        <select class="form-select" id="locationType">
                            <option value="บ้าน">บ้าน</option>
                            <option value="ทางผ่าน">ทางผ่าน</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary w-100" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ปักหมุดตำแหน่งปัจจุบัน
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="vhvRegisterModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h1 class="modal-title fs-5" id="vhvRegisterModalLabel">ข้อมูล อสม.สโตรก</h1><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="vhvForm">
              <div class="mb-3">
                  <label for="vhvName" class="form-label">ชื่อ-นามสกุลจริง</label>
                  <input type="text" class="form-control" id="vhvName" required placeholder="ใช้ชื่อจริงเพื่อความน่าเชื่อถือ">
              </div>
              <div class="mb-3"><label for="vhvPhone" class="form-label">เบอร์โทรศัพท์ (10 หลัก)</label><input type="tel" class="form-control" id="vhvPhone" required pattern="[0-9]{10}"></div>
              <div class="mb-3"><label for="vhvLineId" class="form-label">LINE ID (ถ้ามี)</label><input type="text" class="form-control" id="vhvLineId"></div>
              <div class="mb-3">
                  <label for="vhvArea" class="form-label">เลือกพื้นที่ดูแล (เลือกได้หลายพื้นที่)</label>
                  <p class="small text-muted mb-1">* กดค้าง(มือถือ) หรือ Ctrl+คลิก(คอม) เพื่อเลือกหลายรายการ</p>
                  <select class="form-select" id="vhvArea" multiple required size="5">
                      <!-- Options will be populated -->
                  </select>
              </div>

            <div class="mb-3">
                <label class="form-label">ตำแหน่งบ้าน อสม. <span class="text-danger small">(ปักหมุดเมื่ออยู่ที่บ้านแล้วเท่านั้น)</span></label>
                <div class="input-group">
                    <input type="text" class="form-control" id="vhvAsmHome" placeholder="ยังไม่ได้ปักหมุด" readonly>
                    <button class="btn btn-outline-primary" type="button" onclick="pinVhvHomeInForm()"><i class="bi bi-geo-alt-fill"></i> ปักหมุดที่นี่</button>
                </div>
              </div>

              <div class="form-check"><input class="form-check-input" type="checkbox" id="vhvPdpa" checked><label class="form-check-label small" for="vhvPdpa">ข้าพเจ้ายินยอมให้ รพ.สวีเข้าถึงข้อมูล และยินยอมให้ผู้ป่วยในเขตพื้นที่ดูแลสามารถโทรศัพท์สอบถามได้</label></div>
            </form>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button><button type="button" class="btn btn-primary" onclick="handleVhvRegistration()">บันทึกข้อมูล</button></div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="shareProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">เลือกข้อมูลที่จะแชร์</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">เลือกข้อมูลโปรไฟล์ อสม. ที่คุณต้องการส่งให้ผู้อื่น</p>
                    <div class="form-check fs-5">
                        <input class="form-check-input" type="checkbox" value="" id="sharePhone" checked>
                        <label class="form-check-label" for="sharePhone">
                            แชร์เบอร์โทรศัพท์
                        </label>
                    </div>
                    <div class="form-check fs-5 mt-2">
                        <input class="form-check-input" type="checkbox" value="" id="shareLine" checked>
                        <label class="form-check-label" for="shareLine">
                            แชร์ LINE
                        </label>
                    </div>
                    <div class="form-check fs-5 mt-2">
                        <input class="form-check-input" type="checkbox" value="" id="shareLocation">
                        <label class="form-check-label" for="shareLocation">
                            แชร์พิกัดบ้าน
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="handleShareProfile()"><i class="bi bi-share-fill"></i> แชร์เลย</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="mb-4">สวีรู้ทันสโตรก</h2>
                    <!-- ใช้ QR API หรือรูปภาพ QR ที่ถูกต้อง -->
                    <img src="https://qr-official.line.me/sid/L/2005789397.png" alt="QR Code" style="max-width: 90%; width: 300px; border: 10px solid white; border-radius: 10px;">
                    <p class="mt-3">สแกนเพื่อเพิ่มเพื่อน</p>
                    <button class="btn btn-light mt-4 rounded-pill px-5" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        const LIFF_ID_REGIS = "https://liff.line.me/2005789397-nebQ8oJy";
        const LIFF_ID_DAILY = "https://liff.line.me/2005789397-WRm1lYd9";
        const LIFF_ID_STICKER = "https://liff.line.me/2005789397-37lemBgX";
        const LIFF_ID_KNOWLEDGE = "https://liff.line.me/2005789397-ROQvjpYk";

        let LIFF_PROFILE = null;
        let ALL_USER_DATA = null;
        let DISTANCE_MODAL, VHV_REG_MODAL, SHARE_PROFILE_MODAL, QR_MODAL;
        
        document.addEventListener('DOMContentLoaded', initializeLiff);

        async function initializeLiff() {
            DISTANCE_MODAL = new bootstrap.Modal(document.getElementById('distanceModal'));
            VHV_REG_MODAL = new bootstrap.Modal(document.getElementById('vhvRegisterModal'));
            SHARE_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('shareProfileModal'));
            QR_MODAL = new bootstrap.Modal(document.getElementById('qrModal'));

            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                if (!liff.isLoggedIn()) { liff.login(); return; } 
                
                LIFF_PROFILE = await liff.getProfile();
                fetchUserData(LIFF_PROFILE.userId);

            } catch (error) { handleFailure(error); }
        }

        function fetchUserData(userId) {
            showLoading(true, "กำลังโหลดข้อมูล...");
            fetch(`${WEB_APP_URL}?action=getUserData&userId=${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    if (!data.userProfile) {
                        document.getElementById('unregistered-user').style.display = 'block';
                        document.getElementById('mainTabs').style.display = 'none'; // Hide tabs if not registered
                    } else {
                        ALL_USER_DATA = data;
                        updatePage(data);
                    }
                })
                .catch(handleFailure)
                .finally(() => showLoading(false));
        }
        
        function updatePage(data) {
            // Tab 1: Health Content
            const healthContainer = document.getElementById('dynamic-content-container');
            healthContainer.innerHTML = 
                buildProfileCard(data.userProfile) +
                buildGamificationCard(data.gamification) + // New
                buildDailyCheckCard(data.dailyCheckInfo) +
                buildCommunityLeadersCard(data.communityLeaders) +
                buildDistanceCard(data.homeDistance, data.userProfile.help) +
                buildStickerCard(data.stickerShareCount) +
                buildKnowledgeTestCard(data.knowledgeTestStats);
            
            // Tab 2: VHV Content
            const vhvContainer = document.getElementById('vhv-content-container');
            if (data.isVhv) {
                vhvContainer.innerHTML = 
                    buildVhvInfoCard(data.vhvProfile) +
                    buildVhvPatientListCard(data.vhvPatientList);
            } else {
                vhvContainer.innerHTML = buildVhvRegistrationButton();
            }
        }

        // --- HTML Builders ---
        
        function buildGamificationCard(scores) {
            if (!scores) return '';
            return `
            <div class="col-12">
                <div class="card bg-white"><div class="card-body p-3">
                    <h5 class="section-title mb-3"><i class="bi bi-trophy-fill text-warning"></i>คะแนนสุขภาพของคุณ</h5>
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <div class="game-score-box">
                                <div class="game-icon text-primary"><i class="bi bi-clipboard-check"></i></div>
                                <h3>${scores.checkScore}</h3>
                                <span>คะแนนประเมิน</span>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="game-score-box">
                                <div class="game-icon text-danger"><i class="bi bi-ambulance"></i></div>
                                <h3>${scores.emergencyScore}</h3>
                                <span>เข้าถึงฉุกเฉิน (เต็ม 10)</span>
                            </div>
                        </div>
                         <div class="col-6 col-md-3">
                            <div class="game-score-box">
                                <div class="game-icon text-info"><i class="bi bi-emoji-smile"></i></div>
                                <h3>${scores.stickerScore}</h3>
                                <span>ส่งสติกเกอร์</span>
                            </div>
                        </div>
                         <div class="col-6 col-md-3">
                            <div class="game-score-box">
                                <div class="game-icon text-success"><i class="bi bi-book"></i></div>
                                <h3>${scores.knowledgeScore}</h3>
                                <span>ความรู้ (เต็ม 10)</span>
                            </div>
                        </div>
                    </div>
                </div></div>
            </div>`;
        }

        function buildProfileCard(p) {
            if (!p) return '';
            const riskValue = p.thai_cv_risk_score / 100;
            const riskInfo = classifyRisk(riskValue);
            const nonModifiableFactors = `<div class="info-item"><i class="bi bi-gender-ambiguous"></i><div><span class="label">เพศ</span> <b>${p.gender == 1 ? 'ชาย' : 'หญิง'}</b></div></div><div class="info-item"><i class="bi bi-calendar-event"></i><div><span class="label">อายุ</span> <b>${p.age || 'N/A'} ปี</b></div></div>`;
            const modifiableFactors = `<div class="info-item"><i class="bi bi-fire"></i><div><span class="label">สูบบุหรี่</span> <b>${p.smoke == 1 ? 'สูบ' : 'ไม่สูบ'}</b></div></div><div class="info-item"><i class="bi bi-bandaid"></i><div><span class="label">เบาหวาน</span> <b>${p.dm == 1 ? 'เป็น' : 'ไม่เป็น'}</b></div></div><div class="info-item"><i class="bi bi-speedometer2"></i><div><span class="label">ความดัน</span> <b>${p.sbp || 'N/A'}</b></div></div><div class="info-item"><i class="bi bi-rulers"></i><div><span class="label">ส่วนสูง</span> <b>${p.height || 'N/A'}</b></div></div>`;
            
            return `
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-center text-center text-md-start mb-3">
                            <div class="d-flex align-items-center flex-column flex-md-row">
                                <img src="${p.pictureUrl || 'https://via.placeholder.com/90'}" class="profile-img mb-2 me-md-3 mb-md-0">
                                <div>
                                    <h5 class="fw-bold mb-1">${p.name || 'N/A'}</h5>
                                    <div class="text-muted small">โทร: ${p.telephone || 'N/A'}</div>
                                    <span class="badge bg-secondary fw-normal mt-1">ลงทะเบียน: ${p.timestamp ? new Date(p.timestamp).toLocaleDateString('th-TH') : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <h6 class="text-center text-dark">ความเสี่ยงสโตรกที่ประเมิน</h6>
                        <div class="d-flex align-items-center justify-content-center mb-3">
                             <div class="text-center">
                                <div style="color: ${riskInfo.color};">
                                    <div class="display-4 fw-bolder">${p.thai_cv_risk_score !== undefined ? `${p.thai_cv_risk_score}%` : 'N/A'}</div>
                                    <div class="fw-bold">${riskInfo.text}</div>
                                </div>
                            </div>
                            <a href="${LIFF_ID_REGIS}" class="btn btn-outline-primary ms-4 align-self-center">ประเมินใหม่</a>
                        </div>
                        <h6 class="section-title border-top pt-3"><i class="bi bi-person-slash"></i>ปัจจัยเสี่ยงคงที่</h6>
                        <div class="info-grid mb-3">${nonModifiableFactors}</div>
                        <hr>
                        <h6 class="section-title"><i class="bi bi-person-check"></i>ปัจจัยปรับเปลี่ยนได้</h6>
                        <div class="info-grid">${modifiableFactors}</div>
                    </div>
                </div>
            </div>`;
        }

        // ... [Include buildDailyCheckCard, buildCommunityLeadersCard, buildDistanceCard, buildStickerCard, buildKnowledgeTestCard from previous version here as they are largely unchanged visually] ...
        
        function buildDailyCheckCard(info) {
             // (Use exact same code as provided in previous version)
             let daysSinceCheck = '';
            if (info.latestCheckTimestamp) {
                const lastCheckDate = new Date(info.latestCheckTimestamp);
                const today = new Date();
                lastCheckDate.setHours(0,0,0,0);
                today.setHours(0,0,0,0);
                const diffTime = Math.abs(today - lastCheckDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays > 0) daysSinceCheck = `<p class="text-center text-danger small mt-3 mb-0">ไม่ได้ประเมินมา ${diffDays} วัน</p>`;
            } else { daysSinceCheck = `<p class="text-center text-danger small mt-3 mb-0">ยังไม่เคยประเมินอาการ</p>`; }

            return `<div class="col-lg-6 col-12"><div class="card"><div class="card-body">
                <h5 class="section-title"><i class="bi bi-calendar-check-fill"></i>ประเมินประจำวัน</h5>
                <div class="d-flex justify-content-around text-center mb-2">
                    <div><div class="fs-4 fw-bold text-danger">${info.symptomCount}</div><div class="small">มีอาการ</div></div>
                    <div><div class="fs-4 fw-bold text-success">${info.noSymptomCount}</div><div class="small">ไม่มีอาการ</div></div>
                </div>
                ${daysSinceCheck}
                <a href="${LIFF_ID_DAILY}" class="btn btn-primary w-100 mt-3">เช็คอาการ</a>
            </div></div></div>`;
        }
        
        function buildCommunityLeadersCard(leaders) {
             // (Use exact same code as provided)
             let leaderHtml = `<p class="text-muted">ไม่พบข้อมูลผู้นำชุมชน</p>`;
            if (leaders) {
                const pcuCallBtn = leaders.pcu_tel ? `<a href="#" onclick="trackTelCall('${leaders.pcu_tel}')" class="btn-call"><i class="bi bi-telephone-fill"></i> โทร</a>` : '';
                const createVhvItem = (num, vhvData) => {
                    if (!vhvData.name || !vhvData.tel) return '';
                    const dist = vhvData.distance_km ? `<small class="text-muted ms-2">(${vhvData.distance_km} กม.)</small>` : '';
                    return `<li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>อสม. ${num}: ${vhvData.name} ${dist}</span>
                        <a href="#" onclick="trackTelCall('${vhvData.tel}')" class="btn-call"><i class="bi bi-telephone-fill"></i> โทร</a>
                    </li>`;
                };
                let vhvItems = createVhvItem(1, {name: leaders.volunteer1, tel: leaders.volunteer1_tel, distance_km: leaders.volunteer1_distance_km});
                vhvItems += createVhvItem(2, {name: leaders.volunteer2, tel: leaders.volunteer2_tel, distance_km: leaders.volunteer2_distance_km});
                leaderHtml = `<ul class="list-group list-group-flush"><li class="list-group-item d-flex justify-content-between align-items-center"><span>รพ.สต.: ${leaders.pcu || 'N/A'}</span> ${pcuCallBtn}</li>${vhvItems}</ul>`;
            }
            return `<div class="col-lg-6 col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-person-hearts"></i>อสม.ใกล้ฉัน</h5>${leaderHtml}</div></div></div>`;
        }

        function buildDistanceCard(distanceInfo, helpText) {
             // (Use exact same code as provided)
             let historyHtml = '<p class="text-muted">ไม่พบประวัติปักหมุด</p>';
             let cardClass = 'card';
             if(distanceInfo) {
                 const duration = parseInt(distanceInfo.duration);
                 if(duration < 120) cardClass += ' bg-success-subtle'; else if(duration < 210) cardClass += ' bg-warning-subtle'; else cardClass += ' bg-danger-subtle';
                 historyHtml = `<p class="mb-1"><strong>ระยะทาง:</strong> ${parseFloat(distanceInfo.distance).toFixed(1)} กม.</p><p><strong>เวลา:</strong> ${Math.floor(duration/60)} ชม. ${duration%60} นาที</p>`;
             }
             return `<div class="col-lg-6 col-12"><div class="card bg-success-subtle"><div class="card-body">
                <h5 class="section-title"><i class="bi bi-hospital-fill"></i>ระยะทางไป รพ.</h5>
                ${historyHtml}
                <button type="button" class="btn btn-secondary w-100 mt-2" onclick="DISTANCE_MODAL.show()"><i class="bi bi-pin-map-fill"></i> ปักหมุดใหม่</button>
             </div></div></div>`;
        }
        
        function buildStickerCard(count) {
             return `<div class="col-lg-6 col-12"><div class="card"><div class="card-body">
                <h5 class="section-title"><i class="bi bi-send-check-fill"></i>ส่งสติกเกอร์</h5>
                <p class="text-center mb-0">ส่งแล้ว <strong class="fs-4">${count || 0}</strong> ครั้ง</p>
                <a href="${LIFF_ID_STICKER}" class="btn btn-info w-100 text-white mt-3">ส่งสติกเกอร์</a>
            </div></div></div>`;
        }
        
        function buildKnowledgeTestCard(stats) {
             return `<div class="col-12"><div class="card"><div class="card-body">
                <h5 class="section-title"><i class="bi bi-patch-question-fill"></i>ทดสอบความรู้</h5>
                <div class="d-flex justify-content-around text-center">
                    <div><div class="fs-4 fw-bold">${stats.testCount}</div><small>ครั้ง</small></div>
                    <div><div class="fs-4 fw-bold">${stats.maxScore}</div><small>คะแนนสูงสุด</small></div>
                </div>
                <a href="${LIFF_ID_KNOWLEDGE}" class="btn btn-success w-100 mt-3">ทำแบบทดสอบ</a>
            </div></div></div>`;
        }

        function buildVhvInfoCard(vhv) {
            return `<div class="col-12"><div class="card bg-white shadow-sm"><div class="card-body">
                <h5 class="section-title text-dark"><i class="bi bi-person-badge-fill text-warning"></i> แดชบอร์ด อสม.</h5>
                <div class="mb-3">
                    <p class="mb-1"><b>ชื่อ:</b> ${vhv.name}</p>
                    <p class="mb-1"><b>พื้นที่:</b> ${vhv.area}</p>
                    <p class="mb-0"><b>โทร:</b> ${vhv.phone}</p>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="SHARE_PROFILE_MODAL.show()"><i class="bi bi-share-fill"></i> แชร์โปรไฟล์</button>
                    <button class="btn btn-outline-dark" onclick="openVhvModal()">แก้ไขข้อมูล</button>
                </div>
            </div></div></div>`;
        }

        function buildVhvPatientListCard(patients) {
            if (!patients || patients.length === 0) return '<div class="col-12"><div class="alert alert-light text-center">ยังไม่มีผู้ป่วยในพื้นที่</div></div>';
            
            const listHtml = patients.map(p => {
                const riskInfo = classifyRisk(p.thai_cv_risk_score/100);
                const distHtml = (p.distanceFromVhv_km && p.latlong) ? 
                    `<a href="https://www.google.com/maps?q=${p.latlong}" target="_blank" class="badge bg-secondary text-decoration-none"><i class="bi bi-geo-alt-fill"></i> ${p.distanceFromVhv_km} กม.</a>` : '';
                
                return `<li class="list-group-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="fw-bold mb-0">${p.name} ${distHtml}</h6>
                            <small style="color:${riskInfo.color}">${riskInfo.text} (${p.thai_cv_risk_score}%)</small>
                        </div>
                        <a href="#" onclick="trackTelCall('${p.telephone}')" class="btn btn-sm btn-outline-success align-self-center"><i class="bi bi-telephone-fill"></i></a>
                    </div>
                </li>`;
            }).join('');

            return `<div class="col-12"><div class="card bg-white shadow-sm"><div class="card-body p-0">
                <div class="p-3 border-bottom"><h5 class="mb-0 fw-bold">รายชื่อกลุ่มเสี่ยง (${patients.length})</h5></div>
                <ul class="list-group list-group-flush">${listHtml}</ul>
            </div></div></div>`;
        }

        function buildVhvRegistrationButton() {
            return `<div class="col-12 mt-5 text-center">
                <div class="card bg-white"><div class="card-body p-5">
                    <i class="bi bi-person-plus-fill display-1 text-secondary mb-3"></i>
                    <h3>ยังไม่ได้ลงทะเบียน อสม.</h3>
                    <p class="text-muted">สำหรับ อสม. รพ.สวี เพื่อดูแลผู้ป่วยในพื้นที่</p>
                    <button class="btn btn-lg btn-warning fw-bold w-100 mt-3" onclick="openVhvModal()">ลงทะเบียน อสม.</button>
                </div></div>
            </div>`;
        }

        function showQrModal() { QR_MODAL.show(); }

        // --- Event Handlers (Using same logic as previous, ensuring openVhvModal selects multiple) ---
        function openVhvModal() {
            document.getElementById('vhvForm').reset();
            const vhvData = ALL_USER_DATA.vhvProfile || {};
            const userData = ALL_USER_DATA.userProfile || {};
            
            document.getElementById('vhvRegisterModalLabel').textContent = ALL_USER_DATA.isVhv ? 'แก้ไขข้อมูล' : 'ลงทะเบียน';
            document.getElementById('vhvName').value = vhvData.name || userData.name ||'';
            document.getElementById('vhvPhone').value = vhvData.phone || userData.telephone || '';
            document.getElementById('vhvLineId').value = vhvData.line_id || userData.line_id || '';
            document.getElementById('vhvAsmHome').value = vhvData.asm_home || '';
            
            const areaSelect = document.getElementById('vhvArea');
            areaSelect.innerHTML = ''; 
            const currentAreas = vhvData.area ? vhvData.area.split(',').map(s=>s.trim()) : [];
            
            ALL_USER_DATA.availableVhvAreas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                if(currentAreas.includes(area)) option.selected = true;
                areaSelect.appendChild(option);
            });
            VHV_REG_MODAL.show();
        }

        function handlePinNewLocation() {
            // (Same as previous code)
            const type = document.getElementById('locationType').value;
            showLoading(true, "กำลังระบุตำแหน่ง...");
            navigator.geolocation.getCurrentPosition(pos => {
                const latlong = `${pos.coords.latitude},${pos.coords.longitude}`;
                fetch(`${WEB_APP_URL}?action=calculateDistance&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`)
                    .then(res => res.json()).then(d => {
                        return fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'saveNewLocation', data: { userId: LIFF_PROFILE.userId, type: type, latlong: latlong, distance: d.distance_km, duration: d.duration_mins }}) });
                    }).then(() => { alert("บันทึกสำเร็จ"); window.location.reload(); }).catch(handleFailure);
            }, err => handleFailure(err), {enableHighAccuracy: true});
        }
        
        function handleVhvRegistration() {
            const form = document.getElementById('vhvForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            const selectedAreas = Array.from(document.getElementById('vhvArea').selectedOptions).map(opt => opt.value);
            if(selectedAreas.length === 0){ alert("กรุณาเลือกพื้นที่"); return; }
            
            showLoading(true);
            const regData = {
                userId: LIFF_PROFILE.userId, displayName: LIFF_PROFILE.displayName, profilePicture: LIFF_PROFILE.pictureUrl,
                name: document.getElementById('vhvName').value, phone: document.getElementById('vhvPhone').value,
                line_id: document.getElementById('vhvLineId').value, areas: selectedAreas,
                pdpa: "ยินยอม", asm_home: document.getElementById('vhvAsmHome').value, asm_test: ALL_USER_DATA.vhvProfile?.asm_test || ''
            };
            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerVhv', data: regData }) })
                .then(() => { alert("บันทึกสำเร็จ"); window.location.reload(); }).catch(handleFailure);
        }

        function pinVhvHomeInForm() {
            if(!confirm("ยืนยันพิกัดที่บ้าน?")) return;
            showLoading(true);
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('vhvAsmHome').value = `${pos.coords.latitude},${pos.coords.longitude}`;
                showLoading(false);
            }, err => handleFailure(err), {enableHighAccuracy:true});
        }
        
        async function handleShareProfile() {
            const vhv = ALL_USER_DATA.vhvProfile;
            if(!vhv) return;
            const sharePhone = document.getElementById('sharePhone').checked;
            const shareLine = document.getElementById('shareLine').checked;
            const shareLocation = document.getElementById('shareLocation').checked;
            
            // Build Flex buttons logic based on checkboxes...
            const footerButtons = [];
            if(sharePhone && vhv.phone) footerButtons.push({ "type": "button", "style": "primary", "color": "#FFC107", "action": { "type": "uri", "label": "โทรศัพท์", "uri": `tel:${vhv.phone.replace(/'/g,'')}` } });
            if(shareLine && vhv.line_id) footerButtons.push({ "type": "button", "style": "primary", "color": "#06C755", "action": { "type": "uri", "label": "LINE", "uri": `https://line.me/ti/p/~${vhv.line_id}` } });
            if(shareLocation && vhv.asm_home) footerButtons.push({ "type": "button", "style": "secondary", "action": { "type": "uri", "label": "แผนที่บ้าน", "uri": `https://www.google.com/maps?q=${vhv.asm_home}` } });
            
            const flex = {
                type: "flex", altText: "ข้อมูล อสม.",
                contents: {
                    type: "bubble",
                    body: {
                        type: "box", layout: "vertical", backgroundColor: "#007BFF",
                        contents: [
                            { type: "text", text: "อสม.สโตรก", weight: "bold", color: "#FFFFFF", size: "xl", align: "center" },
                            { type: "box", layout: "vertical", margin: "lg", alignItems: "center", contents: [{ type: "image", url: vhv.profilePicture, size: "xl", aspectRatio: "1:1", mask: { type: "circle" } }] },
                            { type: "text", text: vhv.name, weight: "bold", color: "#FFFFFF", size: "lg", align: "center", margin: "md" },
                            
                            // *** คืนค่าส่วนที่หายไป ***
                            { type: "separator", margin: "lg", color: "#FFFFFF" },
                            { type: "box", layout: "horizontal", contents: [
                                { type: "text", text: "พื้นที่ดูแล:", color: "#FFFFFF", size: "sm", flex: 2 },
                                { type: "text", text: vhv.area || "ไม่มีข้อมูล", color: "#FFFFFF", size: "sm", flex: 3, wrap: true, align: "end" }
                            ]},
                            { type: "box", layout: "horizontal", contents: [
                                { type: "text", text: "ผลทดสอบ:", color: "#FFFFFF", size: "sm", flex: 2 },
                                { type: "text", text: vhv.asm_test || "ยังไม่ทดสอบ", color: "#FFFFFF", size: "sm", flex: 3, align: "end" }
                            ]},
                            { type: "box", layout: "horizontal", contents: [
                                { type: "text", text: "ลงทะเบียน:", color: "#FFFFFF", size: "sm", flex: 2 },
                                { type: "text", text: vhv.date_regist ? new Date(vhv.date_regist).toLocaleDateString('th-TH') : "-", color: "#FFFFFF", size: "sm", flex: 3, align: "end" }
                            ]}
                            // *************************
                        ]
                    },
                    footer: { type: "box", layout: "vertical", spacing: "sm", contents: footerButtons }
                }
            };
            SHARE_PROFILE_MODAL.hide();
            await liff.shareTargetPicker([flex]);
        }

        function trackTelCall(tel) { if(confirm("โทรออก?")) window.location.href = 'tel:'+tel.replace(/'/g,''); }
        function classifyRisk(r) { return r<0.1?{text:"เสี่ยงต่ำ",color:"#28a745"}:r<0.2?{text:"ปานกลาง",color:"#ffc107"}:r<0.3?{text:"สูง",color:"#fd7e14"}:{text:"สูงมาก",color:"#dc3545"}; }
        function showLoading(s, t="Loading...") { document.getElementById('loading').style.display=s?'flex':'none'; document.getElementById('loading-text').innerText=t; }
        function handleFailure(e) { alert("Error: "+e.message); showLoading(false); }
    </script>
</body>
</html>