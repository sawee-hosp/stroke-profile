<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลสุขภาพ รู้ทันสโตรก by รพ.สวี</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* Increase base font size to ~2x regular mobile web (usually 14-16px) */
        :root { 
            --bs-primary-rgb: 13, 110, 253; 
            --vhv-bg: #ffc107; 
            --vhv-dark: #b88a00;
            --base-size: 22px; /* Large font for elderly */
        }
        body { 
            font-family: "Noto Sans Thai", sans-serif; 
            font-size: var(--base-size);
            background-color: #f0f2f5; 
            margin: 0; 
            padding-bottom: 3rem;
        }
        
        h1, h2, h3, h4, h5 { font-weight: 700 !important; }
        .h5, h5 { font-size: 1.5rem; }
        .small, small { font-size: 0.9rem; }
        
        /* Navigation Tabs */
        .nav-tabs .nav-link {
            font-size: 1.2rem;
            font-weight: bold;
            color: #6c757d;
            border-radius: 0;
            padding: 15px 10px;
            background: #e9ecef;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background: #fff;
            border-bottom-color: #fff;
        }
        /* VHV Tab Style */
        .nav-tabs .nav-link.vhv-tab {
            background: #fff3cd;
            color: #856404;
        }
        .nav-tabs .nav-link.vhv-tab.active {
            background: var(--vhv-bg);
            color: #000;
            border-color: #dee2e6 #dee2e6 var(--vhv-bg);
        }

        .tab-content-container { padding-top: 20px; }
        
        /* VHV Theme Background */
        .bg-vhv-theme {
            background-color: var(--vhv-bg);
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .card { border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 1.5rem; border-radius: 15px; }
        .section-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 1rem; color: #333; display: flex; align-items: center; }
        .section-title i { margin-right: 0.7rem; color: #0d6efd; font-size: 1.6rem; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
        #loading-text { font-size: 1.5rem; color: #0d6efd; margin-top: 1rem; font-weight: bold; }
        
        .btn-call { background-color: transparent; border: 2px solid #198754; color: #198754; padding: 0.5rem 1rem; font-size: 1.2rem; font-weight: bold; border-radius: 10px; text-decoration: none; }
        .btn-call:hover { background-color: #198754; color: white; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .info-item { display: flex; align-items: center; font-size: 1.1rem; }
        .info-item i { font-size: 1.8rem; color: #0d6efd; min-width: 45px; }
        .info-item div { display: flex; flex-direction: column; }
        .info-item .label { font-size: 0.9em; color: #6c757d; font-weight: normal; }
        
        .bg-light-brown { background-color: #fff8e1; border: 2px solid #ffecb3; }
        .bg-light-blue { background-color: #e3f2fd; border: 1px solid #bbdefb; } /* For Score Card */
        
        .btn-lg { font-size: 1.4rem; padding: 0.8rem 1rem; }
        .form-control, .form-select { font-size: 1.3rem; padding: 0.8rem; }
        .form-label { font-size: 1.3rem; font-weight: bold; }

        /* Gamification Styles */
        .game-score-box {
            background: #fff; border-radius: 15px; padding: 15px 5px; text-align: center; 
            border: 2px solid #fff; height: 100%; transition: transform 0.2s; cursor: pointer;
        }
        .game-score-box:active { transform: scale(0.95); background-color: #f8f9fa; }
        .game-score-box h3 { margin: 5px 0; font-weight: 800; color: #0d6efd; font-size: 2rem; }
        .game-score-box span { font-size: 1rem; color: #666; line-height: 1.2; display: block; }
        .game-icon { font-size: 2.5rem; margin-bottom: 5px; }
        
        .profile-edit-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 40px; height: 40px; color: #0d6efd; }

        /* ID Card Look in Flex Preview */
        .id-card-preview { border: 2px solid #0d6efd; border-radius: 10px; padding: 10px; background: #fff; display: flex; align-items: center; }
        .id-card-img { width: 80px; height: 100px; object-fit: cover; border-radius: 5px; margin-right: 15px; background: #eee; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 4rem; height: 4rem;"></div>
        <span id="loading-text">กำลังโหลดข้อมูล...</span>
    </div>

    <!-- Main Navigation Tabs -->
    <ul class="nav nav-tabs nav-justified fixed-top shadow-sm" id="mainTabs" role="tablist" style="height: 65px;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="health-tab-btn" data-bs-toggle="tab" data-bs-target="#health-tab-content" type="button" role="tab"><i class="bi bi-heart-pulse-fill"></i> ข้อมูลสุขภาพ</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link vhv-tab" id="vhv-tab-btn" data-bs-toggle="tab" data-bs-target="#vhv-tab-content" type="button" role="tab"><i class="bi bi-person-badge-fill"></i> สำหรับ อสม.</button>
        </li>
    </ul>

    <!-- Tab Contents -->
    <div class="tab-content" style="margin-top: 70px;">
        
        <!-- Tab 1: Health Info -->
        <div class="tab-pane fade show active" id="health-tab-content" role="tabpanel">
            <div class="container tab-content-container">
                <div class="row" id="dynamic-content-container">
                    <!-- Cards will be injected here -->
                </div>
            </div>
        </div>

        <!-- Tab 2: VHV Dashboard -->
        <div class="tab-pane fade" id="vhv-tab-content" role="tabpanel">
            <div class="bg-vhv-theme tab-content-container">
                <div class="container">
                    <!-- VHV Content will be injected here -->
                    <div id="vhv-dashboard-area"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <!-- Profile Edit Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">แก้ไขข้อมูลส่วนตัว</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3 text-center">
                            <img id="edit-preview-img" src="" style="width:100px; height:100px; border-radius:50%; object-fit:cover; margin-bottom:10px;">
                            <br>
                            <label class="form-label text-primary" onclick="alert('กรุณาเปลี่ยนรูปโปรไฟล์ใน LINE ของท่าน แล้วระบบจะอัปเดตอัตโนมัติในภายหลัง')">เปลี่ยนรูปโปรไฟล์ (ใช้รูป LINE)</label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ชื่อ-นามสกุล</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">เบอร์โทรศัพท์</label>
                            <input type="tel" class="form-control" id="editPhone" required pattern="[0-9]{10}">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserProfile()">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Distance Modal -->
    <div class="modal fade" id="distanceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">ปักหมุดตำแหน่ง</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="locationType" class="form-label">ประเภทตำแหน่ง</label>
                        <select class="form-select" id="locationType">
                            <option value="บ้าน">บ้าน (ใช้อ้างอิงระยะทาง)</option>
                            <option value="ทางผ่าน">ทางผ่าน (ไม่นำมาคำนวณ)</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary w-100 btn-lg" onclick="handlePinNewLocation()">
                        <i class="bi bi-geo-alt-fill"></i> ปักหมุดที่นี่
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- VHV Register Modal -->
    <div class="modal fade" id="vhvRegisterModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header"><h1 class="modal-title fs-5" id="vhvRegisterModalLabel">ลงทะเบียน อสม.</h1><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <form id="vhvForm">
              <div class="mb-3">
                  <label class="form-label">ชื่อ-นามสกุล</label>
                  <input type="text" class="form-control" id="vhvName" required>
              </div>
              <div class="mb-3"><label class="form-label">เบอร์โทรศัพท์</label><input type="tel" class="form-control" id="vhvPhone" required pattern="[0-9]{10}"></div>
              <div class="mb-3"><label class="form-label">LINE ID</label><input type="text" class="form-control" id="vhvLineId"></div>
              
              <!-- Dropdown เขตพื้นที่ -->
              <div class="mb-3">
                  <label class="form-label">เลือกพื้นที่ดูแล (หมู่บ้าน)</label>
                  <div class="row g-2">
                      <div class="col-6">
                          <select class="form-select" id="vhvDistrict" onchange="updateVillages()" required>
                              <option value="" disabled selected>เลือกตำบล</option>
                          </select>
                      </div>
                      <div class="col-6">
                           <select class="form-select" id="vhvVillage" required disabled>
                              <option value="" disabled selected>เลือกหมู่</option>
                          </select>
                      </div>
                  </div>
              </div>

            <div class="mb-3">
                <label class="form-label">ตำแหน่งบ้าน อสม.</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="vhvAsmHome" placeholder="รอปักหมุด..." readonly>
                    <button class="btn btn-outline-primary" type="button" onclick="pinVhvHomeInForm()"><i class="bi bi-geo-alt-fill"></i> ปักหมุด</button>
                </div>
              </div>

              <div class="form-check"><input class="form-check-input" type="checkbox" id="vhvPdpa" checked><label class="form-check-label small" for="vhvPdpa">ยินยอมเปิดเผยข้อมูลติดต่อให้ผู้ป่วยในพื้นที่</label></div>
            </form>
          </div>
          <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-primary" onclick="handleVhvRegistration()">บันทึก</button></div>
        </div>
      </div>
    </div>

    <!-- Share Profile Modal -->
    <div class="modal fade" id="shareProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">แชร์นามบัตร อสม.</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted">ระบบจะสร้างนามบัตรดิจิทัลพร้อมคะแนนของคุณเพื่อส่งให้ชาวบ้าน</p>
                    <button type="button" class="btn btn-primary btn-lg w-100" onclick="handleShareProfile()"><i class="bi bi-line"></i> ส่งเข้าไลน์</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex flex-column justify-content-center align-items-center">
                    <h2 class="mb-4">สวีรู้ทันสโตรก</h2>
                    <!-- QR Code -->
                    <img src="https://qr-official.line.me/sid/L/2005789397.png" alt="QR Code" style="max-width: 90%; width: 300px; border: 10px solid white; border-radius: 10px;">
                    <p class="mt-3 fs-4">ให้ชาวบ้านสแกนเพื่อเพิ่มเพื่อน</p>
                    <button class="btn btn-light btn-lg mt-4 rounded-pill px-5" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz-nmfZUs5zFM8ZGvNnOjPSu77weGpOeNQgkdCLajx0YG3sb5aoHp3xynsByTv90dmT/exec';
        const LIFF_ID_MAIN = "2005789397-RLAGXrBJ";
        
        // Link IDs (Replace with actual IDs)
        const LINKS = {
            REGIS: "https://liff.line.me/2005789397-nebQ8oJy",
            DAILY: "https://liff.line.me/2005789397-WRm1lYd9",
            STICKER: "https://liff.line.me/2005789397-37lemBgX",
            KNOWLEDGE: "https://liff.line.me/2005789397-ROQvjpYk"
        };

        // --- Mock Data for Sawee District (Example) ---
        // เพิ่มข้อมูลจริงตรงนี้
        const SAWEE_LOCATIONS = {
            "นาโพธิ์": ["หมู่ 1", "หมู่ 2", "หมู่ 3", "หมู่ 4", "หมู่ 5", "หมู่ 6", "หมู่ 7", "หมู่ 8"],
            "สวี": ["หมู่ 1", "หมู่ 2", "หมู่ 3", "หมู่ 4"],
            "ทุ่งคา": ["หมู่ 1", "หมู่ 2", "หมู่ 3", "หมู่ 4", "หมู่ 5"],
            "วิสัยใต้": ["หมู่ 1", "หมู่ 2", "หมู่ 3"],
             // เพิ่มตำบลอื่นๆ...
        };

        let LIFF_PROFILE = null;
        let ALL_USER_DATA = null;
        let DISTANCE_MODAL, VHV_REG_MODAL, SHARE_PROFILE_MODAL, QR_MODAL, EDIT_PROFILE_MODAL;
        
        document.addEventListener('DOMContentLoaded', initializeLiff);

        async function initializeLiff() {
            DISTANCE_MODAL = new bootstrap.Modal(document.getElementById('distanceModal'));
            VHV_REG_MODAL = new bootstrap.Modal(document.getElementById('vhvRegisterModal'));
            SHARE_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('shareProfileModal'));
            QR_MODAL = new bootstrap.Modal(document.getElementById('qrModal'));
            EDIT_PROFILE_MODAL = new bootstrap.Modal(document.getElementById('editProfileModal'));

            try {
                await liff.init({ liffId: LIFF_ID_MAIN });
                // Check if opened from VHV link (?ref=xxx)
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const refId = urlParams.get('ref');

                if (!liff.isLoggedIn()) { liff.login(); return; } 
                
                LIFF_PROFILE = await liff.getProfile();
                
                // Fetch data with Ref ID if exists
                let fetchUrl = `${WEB_APP_URL}?action=getUserData&userId=${LIFF_PROFILE.userId}`;
                if(refId) fetchUrl += `&ref=${refId}`;
                
                fetchUserData(fetchUrl);

            } catch (error) { handleFailure(error); }
        }

        function fetchUserData(url) {
            showLoading(true, "กำลังโหลดข้อมูล...");
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.error) throw new Error(data.error);
                    
                    if (!data.userProfile) {
                        document.getElementById('unregistered-user').style.display = 'block';
                        document.getElementById('mainTabs').style.display = 'none';
                    } else {
                        ALL_USER_DATA = data;
                        updatePage(data);
                    }
                })
                .catch(handleFailure)
                .finally(() => showLoading(false));
        }
        
        function updatePage(data) {
            // Tab 1: Health
            const healthContainer = document.getElementById('dynamic-content-container');
            healthContainer.innerHTML = 
                buildProfileCard(data.userProfile) +
                buildGamificationCard(data.gamification, data.userProfile.district) +
                `<div id="card-risk">` + buildProfileCard(data.userProfile, true) + `</div>` + // Only Risk Score part
                `<div id="card-check">` + buildDailyCheckCard(data.dailyCheckInfo) + `</div>` +
                `<div id="card-emergency">` + buildDistanceCard(data.homeDistance, data.userProfile.help) + `</div>` +
                `<div id="card-leaders">` + buildCommunityLeadersCard(data.communityLeaders) + `</div>` +
                `<div id="card-sticker">` + buildStickerCard(data.stickerShareCount) + `</div>` +
                `<div id="card-exam">` + buildKnowledgeTestCard(data.knowledgeTestStats) + `</div>`;
            
            // Tab 2: VHV
            const vhvArea = document.getElementById('vhv-dashboard-area');
            if (data.isVhv) {
                vhvArea.innerHTML = 
                    buildVhvInstructions(true) +
                    buildVhvStats(data.vhvStats) +
                    buildVhvInfoCard(data.vhvProfile) +
                    buildVhvPatientListCard(data.vhvPatientList);
            } else {
                vhvArea.innerHTML = 
                    buildVhvInstructions(false) +
                    buildVhvStats(data.vhvStats) + // Show total count even if not reg
                    buildVhvRegistrationButton();
            }
        }

        // --- Builders ---

        function buildGamificationCard(scores, district) {
            if (!scores) return '';
            // Rank logic display
            const rankText = `สูงเป็นลำดับที่ <b>${scores.rank}</b> จาก ${scores.totalUsers} คน`;
            
            return `
            <div class="col-12 mb-3">
                <div class="card bg-light-blue shadow-sm">
                    <div class="card-body p-3">
                        <h5 class="section-title mb-2 text-primary"><i class="bi bi-trophy-fill text-warning"></i>คะแนนสุขภาพสโตรก</h5>
                        <div class="text-center mb-3">
                             <h1 class="display-3 fw-bold text-primary mb-0">${scores.totalScore}</h1>
                             <div class="text-muted">คะแนนรวม (${rankText})</div>
                        </div>
                        <div class="row g-2">
                            <div class="col-6 col-md-3" onclick="scrollToId('card-check')">
                                <div class="game-score-box">
                                    <div class="game-icon text-primary"><i class="bi bi-clipboard-check"></i></div>
                                    <h3>${scores.checkScore}</h3>
                                    <span>ใส่ใจ (ครั้ง)</span>
                                </div>
                            </div>
                            <div class="col-6 col-md-3" onclick="scrollToId('card-emergency')">
                                <div class="game-score-box">
                                    <div class="game-icon text-danger"><i class="bi bi-ambulance"></i></div>
                                    <h3>${scores.emergencyScore}</h3>
                                    <span>ฉุกเฉิน (10)</span>
                                </div>
                            </div>
                             <div class="col-6 col-md-3" onclick="scrollToId('card-sticker')">
                                <div class="game-score-box">
                                    <div class="game-icon text-info"><i class="bi bi-emoji-smile"></i></div>
                                    <h3>${scores.stickerScore}</h3>
                                    <span>แชร์ (ครั้ง)</span>
                                </div>
                            </div>
                             <div class="col-6 col-md-3" onclick="scrollToId('card-exam')">
                                <div class="game-score-box">
                                    <div class="game-icon text-success"><i class="bi bi-book"></i></div>
                                    <h3>${scores.knowledgeScore}</h3>
                                    <span>ความรู้ (10)</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-2 small text-muted">* คลิกที่กล่องคะแนนเพื่อดูรายละเอียด</div>
                    </div>
                </div>
            </div>`;
        }

        function buildProfileCard(p, riskOnly = false) {
            if (!p) return '';
            const riskValue = p.thai_cv_risk_score / 100;
            const riskInfo = classifyRisk(riskValue);
            
            // If riskOnly is true, return just the risk section for layout purposes
            if (riskOnly) {
                return `
                <div class="col-12">
                <div class="card">
                    <div class="card-body">
                         <h6 class="section-title"><i class="bi bi-activity"></i>ความเสี่ยงสโตรกที่ประเมิน</h6>
                        <div class="d-flex align-items-center justify-content-center mb-3">
                             <div class="text-center">
                                <div style="color: ${riskInfo.color};">
                                    <div class="display-3 fw-bolder">${p.thai_cv_risk_score !== undefined ? `${p.thai_cv_risk_score}%` : 'N/A'}</div>
                                    <div class="fw-bold fs-4">${riskInfo.text}</div>
                                </div>
                            </div>
                            <a href="${LINKS.REGIS}" class="btn btn-outline-primary ms-4 align-self-center btn-lg">ประเมินใหม่</a>
                        </div>
                        <hr>
                        <h6 class="section-title"><i class="bi bi-person-check"></i>ปัจจัยเสี่ยงของคุณ</h6>
                         <div class="info-grid">
                            <div class="info-item"><i class="bi bi-fire"></i><div><span class="label">สูบบุหรี่</span> <b>${p.smoke == 1 ? 'สูบ' : 'ไม่สูบ'}</b></div></div>
                            <div class="info-item"><i class="bi bi-bandaid"></i><div><span class="label">เบาหวาน</span> <b>${p.dm == 1 ? 'เป็น' : 'ไม่เป็น'}</b></div></div>
                            <div class="info-item"><i class="bi bi-speedometer2"></i><div><span class="label">ความดัน</span> <b>${p.sbp || 'N/A'}</b></div></div>
                        </div>
                    </div>
                </div>
                </div>`;
            }

            // Full Profile Header
            return `
            <div class="col-12">
                <div class="card bg-white">
                    <div class="card-body position-relative">
                        <button class="profile-edit-btn shadow-sm" onclick="openEditProfile()"><i class="bi bi-pencil-fill"></i></button>
                        <div class="d-flex align-items-center">
                            <img src="${p.pictureUrl || 'https://via.placeholder.com/90'}" class="rounded-circle border border-3 border-primary me-3" style="width: 100px; height: 100px; object-fit: cover;">
                            <div>
                                <h4 class="fw-bold mb-1">${p.name || 'N/A'}</h4>
                                <div class="text-muted fs-5"><i class="bi bi-telephone"></i> ${p.telephone || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function buildVhvInstructions(isRegistered) {
            return `
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="fw-bold text-dark mb-3"><i class="bi bi-list-check"></i> ขั้นตอนการทำงานของ อสม.</h5>
                    <ol class="list-group list-group-numbered list-group-flush fs-5">
                        <li class="list-group-item bg-transparent">สมัครเป็น อสม.สโตรก (เลือกหมู่บ้านที่ดูแล)</li>
                        <li class="list-group-item bg-transparent">ทำแบบทดสอบความรู้ให้ได้คะแนนเต็ม</li>
                        <li class="list-group-item bg-transparent">ปักหมุดบ้านของท่าน (เพื่อให้ระบบแนะนำลูกบ้านได้)</li>
                        <li class="list-group-item bg-transparent">แชร์ QR Code/นามบัตร ให้ชาวบ้านสแกนเพื่อประเมินความเสี่ยง</li>
                        <li class="list-group-item bg-transparent">แนะนำให้ชาวบ้านทำแบบทดสอบความรู้</li>
                        <li class="list-group-item bg-transparent">ส่งสติกเกอร์ความห่วงใยให้กลุ่มเสี่ยงสม่ำเสมอ</li>
                    </ol>
                </div>
            </div>`;
        }
        
        function buildVhvStats(stats) {
            if(!stats) return '';
            const myRef = stats.myReferrals ? `<div class="col-6"><div class="border rounded p-2 bg-white"><h1>${stats.myReferrals}</h1><small>ลูกข่ายที่เข้าถึง</small></div></div>` : '';
            return `
            <div class="text-center mb-3">
                <div class="row g-2">
                    <div class="col-6 mx-auto">
                        <div class="border rounded p-2 bg-white shadow-sm">
                             <h1 class="text-primary fw-bold">${stats.totalVhv || 0}</h1>
                             <small class="text-muted">อสม.ที่ลงทะเบียนแล้ว</small>
                        </div>
                    </div>
                    ${myRef}
                </div>
            </div>`;
        }

        function buildVhvInfoCard(vhv) {
            const btnExam = !vhv.asm_test ? `<a href="${LINKS.KNOWLEDGE}" class="btn btn-warning w-100 mt-2 text-dark fw-bold">⚠️ ยังไม่มีคะแนนสอบ (คลิกทำข้อสอบ)</a>` : `<div class="text-success mt-2 fw-bold"><i class="bi bi-check-circle"></i> สอบแล้ว (${vhv.asm_test}/10)</div>`;

            return `<div class="card border-warning shadow"><div class="card-body">
                <div class="text-center mb-3">
                    <button class="btn btn-dark btn-lg w-100 shadow rounded-pill" onclick="showQrModal()">
                         <i class="bi bi-qr-code"></i> แสดง QR Code สวีรู้ทันสโตรก
                    </button>
                </div>
                <hr>
                <h5 class="section-title text-dark">ข้อมูลส่วนตัว อสม.</h5>
                <p class="mb-1 fs-5"><b>ชื่อ:</b> ${vhv.name}</p>
                <p class="mb-1 fs-5"><b>พื้นที่:</b> ${vhv.area}</p>
                ${btnExam}
                <div class="row mt-3 g-2">
                    <div class="col-6"><button class="btn btn-primary w-100 btn-lg" onclick="handleShareProfile()"><i class="bi bi-share-fill"></i> แชร์นามบัตร</button></div>
                    <div class="col-6"><button class="btn btn-outline-dark w-100 btn-lg" onclick="openVhvModal()">แก้ไขข้อมูล</button></div>
                </div>
            </div></div>`;
        }

        function buildVhvRegistrationButton() {
            return `<div class="card bg-white text-center p-4">
                <i class="bi bi-person-plus-fill display-1 text-warning mb-3"></i>
                <h3>สมัครเป็น อสม.สโตรก</h3>
                <p class="text-muted">สำหรับ อสม. รพ.สวี เท่านั้น</p>
                <button class="btn btn-lg btn-warning fw-bold w-100" onclick="openVhvModal()">ลงทะเบียน</button>
            </div>`;
        }

        // Reusing existing builders (with slight class tweaks for size)
        function buildDailyCheckCard(info) {
             let daysSinceCheck = '';
            if (info.latestCheckTimestamp) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(info.latestCheckTimestamp).setHours(0,0,0,0)) / (864e5));
                if (diffDays > 0) daysSinceCheck = `<p class="text-center text-danger mt-2">ไม่ได้ประเมินมา ${diffDays} วัน</p>`;
            } else { daysSinceCheck = `<p class="text-center text-danger mt-2">ยังไม่เคยประเมิน</p>`; }
            return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-calendar-check-fill"></i>ใส่ใจประเมินอาการ</h5><div class="d-flex justify-content-around text-center"><div><div class="display-4 fw-bold text-danger">${info.symptomCount}</div><div class="small">มีอาการ</div></div><div><div class="display-4 fw-bold text-success">${info.noSymptomCount}</div><div class="small">ปกติ</div></div></div>${daysSinceCheck}<a href="${LINKS.DAILY}" class="btn btn-primary w-100 btn-lg mt-3">เช็คอาการ</a></div></div></div>`;
        }
        function buildDistanceCard(d, help) {
             let html = '<p class="text-muted text-center">ยังไม่ปักหมุดบ้าน</p>';
             let cls = 'card';
             if(d) {
                 const min = parseInt(d.duration);
                 cls += min < 120 ? ' bg-success-subtle' : min < 270 ? ' bg-warning-subtle' : ' bg-danger-subtle';
                 html = `<div class="text-center"><h1>${parseFloat(d.distance).toFixed(1)} กม.</h1><h3>${Math.floor(min/60)} ชม. ${min%60} นาที</h3></div>`;
             }
             return `<div class="col-12"><div class="${cls}"><div class="card-body"><h5 class="section-title"><i class="bi bi-hospital-fill"></i>การเข้าถึงฉุกเฉิน (รพ.สวี)</h5>${html}<button class="btn btn-secondary w-100 btn-lg mt-2" onclick="DISTANCE_MODAL.show()"><i class="bi bi-geo-alt-fill"></i> ปักหมุด/แก้ไข</button></div></div></div>`;
        }
        function buildStickerCard(c) { return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-send-check-fill"></i>แชร์สติกเกอร์ไลน์</h5><div class="text-center"><h1>${c} ครั้ง</h1></div><a href="${LINKS.STICKER}" class="btn btn-info w-100 btn-lg text-white mt-2">ส่งสติกเกอร์</a></div></div></div>`; }
        function buildKnowledgeTestCard(s) { return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-book-half"></i>ความรู้เรื่องสโตรก</h5><div class="text-center"><h1>${s.maxScore}/10</h1><small>สอบไป ${s.testCount} ครั้ง</small></div><a href="${LINKS.KNOWLEDGE}" class="btn btn-success w-100 btn-lg mt-2">ทำแบบทดสอบ</a></div></div></div>`; }
        function buildCommunityLeadersCard(l) { 
            if(!l) return '';
            let html = '<ul class="list-group list-group-flush fs-5">';
            if(l.pcu) html += `<li class="list-group-item d-flex justify-content-between"><span>รพ.สต.: ${l.pcu}</span>${l.pcu_tel?`<a href="tel:${l.pcu_tel}" class="btn-call">โทร</a>`:''}</li>`;
            if(l.volunteer1) html += `<li class="list-group-item d-flex justify-content-between"><span>อสม.1: ${l.volunteer1}</span><a href="tel:${l.volunteer1_tel}" class="btn-call">โทร</a></li>`;
            html += '</ul>';
            return `<div class="col-12"><div class="card"><div class="card-body"><h5 class="section-title"><i class="bi bi-people-fill"></i>อสม.ใกล้ฉัน</h5>${html}</div></div></div>`;
        }
        function buildVhvPatientListCard(pts) {
            if(!pts || pts.length===0) return '';
            const list = pts.map(p => `<li class="list-group-item d-flex justify-content-between align-items-center"><span>${p.name} <small class="text-muted">(${p.thai_cv_risk_score}%)</small></span><a href="tel:${p.telephone}" class="btn-call"><i class="bi bi-telephone"></i></a></li>`).join('');
            return `<div class="card"><div class="card-body p-0"><div class="p-3 bg-light"><b>รายชื่อกลุ่มเสี่ยง (${pts.length})</b></div><ul class="list-group list-group-flush fs-5">${list}</ul></div></div>`;
        }

        // --- Logic Functions ---

        function openEditProfile() {
            document.getElementById('editName').value = ALL_USER_DATA.userProfile.name;
            document.getElementById('editPhone').value = ALL_USER_DATA.userProfile.telephone ? ALL_USER_DATA.userProfile.telephone.replace(/'/g,'') : '';
            document.getElementById('edit-preview-img').src = ALL_USER_DATA.userProfile.pictureUrl;
            EDIT_PROFILE_MODAL.show();
        }

        function saveUserProfile() {
            const name = document.getElementById('editName').value;
            const phone = document.getElementById('editPhone').value;
            if(!name || !phone) return alert("กรุณากรอกข้อมูลให้ครบ");
            
            showLoading(true, "กำลังอัปเดต...");
            fetch(WEB_APP_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action: 'updateUserProfile', data: { userId: LIFF_PROFILE.userId, name: name, phone: phone, pictureUrl: LIFF_PROFILE.pictureUrl } })
            }).then(() => {
                alert("บันทึกสำเร็จ");
                window.location.reload();
            }).catch(handleFailure);
        }

        function openVhvModal() {
            // Populate Districts
            const distSelect = document.getElementById('vhvDistrict');
            distSelect.innerHTML = '<option value="" disabled selected>เลือกตำบล</option>';
            for (const d in SAWEE_LOCATIONS) {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                distSelect.appendChild(opt);
            }

            // Fill Data if exists
            const vhv = ALL_USER_DATA.vhvProfile || {};
            const user = ALL_USER_DATA.userProfile || {};
            
            document.getElementById('vhvName').value = vhv.name || user.name || '';
            document.getElementById('vhvPhone').value = vhv.phone ? vhv.phone.replace(/'/g,'') : (user.telephone ? user.telephone.replace(/'/g,'') : '');
            document.getElementById('vhvLineId').value = vhv.line_id || user.line_id || '';
            document.getElementById('vhvAsmHome').value = vhv.asm_home || '';

            // Handle Area (Split District and Village)
            if (vhv.area) {
                // สมมติ format: "ต.นาโพธิ์ ม.1"
                const parts = vhv.area.match(/ต\.(.*?) ม\.(.*)/);
                if (parts && parts[1] && parts[2]) {
                    distSelect.value = parts[1].trim();
                    updateVillages(); // Populate village
                    document.getElementById('vhvVillage').value = "หมู่ " + parts[2].trim();
                }
            }

            VHV_REG_MODAL.show();
        }

        function updateVillages() {
            const dist = document.getElementById('vhvDistrict').value;
            const villSelect = document.getElementById('vhvVillage');
            villSelect.innerHTML = '<option value="" disabled selected>เลือกหมู่</option>';
            villSelect.disabled = true;
            
            if (SAWEE_LOCATIONS[dist]) {
                villSelect.disabled = false;
                SAWEE_LOCATIONS[dist].forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v; // "หมู่ 1"
                    opt.textContent = v;
                    villSelect.appendChild(opt);
                });
            }
        }

        function handleVhvRegistration() {
            const name = document.getElementById('vhvName').value;
            const phone = document.getElementById('vhvPhone').value;
            const line = document.getElementById('vhvLineId').value;
            const dist = document.getElementById('vhvDistrict').value;
            const vill = document.getElementById('vhvVillage').value;
            const home = document.getElementById('vhvAsmHome').value;
            
            if (!name || !phone || !dist || !vill) return alert("กรุณากรอกข้อมูลให้ครบถ้วน");
            
            // Format Area: "ต.xxx ม.yy"
            const villNum = vill.replace('หมู่ ', '');
            const areaString = `ต.${dist} ม.${villNum}`;

            showLoading(true, "กำลังบันทึก...");
            const data = {
                userId: LIFF_PROFILE.userId, displayName: LIFF_PROFILE.displayName, profilePicture: LIFF_PROFILE.pictureUrl,
                name: name, phone: phone, line_id: line,
                areas: [areaString], // Send as array for backend compatibility
                pdpa: "ยินยอม", asm_home: home, asm_test: ALL_USER_DATA.vhvProfile?.asm_test || ''
            };
            
            fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'registerVhv', data: data }) })
                .then(() => { alert("ลงทะเบียนสำเร็จ"); window.location.reload(); }).catch(handleFailure);
        }

        async function handleShareProfile() {
            // เรียก Backend เพื่อขอ Flex JSON (เพื่อความปลอดภัยและข้อมูลครบถ้วน)
            showLoading(true, "กำลังสร้างนามบัตร...");
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getShareCard&userId=${LIFF_PROFILE.userId}`);
                const data = await res.json();
                showLoading(false);
                
                if (data.success && data.flex) {
                    SHARE_PROFILE_MODAL.hide();
                    await liff.shareTargetPicker([data.flex]);
                } else {
                    alert("ไม่สามารถสร้างนามบัตรได้: " + data.message);
                }
            } catch (err) { handleFailure(err); }
        }

        function scrollToId(id) {
            const el = document.getElementById(id);
            if(el) {
                // Switch tab if needed
                const tabBtn = document.getElementById('health-tab-btn');
                const tab = new bootstrap.Tab(tabBtn);
                tab.show();
                setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            }
        }

        function showQrModal() { QR_MODAL.show(); }
        function handlePinNewLocation() {
            // (Use existing logic)
             showLoading(true);
             navigator.geolocation.getCurrentPosition(p => {
                 fetch(`${WEB_APP_URL}?action=calculateDistance&lat=${p.coords.latitude}&lon=${p.coords.longitude}`)
                 .then(r=>r.json()).then(d=> {
                     fetch(WEB_APP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify({action:'saveNewLocation',data:{userId:LIFF_PROFILE.userId,type:document.getElementById('locationType').value,latlong:`${p.coords.latitude},${p.coords.longitude}`,distance:d.distance_km,duration:d.duration_mins}})})
                     .then(()=>{alert("บันทึกสำเร็จ"); window.location.reload();});
                 });
             }, e=>handleFailure(e));
        }
        function pinVhvHomeInForm() {
            showLoading(true);
            navigator.geolocation.getCurrentPosition(p => {
                document.getElementById('vhvAsmHome').value = `${p.coords.latitude},${p.coords.longitude}`;
                showLoading(false);
            }, e=>handleFailure(e));
        }
        function classifyRisk(r) { return r<0.1?{text:"เสี่ยงต่ำ",color:"#28a745"}:r<0.2?{text:"ปานกลาง",color:"#ffc107"}:r<0.3?{text:"สูง",color:"#fd7e14"}:{text:"สูงมาก",color:"#dc3545"}; }
        function showLoading(s, t="Loading...") { document.getElementById('loading').style.display=s?'flex':'none'; document.getElementById('loading-text').innerText=t; }
        function handleFailure(e) { alert("Error: "+e.message); showLoading(false); }
    </script>
</body>
</html>