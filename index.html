// --- Script Properties ---
const SCRIPT_PROPERTIES = PropertiesService.getScriptProperties();
const SHEET_ID = SCRIPT_PROPERTIES.getProperty('SHEET_ID');

// --- Sheet Names ---
const DATABASE_SHEET_NAME = 'database';
const ASM_DATABASE_SHEET_NAME = 'asm_database';
const VOLUNTEER_LIST_SHEET_NAME = 'volunteer_list';
const DAILY_CHECK_SHEET_NAME = 'daily_check';
const STICKER_SHARE_SHEET_NAME = 'sticker_share';
const TEST_DISTANCE_SHEET_NAME = 'test_distance';
const KNOWLEDGE_TEST_SHEET_NAME = 'knowledge_test';
const TEL_LOG_SHEET_NAME = 'tel_log';

// --- Main HTTP Handlers ---

function doGet(e) {
  const action = e.parameter.action || 'getUserData';
  const ss = SpreadsheetApp.openById(SHEET_ID);

  try {
    let data;

    switch (action) {
      case 'getUserData':
        const userId = e.parameter.userId;
        const currentPic = e.parameter.pictureUrl; // รับรูปปัจจุบันมาเช็ค
        if (!userId) throw new Error("ไม่พบ User ID");
        
        // Auto Sync Profile Picture
        if (currentPic) syncProfilePicture(ss, userId, currentPic);
        
        const userProfile = getUserProfile(ss, userId);
        const vhvProfile = getVhvProfile(ss, userId);
        const isVhv = vhvProfile !== null;
        const homeDistance = getHomeDistance(ss, userId);
        const userLatLon = homeDistance ? homeDistance.latlong : null;

        // คำนวณ Gamification & Ranking
        const gameStats = getGamificationStats(ss, userId, homeDistance);

        // ข้อมูลสำหรับหน้า อสม.
        let vhvStats = {};
        let vhvChecklist = {};
        let vhvPatientList = [];
        
        // Top 3 Vhvs (Sticker Share in last 7 days) & Total Count
        const topVhvs = getTopVhvs(ss);
        const totalVhv = getVhvTotalCount(ss);

        if (isVhv) {
            vhvPatientList = getVhvPatientDetails(ss, vhvProfile.area, vhvProfile.asm_home);
            vhvChecklist = getVhvChecklist(ss, userId, vhvProfile, vhvPatientList.length);
        }

        data = {
          userProfile: userProfile,
          isVhv: isVhv,
          vhvProfile: vhvProfile,
          communityLeaders: userProfile ? getCommunityLeaders(ss, userProfile.district, userProfile.village, userLatLon) : null,
          dailyCheckInfo: getDailyCheckInfo(ss, userId),
          stickerShareCount: getStickerShareCount(ss, userId),
          homeDistance: homeDistance,
          knowledgeTestStats: getKnowledgeTestStats(ss, userId),
          gamification: gameStats,
          vhvDashboard: {
              totalVhv: totalVhv,
              topVhvs: topVhvs,
              checklist: vhvChecklist
          },
          availableVhvAreas: getAvailableVhvAreas(ss),
          vhvPatientList: vhvPatientList,
        };
        break;
      
      case 'calculateDistance':
        const originLat = e.parameter.lat;
        const originLon = e.parameter.lon;
        const destination = "10.2300226,99.1087481"; // รพ.สวี
        
        if (!originLat || !originLon) throw new Error("ไม่พบค่า Lat/Lon");
        
        const directions = Maps.newDirectionFinder()
          .setOrigin(originLat + "," + originLon)
          .setDestination(destination)
          .setMode(Maps.DirectionFinder.Mode.DRIVING)
          .getDirections();
        
        if (directions.routes.length === 0) throw new Error("ไม่สามารถคำนวณเส้นทางได้");
        
        const leg = directions.routes[0].legs[0];
        data = {
          distance_km: leg.distance.value / 1000,
          duration_mins: Math.round(leg.duration.value / 60)
        };
        break;

      case 'getShareCard':
         const vUserId = e.parameter.userId;
         const vProfile = getVhvProfile(ss, vUserId);
         if (vProfile) {
           const kStats = getKnowledgeTestStats(ss, vUserId);
           const gStats = getGamificationStats(ss, vUserId, getHomeDistance(ss, vUserId));
           data = { success: true, flex: createFlexMessage(vProfile, kStats, gStats) }; 
         } else {
           data = { success: false, message: "ไม่พบข้อมูล อสม." };
         }
         break;
         
      case 'logQrShare':
         const qUserId = e.parameter.userId;
         updateQrShareCount(ss, qUserId);
         data = { success: true };
         break;
        
      default:
        throw new Error("Invalid GET action.");
    }
    
    return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log(`doGet Error: ${err.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ error: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.openById(SHEET_ID);
    let response;

    switch(requestData.action) {
      case 'registerVhv':
        response = handleVhvRegistration(ss, requestData.data);
        break;
      
      case 'saveNewLocation':
        const locData = requestData.data;
        const distanceSheet = ss.getSheetByName(TEST_DISTANCE_SHEET_NAME);
        distanceSheet.appendRow([ new Date(), locData.userId, locData.type, locData.latlong, locData.distance, locData.duration ]);
        response = { success: true, message: "บันทึกตำแหน่งใหม่สำเร็จ!" };
        break;

      case 'updateUserProfile':
        response = updateUserProfile(ss, requestData.data);
        break;

      case 'logTelCall':
        const callData = requestData.data;
        const logSheet = ss.getSheetByName(TEL_LOG_SHEET_NAME);
        logSheet.appendRow([ new Date(), callData.userId, callData.tel ]);
        response = { success: true };
        break;
        
      default:
        throw new Error("Invalid POST action.");
    }
    return ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log(`doPost Error: ${err.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ error: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}

// --- Helper Functions ---

// 1. Gamification Logic
function getGamificationStats(ss, userId, homeDistance) {
    const checkInfo = getDailyCheckInfo(ss, userId);
    const checkScore = checkInfo.symptomCount + checkInfo.noSymptomCount;

    let emergencyScore = 0;
    if (homeDistance && homeDistance.duration) {
        const mins = parseInt(homeDistance.duration);
        if (mins <= 10) {
            emergencyScore = 10;
        } else if (mins >= 270) { // 4.5 hours
            emergencyScore = 0;
        } else {
            // Linear scale from 10 mins (10 pts) to 270 mins (0 pts)
            // Range = 260 mins. Score drops 10 pts over 260 mins.
            emergencyScore = 10 - ((mins - 10) / 260 * 10);
        }
    }
    emergencyScore = parseFloat(emergencyScore.toFixed(1));

    const stickerScore = getStickerShareCount(ss, userId);

    const knowledgeStats = getKnowledgeTestStats(ss, userId);
    const knowledgeScore = knowledgeStats.maxScore || 0;

    const totalScore = parseFloat((checkScore + emergencyScore + stickerScore + knowledgeScore).toFixed(1));
    const rank = getEstimatedRank(ss, totalScore);

    return {
        checkScore: checkScore,
        emergencyScore: emergencyScore,
        stickerScore: stickerScore,
        knowledgeScore: knowledgeScore,
        totalScore: totalScore,
        rank: rank.rank,
        totalUsers: rank.totalUsers
    };
}

function getEstimatedRank(ss, myScore) {
  const sheet = ss.getSheetByName(KNOWLEDGE_TEST_SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const totalUsers = Math.max(1, data.length - 1);
  // Simplified rank logic for speed
  let estimatedRank = Math.floor(totalUsers * (1 - (Math.min(myScore, 100)/120))) + 1;
  if(estimatedRank < 1) estimatedRank = 1;
  if(estimatedRank > totalUsers) estimatedRank = totalUsers;
  return { rank: estimatedRank, totalUsers: totalUsers };
}

// 2. VHV Checklist Logic
function getVhvChecklist(ss, userId, vhvProfile, patientCount) {
    // 1. Register (Already true if we are here)
    // 2. Exam (Level=asm in knowledge_test)
    let hasExam = false;
    const kSheet = ss.getSheetByName(KNOWLEDGE_TEST_SHEET_NAME);
    const kData = kSheet.getDataRange().getValues();
    for(let i=1; i<kData.length; i++) {
        if(kData[i][1] === userId && String(kData[i][3]).toLowerCase() === 'asm') {
            hasExam = true; break;
        }
    }
    
    // 3. Pin Home (test_distance type='บ้าน_อสม')
    let hasPinned = false;
    const dSheet = ss.getSheetByName(TEST_DISTANCE_SHEET_NAME);
    const dData = dSheet.getDataRange().getValues();
    for(let i=dData.length-1; i>0; i--) {
        if(dData[i][1] === userId && dData[i][2] === 'บ้าน_อสม') {
            hasPinned = true; break;
        }
    }

    // 4. Shared QR (asm_database col qr_share > 0)
    const hasSharedQr = (vhvProfile.qr_share && vhvProfile.qr_share > 0);

    // 5. Recommend Patients (Patient Count > 1)
    const hasRecommended = patientCount > 1;

    // 6. Shared Sticker (sticker_share > 1)
    const stickerCount = getStickerShareCount(ss, userId);
    const hasSharedSticker = stickerCount > 1;

    return {
        isRegistered: true,
        hasExam: hasExam,
        hasPinned: hasPinned,
        hasSharedQr: hasSharedQr,
        hasRecommended: hasRecommended,
        hasSharedSticker: hasSharedSticker
    };
}

// 3. Top VHV Logic
function getTopVhvs(ss) {
    const stickerSheet = ss.getSheetByName(STICKER_SHARE_SHEET_NAME);
    const asmSheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    
    if(!stickerSheet || !asmSheet) return [];

    // Get Sticker Data (Last 7 days)
    const sData = stickerSheet.getDataRange().getValues();
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    
    const counts = {}; // userId -> count
    
    for(let i=1; i<sData.length; i++) {
        const ts = new Date(sData[i][0]);
        const uid = sData[i][1]; // Assuming col 2 is userId
        if(ts >= sevenDaysAgo) {
            counts[uid] = (counts[uid] || 0) + 1;
        }
    }

    // Map to VHV Profiles
    const asmData = asmSheet.getDataRange().getValues();
    const vhvs = [];
    const asmHeaders = asmData[0].map(h => h.trim());
    const uIdx = asmHeaders.indexOf('userId');
    const nIdx = asmHeaders.indexOf('name');
    const pIdx = asmHeaders.indexOf('profilePicture');

    for(let i=1; i<asmData.length; i++) {
        const uid = asmData[i][uIdx];
        if(counts[uid]) {
            vhvs.push({
                name: asmData[i][nIdx],
                picture: asmData[i][pIdx],
                score: counts[uid]
            });
        }
    }

    // Sort & Slice
    vhvs.sort((a,b) => b.score - a.score);
    return vhvs.slice(0, 3);
}

// 4. Flex Message (Safe & Enhanced)
function createFlexMessage(p, kStats, gStats) {
  // Null Checks
  const name = p.name || "อสม.สโตรก";
  const pic = p.profilePicture || "https://via.placeholder.com/150";
  const area = p.area || "ไม่ระบุ";
  const phone = p.phone ? p.phone.replace(/'/g,'') : "";
  const lineId = p.line_id || "";
  const exam = kStats.maxScore ? kStats.maxScore : "-";
  const health = gStats.totalScore || "-";

  // Buttons Logic (Safe)
  const buttons = [];
  if (lineId) {
      buttons.push({
         "type": "button", "style": "primary", "height": "sm", "color": "#06C755",
         "action": { "type": "uri", "label": "เพิ่มเพื่อน LINE", "uri": `https://line.me/ti/p/~${lineId}` }
      });
  }
  if (phone) {
      buttons.push({
         "type": "button", "style": "secondary", "height": "sm",
         "action": { "type": "uri", "label": "โทรหา อสม.", "uri": `tel:${phone}` }
      });
  }

  // Emergency Button
  const emergencyBtn = {
      "type": "button", "style": "primary", "height": "sm", "color": "#FF3333",
      "action": { "type": "uri", "label": "โทรสายด่วน รพ.สวี", "uri": "tel:08947455523" }
  };

  return {
    "type": "flex",
    "altText": `นามบัตร อสม. ${name}`,
    "contents": {
      "type": "bubble",
      "size": "mega",
      "body": {
        "type": "box", "layout": "vertical", "backgroundColor": "#f0f8ff", "paddingAll": "0px",
        "contents": [
          {
            "type": "box", "layout": "vertical", "paddingAll": "15px", "backgroundColor": "#0d6efd",
            "contents": [
               { "type": "text", "text": "บัตรประจำตัว อสม.สโตรก", "color": "#ffffff", "weight": "bold", "size": "md" },
               { "type": "text", "text": "รพ.สวี จ.ชุมพร", "color": "#ffffff", "size": "xs", "alpha": 0.8 }
            ]
          },
          {
            "type": "box", "layout": "horizontal", "paddingAll": "15px", "spacing": "md", "alignItems": "center",
            "contents": [
              {
                "type": "image", "url": pic, "aspectMode": "cover", "size": "100px", "aspectRatio": "3:4", "cornerRadius": "8px", "flex": 0
              },
              {
                "type": "box", "layout": "vertical", "spacing": "xs", "flex": 1,
                "contents": [
                  { "type": "text", "text": name, "weight": "bold", "size": "md", "color": "#333333", "wrap": true },
                  { "type": "text", "text": `พื้นที่: ${area}`, "size": "xxs", "color": "#666666", "wrap": true },
                  { "type": "separator", "margin": "sm" },
                  { "type": "text", "text": `สอบได้: ${exam}/10`, "size": "xxs", "color": "#0d6efd", "weight": "bold" },
                  { "type": "text", "text": `คะแนนสุขภาพ: ${health}`, "size": "xxs", "color": "#0d6efd", "weight": "bold" }
                ]
              }
            ]
          },
          // Emergency Section
          {
             "type": "box", "layout": "vertical", "paddingAll": "15px", "backgroundColor": "#ffebee",
             "contents": [
                 { "type": "text", "text": "มีปัญหาสงสัยเรื่องสโตรก ปรึกษา อสม. หรือ", "size": "xxs", "color": "#d32f2f", "align": "center", "wrap": true },
                 { "type": "spacer", "size": "sm" },
                 emergencyBtn
             ]
          },
          // Contact Buttons
          {
            "type": "box", "layout": "vertical", "paddingAll": "15px", "spacing": "sm", "contents": buttons
          }
        ]
      }
    }
  };
}

// 5. Update QR Share Count
function updateQrShareCount(ss, userId) {
    const sheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    const headers = data[0].map(h => h.trim());
    const uIdx = headers.indexOf('userId');
    const qIdx = headers.indexOf('qr_share');
    
    // If qr_share col doesn't exist, created virtually by logic, but assume created in sheet
    // If not found in header, we can't update properly without `getRange`.
    // Assuming user added column "qr_share"
    
    if(qIdx === -1) return; // Column not found

    for(let i=1; i<data.length; i++) {
        if(data[i][uIdx] === userId) {
            const currentVal = parseInt(data[i][qIdx]) || 0;
            sheet.getRange(i+1, qIdx+1).setValue(currentVal + 1);
            break;
        }
    }
}

// 6. Sync Profile Logic
function syncProfilePicture(ss, userId, newUrl) {
    // Check Database
    const dbSheet = ss.getSheetByName(DATABASE_SHEET_NAME);
    const dbData = dbSheet.getDataRange().getValues();
    const dbHeaders = dbData[0].map(h => h.trim());
    const dbUIdx = dbHeaders.indexOf('userId');
    const dbPIdx = dbHeaders.indexOf('pictureUrl');
    
    if(dbUIdx > -1 && dbPIdx > -1) {
        for(let i=1; i<dbData.length; i++) {
            if(dbData[i][dbUIdx] === userId) {
                if(dbData[i][dbPIdx] !== newUrl) {
                    dbSheet.getRange(i+1, dbPIdx+1).setValue(newUrl);
                }
                break;
            }
        }
    }
    
    // Check ASM Database
    const asmSheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    const asmData = asmSheet.getDataRange().getValues();
    const asmHeaders = asmData[0].map(h => h.trim());
    const asmUIdx = asmHeaders.indexOf('userId');
    const asmPIdx = asmHeaders.indexOf('profilePicture');
    
    if(asmUIdx > -1 && asmPIdx > -1) {
        for(let i=1; i<asmData.length; i++) {
            if(asmData[i][asmUIdx] === userId) {
                if(asmData[i][asmPIdx] !== newUrl) {
                    asmSheet.getRange(i+1, asmPIdx+1).setValue(newUrl);
                }
                break;
            }
        }
    }
}

// ... [Existing Functions: handleVhvRegistration, updateUserProfile, getVhvTotalCount, getUserProfile, etc. remain unchanged] ...
// (Keeping existing standard functions to save space, assuming they exist as per previous context)

function handleVhvRegistration(ss, regData) {
    const asmSheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    const asmData = asmSheet.getDataRange().getValues();
    const asmHeaders = asmData[0].map(h => h.trim());
    const userIdCol = asmHeaders.indexOf('userId');
    const areasAsString = Array.isArray(regData.areas) ? regData.areas.join(',') : regData.areas;
    
    let existingRowIndex = -1;
    for (let i = 1; i < asmData.length; i++) {
        if (asmData[i][userIdCol] === regData.userId) {
            existingRowIndex = i + 1;
            break;
        }
    }
    const rowData = {
        'timestamp': new Date(), 'displayName': regData.displayName, 'profilePicture': regData.profilePicture,
        'name': regData.name, 'phone': `'${String(regData.phone)}`, 'line_id': regData.line_id,
        'area': areasAsString, 'pdpa': regData.pdpa, 'asm_home': regData.asm_home, 'asm_test': regData.asm_test
    };
    if (existingRowIndex > -1) { 
        asmHeaders.forEach((header, index) => { if (header in rowData) asmSheet.getRange(existingRowIndex, index + 1).setValue(rowData[header]); });
    } else { 
        const newRow = asmHeaders.map(h => rowData[h] || '');
        newRow[userIdCol] = regData.userId;
        asmSheet.appendRow(newRow);
    }
    return { success: true, message: "บันทึกข้อมูลสำเร็จ" };
}

function updateUserProfile(ss, userData) {
    const sheet = ss.getSheetByName(DATABASE_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    const headers = data[0].map(h => h.toString().trim());
    const userIdCol = headers.indexOf('userId');
    let found = false;
    for(let i=1; i<data.length; i++) {
        if(data[i][userIdCol] === userData.userId) {
            if(userData.name) sheet.getRange(i+1, headers.indexOf('name')+1).setValue(userData.name);
            if(userData.phone) sheet.getRange(i+1, headers.indexOf('telephone')+1).setValue(`'${userData.phone}`);
            if(userData.pictureUrl) sheet.getRange(i+1, headers.indexOf('pictureUrl')+1).setValue(userData.pictureUrl);
            found = true; break;
        }
    }
    const vhvSheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    const vhvData = vhvSheet.getDataRange().getValues();
    const vhvHeaders = vhvData[0].map(h => h.trim());
    const vUserIdCol = vhvHeaders.indexOf('userId');
    for(let i=1; i<vhvData.length; i++) {
        if(vhvData[i][vUserIdCol] === userData.userId) {
            if(userData.name) vhvSheet.getRange(i+1, vhvHeaders.indexOf('name')+1).setValue(userData.name);
            if(userData.phone) vhvSheet.getRange(i+1, vhvHeaders.indexOf('phone')+1).setValue(`'${userData.phone}`);
            if(userData.pictureUrl) vhvSheet.getRange(i+1, vhvHeaders.indexOf('profilePicture')+1).setValue(userData.pictureUrl);
            break;
        }
    }
    return found ? { success: true } : { success: false };
}

function getVhvTotalCount(ss) {
    const sheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    return Math.max(0, sheet.getLastRow() - 1);
}

function getUserProfile(ss, userId) {
  const sheet = ss.getSheetByName(DATABASE_SHEET_NAME);
  if (!sheet) return null;
  const data = sheet.getDataRange().getValues();
  const headers = data[0].map(h => h.toString().trim());
  const userIdColIndex = headers.indexOf('userId');
  if (userIdColIndex === -1) return null;
  for (let i = data.length - 1; i > 0; i--) {
    if (data[i][userIdColIndex] === userId) {
      const record = {};
      headers.forEach((header, index) => { if (header) record[header] = data[i][index]; });
      return record;
    }
  }
  return null;
}
function getVhvProfile(ss, userId) {
    const sheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    if (!sheet || sheet.getLastRow() < 2) return null;
    const data = sheet.getDataRange().getValues();
    const headers = data[0].map(h => h.trim());
    const userIdCol = headers.indexOf('userId');
    if (userIdCol === -1) return null;
    for (let i = 1; i < data.length; i++) {
        if (data[i][userIdCol] === userId) {
            const vhv = {};
            headers.forEach((h, index) => { if (h) vhv[h] = data[i][index]; });
            return vhv;
        }
    }
    return null;
}
function getCommunityLeaders(ss, userDistrict, userVillage, userLatLon) {
    const sheet = ss.getSheetByName(VOLUNTEER_LIST_SHEET_NAME);
    const asmSheet = ss.getSheetByName(ASM_DATABASE_SHEET_NAME);
    if (!sheet || !asmSheet) return null;
    const asmData = asmSheet.getDataRange().getValues();
    const asmHeaders = asmData[0].map(h => h.trim());
    const asmAreaCol = asmHeaders.indexOf('area');
    const userAreaString = `ต.${userDistrict} ม.${userVillage}`;
    let volunteer1 = null; let volunteer2 = null;
    for(let i=1; i<asmData.length; i++) {
        const areas = String(asmData[i][asmAreaCol]).split(',').map(s=>s.trim());
        if(areas.includes(userAreaString)) {
            const vhv = {};
            asmHeaders.forEach((h, idx) => vhv[h] = asmData[i][idx]);
            vhv.distance_km = calculateHaversineDistance(userLatLon, vhv.asm_home);
            if(!volunteer1) volunteer1 = vhv; else if(!volunteer2) volunteer2 = vhv;
        }
    }
    const volData = sheet.getDataRange().getValues();
    const volHeaders = volData[0].map(h => h.trim());
    let leaders = {};
    for (let i = 1; i < volData.length; i++) {
        if (volData[i][0] === userAreaString) {
            volHeaders.forEach((h, index) => { if (h) leaders[h] = volData[i][index]; });
            break;
        }
    }
    if(volunteer1) {
        leaders.volunteer1 = volunteer1.name; leaders.volunteer1_tel = volunteer1.phone.replace(/'/g, '');
        leaders.volunteer1_line_id = volunteer1.line_id; leaders.volunteer1_distance_km = volunteer1.distance_km;
    }
    if(volunteer2) {
        leaders.volunteer2 = volunteer2.name; leaders.volunteer2_tel = volunteer2.phone.replace(/'/g, '');
        leaders.volunteer2_line_id = volunteer2.line_id; leaders.volunteer2_distance_km = volunteer2.distance_km;
    }
    return leaders;
}
function getVhvPatientDetails(ss, vhvAreaString, vhvHomeLocation) {
    if (!vhvAreaString) return [];
    const dbSheet = ss.getSheetByName(DATABASE_SHEET_NAME);
    const distanceSheet = ss.getSheetByName(TEST_DISTANCE_SHEET_NAME);
    const dailyCheckSheet = ss.getSheetByName(DAILY_CHECK_SHEET_NAME);
    const distanceData = distanceSheet.getDataRange().getValues();
    const patientLocationMap = new Map();
    for(let i = distanceData.length - 1; i > 0; i--) {
      if (distanceData[i][2] === 'บ้าน') patientLocationMap.set(distanceData[i][1], distanceData[i][3]);
    }
    const dailyCheckData = dailyCheckSheet.getDataRange().getValues();
    const lastCheckMap = new Map();
    const checkUserIdCol = dailyCheckData[0].indexOf('userId');
    const checkTimestampCol = dailyCheckData[0].indexOf('timestamp');
    for (let i = 1; i < dailyCheckData.length; i++) {
        const userId = dailyCheckData[i][checkUserIdCol];
        const timestamp = dailyCheckData[i][checkTimestampCol];
        if (userId && timestamp instanceof Date) {
            if (!lastCheckMap.has(userId) || timestamp > lastCheckMap.get(userId)) lastCheckMap.set(userId, timestamp);
        }
    }
    const vhvAreas = vhvAreaString.split(',').map(a => a.trim());
    const dbData = dbSheet.getDataRange().getValues();
    const dbHeaders = dbData[0].map(h => h.trim());
    const riskScoreColName = 'thai_cv_risk_score';
    const patients = [];
    for (let i = 1; i < dbData.length; i++) {
        const patient = {};
        dbHeaders.forEach((h, index) => patient[h] = dbData[i][index]);
        if (patient.allow_tel) {
            const patientArea = `ต.${patient.district} ม.${patient.village}`;
            if (vhvAreas.includes(patientArea)) {
                const patientHomeLocation = patientLocationMap.get(patient.userId);
                patient.distanceFromVhv_km = vhvHomeLocation ? calculateHaversineDistance(vhvHomeLocation, patientHomeLocation) : null;
                patient.latlong = patientHomeLocation || null; 
                const lastCheck = lastCheckMap.get(patient.userId);
                patient.latestCheckTimestamp = lastCheck ? lastCheck.toISOString() : null;
                patients.push(patient);
            }
        }
    }
    patients.sort((a, b) => (b[riskScoreColName] || 0) - (a[riskScoreColName] || 0));
    return patients;
}
function getDailyCheckInfo(ss, userId) {
    const sheet = ss.getSheetByName(DAILY_CHECK_SHEET_NAME);
    const info = { symptomCount: 0, noSymptomCount: 0, latestCheckTimestamp: null };
    if (!sheet || sheet.getLastRow() < 2) return info;
    const data = sheet.getDataRange().getValues();
    const headers = data[0].map(h => String(h).trim());
    const userIdCol = headers.indexOf('userId');
    const eventIdCol = headers.indexOf('eventId'); 
    const timestampCol = headers.indexOf('timestamp');
    if(userIdCol === -1 || eventIdCol === -1 || timestampCol === -1) return info;
    let latestDate = null;
    for (let i = 1; i < data.length; i++) {
        if (data[i][userIdCol] === userId) {
            if (data[i][eventIdCol]) info.symptomCount++; else info.noSymptomCount++;
            if (data[i][timestampCol] instanceof Date && (!latestDate || data[i][timestampCol] > latestDate)) latestDate = data[i][timestampCol];
        }
    }
    info.latestCheckTimestamp = latestDate ? latestDate.toISOString() : null;
    return info;
}
function getAvailableVhvAreas(ss) {
  const sheet = ss.getSheetByName(VOLUNTEER_LIST_SHEET_NAME);
  if (!sheet) return [];
  const data = sheet.getDataRange().getValues();
  const availableAreas = [];
  for (let i = 1; i < data.length; i++) { if(data[i][0]) availableAreas.push(data[i][0]); }
  return availableAreas;
}
function getHomeDistance(ss, userId) {
  const sheet = ss.getSheetByName(TEST_DISTANCE_SHEET_NAME);
  if (!sheet || sheet.getLastRow() < 2) return null;
  const data = sheet.getDataRange().getValues();
  const headers = data[0].map(h => h.toString().trim());
  const userIdCol = headers.indexOf('userId');
  const typeCol = headers.indexOf('type');
  if (userIdCol === -1 || typeCol === -1) return null;
  for (let i = data.length - 1; i > 0; i--) {
    if (data[i][userIdCol] === userId && data[i][typeCol] === 'บ้าน') {
      const record = {}; headers.forEach((h, index) => { record[h] = data[i][index]; }); return record;
    }
  }
  return null;
}
function getStickerShareCount(ss, userId) {
  const sheet = ss.getSheetByName(STICKER_SHARE_SHEET_NAME);
  if (!sheet || sheet.getLastRow() < 2) return 0;
  const data = sheet.getRange("B:B").getValues(); 
  return data.filter(row => row[0] === userId).length;
}
function getKnowledgeTestStats(ss, userId) {
  const sheet = ss.getSheetByName(KNOWLEDGE_TEST_SHEET_NAME);
  const stats = { testCount: 0, maxScore: 0 };
  if (!sheet || sheet.getLastRow() < 2) return stats;
  const data = sheet.getDataRange().getValues();
  const headers = data[0].map(h => h.trim());
  const userIdCol = headers.indexOf('userId');
  const levelCol = headers.indexOf('level');
  const scoreCol = headers.indexOf('get_score');
  if (userIdCol === -1 || levelCol === -1 || scoreCol === -1) return stats;
  let userScores = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][userIdCol] === userId && data[i][levelCol] === 'general') {
      const score = parseFloat(data[i][scoreCol]); if (!isNaN(score)) userScores.push(score);
    }
  }
  stats.testCount = userScores.length;
  if (userScores.length > 0) stats.maxScore = Math.max(...userScores);
  return stats;
}
function calculateHaversineDistance(coords1Str, coords2Str) {
    if (!coords1Str || !coords2Str) return null;
    try {
        const [lat1, lon1] = coords1Str.split(',').map(Number);
        const [lat2, lon2] = coords2Str.split(',').map(Number);
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return (R * c).toFixed(1);
    } catch (e) { return null; }
}